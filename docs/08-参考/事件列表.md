# 事件列表

NetherGate 提供了丰富的事件系统，本文档列出了所有可用的事件及其详细说明。

---

## 📋 **事件分类**

- [服务器生命周期事件](#服务器生命周期事件)
- [玩家事件](#玩家事件)
- [允许列表和封禁事件](#允许列表和封禁事件)
- [网络层事件](#网络层事件)
- [SMP 协议事件](#smp-协议事件)

---

## 🔄 **服务器生命周期事件**

### **ServerStartingEvent**

服务器进程即将启动时触发。

```csharp
public record ServerStartingEvent();
```

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerStartingEvent>(e =>
{
    _context.Logger.Info("服务器即将启动");
    // 初始化资源
});
```

**触发时机：** 在服务器进程启动之前  
**用途：** 预初始化、准备资源

---

### **ServerReadyEvent**

服务器完全启动，可以接受玩家连接。

```csharp
public record ServerReadyEvent(TimeSpan StartupTime);
```

**字段：**
- `StartupTime`: 服务器启动耗时

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerReadyEvent>(e =>
{
    _context.Logger.Info($"服务器启动完成，耗时 {e.StartupTime.TotalSeconds:F3} 秒");
    // 可以开始发送命令
});
```

**触发时机：** 检测到日志中的 "Done (X.XXXs)!" 消息  
**用途：** 启动后的初始化操作

---

### **ServerShuttingDownEvent**

服务器开始关闭流程。

```csharp
public record ServerShuttingDownEvent();
```

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerShuttingDownEvent>(e =>
{
    _context.Logger.Info("服务器正在关闭");
    // 保存数据
});
```

**触发时机：** 检测到日志中的 "Stopping server" 消息  
**用途：** 保存数据、清理资源

---

### **ServerStoppedEvent**

服务器进程已完全停止。

```csharp
public record ServerStoppedEvent(int ExitCode);
```

**字段：**
- `ExitCode`: 进程退出代码（0 = 正常退出）

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerStoppedEvent>(e =>
{
    if (e.ExitCode == 0)
    {
        _context.Logger.Info("服务器正常停止");
    }
    else
    {
        _context.Logger.Warning($"服务器异常停止，退出代码: {e.ExitCode}");
    }
});
```

**触发时机：** 服务器进程终止后  
**用途：** 清理、日志记录、决定是否重启

---

### **ServerCrashedEvent**

服务器崩溃。

```csharp
public record ServerCrashedEvent(int ExitCode, string Reason);
```

**字段：**
- `ExitCode`: 进程退出代码
- `Reason`: 崩溃原因描述

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerCrashedEvent>(e =>
{
    _context.Logger.Error($"服务器崩溃: {e.Reason}");
    _context.Logger.Error($"退出代码: {e.ExitCode}");
    
    // 发送告警通知
    await SendCrashAlert(e);
});
```

**触发时机：** 服务器非正常退出  
**用途：** 崩溃分析、告警通知、自动重启

---

### **ServerHeartbeatEvent**

服务器心跳（定期接收服务器状态）。

```csharp
public record ServerHeartbeatEvent(ServerState State);

public class ServerState
{
    public int PlayerCount { get; set; }
    public int MaxPlayers { get; set; }
    public double Tps { get; set; }
    public long MemoryUsed { get; set; }
    public long MemoryMax { get; set; }
    public List<PlayerInfo> Players { get; set; }
}
```

**字段：**
- `State.PlayerCount`: 在线玩家数
- `State.MaxPlayers`: 最大玩家数
- `State.Tps`: 服务器 TPS（每秒 Tick 数）
- `State.MemoryUsed`: 已使用内存
- `State.MemoryMax`: 最大内存
- `State.Players`: 在线玩家列表

**使用示例：**
```csharp
_context.EventBus.Subscribe<ServerHeartbeatEvent>(e =>
{
    _context.Logger.Debug($"TPS: {e.State.Tps:F1}, 玩家: {e.State.PlayerCount}/{e.State.MaxPlayers}");
    
    // 性能告警
    if (e.State.Tps < 15)
    {
        _context.Logger.Warning("服务器 TPS 过低！");
    }
});
```

**触发时机：** 定期（通过 SMP 协议，通常每秒一次）  
**用途：** 性能监控、状态展示

---

## 👤 **玩家事件**

### **PlayerJoinedEvent**

玩家加入服务器。

```csharp
public record PlayerJoinedEvent(PlayerInfo Player, string JoinMessage);

public class PlayerInfo
{
    public string Name { get; set; }
    public string Uuid { get; set; }
    public string IpAddress { get; set; }
}
```

**字段：**
- `Player`: 玩家信息
- `JoinMessage`: 加入消息

**使用示例：**
```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    _context.Logger.Info($"{e.Player.Name} 加入了服务器");
    
    // 发送欢迎消息
    await _context.GameDisplayApi.SendChatMessage(
        e.Player.Name, 
        "§a欢迎来到服务器！"
    );
    
    // 显示标题
    await _context.GameDisplayApi.ShowTitle(
        e.Player.Name,
        "§6欢迎！",
        $"§e{e.Player.Name}"
    );
});
```

**触发时机：** 玩家完成登录后  
**用途：** 欢迎消息、权限检查、数据加载

---

### **PlayerLeftEvent**

玩家离开服务器。

```csharp
public record PlayerLeftEvent(PlayerInfo Player, string LeaveMessage);
```

**字段：**
- `Player`: 玩家信息
- `LeaveMessage`: 离开消息

**使用示例：**
```csharp
_context.EventBus.Subscribe<PlayerLeftEvent>(e =>
{
    _context.Logger.Info($"{e.Player.Name} 离开了服务器");
    
    // 保存玩家数据
    SavePlayerData(e.Player.Name);
    
    // 清理缓存
    _cache.Remove(e.Player.Name);
});
```

**触发时机：** 玩家断开连接后  
**用途：** 保存数据、清理缓存

---

### **PlayerChatEvent**

玩家发送聊天消息。

```csharp
public record PlayerChatEvent(string PlayerName, string Message);
```

**字段：**
- `PlayerName`: 玩家名称
- `Message`: 聊天消息内容

**使用示例：**
```csharp
_context.EventBus.Subscribe<PlayerChatEvent>(async e =>
{
    // 检测敏感词
    if (ContainsBadWords(e.Message))
    {
        _context.Logger.Warning($"{e.PlayerName} 发送了不当消息");
        await _context.GameDisplayApi.SendChatMessage(
            e.PlayerName, 
            "§c请注意言辞！"
        );
    }
    
    // 聊天记录
    LogChat(e.PlayerName, e.Message);
});
```

**触发时机：** 玩家发送聊天消息时  
**用途：** 聊天过滤、日志记录、自动回复

---

### **PlayerDeathEvent**

玩家死亡。

```csharp
public record PlayerDeathEvent(string PlayerName, string DeathMessage);
```

**字段：**
- `PlayerName`: 玩家名称
- `DeathMessage`: 死亡消息

**使用示例：**
```csharp
_context.EventBus.Subscribe<PlayerDeathEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} 死亡: {e.DeathMessage}");
    
    // 记录死亡位置
    var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(e.PlayerName);
    SaveDeathLocation(e.PlayerName, playerData?.Position);
    
    // 延迟发送提示
    await Task.Delay(3000);
    await _context.GameDisplayApi.SendChatMessage(
        e.PlayerName, 
        "§e输入 #back 返回死亡地点"
    );
});
```

**触发时机：** 玩家死亡时  
**用途：** 死亡统计、死亡地点保存、自动复活

---

### **PlayerAdvancementEvent**

玩家获得成就/进度。

```csharp
public record PlayerAdvancementEvent(string PlayerName, string AdvancementKey, string Title);
```

**字段：**
- `PlayerName`: 玩家名称
- `AdvancementKey`: 成就键名
- `Title`: 成就标题

**使用示例：**
```csharp
_context.EventBus.Subscribe<PlayerAdvancementEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} 获得成就: {e.Title}");
    
    // 广播成就
    await _context.GameDisplayApi.BroadcastMessage(
        $"§6[成就] §e{e.PlayerName} §f获得了成就 §a{e.Title}"
    );
    
    // 给予奖励
    await GiveAchievementReward(e.PlayerName, e.AdvancementKey);
});
```

**触发时机：** 玩家完成成就时  
**用途：** 成就广播、奖励发放、统计

---

## 🔒 **允许列表和封禁事件**

### **AllowlistAddedEvent**

玩家被添加到白名单。

```csharp
public record AllowlistAddedEvent(string PlayerName, string Operator);
```

**字段：**
- `PlayerName`: 被添加的玩家
- `Operator`: 执行操作的管理员

**使用示例：**
```csharp
_context.EventBus.Subscribe<AllowlistAddedEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} 被 {e.Operator} 添加到白名单");
});
```

---

### **AllowlistRemovedEvent**

玩家被从白名单移除。

```csharp
public record AllowlistRemovedEvent(string PlayerName, string Operator);
```

---

### **AllowlistSetEvent**

批量设置白名单。

```csharp
public record AllowlistSetEvent(List<string> PlayerNames, string Operator);
```

**字段：**
- `PlayerNames`: 白名单玩家列表
- `Operator`: 执行操作的管理员

---

### **AllowlistClearedEvent**

白名单被清空。

```csharp
public record AllowlistClearedEvent(string Operator);
```

---

### **BanAddedEvent**

玩家被封禁。

```csharp
public record BanAddedEvent(string PlayerName, string Reason, string Operator, DateTime? Expires);
```

**字段：**
- `PlayerName`: 被封禁的玩家
- `Reason`: 封禁原因
- `Operator`: 执行操作的管理员
- `Expires`: 过期时间（null = 永久封禁）

**使用示例：**
```csharp
_context.EventBus.Subscribe<BanAddedEvent>(e =>
{
    var expireStr = e.Expires.HasValue ? $"至 {e.Expires.Value}" : "永久";
    _context.Logger.Info($"{e.PlayerName} 被 {e.Operator} 封禁 ({expireStr}): {e.Reason}");
    
    // 记录到数据库
    LogBan(e);
});
```

---

### **BanRemovedEvent**

玩家被解封。

```csharp
public record BanRemovedEvent(string PlayerName, string Operator);
```

---

### **BanSetEvent / BanClearedEvent**

批量设置封禁 / 清空封禁列表。

---

### **IpBanAddedEvent / IpBanRemovedEvent**

IP 封禁相关事件。

```csharp
public record IpBanAddedEvent(string IpAddress, string Reason, string Operator, DateTime? Expires);
public record IpBanRemovedEvent(string IpAddress, string Operator);
```

---

### **OperatorAddedEvent / OperatorRemovedEvent**

OP 权限相关事件。

```csharp
public record OperatorAddedEvent(string PlayerName, int Level, string Operator);
public record OperatorRemovedEvent(string PlayerName, string Operator);
```

**字段：**
- `Level`: OP 等级（1-4）

---

## 🌐 **网络层事件**

网络层事件提供了对 Minecraft 网络协议的深度监控能力。

### **监听模式说明**

⚠️ **重要**：网络层事件需要特定的监听模式支持，默认情况下 NetherGate 使用 `LogBased` 模式，**不会触发网络层事件**。

| 模式 | 说明 | 事件支持 | 配置方式 |
|------|------|---------|---------|
| **LogBased** | 默认模式，仅解析日志 | ❌ 不支持网络事件 | 无需配置 |
| **PluginBridge** | 服务端插件桥接 | ✅ 完整支持 | 安装 NetherGate-Bridge 插件 |
| **ModBridge** | 模组桥接（Forge/Fabric） | ✅ 完整支持 | 安装 NetherGate-Mod 模组 |
| **ProxyBridge** | 代理模式（BungeeCord/Velocity） | ✅ 完整支持 | 配置代理插件 |

**启用方式：**
```yaml
# nethergate-config.yaml
network_listener:
  mode: PluginBridge  # 或 ModBridge、ProxyBridge
  bridge_host: localhost
  bridge_port: 40746
```

---

### **连接事件**

#### **PlayerConnectionAttemptEvent**

玩家开始连接握手（Handshake）。

```csharp
public record PlayerConnectionAttemptEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public int Port { get; init; }
    public int ProtocolVersion { get; init; }
    public string ServerAddress { get; init; }
    public int NextState { get; init; }  // 1=状态查询, 2=登录
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PlayerConnectionAttemptEvent>(e =>
{
    Logger.Info($"连接尝试 - IP: {e.IpAddress}, 协议: {e.ProtocolVersion}");
    
    // IP 黑名单检查
    if (IsBlacklisted(e.IpAddress))
    {
        Logger.Warning($"拒绝黑名单 IP: {e.IpAddress}");
        // 注意：此事件仅用于监控，无法阻止连接
    }
}, EventPriority.Normal);
```

**触发时机：** 玩家发送握手包时  
**用途：** 连接日志、IP 统计、协议版本检测

---

#### **PlayerLoginStartEvent**

玩家开始登录流程。

```csharp
public record PlayerLoginStartEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PlayerLoginStartEvent>(e =>
{
    Logger.Info($"{e.PlayerName} ({e.PlayerUuid}) 开始登录");
    
    // 检查维护模式
    if (IsMaintenanceMode())
    {
        Logger.Warning($"维护模式：拒绝 {e.PlayerName} 登录");
    }
}, EventPriority.Normal);
```

**触发时机：** 玩家发送 Login Start 包时  
**用途：** 登录拦截、维护模式检测

---

#### **PlayerLoginSuccessEvent**

玩家登录成功（已通过身份验证）。

```csharp
public record PlayerLoginSuccessEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid PlayerUuid { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PlayerLoginSuccessEvent>(async e =>
{
    Logger.Info($"{e.PlayerName} 登录成功");
    
    // 加载玩家数据
    var playerData = await LoadPlayerDataAsync(e.PlayerUuid);
    
    // 记录登录日志
    await LogLoginAsync(e.PlayerName, e.IpAddress, e.Timestamp);
}, EventPriority.Normal);
```

**触发时机：** 服务器发送 Login Success 包后  
**用途：** 数据加载、登录日志、账号绑定

---

#### **PlayerLoginFailedEvent**

玩家登录失败。

```csharp
public record PlayerLoginFailedEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public string Reason { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PlayerLoginFailedEvent>(e =>
{
    Logger.Warning($"{e.PlayerName} 登录失败: {e.Reason}");
    
    // 记录失败次数
    IncrementFailedAttempts(e.IpAddress);
    
    // 自动封禁（暴力破解防护）
    if (GetFailedAttempts(e.IpAddress) > 5)
    {
        BanIpAddress(e.IpAddress, "多次登录失败");
    }
}, EventPriority.Normal);
```

**触发时机：** 登录被拒绝时  
**用途：** 安全监控、暴力破解防护

---

#### **PlayerDisconnectedEvent**

玩家断开连接（网络层）。

```csharp
public record PlayerDisconnectedEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public string Reason { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PlayerDisconnectedEvent>(async e =>
{
    Logger.Info($"{e.PlayerName} 断开连接: {e.Reason}");
    
    // 清理玩家会话
    await CleanupPlayerSessionAsync(e.PlayerUuid);
    
    // 记录断开原因
    if (e.Reason.Contains("timeout"))
    {
        Logger.Warning($"{e.PlayerName} 超时断开");
    }
}, EventPriority.Normal);
```

**触发时机：** 连接关闭时  
**用途：** 会话清理、断开统计

---

### **数据包事件**

#### **PacketReceivedEvent**

接收到数据包（低级）。

```csharp
public record PacketReceivedEvent : NetworkEvent
{
    public int PacketId { get; init; }
    public string PacketType { get; init; }
    public int DataLength { get; init; }
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PacketReceivedEvent>(e =>
{
    Logger.Debug($"接收: {e.PacketType} (0x{e.PacketId:X2}) - {e.DataLength} 字节");
    
    // 监控特定数据包
    if (e.PacketType == "ServerboundPlayerCommand")
    {
        Logger.Info($"{e.PlayerName} 发送了玩家命令包");
    }
}, EventPriority.Monitor);
```

**触发时机：** 每次接收数据包时  
**用途：** 网络调试、协议分析  
**⚠️ 性能影响**：高频事件，建议仅在调试时使用

---

#### **PacketSentEvent**

发送数据包（低级）。

```csharp
public record PacketSentEvent : NetworkEvent
{
    public int PacketId { get; init; }
    public string PacketType { get; init; }
    public int DataLength { get; init; }
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<PacketSentEvent>(e =>
{
    Logger.Debug($"发送: {e.PacketType} (0x{e.PacketId:X2}) - {e.DataLength} 字节");
    
    // 监控聊天消息发送
    if (e.PacketType == "ClientboundSystemChatPacket")
    {
        Logger.Info($"向 {e.PlayerName} 发送聊天消息");
    }
}, EventPriority.Monitor);
```

**触发时机：** 每次发送数据包时  
**用途：** 网络调试、流量分析  
**⚠️ 性能影响**：高频事件，建议仅在调试时使用

---

### **状态查询事件**

#### **ServerStatusQueryEvent**

服务器列表状态查询（Server List Ping）。

```csharp
public record ServerStatusQueryEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public int ProtocolVersion { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<ServerStatusQueryEvent>(e =>
{
    Logger.Debug($"状态查询 - IP: {e.IpAddress}, 协议: {e.ProtocolVersion}");
    
    // 统计查询来源
    IncrementQueryCount(e.IpAddress);
    
    // 检测扫描器
    if (GetQueryCount(e.IpAddress) > 100)
    {
        Logger.Warning($"可能的扫描器: {e.IpAddress}");
    }
}, EventPriority.Normal);
```

**触发时机：** 玩家在服务器列表中查看服务器时  
**用途：** 流量统计、扫描器检测

---

#### **ServerPingEvent**

服务器 Ping 测试。

```csharp
public record ServerPingEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public long Payload { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**触发时机：** 玩家测试服务器延迟时  
**用途：** Ping 统计、网络质量分析

---

### **异常事件**

#### **NetworkExceptionEvent**

网络异常。

```csharp
public record NetworkExceptionEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public string IpAddress { get; init; }
    public string ExceptionType { get; init; }
    public string Message { get; init; }
    public string? StackTrace { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<NetworkExceptionEvent>(e =>
{
    Logger.Error($"网络异常 - {e.PlayerName}: {e.ExceptionType}");
    Logger.Error($"消息: {e.Message}");
    
    // 记录详细日志
    if (!string.IsNullOrEmpty(e.StackTrace))
    {
        Logger.Debug($"堆栈跟踪:\n{e.StackTrace}");
    }
    
    // 检测常见问题
    if (e.ExceptionType.Contains("Timeout"))
    {
        Logger.Warning($"{e.IpAddress} 连接超时");
    }
}, EventPriority.Normal);
```

**触发时机：** 网络层发生异常时  
**用途：** 错误监控、问题诊断

---

#### **MaliciousPacketDetectedEvent**

检测到恶意数据包。

```csharp
public record MaliciousPacketDetectedEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public string PlayerName { get; init; }
    public string PacketType { get; init; }
    public string Reason { get; init; }
    public bool WasBlocked { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<MaliciousPacketDetectedEvent>(async e =>
{
    Logger.Warning($"🚨 检测到恶意数据包！");
    Logger.Warning($"玩家: {e.PlayerName}, IP: {e.IpAddress}");
    Logger.Warning($"类型: {e.PacketType}, 原因: {e.Reason}");
    Logger.Warning($"已拦截: {e.WasBlocked}");
    
    // 自动封禁
    if (e.WasBlocked)
    {
        await GameDisplay.BanPlayer(e.PlayerName, e.Reason);
        await SmpApi.BanIpAsync(e.IpAddress, e.Reason, null);
    }
    
    // 发送管理员警报
    await NotifyAdminsAsync($"检测到攻击: {e.PlayerName} ({e.IpAddress})");
}, EventPriority.Highest);
```

**触发时机：** 检测到异常数据包时  
**用途：** 安全防护、攻击检测

---

### **流量监控事件**

#### **NetworkTrafficEvent**

网络流量统计（周期性）。

```csharp
public record NetworkTrafficEvent : NetworkEvent
{
    public DateTime PeriodStart { get; init; }
    public DateTime PeriodEnd { get; init; }
    public long BytesReceived { get; init; }
    public long BytesSent { get; init; }
    public long PacketsReceived { get; init; }
    public long PacketsSent { get; init; }
    public int OnlinePlayerCount { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**使用示例：**
```csharp
Events.Subscribe<NetworkTrafficEvent>(e =>
{
    var duration = (e.PeriodEnd - e.PeriodStart).TotalSeconds;
    var receivedMBps = (e.BytesReceived / 1024.0 / 1024.0) / duration;
    var sentMBps = (e.BytesSent / 1024.0 / 1024.0) / duration;
    
    Logger.Info($"📊 网络流量统计 ({duration:F0}秒):");
    Logger.Info($"  接收: {receivedMBps:F2} MB/s ({e.PacketsReceived} 包)");
    Logger.Info($"  发送: {sentMBps:F2} MB/s ({e.PacketsSent} 包)");
    Logger.Info($"  在线玩家: {e.OnlinePlayerCount}");
    
    // 检测异常流量
    if (receivedMBps > 100)
    {
        Logger.Warning("⚠️ 接收流量异常，可能正在遭受攻击！");
    }
}, EventPriority.Normal);
```

**触发时机：** 每个统计周期结束时（默认 60 秒）  
**用途：** 带宽监控、性能分析、DDoS 检测

---

### **网络事件最佳实践**

#### **1. 避免在高频事件中执行耗时操作**

```csharp
// ❌ 不推荐：在 PacketReceivedEvent 中执行耗时操作
Events.Subscribe<PacketReceivedEvent>(async e =>
{
    await Task.Delay(100);  // 会严重影响性能！
}, EventPriority.Normal);

// ✅ 推荐：仅在 Monitor 优先级记录关键信息
Events.Subscribe<PacketReceivedEvent>(e =>
{
    if (e.PacketType == "TargetPacket")
    {
        Logger.Debug($"关键数据包: {e.PacketType}");
    }
}, EventPriority.Monitor);
```

#### **2. 使用适当的监听模式**

```yaml
# 生产环境：使用 LogBased（默认）
network_listener:
  mode: LogBased  # 性能最佳，无网络事件

# 调试/监控：使用 PluginBridge
network_listener:
  mode: PluginBridge  # 完整网络事件支持
  bridge_host: localhost
  bridge_port: 40746
```

#### **3. 合理使用事件优先级**

```csharp
// 安全检查：高优先级
Events.Subscribe<MaliciousPacketDetectedEvent>(async e =>
{
    await BanPlayerAsync(e.PlayerName);
}, EventPriority.Highest);

// 日志记录：监视器优先级
Events.Subscribe<PacketReceivedEvent>(e =>
{
    LogPacket(e.PacketType);
}, EventPriority.Monitor);
```

---

## 📡 **SMP 协议事件**

### **SmpConnectedEvent**

SMP 连接建立。

```csharp
public record SmpConnectedEvent();
```

**使用示例：**
```csharp
_context.EventBus.Subscribe<SmpConnectedEvent>(e =>
{
    _context.Logger.Info("SMP 连接已建立");
});
```

---

### **SmpDisconnectedEvent**

SMP 连接断开。

```csharp
public record SmpDisconnectedEvent(string Reason);
```

**字段：**
- `Reason`: 断开原因

**使用示例：**
```csharp
_context.EventBus.Subscribe<SmpDisconnectedEvent>(e =>
{
    _context.Logger.Warning($"SMP 连接已断开: {e.Reason}");
    // 尝试重连
});
```

---

## 📚 **相关文档**

- [事件系统](../02-核心功能/事件系统.md)
- [插件开发指南](../03-插件开发/插件开发指南.md)
- [API 参考](./API参考.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
