# äº‹ä»¶åˆ—è¡¨

NetherGate æä¾›äº†ä¸°å¯Œçš„äº‹ä»¶ç³»ç»Ÿï¼Œæœ¬æ–‡æ¡£åˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨çš„äº‹ä»¶åŠå…¶è¯¦ç»†è¯´æ˜ã€‚

---

## ğŸ“‹ **äº‹ä»¶åˆ†ç±»**

- [æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶](#æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶)
- [ç©å®¶äº‹ä»¶](#ç©å®¶äº‹ä»¶)
- [å…è®¸åˆ—è¡¨å’Œå°ç¦äº‹ä»¶](#å…è®¸åˆ—è¡¨å’Œå°ç¦äº‹ä»¶)
- [ç½‘ç»œå±‚äº‹ä»¶](#ç½‘ç»œå±‚äº‹ä»¶)
- [SMP åè®®äº‹ä»¶](#smp-åè®®äº‹ä»¶)

---

## ğŸ”„ **æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶**

### **ServerStartingEvent**

æœåŠ¡å™¨è¿›ç¨‹å³å°†å¯åŠ¨æ—¶è§¦å‘ã€‚

```csharp
public record ServerStartingEvent();
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerStartingEvent>(e =>
{
    _context.Logger.Info("æœåŠ¡å™¨å³å°†å¯åŠ¨");
    // åˆå§‹åŒ–èµ„æº
});
```

**è§¦å‘æ—¶æœºï¼š** åœ¨æœåŠ¡å™¨è¿›ç¨‹å¯åŠ¨ä¹‹å‰  
**ç”¨é€”ï¼š** é¢„åˆå§‹åŒ–ã€å‡†å¤‡èµ„æº

---

### **ServerReadyEvent**

æœåŠ¡å™¨å®Œå…¨å¯åŠ¨ï¼Œå¯ä»¥æ¥å—ç©å®¶è¿æ¥ã€‚

```csharp
public record ServerReadyEvent(TimeSpan StartupTime);
```

**å­—æ®µï¼š**
- `StartupTime`: æœåŠ¡å™¨å¯åŠ¨è€—æ—¶

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerReadyEvent>(e =>
{
    _context.Logger.Info($"æœåŠ¡å™¨å¯åŠ¨å®Œæˆï¼Œè€—æ—¶ {e.StartupTime.TotalSeconds:F3} ç§’");
    // å¯ä»¥å¼€å§‹å‘é€å‘½ä»¤
});
```

**è§¦å‘æ—¶æœºï¼š** æ£€æµ‹åˆ°æ—¥å¿—ä¸­çš„ "Done (X.XXXs)!" æ¶ˆæ¯  
**ç”¨é€”ï¼š** å¯åŠ¨åçš„åˆå§‹åŒ–æ“ä½œ

---

### **ServerShuttingDownEvent**

æœåŠ¡å™¨å¼€å§‹å…³é—­æµç¨‹ã€‚

```csharp
public record ServerShuttingDownEvent();
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerShuttingDownEvent>(e =>
{
    _context.Logger.Info("æœåŠ¡å™¨æ­£åœ¨å…³é—­");
    // ä¿å­˜æ•°æ®
});
```

**è§¦å‘æ—¶æœºï¼š** æ£€æµ‹åˆ°æ—¥å¿—ä¸­çš„ "Stopping server" æ¶ˆæ¯  
**ç”¨é€”ï¼š** ä¿å­˜æ•°æ®ã€æ¸…ç†èµ„æº

---

### **ServerStoppedEvent**

æœåŠ¡å™¨è¿›ç¨‹å·²å®Œå…¨åœæ­¢ã€‚

```csharp
public record ServerStoppedEvent(int ExitCode);
```

**å­—æ®µï¼š**
- `ExitCode`: è¿›ç¨‹é€€å‡ºä»£ç ï¼ˆ0 = æ­£å¸¸é€€å‡ºï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerStoppedEvent>(e =>
{
    if (e.ExitCode == 0)
    {
        _context.Logger.Info("æœåŠ¡å™¨æ­£å¸¸åœæ­¢");
    }
    else
    {
        _context.Logger.Warning($"æœåŠ¡å™¨å¼‚å¸¸åœæ­¢ï¼Œé€€å‡ºä»£ç : {e.ExitCode}");
    }
});
```

**è§¦å‘æ—¶æœºï¼š** æœåŠ¡å™¨è¿›ç¨‹ç»ˆæ­¢å  
**ç”¨é€”ï¼š** æ¸…ç†ã€æ—¥å¿—è®°å½•ã€å†³å®šæ˜¯å¦é‡å¯

---

### **ServerCrashedEvent**

æœåŠ¡å™¨å´©æºƒã€‚

```csharp
public record ServerCrashedEvent(int ExitCode, string Reason);
```

**å­—æ®µï¼š**
- `ExitCode`: è¿›ç¨‹é€€å‡ºä»£ç 
- `Reason`: å´©æºƒåŸå› æè¿°

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerCrashedEvent>(e =>
{
    _context.Logger.Error($"æœåŠ¡å™¨å´©æºƒ: {e.Reason}");
    _context.Logger.Error($"é€€å‡ºä»£ç : {e.ExitCode}");
    
    // å‘é€å‘Šè­¦é€šçŸ¥
    await SendCrashAlert(e);
});
```

**è§¦å‘æ—¶æœºï¼š** æœåŠ¡å™¨éæ­£å¸¸é€€å‡º  
**ç”¨é€”ï¼š** å´©æºƒåˆ†æã€å‘Šè­¦é€šçŸ¥ã€è‡ªåŠ¨é‡å¯

---

### **ServerHeartbeatEvent**

æœåŠ¡å™¨å¿ƒè·³ï¼ˆå®šæœŸæ¥æ”¶æœåŠ¡å™¨çŠ¶æ€ï¼‰ã€‚

```csharp
public record ServerHeartbeatEvent(ServerState State);

public class ServerState
{
    public int PlayerCount { get; set; }
    public int MaxPlayers { get; set; }
    public double Tps { get; set; }
    public long MemoryUsed { get; set; }
    public long MemoryMax { get; set; }
    public List<PlayerInfo> Players { get; set; }
}
```

**å­—æ®µï¼š**
- `State.PlayerCount`: åœ¨çº¿ç©å®¶æ•°
- `State.MaxPlayers`: æœ€å¤§ç©å®¶æ•°
- `State.Tps`: æœåŠ¡å™¨ TPSï¼ˆæ¯ç§’ Tick æ•°ï¼‰
- `State.MemoryUsed`: å·²ä½¿ç”¨å†…å­˜
- `State.MemoryMax`: æœ€å¤§å†…å­˜
- `State.Players`: åœ¨çº¿ç©å®¶åˆ—è¡¨

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<ServerHeartbeatEvent>(e =>
{
    _context.Logger.Debug($"TPS: {e.State.Tps:F1}, ç©å®¶: {e.State.PlayerCount}/{e.State.MaxPlayers}");
    
    // æ€§èƒ½å‘Šè­¦
    if (e.State.Tps < 15)
    {
        _context.Logger.Warning("æœåŠ¡å™¨ TPS è¿‡ä½ï¼");
    }
});
```

**è§¦å‘æ—¶æœºï¼š** å®šæœŸï¼ˆé€šè¿‡ SMP åè®®ï¼Œé€šå¸¸æ¯ç§’ä¸€æ¬¡ï¼‰  
**ç”¨é€”ï¼š** æ€§èƒ½ç›‘æ§ã€çŠ¶æ€å±•ç¤º

---

## ğŸ‘¤ **ç©å®¶äº‹ä»¶**

### **PlayerJoinedEvent**

ç©å®¶åŠ å…¥æœåŠ¡å™¨ã€‚

```csharp
public record PlayerJoinedEvent(PlayerInfo Player, string JoinMessage);

public class PlayerInfo
{
    public string Name { get; set; }
    public string Uuid { get; set; }
    public string IpAddress { get; set; }
}
```

**å­—æ®µï¼š**
- `Player`: ç©å®¶ä¿¡æ¯
- `JoinMessage`: åŠ å…¥æ¶ˆæ¯

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    _context.Logger.Info($"{e.Player.Name} åŠ å…¥äº†æœåŠ¡å™¨");
    
    // å‘é€æ¬¢è¿æ¶ˆæ¯
    await _context.GameDisplayApi.SendChatMessage(
        e.Player.Name, 
        "Â§aæ¬¢è¿æ¥åˆ°æœåŠ¡å™¨ï¼"
    );
    
    // æ˜¾ç¤ºæ ‡é¢˜
    await _context.GameDisplayApi.ShowTitle(
        e.Player.Name,
        "Â§6æ¬¢è¿ï¼",
        $"Â§e{e.Player.Name}"
    );
});
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶å®Œæˆç™»å½•å  
**ç”¨é€”ï¼š** æ¬¢è¿æ¶ˆæ¯ã€æƒé™æ£€æŸ¥ã€æ•°æ®åŠ è½½

---

### **PlayerLeftEvent**

ç©å®¶ç¦»å¼€æœåŠ¡å™¨ã€‚

```csharp
public record PlayerLeftEvent(PlayerInfo Player, string LeaveMessage);
```

**å­—æ®µï¼š**
- `Player`: ç©å®¶ä¿¡æ¯
- `LeaveMessage`: ç¦»å¼€æ¶ˆæ¯

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<PlayerLeftEvent>(e =>
{
    _context.Logger.Info($"{e.Player.Name} ç¦»å¼€äº†æœåŠ¡å™¨");
    
    // ä¿å­˜ç©å®¶æ•°æ®
    SavePlayerData(e.Player.Name);
    
    // æ¸…ç†ç¼“å­˜
    _cache.Remove(e.Player.Name);
});
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶æ–­å¼€è¿æ¥å  
**ç”¨é€”ï¼š** ä¿å­˜æ•°æ®ã€æ¸…ç†ç¼“å­˜

---

### **PlayerChatEvent**

ç©å®¶å‘é€èŠå¤©æ¶ˆæ¯ã€‚

```csharp
public record PlayerChatEvent(string PlayerName, string Message);
```

**å­—æ®µï¼š**
- `PlayerName`: ç©å®¶åç§°
- `Message`: èŠå¤©æ¶ˆæ¯å†…å®¹

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<PlayerChatEvent>(async e =>
{
    // æ£€æµ‹æ•æ„Ÿè¯
    if (ContainsBadWords(e.Message))
    {
        _context.Logger.Warning($"{e.PlayerName} å‘é€äº†ä¸å½“æ¶ˆæ¯");
        await _context.GameDisplayApi.SendChatMessage(
            e.PlayerName, 
            "Â§cè¯·æ³¨æ„è¨€è¾ï¼"
        );
    }
    
    // èŠå¤©è®°å½•
    LogChat(e.PlayerName, e.Message);
});
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶å‘é€èŠå¤©æ¶ˆæ¯æ—¶  
**ç”¨é€”ï¼š** èŠå¤©è¿‡æ»¤ã€æ—¥å¿—è®°å½•ã€è‡ªåŠ¨å›å¤

---

### **PlayerDeathEvent**

ç©å®¶æ­»äº¡ã€‚

```csharp
public record PlayerDeathEvent(string PlayerName, string DeathMessage);
```

**å­—æ®µï¼š**
- `PlayerName`: ç©å®¶åç§°
- `DeathMessage`: æ­»äº¡æ¶ˆæ¯

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<PlayerDeathEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} æ­»äº¡: {e.DeathMessage}");
    
    // è®°å½•æ­»äº¡ä½ç½®
    var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(e.PlayerName);
    SaveDeathLocation(e.PlayerName, playerData?.Position);
    
    // å»¶è¿Ÿå‘é€æç¤º
    await Task.Delay(3000);
    await _context.GameDisplayApi.SendChatMessage(
        e.PlayerName, 
        "Â§eè¾“å…¥ #back è¿”å›æ­»äº¡åœ°ç‚¹"
    );
});
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶æ­»äº¡æ—¶  
**ç”¨é€”ï¼š** æ­»äº¡ç»Ÿè®¡ã€æ­»äº¡åœ°ç‚¹ä¿å­˜ã€è‡ªåŠ¨å¤æ´»

---

### **PlayerAdvancementEvent**

ç©å®¶è·å¾—æˆå°±/è¿›åº¦ã€‚

```csharp
public record PlayerAdvancementEvent(string PlayerName, string AdvancementKey, string Title);
```

**å­—æ®µï¼š**
- `PlayerName`: ç©å®¶åç§°
- `AdvancementKey`: æˆå°±é”®å
- `Title`: æˆå°±æ ‡é¢˜

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<PlayerAdvancementEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} è·å¾—æˆå°±: {e.Title}");
    
    // å¹¿æ’­æˆå°±
    await _context.GameDisplayApi.BroadcastMessage(
        $"Â§6[æˆå°±] Â§e{e.PlayerName} Â§fè·å¾—äº†æˆå°± Â§a{e.Title}"
    );
    
    // ç»™äºˆå¥–åŠ±
    await GiveAchievementReward(e.PlayerName, e.AdvancementKey);
});
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶å®Œæˆæˆå°±æ—¶  
**ç”¨é€”ï¼š** æˆå°±å¹¿æ’­ã€å¥–åŠ±å‘æ”¾ã€ç»Ÿè®¡

---

## ğŸ”’ **å…è®¸åˆ—è¡¨å’Œå°ç¦äº‹ä»¶**

### **AllowlistAddedEvent**

ç©å®¶è¢«æ·»åŠ åˆ°ç™½åå•ã€‚

```csharp
public record AllowlistAddedEvent(string PlayerName, string Operator);
```

**å­—æ®µï¼š**
- `PlayerName`: è¢«æ·»åŠ çš„ç©å®¶
- `Operator`: æ‰§è¡Œæ“ä½œçš„ç®¡ç†å‘˜

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<AllowlistAddedEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} è¢« {e.Operator} æ·»åŠ åˆ°ç™½åå•");
});
```

---

### **AllowlistRemovedEvent**

ç©å®¶è¢«ä»ç™½åå•ç§»é™¤ã€‚

```csharp
public record AllowlistRemovedEvent(string PlayerName, string Operator);
```

---

### **AllowlistSetEvent**

æ‰¹é‡è®¾ç½®ç™½åå•ã€‚

```csharp
public record AllowlistSetEvent(List<string> PlayerNames, string Operator);
```

**å­—æ®µï¼š**
- `PlayerNames`: ç™½åå•ç©å®¶åˆ—è¡¨
- `Operator`: æ‰§è¡Œæ“ä½œçš„ç®¡ç†å‘˜

---

### **AllowlistClearedEvent**

ç™½åå•è¢«æ¸…ç©ºã€‚

```csharp
public record AllowlistClearedEvent(string Operator);
```

---

### **BanAddedEvent**

ç©å®¶è¢«å°ç¦ã€‚

```csharp
public record BanAddedEvent(string PlayerName, string Reason, string Operator, DateTime? Expires);
```

**å­—æ®µï¼š**
- `PlayerName`: è¢«å°ç¦çš„ç©å®¶
- `Reason`: å°ç¦åŸå› 
- `Operator`: æ‰§è¡Œæ“ä½œçš„ç®¡ç†å‘˜
- `Expires`: è¿‡æœŸæ—¶é—´ï¼ˆnull = æ°¸ä¹…å°ç¦ï¼‰

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<BanAddedEvent>(e =>
{
    var expireStr = e.Expires.HasValue ? $"è‡³ {e.Expires.Value}" : "æ°¸ä¹…";
    _context.Logger.Info($"{e.PlayerName} è¢« {e.Operator} å°ç¦ ({expireStr}): {e.Reason}");
    
    // è®°å½•åˆ°æ•°æ®åº“
    LogBan(e);
});
```

---

### **BanRemovedEvent**

ç©å®¶è¢«è§£å°ã€‚

```csharp
public record BanRemovedEvent(string PlayerName, string Operator);
```

---

### **BanSetEvent / BanClearedEvent**

æ‰¹é‡è®¾ç½®å°ç¦ / æ¸…ç©ºå°ç¦åˆ—è¡¨ã€‚

---

### **IpBanAddedEvent / IpBanRemovedEvent**

IP å°ç¦ç›¸å…³äº‹ä»¶ã€‚

```csharp
public record IpBanAddedEvent(string IpAddress, string Reason, string Operator, DateTime? Expires);
public record IpBanRemovedEvent(string IpAddress, string Operator);
```

---

### **OperatorAddedEvent / OperatorRemovedEvent**

OP æƒé™ç›¸å…³äº‹ä»¶ã€‚

```csharp
public record OperatorAddedEvent(string PlayerName, int Level, string Operator);
public record OperatorRemovedEvent(string PlayerName, string Operator);
```

**å­—æ®µï¼š**
- `Level`: OP ç­‰çº§ï¼ˆ1-4ï¼‰

---

## ğŸŒ **ç½‘ç»œå±‚äº‹ä»¶**

ç½‘ç»œå±‚äº‹ä»¶æä¾›äº†å¯¹ Minecraft ç½‘ç»œåè®®çš„æ·±åº¦ç›‘æ§èƒ½åŠ›ã€‚

### **ç›‘å¬æ¨¡å¼è¯´æ˜**

âš ï¸ **é‡è¦**ï¼šç½‘ç»œå±‚äº‹ä»¶éœ€è¦ç‰¹å®šçš„ç›‘å¬æ¨¡å¼æ”¯æŒï¼Œé»˜è®¤æƒ…å†µä¸‹ NetherGate ä½¿ç”¨ `LogBased` æ¨¡å¼ï¼Œ**ä¸ä¼šè§¦å‘ç½‘ç»œå±‚äº‹ä»¶**ã€‚

| æ¨¡å¼ | è¯´æ˜ | äº‹ä»¶æ”¯æŒ | é…ç½®æ–¹å¼ |
|------|------|---------|---------|
| **LogBased** | é»˜è®¤æ¨¡å¼ï¼Œä»…è§£ææ—¥å¿— | âŒ ä¸æ”¯æŒç½‘ç»œäº‹ä»¶ | æ— éœ€é…ç½® |
| **PluginBridge** | æœåŠ¡ç«¯æ’ä»¶æ¡¥æ¥ | âœ… å®Œæ•´æ”¯æŒ | å®‰è£… NetherGate-Bridge æ’ä»¶ |
| **ModBridge** | æ¨¡ç»„æ¡¥æ¥ï¼ˆForge/Fabricï¼‰ | âœ… å®Œæ•´æ”¯æŒ | å®‰è£… NetherGate-Mod æ¨¡ç»„ |
| **ProxyBridge** | ä»£ç†æ¨¡å¼ï¼ˆBungeeCord/Velocityï¼‰ | âœ… å®Œæ•´æ”¯æŒ | é…ç½®ä»£ç†æ’ä»¶ |

**å¯ç”¨æ–¹å¼ï¼š**
```yaml
# nethergate-config.yaml
network_listener:
  mode: PluginBridge  # æˆ– ModBridgeã€ProxyBridge
  bridge_host: localhost
  bridge_port: 40746
```

---

### **è¿æ¥äº‹ä»¶**

#### **PlayerConnectionAttemptEvent**

ç©å®¶å¼€å§‹è¿æ¥æ¡æ‰‹ï¼ˆHandshakeï¼‰ã€‚

```csharp
public record PlayerConnectionAttemptEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public int Port { get; init; }
    public int ProtocolVersion { get; init; }
    public string ServerAddress { get; init; }
    public int NextState { get; init; }  // 1=çŠ¶æ€æŸ¥è¯¢, 2=ç™»å½•
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PlayerConnectionAttemptEvent>(e =>
{
    Logger.Info($"è¿æ¥å°è¯• - IP: {e.IpAddress}, åè®®: {e.ProtocolVersion}");
    
    // IP é»‘åå•æ£€æŸ¥
    if (IsBlacklisted(e.IpAddress))
    {
        Logger.Warning($"æ‹’ç»é»‘åå• IP: {e.IpAddress}");
        // æ³¨æ„ï¼šæ­¤äº‹ä»¶ä»…ç”¨äºç›‘æ§ï¼Œæ— æ³•é˜»æ­¢è¿æ¥
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶å‘é€æ¡æ‰‹åŒ…æ—¶  
**ç”¨é€”ï¼š** è¿æ¥æ—¥å¿—ã€IP ç»Ÿè®¡ã€åè®®ç‰ˆæœ¬æ£€æµ‹

---

#### **PlayerLoginStartEvent**

ç©å®¶å¼€å§‹ç™»å½•æµç¨‹ã€‚

```csharp
public record PlayerLoginStartEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PlayerLoginStartEvent>(e =>
{
    Logger.Info($"{e.PlayerName} ({e.PlayerUuid}) å¼€å§‹ç™»å½•");
    
    // æ£€æŸ¥ç»´æŠ¤æ¨¡å¼
    if (IsMaintenanceMode())
    {
        Logger.Warning($"ç»´æŠ¤æ¨¡å¼ï¼šæ‹’ç» {e.PlayerName} ç™»å½•");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶å‘é€ Login Start åŒ…æ—¶  
**ç”¨é€”ï¼š** ç™»å½•æ‹¦æˆªã€ç»´æŠ¤æ¨¡å¼æ£€æµ‹

---

#### **PlayerLoginSuccessEvent**

ç©å®¶ç™»å½•æˆåŠŸï¼ˆå·²é€šè¿‡èº«ä»½éªŒè¯ï¼‰ã€‚

```csharp
public record PlayerLoginSuccessEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid PlayerUuid { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PlayerLoginSuccessEvent>(async e =>
{
    Logger.Info($"{e.PlayerName} ç™»å½•æˆåŠŸ");
    
    // åŠ è½½ç©å®¶æ•°æ®
    var playerData = await LoadPlayerDataAsync(e.PlayerUuid);
    
    // è®°å½•ç™»å½•æ—¥å¿—
    await LogLoginAsync(e.PlayerName, e.IpAddress, e.Timestamp);
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** æœåŠ¡å™¨å‘é€ Login Success åŒ…å  
**ç”¨é€”ï¼š** æ•°æ®åŠ è½½ã€ç™»å½•æ—¥å¿—ã€è´¦å·ç»‘å®š

---

#### **PlayerLoginFailedEvent**

ç©å®¶ç™»å½•å¤±è´¥ã€‚

```csharp
public record PlayerLoginFailedEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public string Reason { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PlayerLoginFailedEvent>(e =>
{
    Logger.Warning($"{e.PlayerName} ç™»å½•å¤±è´¥: {e.Reason}");
    
    // è®°å½•å¤±è´¥æ¬¡æ•°
    IncrementFailedAttempts(e.IpAddress);
    
    // è‡ªåŠ¨å°ç¦ï¼ˆæš´åŠ›ç ´è§£é˜²æŠ¤ï¼‰
    if (GetFailedAttempts(e.IpAddress) > 5)
    {
        BanIpAddress(e.IpAddress, "å¤šæ¬¡ç™»å½•å¤±è´¥");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** ç™»å½•è¢«æ‹’ç»æ—¶  
**ç”¨é€”ï¼š** å®‰å…¨ç›‘æ§ã€æš´åŠ›ç ´è§£é˜²æŠ¤

---

#### **PlayerDisconnectedEvent**

ç©å®¶æ–­å¼€è¿æ¥ï¼ˆç½‘ç»œå±‚ï¼‰ã€‚

```csharp
public record PlayerDisconnectedEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public string Reason { get; init; }
    public string IpAddress { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PlayerDisconnectedEvent>(async e =>
{
    Logger.Info($"{e.PlayerName} æ–­å¼€è¿æ¥: {e.Reason}");
    
    // æ¸…ç†ç©å®¶ä¼šè¯
    await CleanupPlayerSessionAsync(e.PlayerUuid);
    
    // è®°å½•æ–­å¼€åŸå› 
    if (e.Reason.Contains("timeout"))
    {
        Logger.Warning($"{e.PlayerName} è¶…æ—¶æ–­å¼€");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** è¿æ¥å…³é—­æ—¶  
**ç”¨é€”ï¼š** ä¼šè¯æ¸…ç†ã€æ–­å¼€ç»Ÿè®¡

---

### **æ•°æ®åŒ…äº‹ä»¶**

#### **PacketReceivedEvent**

æ¥æ”¶åˆ°æ•°æ®åŒ…ï¼ˆä½çº§ï¼‰ã€‚

```csharp
public record PacketReceivedEvent : NetworkEvent
{
    public int PacketId { get; init; }
    public string PacketType { get; init; }
    public int DataLength { get; init; }
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PacketReceivedEvent>(e =>
{
    Logger.Debug($"æ¥æ”¶: {e.PacketType} (0x{e.PacketId:X2}) - {e.DataLength} å­—èŠ‚");
    
    // ç›‘æ§ç‰¹å®šæ•°æ®åŒ…
    if (e.PacketType == "ServerboundPlayerCommand")
    {
        Logger.Info($"{e.PlayerName} å‘é€äº†ç©å®¶å‘½ä»¤åŒ…");
    }
}, EventPriority.Monitor);
```

**è§¦å‘æ—¶æœºï¼š** æ¯æ¬¡æ¥æ”¶æ•°æ®åŒ…æ—¶  
**ç”¨é€”ï¼š** ç½‘ç»œè°ƒè¯•ã€åè®®åˆ†æ  
**âš ï¸ æ€§èƒ½å½±å“**ï¼šé«˜é¢‘äº‹ä»¶ï¼Œå»ºè®®ä»…åœ¨è°ƒè¯•æ—¶ä½¿ç”¨

---

#### **PacketSentEvent**

å‘é€æ•°æ®åŒ…ï¼ˆä½çº§ï¼‰ã€‚

```csharp
public record PacketSentEvent : NetworkEvent
{
    public int PacketId { get; init; }
    public string PacketType { get; init; }
    public int DataLength { get; init; }
    public string PlayerName { get; init; }
    public Guid? PlayerUuid { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<PacketSentEvent>(e =>
{
    Logger.Debug($"å‘é€: {e.PacketType} (0x{e.PacketId:X2}) - {e.DataLength} å­—èŠ‚");
    
    // ç›‘æ§èŠå¤©æ¶ˆæ¯å‘é€
    if (e.PacketType == "ClientboundSystemChatPacket")
    {
        Logger.Info($"å‘ {e.PlayerName} å‘é€èŠå¤©æ¶ˆæ¯");
    }
}, EventPriority.Monitor);
```

**è§¦å‘æ—¶æœºï¼š** æ¯æ¬¡å‘é€æ•°æ®åŒ…æ—¶  
**ç”¨é€”ï¼š** ç½‘ç»œè°ƒè¯•ã€æµé‡åˆ†æ  
**âš ï¸ æ€§èƒ½å½±å“**ï¼šé«˜é¢‘äº‹ä»¶ï¼Œå»ºè®®ä»…åœ¨è°ƒè¯•æ—¶ä½¿ç”¨

---

### **çŠ¶æ€æŸ¥è¯¢äº‹ä»¶**

#### **ServerStatusQueryEvent**

æœåŠ¡å™¨åˆ—è¡¨çŠ¶æ€æŸ¥è¯¢ï¼ˆServer List Pingï¼‰ã€‚

```csharp
public record ServerStatusQueryEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public int ProtocolVersion { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<ServerStatusQueryEvent>(e =>
{
    Logger.Debug($"çŠ¶æ€æŸ¥è¯¢ - IP: {e.IpAddress}, åè®®: {e.ProtocolVersion}");
    
    // ç»Ÿè®¡æŸ¥è¯¢æ¥æº
    IncrementQueryCount(e.IpAddress);
    
    // æ£€æµ‹æ‰«æå™¨
    if (GetQueryCount(e.IpAddress) > 100)
    {
        Logger.Warning($"å¯èƒ½çš„æ‰«æå™¨: {e.IpAddress}");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶åœ¨æœåŠ¡å™¨åˆ—è¡¨ä¸­æŸ¥çœ‹æœåŠ¡å™¨æ—¶  
**ç”¨é€”ï¼š** æµé‡ç»Ÿè®¡ã€æ‰«æå™¨æ£€æµ‹

---

#### **ServerPingEvent**

æœåŠ¡å™¨ Ping æµ‹è¯•ã€‚

```csharp
public record ServerPingEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public long Payload { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**è§¦å‘æ—¶æœºï¼š** ç©å®¶æµ‹è¯•æœåŠ¡å™¨å»¶è¿Ÿæ—¶  
**ç”¨é€”ï¼š** Ping ç»Ÿè®¡ã€ç½‘ç»œè´¨é‡åˆ†æ

---

### **å¼‚å¸¸äº‹ä»¶**

#### **NetworkExceptionEvent**

ç½‘ç»œå¼‚å¸¸ã€‚

```csharp
public record NetworkExceptionEvent : NetworkEvent
{
    public string PlayerName { get; init; }
    public string IpAddress { get; init; }
    public string ExceptionType { get; init; }
    public string Message { get; init; }
    public string? StackTrace { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<NetworkExceptionEvent>(e =>
{
    Logger.Error($"ç½‘ç»œå¼‚å¸¸ - {e.PlayerName}: {e.ExceptionType}");
    Logger.Error($"æ¶ˆæ¯: {e.Message}");
    
    // è®°å½•è¯¦ç»†æ—¥å¿—
    if (!string.IsNullOrEmpty(e.StackTrace))
    {
        Logger.Debug($"å †æ ˆè·Ÿè¸ª:\n{e.StackTrace}");
    }
    
    // æ£€æµ‹å¸¸è§é—®é¢˜
    if (e.ExceptionType.Contains("Timeout"))
    {
        Logger.Warning($"{e.IpAddress} è¿æ¥è¶…æ—¶");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** ç½‘ç»œå±‚å‘ç”Ÿå¼‚å¸¸æ—¶  
**ç”¨é€”ï¼š** é”™è¯¯ç›‘æ§ã€é—®é¢˜è¯Šæ–­

---

#### **MaliciousPacketDetectedEvent**

æ£€æµ‹åˆ°æ¶æ„æ•°æ®åŒ…ã€‚

```csharp
public record MaliciousPacketDetectedEvent : NetworkEvent
{
    public string IpAddress { get; init; }
    public string PlayerName { get; init; }
    public string PacketType { get; init; }
    public string Reason { get; init; }
    public bool WasBlocked { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<MaliciousPacketDetectedEvent>(async e =>
{
    Logger.Warning($"ğŸš¨ æ£€æµ‹åˆ°æ¶æ„æ•°æ®åŒ…ï¼");
    Logger.Warning($"ç©å®¶: {e.PlayerName}, IP: {e.IpAddress}");
    Logger.Warning($"ç±»å‹: {e.PacketType}, åŸå› : {e.Reason}");
    Logger.Warning($"å·²æ‹¦æˆª: {e.WasBlocked}");
    
    // è‡ªåŠ¨å°ç¦
    if (e.WasBlocked)
    {
        await GameDisplay.BanPlayer(e.PlayerName, e.Reason);
        await SmpApi.BanIpAsync(e.IpAddress, e.Reason, null);
    }
    
    // å‘é€ç®¡ç†å‘˜è­¦æŠ¥
    await NotifyAdminsAsync($"æ£€æµ‹åˆ°æ”»å‡»: {e.PlayerName} ({e.IpAddress})");
}, EventPriority.Highest);
```

**è§¦å‘æ—¶æœºï¼š** æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®åŒ…æ—¶  
**ç”¨é€”ï¼š** å®‰å…¨é˜²æŠ¤ã€æ”»å‡»æ£€æµ‹

---

### **æµé‡ç›‘æ§äº‹ä»¶**

#### **NetworkTrafficEvent**

ç½‘ç»œæµé‡ç»Ÿè®¡ï¼ˆå‘¨æœŸæ€§ï¼‰ã€‚

```csharp
public record NetworkTrafficEvent : NetworkEvent
{
    public DateTime PeriodStart { get; init; }
    public DateTime PeriodEnd { get; init; }
    public long BytesReceived { get; init; }
    public long BytesSent { get; init; }
    public long PacketsReceived { get; init; }
    public long PacketsSent { get; init; }
    public int OnlinePlayerCount { get; init; }
    public DateTime Timestamp { get; init; }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
Events.Subscribe<NetworkTrafficEvent>(e =>
{
    var duration = (e.PeriodEnd - e.PeriodStart).TotalSeconds;
    var receivedMBps = (e.BytesReceived / 1024.0 / 1024.0) / duration;
    var sentMBps = (e.BytesSent / 1024.0 / 1024.0) / duration;
    
    Logger.Info($"ğŸ“Š ç½‘ç»œæµé‡ç»Ÿè®¡ ({duration:F0}ç§’):");
    Logger.Info($"  æ¥æ”¶: {receivedMBps:F2} MB/s ({e.PacketsReceived} åŒ…)");
    Logger.Info($"  å‘é€: {sentMBps:F2} MB/s ({e.PacketsSent} åŒ…)");
    Logger.Info($"  åœ¨çº¿ç©å®¶: {e.OnlinePlayerCount}");
    
    // æ£€æµ‹å¼‚å¸¸æµé‡
    if (receivedMBps > 100)
    {
        Logger.Warning("âš ï¸ æ¥æ”¶æµé‡å¼‚å¸¸ï¼Œå¯èƒ½æ­£åœ¨é­å—æ”»å‡»ï¼");
    }
}, EventPriority.Normal);
```

**è§¦å‘æ—¶æœºï¼š** æ¯ä¸ªç»Ÿè®¡å‘¨æœŸç»“æŸæ—¶ï¼ˆé»˜è®¤ 60 ç§’ï¼‰  
**ç”¨é€”ï¼š** å¸¦å®½ç›‘æ§ã€æ€§èƒ½åˆ†æã€DDoS æ£€æµ‹

---

### **ç½‘ç»œäº‹ä»¶æœ€ä½³å®è·µ**

#### **1. é¿å…åœ¨é«˜é¢‘äº‹ä»¶ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ**

```csharp
// âŒ ä¸æ¨èï¼šåœ¨ PacketReceivedEvent ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
Events.Subscribe<PacketReceivedEvent>(async e =>
{
    await Task.Delay(100);  // ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼
}, EventPriority.Normal);

// âœ… æ¨èï¼šä»…åœ¨ Monitor ä¼˜å…ˆçº§è®°å½•å…³é”®ä¿¡æ¯
Events.Subscribe<PacketReceivedEvent>(e =>
{
    if (e.PacketType == "TargetPacket")
    {
        Logger.Debug($"å…³é”®æ•°æ®åŒ…: {e.PacketType}");
    }
}, EventPriority.Monitor);
```

#### **2. ä½¿ç”¨é€‚å½“çš„ç›‘å¬æ¨¡å¼**

```yaml
# ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ LogBasedï¼ˆé»˜è®¤ï¼‰
network_listener:
  mode: LogBased  # æ€§èƒ½æœ€ä½³ï¼Œæ— ç½‘ç»œäº‹ä»¶

# è°ƒè¯•/ç›‘æ§ï¼šä½¿ç”¨ PluginBridge
network_listener:
  mode: PluginBridge  # å®Œæ•´ç½‘ç»œäº‹ä»¶æ”¯æŒ
  bridge_host: localhost
  bridge_port: 40746
```

#### **3. åˆç†ä½¿ç”¨äº‹ä»¶ä¼˜å…ˆçº§**

```csharp
// å®‰å…¨æ£€æŸ¥ï¼šé«˜ä¼˜å…ˆçº§
Events.Subscribe<MaliciousPacketDetectedEvent>(async e =>
{
    await BanPlayerAsync(e.PlayerName);
}, EventPriority.Highest);

// æ—¥å¿—è®°å½•ï¼šç›‘è§†å™¨ä¼˜å…ˆçº§
Events.Subscribe<PacketReceivedEvent>(e =>
{
    LogPacket(e.PacketType);
}, EventPriority.Monitor);
```

---

## ğŸ“¡ **SMP åè®®äº‹ä»¶**

### **SmpConnectedEvent**

SMP è¿æ¥å»ºç«‹ã€‚

```csharp
public record SmpConnectedEvent();
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<SmpConnectedEvent>(e =>
{
    _context.Logger.Info("SMP è¿æ¥å·²å»ºç«‹");
});
```

---

### **SmpDisconnectedEvent**

SMP è¿æ¥æ–­å¼€ã€‚

```csharp
public record SmpDisconnectedEvent(string Reason);
```

**å­—æ®µï¼š**
- `Reason`: æ–­å¼€åŸå› 

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
_context.EventBus.Subscribe<SmpDisconnectedEvent>(e =>
{
    _context.Logger.Warning($"SMP è¿æ¥å·²æ–­å¼€: {e.Reason}");
    // å°è¯•é‡è¿
});
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [äº‹ä»¶ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/äº‹ä»¶ç³»ç»Ÿ.md)
- [æ’ä»¶å¼€å‘æŒ‡å—](../03-æ’ä»¶å¼€å‘/æ’ä»¶å¼€å‘æŒ‡å—.md)
- [API å‚è€ƒ](./APIå‚è€ƒ.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
