# NetherGate 配置文件详解

本文档详细说明 NetherGate 的所有配置选项，基于实际配置类结构。

---

## 📋 目录

- [配置文件位置](#配置文件位置)
- [服务器进程管理](#服务器进程管理-server_process)
- [SMP 连接配置](#smp-连接配置-server_connection)
- [RCON 客户端配置](#rcon-客户端配置-rcon)
- [日志监听器配置](#日志监听器配置-log_listener)
- [插件管理配置](#插件管理配置-plugins)
- [日志系统配置](#日志系统配置-logging)
- [spark 性能监控配置](#spark-性能监控配置-spark)
- [高级配置](#高级配置-advanced)
- [WebSocket 服务器配置](#websocket-服务器配置)
- [完整配置示例](#完整配置示例)

---

## 📁 配置文件位置

NetherGate 配置文件位于程序根目录，**支持 JSON 和 YAML 两种格式**。

```
NetherGate/
├── nethergate-config.yaml  # 主配置文件（YAML 格式，推荐）
├── nethergate-config.yml   # 或使用 .yml 扩展名
└── nethergate-config.json  # 或使用 JSON 格式
```

### **配置文件优先级**

1. `nethergate-config.yaml` (优先级最高)
2. `nethergate-config.yml`
3. `nethergate-config.json`

### **首次启动流程**

1. NetherGate 检测到配置文件不存在
2. 自动生成 `nethergate-config.yaml`（默认YAML格式）
3. 显示配置文件位置和重要配置项提示
4. 继续启动（使用默认配置）

### **格式选择建议**

- **YAML** - ✅ 推荐使用，支持注释，可读性强
- **JSON** - ⚠️ 兼容性好，但不支持注释

> 💡 **提示**：可以同时存在多个格式，系统会按优先级加载第一个找到的文件

---

## 🖥️ 服务器进程管理 (server_process)

NetherGate 可以自动启动和管理 Minecraft 服务器进程。

### **基础配置**

```yaml
server_process:
  # 是否启用进程管理
  enabled: true
  
  # 启动方式：java | script | external
  launch_method: java
  
  # Java 配置（launch_method = java 时使用）
  java:
    path: java              # Java 可执行文件路径
    version_check: true     # 启动前检查 Java 版本
  
  # 服务器 JAR 配置（launch_method = java 时使用）
  server:
    jar: server.jar         # 服务器 JAR 文件名
    working_directory: ./minecraft_server  # 服务器工作目录
  
  # 内存配置（launch_method = java 时使用）
  memory:
    min: 2048               # 最小内存（MB）
    max: 4096               # 最大内存（MB）
  
  # JVM 参数配置（launch_method = java 时使用）
  arguments:
    jvm_prefix: []          # JVM 前置参数
    jvm_middle:             # JVM 中间参数
      - -XX:+UseG1GC
      - -Dfile.encoding=UTF-8
    server:                 # 服务器参数
      - --nogui
  
  # 脚本配置（launch_method = script 时使用）
  script:
    path: ./start.sh        # 脚本路径
    arguments: []           # 脚本参数
    working_directory: ./minecraft_server
    use_shell: false        # 是否使用 Shell 执行（Linux/macOS）
  
  # 进程监控配置
  monitoring:
    startup_timeout: 300    # 启动超时（秒）
    show_server_output: true  # 显示服务器输出
    server_output_prefix: "[MC] "  # 服务器输出前缀
    
    startup_detection:      # 启动检测
      enabled: true
      keywords:
        - "Done ("          # 启动完成关键词
    
    crash_detection:        # 崩溃检测
      enabled: true
      keywords:
        - "Exception in server tick loop"
  
  # 自动重启配置
  auto_restart:
    enabled: true           # 是否启用自动重启
    delay_seconds: 5        # 重启延迟（秒）
    max_retries: 3          # 最大重试次数
    retry_delay: 5000       # 重试延迟（毫秒）
    reset_timer: 600000     # 重试计数器重置时间（毫秒）
```

### **配置项说明**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用进程管理 |
| `launch_method` | string | `"java"` | 启动方式：`java`/`script`/`external` |

### **启动方式详解**

#### **1. java 模式（推荐）**

NetherGate 直接构建 Java 命令启动服务器。

**完整命令格式：**
```bash
java [jvm_prefix] -Xms<min>M -Xmx<max>M [jvm_middle] -jar <jar> [server]
```

**示例：**
```bash
java -Xms2048M -Xmx4096M -XX:+UseG1GC -Dfile.encoding=UTF-8 -jar server.jar --nogui
```

#### **2. script 模式**

通过脚本启动服务器（适合自定义启动逻辑）。

**Linux/macOS 脚本示例 (`start.sh`)：**
```bash
#!/bin/bash
cd /opt/minecraft/server
java -Xmx4G -Xms2G -jar server.jar nogui
```

**Windows 脚本示例 (`start.bat`)：**
```batch
@echo off
cd C:\Minecraft\Server
java -Xmx4G -Xms2G -jar server.jar nogui
```

#### **3. external 模式**

服务器已在外部运行，NetherGate 仅连接管理。

**配置要点：**
- 仍需指定 `server.working_directory` 用于文件访问
- 确保 RCON 和 SMP 配置正确
- NetherGate 不会启动/停止服务器进程

---

### **启动方式对比**

| 特性 | java | script | external |
|------|------|--------|----------|
| **进程管理** | ✅ 完全管理 | ✅ 完全管理 | ❌ 仅连接 |
| **崩溃检测** | ✅ 支持 | ✅ 支持 | ⚠️ 有限支持 |
| **自动重启** | ✅ 支持 | ✅ 支持 | ❌ 不支持 |
| **启动流程控制** | ✅ 精确控制 | ⚠️ 依赖脚本 | ❌ 无控制 |
| **配置方式** | YAML 配置 | 脚本文件 | 外部管理 |
| **灵活性** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **易用性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **适合新手** | ✅ 是 | ❌ 否 | ❌ 否 |

### **脚本模式详细示例**

#### **基础脚本**

**Linux/macOS (`start.sh`):**
```bash
#!/bin/bash
# 设置工作目录
cd /opt/minecraft/server

# 启动服务器
java -Xms2G -Xmx4G \
  -XX:+UseG1GC \
  -XX:+ParallelRefProcEnabled \
  -XX:MaxGCPauseMillis=200 \
  -Dfile.encoding=UTF-8 \
  -jar server.jar nogui
```

**Windows (`start.bat`):**
```batch
@echo off
:: 设置工作目录
cd C:\Minecraft\Server

:: 启动服务器
java -Xms2G -Xmx4G ^
  -XX:+UseG1GC ^
  -XX:+ParallelRefProcEnabled ^
  -XX:MaxGCPauseMillis=200 ^
  -Dfile.encoding=UTF-8 ^
  -jar server.jar nogui
```

#### **高级脚本（带环境检测）**

**Linux/macOS (`start.sh`):**
```bash
#!/bin/bash
set -e  # 遇到错误立即退出

# 切换到脚本所在目录
cd "$(dirname "$0")"

# 检查 Java 是否安装
if ! command -v java &> /dev/null; then
    echo "错误: 未找到 Java，请先安装 Java 17+"
    exit 1
fi

# 检查 Java 版本
JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d. -f1)
if [ "$JAVA_VERSION" -lt 17 ]; then
    echo "错误: Java 版本过低（需要 17+），当前版本: $JAVA_VERSION"
    exit 1
fi

# 检查服务器 JAR 是否存在
if [ ! -f "server.jar" ]; then
    echo "错误: 未找到 server.jar"
    exit 1
fi

# 接受 EULA（首次运行）
if [ ! -f "eula.txt" ]; then
    echo "eula=true" > eula.txt
    echo "已自动接受 Minecraft EULA"
fi

# 启动服务器
echo "正在启动 Minecraft 服务器..."
java -Xms2G -Xmx4G \
  -XX:+UseG1GC \
  -XX:+ParallelRefProcEnabled \
  -XX:MaxGCPauseMillis=200 \
  -XX:+UnlockExperimentalVMOptions \
  -XX:+DisableExplicitGC \
  -XX:+AlwaysPreTouch \
  -XX:G1NewSizePercent=30 \
  -XX:G1MaxNewSizePercent=40 \
  -XX:G1HeapRegionSize=8M \
  -Dfile.encoding=UTF-8 \
  -Duser.language=zh \
  -Duser.country=CN \
  -jar server.jar nogui
```

**Windows (`start.bat`):**
```batch
@echo off
setlocal enabledelayedexpansion

:: 切换到脚本所在目录
cd /d "%~dp0"

:: 检查 Java 是否安装
where java >nul 2>&1
if errorlevel 1 (
    echo 错误: 未找到 Java，请先安装 Java 17+
    exit /b 1
)

:: 检查服务器 JAR 是否存在
if not exist "server.jar" (
    echo 错误: 未找到 server.jar
    exit /b 1
)

:: 接受 EULA（首次运行）
if not exist "eula.txt" (
    echo eula=true > eula.txt
    echo 已自动接受 Minecraft EULA
)

:: 启动服务器
echo 正在启动 Minecraft 服务器...
java -Xms2G -Xmx4G ^
  -XX:+UseG1GC ^
  -XX:+ParallelRefProcEnabled ^
  -XX:MaxGCPauseMillis=200 ^
  -XX:+UnlockExperimentalVMOptions ^
  -XX:+DisableExplicitGC ^
  -XX:+AlwaysPreTouch ^
  -XX:G1NewSizePercent=30 ^
  -XX:G1MaxNewSizePercent=40 ^
  -XX:G1HeapRegionSize=8M ^
  -Dfile.encoding=UTF-8 ^
  -Duser.language=zh ^
  -Duser.country=CN ^
  -jar server.jar nogui

endlocal
```

#### **Forge/Fabric 启动脚本**

**Forge (`start_forge.sh`):**
```bash
#!/bin/bash
cd /opt/minecraft/forge-server

# Forge 通常会生成 run.sh，直接使用
if [ -f "run.sh" ]; then
    chmod +x run.sh
    ./run.sh
else
    # 手动启动
    java -Xms2G -Xmx4G @libraries/net/minecraftforge/forge/*/unix_args.txt nogui
fi
```

**Fabric (`start_fabric.sh`):**
```bash
#!/bin/bash
cd /opt/minecraft/fabric-server

java -Xms2G -Xmx4G \
  -XX:+UseG1GC \
  -jar fabric-server-launch.jar nogui
```

### **选择建议**

#### **选择 java 模式，如果您：**

- ✅ 是新手，刚开始使用 NetherGate
- ✅ 运行标准的 Minecraft 服务器（Paper/Spigot/Vanilla）
- ✅ 希望通过 YAML 配置文件管理所有参数
- ✅ 需要跨平台一致性
- ✅ 希望使用 NetherGate 的完整进程管理功能

#### **选择 script 模式，如果您：**

- ✅ 已经有成熟的启动脚本
- ✅ 需要复杂的启动前/后处理（如备份、环境检测）
- ✅ 使用第三方启动器（Forge、Fabric、Mohist 等）
- ✅ 需要高度自定义的启动流程
- ✅ 需要在脚本中设置特殊环境变量

#### **选择 external 模式，如果您：**

- ✅ 服务器由其他工具管理（如 systemd、Docker）
- ✅ 只需要 NetherGate 的插件和管理功能
- ✅ 运行在受限环境（无法直接管理进程）
- ⚠️ 注意：将失去崩溃检测和自动重启功能

### **最佳实践**

#### **1. 脚本权限（Linux/macOS）**

```bash
# 赋予脚本执行权限
chmod +x start.sh

# 验证权限
ls -l start.sh
# 输出应包含 -rwxr-xr-x
```

#### **2. 相对路径 vs 绝对路径**

```yaml
# ✅ 推荐：使用相对路径（基于 working_directory）
script:
  path: ./start.sh
  working_directory: ./minecraft_server

# ✅ 也可以：使用绝对路径
script:
  path: /opt/minecraft/server/start.sh
  working_directory: /opt/minecraft/server

# ❌ 避免：混合使用可能导致混淆
script:
  path: /opt/minecraft/start.sh
  working_directory: ./server  # 不一致
```

#### **3. 脚本参数传递**

```yaml
# 配置
script:
  path: ./start.sh
  arguments:
    - --config
    - custom.yml
    - --verbose

# 相当于执行
./start.sh --config custom.yml --verbose
```

#### **4. 使用 Shell 特性（Linux/macOS）**

```yaml
# 需要使用管道、重定向等 Shell 特性时
script:
  use_shell: true
  path: "./start.sh | tee server.log"  # 同时输出到控制台和文件
```

**注意**：通常不需要启用 `use_shell`，除非您的脚本包含 Shell 特性。

---

## 🌐 SMP 连接配置 (server_connection)

SMP（Server Management Protocol）是 NetherGate 的高级管理协议，基于 WebSocket 和 JSON-RPC 2.0。

```yaml
server_connection:
  # SMP 服务器地址
  host: localhost
  
  # SMP 端口
  port: 40745
  
  # 认证密钥（必须与服务器端一致）
  secret: ""
  
  # TLS 配置
  use_tls: false
  tls_certificate: null
  tls_password: null
  
  # 重连配置
  reconnect_interval: 5000      # 重连间隔（毫秒）
  heartbeat_timeout: 30000      # 心跳超时（毫秒）
  
  # 自动连接
  auto_connect: true
  connect_delay: 3000           # 连接延迟（毫秒）
  wait_for_server_ready: true   # 等待服务器启动完成
```

### **配置项说明**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `host` | string | `"localhost"` | SMP 服务器地址 |
| `port` | number | `40745` | SMP 端口（对应 `management-server-port`） |
| `secret` | string | `""` | 认证密钥（对应 `management-server-secret`） |
| `use_tls` | boolean | `false` | 是否使用 TLS 加密 |
| `reconnect_interval` | number | `5000` | 重连间隔（毫秒） |
| `heartbeat_timeout` | number | `30000` | 心跳超时（毫秒） |
| `auto_connect` | boolean | `true` | 是否自动连接 |
| `connect_delay` | number | `3000` | 连接延迟（毫秒） |
| `wait_for_server_ready` | boolean | `true` | 是否等待服务器启动完成 |

### **对应的 server.properties 配置**

```properties
# 启用 SMP
management-server-enabled=true
management-server-host=localhost
management-server-port=40745
management-server-secret=<你的40位认证令牌>
management-server-tls-enabled=false
```

### **生成认证密钥**

**Linux/macOS:**
```bash
openssl rand -base64 30 | tr -d '+/=' | cut -c1-40
```

**Windows PowerShell:**
```powershell
-join ((65..90) + (97..122) + (48..57) | Get-Random -Count 40 | % {[char]$_})
```

---

## 🔧 RCON 客户端配置 (rcon)

RCON 用于向 Minecraft 服务器发送命令。

```yaml
rcon:
  # 是否启用 RCON
  enabled: true
  
  # RCON 服务器地址
  host: localhost
  
  # RCON 端口
  port: 25566
  
  # RCON 密码（必须与 server.properties 一致）
  password: ""
  
  # 连接超时（毫秒）
  connect_timeout: 5000
  
  # 命令超时（毫秒）
  command_timeout: 10000
  
  # 自动连接
  auto_connect: true
  connect_delay: 3000
  
  # 重连配置
  reconnect:
    enabled: true
    interval: 5000          # 重连间隔（毫秒）
    max_retries: 5          # 最大重连次数
```

### **配置项说明**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用 RCON |
| `host` | string | `"localhost"` | RCON 服务器地址 |
| `port` | number | `25566` | RCON 端口 |
| `password` | string | `""` | RCON 密码 |
| `connect_timeout` | number | `5000` | 连接超时（毫秒） |
| `command_timeout` | number | `10000` | 命令超时（毫秒） |
| `auto_connect` | boolean | `true` | 是否自动连接 |
| `connect_delay` | number | `3000` | 连接延迟（毫秒） |
| `reconnect.enabled` | boolean | `true` | 是否启用自动重连 |
| `reconnect.interval` | number | `5000` | 重连间隔（毫秒） |
| `reconnect.max_retries` | number | `5` | 最大重连次数 |

### **对应的 server.properties 配置**

```properties
# 启用 RCON
enable-rcon=true
rcon.port=25566
rcon.password=<你的RCON密码>
```

---

## 📜 日志监听器配置 (log_listener)

日志监听器用于解析和处理 Minecraft 服务器日志。

```yaml
log_listener:
  # 是否启用日志监听
  enabled: true
  
  # 解析配置
  parsing:
    parse_chat: true          # 解析聊天消息
    parse_commands: true      # 解析命令
    parse_player_events: true # 解析玩家事件（加入/离开）
    parse_errors: true        # 解析错误信息
  
  # 过滤配置
  filters:
    ignore_patterns: []       # 忽略的日志模式（正则表达式）
    log_levels:               # 监听的日志级别
      - INFO
      - WARN
      - ERROR
  
  # 缓冲配置
  buffer:
    size: 1000                # 缓冲区大小
    drop_old: true            # 缓冲区满时丢弃旧日志
```

---

## 🔌 插件管理配置 (plugins)

```yaml
plugins:
  # 插件目录
  directory: plugins
  
  # 是否自动加载插件
  auto_load: true
  
  # 是否启用热重载
  hot_reload: true
  
  # 启用的插件列表（"*" 表示全部）
  enabled_plugins:
    - "*"
  
  # 禁用的插件列表
  disabled_plugins: []
  
  # 是否在服务器启动完成后加载插件
  load_after_server_ready: true
  
  # 插件加载超时（秒）
  load_timeout: 30
  
  # 依赖管理配置
  dependency_management:
    enabled: true             # 是否启用依赖管理
    auto_download: true       # 是否自动下载缺失的依赖
    nuget_sources:            # NuGet 源列表
      - https://api.nuget.org/v3/index.json
    download_timeout: 60      # 下载超时（秒）
    verify_hash: true         # 是否验证文件哈希
    conflict_resolution: highest  # 冲突解决策略：highest | lowest | fail
    show_conflict_report: true    # 是否显示冲突报告
```

### **依赖管理说明**

NetherGate 支持自动下载和管理插件的 NuGet 依赖：

- **`highest`** - 使用最高版本（默认）
- **`lowest`** - 使用最低兼容版本
- **`fail`** - 检测到冲突时失败

---

## 📝 日志系统配置 (logging)

```yaml
logging:
  # 日志级别：Debug | Info | Warning | Error
  level: Info
  
  # 控制台日志配置
  console:
    enabled: true
    colored: true             # 彩色输出
    show_server_output: true  # 显示服务器输出
    server_output_prefix: "[MC] "
  
  # 文件日志配置
  file:
    enabled: true
    path: logs/latest.log
    max_size: 10485760        # 最大文件大小（字节，默认 10MB）
    max_files: 10             # 保留的日志文件数量
    rolling: true             # 是否启用滚动日志
    encoding: UTF-8
  
  # 高级日志配置
  advanced:
    log_plugin_loading: true      # 记录插件加载
    log_smp_communication: false  # 记录 SMP 通信（调试用）
    log_rcon_communication: false # 记录 RCON 通信（调试用）
    log_performance: false        # 记录性能信息
```

### **日志级别说明**

| 级别 | 说明 | 用途 |
|------|------|------|
| `Debug` | 调试信息 | 开发环境 |
| `Info` | 一般信息 | 生产环境（推荐） |
| `Warning` | 警告信息 | 生产环境 |
| `Error` | 错误信息 | 仅错误 |

---

## ⚡ spark 性能监控配置 (spark)

spark 是强大的 Java 应用性能分析工具。

```yaml
spark:
  # 是否启用 spark
  enabled: false
  
  # spark 类型：standalone | plugin
  # standalone: 独立代理版（通过 -javaagent 注入）
  # plugin: 插件/模组版（通过 RCON 交互）
  type: standalone
  
  # 是否强制在非 java 启动模式下也尝试启用 spark
  # 仅对 type=standalone 有效
  # 警告：脚本模式需要自行在脚本中添加 -javaagent 参数
  force_enable_for_script_mode: false
  
  # 是否自动下载 spark agent（仅 standalone）
  auto_download: true
  
  # spark agent jar 文件路径（仅 standalone）
  # 如果为空且 auto_download=true，将自动下载
  agent_jar: null
  
  # spark SSH 监听端口
  ssh_port: 2222
  
  # SSH 密码（如果为空则使用随机生成的密码）
  ssh_password: null
  
  # 启动时自动开始性能分析
  auto_start_profiling: false
  
  # spark 版本（留空使用最新版本）
  version: null
  
  # spark 下载地址
  download_url: https://spark.lucko.me/download/stable
```

---

## ⚙️ 高级配置 (advanced)

```yaml
advanced:
  # 性能配置
  performance:
    enabled: false
    report_interval: 60       # 性能报告间隔（秒）
  
  # 安全配置
  security:
    hide_secrets_in_logs: true  # 隐藏日志中的密钥
    plugin_sandbox: false       # 插件沙箱（实验性）
  
  # 实验性功能
  experimental:
    enabled: false
    hot_reload: false           # 实验性热重载
    web_interface: false        # Web 管理界面
```

---

## 🌐 WebSocket 服务器配置

NetherGate 内置 WebSocket 服务器，用于 Web 管理面板和实时监控。

> 📝 **注意**：WebSocket 配置**独立于主配置文件**，存储在 `websocket-config.yaml` 中。

### **配置文件位置**

```
NetherGate/
├── nethergate-config.yaml   # 主配置文件
└── websocket-config.yaml    # WebSocket 配置文件（独立）
```

### **首次启动**

首次运行 NetherGate 时，会自动生成 `websocket-config.yaml` 文件，并自动生成安全的认证令牌。

### **完整配置**

```yaml
# ============================================
# NetherGate WebSocket 配置文件
# ============================================

# 是否启用 WebSocket 服务器
enabled: true

# 监听地址（localhost 或 0.0.0.0）
host: localhost

# 监听端口
port: 8766

# 最大连接数
max_connections: 100

# ============================================
# 认证配置
# ============================================
authentication:
  # 是否启用认证
  enabled: true
  
  # 认证令牌（首次启动时自动生成）
  token: "your-auto-generated-token-here"
  
  # 令牌过期时间（小时）
  token_expiry_hours: 24
  
  # 允许的 IP 地址列表（空则允许所有）
  allowed_ips: []
  
  # 是否要求 TLS（HTTPS/WSS）
  require_tls: false

# ============================================
# CORS 配置
# ============================================
cors:
  # 是否启用 CORS
  enabled: true
  
  # 允许的源（"*" 表示所有）
  allowed_origins:
    - "*"

# ============================================
# 心跳配置
# ============================================
heartbeat:
  # 是否启用心跳
  enabled: true
  
  # 心跳间隔（秒）
  interval_seconds: 30
  
  # 超时时间（秒）
  timeout_seconds: 60

# ============================================
# 缓冲区配置
# ============================================
buffer:
  # 接收缓冲区大小（字节）
  receive_buffer_size: 4096
  
  # 发送缓冲区大小（字节）
  send_buffer_size: 4096
```

### **配置项说明**

#### **基础配置**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用 WebSocket 服务器 |
| `host` | string | `"localhost"` | 监听地址（`localhost` 仅本地，`0.0.0.0` 所有网卡） |
| `port` | number | `8766` | 监听端口 |
| `max_connections` | number | `100` | 最大连接数 |

#### **认证配置 (authentication)**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用认证 |
| `token` | string | `""` | 认证令牌（首次启动时自动生成） |
| `token_expiry_hours` | number | `24` | 令牌过期时间（小时） |
| `allowed_ips` | string[] | `[]` | 允许的 IP 地址列表（空则允许所有） |
| `require_tls` | boolean | `false` | 是否要求 TLS 加密连接 |

#### **CORS 配置 (cors)**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用 CORS |
| `allowed_origins` | string[] | `["*"]` | 允许的源（`"*"` 表示所有） |

#### **心跳配置 (heartbeat)**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用心跳 |
| `interval_seconds` | number | `30` | 心跳间隔（秒） |
| `timeout_seconds` | number | `60` | 超时时间（秒） |

#### **缓冲区配置 (buffer)**

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `receive_buffer_size` | number | `4096` | 接收缓冲区大小（字节） |
| `send_buffer_size` | number | `4096` | 发送缓冲区大小（字节） |

---

### **使用场景**

#### **场景 1: Web 管理面板**

为 Web 管理面板提供实时数据推送。

```yaml
enabled: true
host: 0.0.0.0  # 允许外部访问
port: 8766
authentication:
  enabled: true
  allowed_ips:
    - 192.168.1.0/24  # 限制到局域网
```

#### **场景 2: 仅本地访问**

仅允许本地工具连接。

```yaml
enabled: true
host: localhost  # 仅本地访问
port: 8766
authentication:
  enabled: true
```

#### **场景 3: 禁用 WebSocket**

如果不需要 WebSocket 功能。

```yaml
enabled: false
```

---

### **安全建议**

#### **1. 使用强认证令牌**

- ✅ 首次启动时会自动生成 64 位随机令牌
- ✅ 不要使用简单的密码
- ⚠️ 定期更换令牌

#### **2. 限制访问 IP**

```yaml
authentication:
  allowed_ips:
    - 127.0.0.1        # 仅本地
    - 192.168.1.100    # 特定 IP
    - 192.168.1.0/24   # 子网
```

#### **3. 使用 TLS（生产环境推荐）**

```yaml
authentication:
  require_tls: true
```

配合反向代理（如 Nginx）实现 WSS 加密连接。

#### **4. 限制最大连接数**

```yaml
max_connections: 10  # 根据实际需要调整
```

---

### **连接示例**

#### **JavaScript (浏览器)**

```javascript
const ws = new WebSocket('ws://localhost:8766');

ws.onopen = () => {
  console.log('已连接到 NetherGate');
  
  // 认证
  ws.send(JSON.stringify({
    type: 'auth',
    requestId: '1',
    data: {
      token: 'your-token-here'
    }
  }));
};

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('收到消息:', message);
};
```

#### **Python**

```python
import asyncio
import websockets
import json

async def connect():
    uri = "ws://localhost:8766"
    async with websockets.connect(uri) as websocket:
        # 认证
        await websocket.send(json.dumps({
            "type": "auth",
            "requestId": "1",
            "data": {
                "token": "your-token-here"
            }
        }))
        
        # 接收消息
        response = await websocket.recv()
        print(f"收到: {response}")

asyncio.run(connect())
```

---

### **常见问题**

#### **Q: WebSocket 端口被占用怎么办？**

**A**: 修改 `port` 配置：
```yaml
port: 9000  # 更改为其他端口
```

#### **Q: 如何查看自动生成的令牌？**

**A**: 查看 `websocket-config.yaml` 文件中的 `authentication.token` 字段。

#### **Q: 如何重新生成令牌？**

**A**: 
1. 删除 `websocket-config.yaml` 文件
2. 重启 NetherGate
3. 系统会自动生成新配置和令牌

#### **Q: 可以禁用认证吗？**

**A**: 可以，但**不推荐**（特别是在生产环境）：
```yaml
authentication:
  enabled: false
```

---

### **WebSocket API 参考**

完整的 WebSocket API 文档请参考：[WebSocket API 文档](../04-高级功能/WebSocket集成.md)

---

## 📄 完整配置示例

```yaml
# NetherGate 主配置文件
# 版本: 0.1.0

# ========== 服务器进程管理 ==========
server_process:
  enabled: true
  launch_method: java
  
  java:
    path: java
    version_check: true
  
  server:
    jar: server.jar
    working_directory: ./minecraft_server
  
  memory:
    min: 2048
    max: 4096
  
  arguments:
    jvm_prefix: []
    jvm_middle:
      - -XX:+UseG1GC
      - -XX:+ParallelRefProcEnabled
      - -XX:MaxGCPauseMillis=200
      - -Dfile.encoding=UTF-8
    server:
      - --nogui
  
  script:
    path: ./start.sh
    arguments: []
    working_directory: ./minecraft_server
    use_shell: false
  
  monitoring:
    startup_timeout: 300
    show_server_output: true
    server_output_prefix: "[MC] "
    startup_detection:
      enabled: true
      keywords:
        - "Done ("
    crash_detection:
      enabled: true
      keywords:
        - "Exception in server tick loop"
  
  auto_restart:
    enabled: true
    delay_seconds: 5
    max_retries: 3
    retry_delay: 5000
    reset_timer: 600000

# ========== SMP 连接配置 ==========
server_connection:
  host: localhost
  port: 40745
  secret: ""  # 请设置认证密钥
  use_tls: false
  tls_certificate: null
  tls_password: null
  reconnect_interval: 5000
  heartbeat_timeout: 30000
  auto_connect: true
  connect_delay: 3000
  wait_for_server_ready: true

# ========== RCON 客户端配置 ==========
rcon:
  enabled: true
  host: localhost
  port: 25566
  password: ""  # 请设置 RCON 密码
  connect_timeout: 5000
  command_timeout: 10000
  auto_connect: true
  connect_delay: 3000
  reconnect:
    enabled: true
    interval: 5000
    max_retries: 5

# ========== spark 性能监控配置 ==========
spark:
  enabled: false
  type: standalone
  force_enable_for_script_mode: false
  auto_download: true
  agent_jar: null
  ssh_port: 2222
  ssh_password: null
  auto_start_profiling: false
  version: null
  download_url: https://spark.lucko.me/download/stable

# ========== 日志监听器配置 ==========
log_listener:
  enabled: true
  parsing:
    parse_chat: true
    parse_commands: true
    parse_player_events: true
    parse_errors: true
  filters:
    ignore_patterns: []
    log_levels:
      - INFO
      - WARN
      - ERROR
  buffer:
    size: 1000
    drop_old: true

# ========== 插件管理配置 ==========
plugins:
  directory: plugins
  auto_load: true
  hot_reload: true
  enabled_plugins:
    - "*"
  disabled_plugins: []
  load_after_server_ready: true
  load_timeout: 30
  dependency_management:
    enabled: true
    auto_download: true
    nuget_sources:
      - https://api.nuget.org/v3/index.json
    download_timeout: 60
    verify_hash: true
    conflict_resolution: highest
    show_conflict_report: true

# ========== 日志系统配置 ==========
logging:
  level: Info
  console:
    enabled: true
    colored: true
    show_server_output: true
    server_output_prefix: "[MC] "
  file:
    enabled: true
    path: logs/latest.log
    max_size: 10485760
    max_files: 10
    rolling: true
    encoding: UTF-8
  advanced:
    log_plugin_loading: true
    log_smp_communication: false
    log_rcon_communication: false
    log_performance: false

# ========== 高级配置 ==========
advanced:
  performance:
    enabled: false
    report_interval: 60
  security:
    hide_secrets_in_logs: true
    plugin_sandbox: false
  experimental:
    enabled: false
    hot_reload: false
    web_interface: false
```

---

## 🔗 相关文档

- [安装和配置](./安装和配置.md)
- [第一个插件](./第一个插件.md)
- [内置命令](../08-参考/内置命令.md)
- [FAQ](../08-参考/FAQ.md)

---

## ❓ 常见问题

### **Q: 如何更改配置文件格式？**

**A**: 删除现有配置文件，NetherGate 会自动生成 YAML 格式。或手动创建所需格式的文件。

---

### **Q: 配置文件修改后需要重启吗？**

**A**: 是的，大部分配置项需要重启 NetherGate 才能生效。

---

### **Q: external 模式下如何配置？**

**A**: 
```yaml
server_process:
  enabled: true
  launch_method: external
  server:
    working_directory: ./minecraft_server  # 必须指定
    
rcon:
  enabled: true
  # RCON 配置...
  
server_connection:
  # SMP 配置...
```

---

## 📌 最佳实践

### **1. 安全配置**

- ✅ 使用强密钥
- ✅ 限制 RCON 和 SMP 仅本地访问
- ✅ 启用 `hide_secrets_in_logs`

### **2. 性能优化**

- ✅ 根据服务器规模调整内存
- ✅ 使用推荐的 JVM 参数
- ✅ 启用 G1GC（Java 8+）

### **3. 日志管理**

- ✅ 生产环境使用 `Info` 级别
- ✅ 开发环境使用 `Debug` 级别
- ✅ 定期清理旧日志文件

### **4. 插件管理**

- ✅ 开发时启用热重载
- ✅ 生产环境谨慎使用热重载
- ✅ 定期备份插件数据

---

**最后更新**: 2025-10-05  
**NetherGate 版本**: v0.1.0  
**配置类版本**: `NetherGateConfig.cs`
