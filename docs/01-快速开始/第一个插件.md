# 第一个插件

本教程将手把手教你创建一个完整的 NetherGate 插件，从零开始到发布。我们将创建一个**签到插件**，玩家可以每天签到获得奖励。

---

## 📋 **功能需求**

我们的签到插件将实现以下功能：

- ✅ 玩家每天可以签到一次
- ✅ 签到获得随机金币奖励
- ✅ 连续签到有额外奖励
- ✅ 显示签到排行榜
- ✅ 签到提醒和 BossBar 显示
- ✅ 数据持久化

---

## 🚀 **第一步：创建项目**

### **1. 创建项目目录**

```bash
mkdir CheckinPlugin
cd CheckinPlugin
```

### **2. 初始化项目**

```bash
dotnet new classlib -n CheckinPlugin
cd CheckinPlugin
```

### **3. 添加 NetherGate.API 引用**

```bash
# 如果从源码引用
dotnet add reference ../../NetherGate/src/NetherGate.API/NetherGate.API.csproj

# 或从 NuGet
dotnet add package NetherGate.API
```

### **4. 配置项目文件**

编辑 `CheckinPlugin.csproj`：

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <EnableDynamicLoading>true</EnableDynamicLoading>
    <Nullable>enable</Nullable>
    <Version>1.0.0</Version>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="NetherGate.API" Version="1.0.0" PrivateAssets="all" />
  </ItemGroup>

  <ItemGroup>
    <None Update="plugin.json">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
    <None Update="config.example.yaml">
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <!-- 自动复制到 NetherGate 插件目录 -->
  <Target Name="CopyToPlugins" AfterTargets="Build">
    <ItemGroup>
      <PluginFiles Include="$(OutputPath)**\*.*" />
    </ItemGroup>
    <Copy 
      SourceFiles="@(PluginFiles)" 
      DestinationFolder="$(SolutionDir)..\NetherGate\bin\$(Configuration)\plugins\$(ProjectName)\%(RecursiveDir)" 
      SkipUnchangedFiles="true" />
  </Target>
</Project>
```

---

## 📝 **第二步：创建数据模型**

### **1. 创建目录结构**

```
CheckinPlugin/
├── Models/           # 数据模型
├── Commands/         # 命令
├── Events/           # 事件处理
├── Services/         # 业务逻辑
├── CheckinPlugin.cs  # 主类
└── plugin.json       # 元数据
```

### **2. 定义配置类**

创建 `Models/CheckinConfig.cs`：

```csharp
namespace CheckinPlugin.Models;

public class CheckinConfig
{
    /// <summary>
    /// 最小金币奖励
    /// </summary>
    public int MinCoins { get; set; } = 10;

    /// <summary>
    /// 最大金币奖励
    /// </summary>
    public int MaxCoins { get; set; } = 50;

    /// <summary>
    /// 连续签到奖励倍数
    /// </summary>
    public double StreakMultiplier { get; set; } = 1.5;

    /// <summary>
    /// 连续签到触发天数
    /// </summary>
    public int StreakDays { get; set; } = 3;

    /// <summary>
    /// 是否启用签到提醒
    /// </summary>
    public bool EnableReminder { get; set; } = true;

    /// <summary>
    /// 签到后显示 BossBar 的时长（秒）
    /// </summary>
    public int BossBarDurationSeconds { get; set; } = 5;
}
```

### **3. 定义玩家数据类**

创建 `Models/PlayerCheckinData.cs`：

```csharp
namespace CheckinPlugin.Models;

public class PlayerCheckinData
{
    /// <summary>
    /// 玩家名称
    /// </summary>
    public string PlayerName { get; set; } = string.Empty;

    /// <summary>
    /// 最后签到时间
    /// </summary>
    public DateTime? LastCheckinTime { get; set; }

    /// <summary>
    /// 连续签到天数
    /// </summary>
    public int StreakDays { get; set; }

    /// <summary>
    /// 总签到次数
    /// </summary>
    public int TotalCheckins { get; set; }

    /// <summary>
    /// 累计获得金币
    /// </summary>
    public int TotalCoinsEarned { get; set; }
}
```

---

## 🔧 **第三步：实现业务逻辑**

### **创建签到服务**

创建 `Services/CheckinService.cs`：

```csharp
using NetherGate.API.Plugins;
using CheckinPlugin.Models;

namespace CheckinPlugin.Services;

public class CheckinService
{
    private readonly IPluginContext _context;
    private readonly CheckinConfig _config;
    private readonly Dictionary<string, PlayerCheckinData> _playerData = new();
    private readonly Random _random = new();
    private readonly string _dataFile;

    public CheckinService(IPluginContext context, CheckinConfig config)
    {
        _context = context;
        _config = config;
        _dataFile = Path.Combine(_context.DataDirectory, "checkin_data.json");
        LoadData();
    }

    /// <summary>
    /// 玩家签到
    /// </summary>
    public async Task<CheckinResult> CheckinAsync(string playerName)
    {
        var now = DateTime.UtcNow;
        var today = now.Date;

        // 获取或创建玩家数据
        if (!_playerData.TryGetValue(playerName, out var data))
        {
            data = new PlayerCheckinData { PlayerName = playerName };
            _playerData[playerName] = data;
        }

        // 检查是否已签到
        if (data.LastCheckinTime.HasValue && data.LastCheckinTime.Value.Date == today)
        {
            var nextCheckinTime = data.LastCheckinTime.Value.AddDays(1).Date;
            return new CheckinResult
            {
                Success = false,
                Message = $"§c你今天已经签到过了！\n§7下次签到时间: {nextCheckinTime:yyyy-MM-dd}",
                CoinsEarned = 0
            };
        }

        // 计算连续签到
        bool isStreak = false;
        if (data.LastCheckinTime.HasValue)
        {
            var daysSinceLastCheckin = (today - data.LastCheckinTime.Value.Date).Days;
            if (daysSinceLastCheckin == 1)
            {
                // 连续签到
                data.StreakDays++;
                isStreak = data.StreakDays >= _config.StreakDays;
            }
            else if (daysSinceLastCheckin > 1)
            {
                // 连续签到中断
                data.StreakDays = 1;
            }
        }
        else
        {
            data.StreakDays = 1;
        }

        // 计算奖励
        int baseCoins = _random.Next(_config.MinCoins, _config.MaxCoins + 1);
        int coins = baseCoins;

        if (isStreak)
        {
            coins = (int)(baseCoins * _config.StreakMultiplier);
        }

        // 更新数据
        data.LastCheckinTime = now;
        data.TotalCheckins++;
        data.TotalCoinsEarned += coins;

        // 保存数据
        SaveData();

        // 返回结果
        return new CheckinResult
        {
            Success = true,
            Message = $"§a签到成功！\n" +
                      $"§e获得金币: §6{coins}\n" +
                      $"§e连续签到: §6{data.StreakDays} §e天\n" +
                      (isStreak ? $"§6★ 连续签到奖励 {_config.StreakMultiplier}x ★" : ""),
            CoinsEarned = coins,
            StreakDays = data.StreakDays,
            IsStreak = isStreak
        };
    }

    /// <summary>
    /// 获取玩家签到数据
    /// </summary>
    public PlayerCheckinData? GetPlayerData(string playerName)
    {
        _playerData.TryGetValue(playerName, out var data);
        return data;
    }

    /// <summary>
    /// 获取排行榜
    /// </summary>
    public List<PlayerCheckinData> GetLeaderboard(int count = 10)
    {
        return _playerData.Values
            .OrderByDescending(d => d.TotalCheckins)
            .ThenByDescending(d => d.StreakDays)
            .Take(count)
            .ToList();
    }

    /// <summary>
    /// 加载数据
    /// </summary>
    private void LoadData()
    {
        try
        {
            if (File.Exists(_dataFile))
            {
                var json = File.ReadAllText(_dataFile);
                var data = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, PlayerCheckinData>>(json);
                if (data != null)
                {
                    foreach (var kvp in data)
                    {
                        _playerData[kvp.Key] = kvp.Value;
                    }
                    _context.Logger.Info($"已加载 {_playerData.Count} 个玩家的签到数据");
                }
            }
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"加载签到数据失败: {ex.Message}");
        }
    }

    /// <summary>
    /// 保存数据
    /// </summary>
    private void SaveData()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(_playerData, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });
            File.WriteAllText(_dataFile, json);
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"保存签到数据失败: {ex.Message}");
        }
    }
}

public class CheckinResult
{
    public bool Success { get; set; }
    public string Message { get; set; } = string.Empty;
    public int CoinsEarned { get; set; }
    public int StreakDays { get; set; }
    public bool IsStreak { get; set; }
}
```

---

## 🎮 **第四步：创建命令**

### **创建签到命令**

创建 `Commands/CheckinCommand.cs`：

```csharp
using NetherGate.API.Commands;
using NetherGate.API.Plugins;
using CheckinPlugin.Services;

namespace CheckinPlugin.Commands;

public class CheckinCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly CheckinService _service;

    public string Name => "checkin";
    public string Description => "每日签到获得奖励";
    public string[] Aliases => new[] { "签到", "qd" };
    public string? Usage => "#checkin";

    public CheckinCommand(IPluginContext context, CheckinService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
        {
            return CommandResult.Fail("此命令只能在游戏内使用");
        }

        try
        {
            var result = await _service.CheckinAsync(sender.Name);

            if (result.Success)
            {
                // 发送成功消息
                await _context.GameDisplayApi.SendChatMessage(sender.Name, result.Message);

                // 显示 BossBar
                await _context.GameDisplayApi.ShowBossBar(
                    sender.Name,
                    "checkin_reward",
                    $"§a签到成功！获得 {result.CoinsEarned} 金币",
                    BossBarColor.Green,
                    BossBarStyle.Progress,
                    progress: 1.0f
                );

                // 5秒后移除 BossBar
                _ = Task.Run(async () =>
                {
                    await Task.Delay(5000);
                    await _context.GameDisplayApi.RemoveBossBar(sender.Name, "checkin_reward");
                });

                // 连续签到显示标题
                if (result.IsStreak)
                {
                    await _context.GameDisplayApi.ShowTitle(
                        sender.Name,
                        "§6§l连续签到奖励！",
                        $"§e已连续签到 {result.StreakDays} 天",
                        fadeIn: 10, stay: 60, fadeOut: 20
                    );
                }

                return CommandResult.Success();
            }
            else
            {
                await _context.GameDisplayApi.SendChatMessage(sender.Name, result.Message);
                return CommandResult.Fail();
            }
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"签到失败: {ex.Message}");
            return CommandResult.Fail("§c签到失败，请联系管理员");
        }
    }
}
```

### **创建签到信息命令**

创建 `Commands/CheckinInfoCommand.cs`：

```csharp
using NetherGate.API.Commands;
using NetherGate.API.Plugins;
using CheckinPlugin.Services;

namespace CheckinPlugin.Commands;

public class CheckinInfoCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly CheckinService _service;

    public string Name => "checkininfo";
    public string Description => "查看签到信息";
    public string[] Aliases => new[] { "qdinfo" };
    public string? Usage => "#checkininfo [player]";

    public CheckinInfoCommand(IPluginContext context, CheckinService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        string targetPlayer = sender?.Name ?? "Console";
        
        if (args.Length > 0)
        {
            targetPlayer = args[0];
        }
        else if (sender == null)
        {
            return CommandResult.Fail("用法: checkininfo <player>");
        }

        var data = _service.GetPlayerData(targetPlayer);

        if (data == null)
        {
            var message = $"§c玩家 {targetPlayer} 还没有签到记录";
            if (sender != null)
            {
                await _context.GameDisplayApi.SendChatMessage(sender.Name, message);
            }
            return CommandResult.Fail(message);
        }

        string info = $"§6=== {targetPlayer} 的签到信息 ===\n" +
                      $"§e总签到次数: §f{data.TotalCheckins}\n" +
                      $"§e连续签到: §f{data.StreakDays} §e天\n" +
                      $"§e累计金币: §f{data.TotalCoinsEarned}\n" +
                      $"§e最后签到: §f{data.LastCheckinTime?.ToString("yyyy-MM-dd HH:mm:ss") ?? "从未"}";

        if (sender != null)
        {
            await _context.GameDisplayApi.SendChatMessage(sender.Name, info);
        }

        return CommandResult.Success(info);
    }
}
```

### **创建排行榜命令**

创建 `Commands/CheckinTopCommand.cs`：

```csharp
using NetherGate.API.Commands;
using NetherGate.API.Plugins;
using CheckinPlugin.Services;

namespace CheckinPlugin.Commands;

public class CheckinTopCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly CheckinService _service;

    public string Name => "checkintop";
    public string Description => "查看签到排行榜";
    public string[] Aliases => new[] { "qdtop" };

    public CheckinTopCommand(IPluginContext context, CheckinService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        var leaderboard = _service.GetLeaderboard(10);

        if (leaderboard.Count == 0)
        {
            return CommandResult.Fail("还没有任何玩家签到");
        }

        var message = "§6§l=== 签到排行榜 ===\n";
        for (int i = 0; i < leaderboard.Count; i++)
        {
            var data = leaderboard[i];
            string medal = i switch
            {
                0 => "§6🥇",
                1 => "§7🥈",
                2 => "§c🥉",
                _ => $"§7#{i + 1}"
            };
            message += $"{medal} §f{data.PlayerName} §7- " +
                      $"§e{data.TotalCheckins}次 §7(连续{data.StreakDays}天)\n";
        }

        if (sender != null)
        {
            await _context.GameDisplayApi.SendChatMessage(sender.Name, message);
        }

        return CommandResult.Success(message);
    }
}
```

---

## 🎭 **第五步：处理事件**

### **创建事件处理器**

创建 `Events/PlayerEventHandler.cs`：

```csharp
using NetherGate.API.Events;
using NetherGate.API.Plugins;
using CheckinPlugin.Services;
using CheckinPlugin.Models;

namespace CheckinPlugin.Events;

public class PlayerEventHandler
{
    private readonly IPluginContext _context;
    private readonly CheckinService _service;
    private readonly CheckinConfig _config;

    public PlayerEventHandler(IPluginContext context, CheckinService service, CheckinConfig config)
    {
        _context = context;
        _service = service;
        _config = config;
    }

    public void Register()
    {
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        if (!_config.EnableReminder)
            return;

        // 延迟3秒后提醒
        await Task.Delay(3000);

        var data = _service.GetPlayerData(e.Player.Name);
        var today = DateTime.UtcNow.Date;

        // 如果今天还没签到，发送提醒
        if (data == null || !data.LastCheckinTime.HasValue || data.LastCheckinTime.Value.Date < today)
        {
            await _context.GameDisplayApi.SendChatMessage(
                e.Player.Name,
                "§e[签到] §f别忘了今天签到哦！输入 §a#checkin §f签到获得奖励"
            );

            await _context.GameDisplayApi.ShowActionBar(
                e.Player.Name,
                "§6点击聊天框输入 #checkin 签到"
            );
        }
        else
        {
            // 已签到，显示信息
            await _context.GameDisplayApi.ShowActionBar(
                e.Player.Name,
                $"§a今日已签到 §7| §e连续 {data.StreakDays} 天"
            );
        }
    }
}
```

---

## 🏗️ **第六步：组装插件**

### **创建主类**

创建 `CheckinPlugin.cs`：

```csharp
using NetherGate.API.Plugins;
using CheckinPlugin.Models;
using CheckinPlugin.Services;
using CheckinPlugin.Commands;
using CheckinPlugin.Events;

namespace CheckinPlugin;

public class CheckinPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private CheckinConfig _config = null!;
    private CheckinService _service = null!;
    private PlayerEventHandler _eventHandler = null!;

    public void OnLoad()
    {
        Console.WriteLine("[CheckinPlugin] Loading...");
    }

    public async void OnEnable(IPluginContext context)
    {
        _context = context;
        _context.Logger.Info("CheckinPlugin is enabling...");

        try
        {
            // 1. 加载配置
            _config = await _context.ConfigManager.LoadConfigAsync<CheckinConfig>("config");
            _context.Logger.Info("配置已加载");

            // 2. 初始化服务
            _service = new CheckinService(_context, _config);
            _context.Logger.Info("签到服务已初始化");

            // 3. 注册命令
            _context.CommandManager.RegisterCommand(new CheckinCommand(_context, _service));
            _context.CommandManager.RegisterCommand(new CheckinInfoCommand(_context, _service));
            _context.CommandManager.RegisterCommand(new CheckinTopCommand(_context, _service));
            _context.Logger.Info("命令已注册");

            // 4. 注册事件
            _eventHandler = new PlayerEventHandler(_context, _service, _config);
            _eventHandler.Register();
            _context.Logger.Info("事件已注册");

            _context.Logger.Info("§aCheckinPlugin 启用成功！");
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"启用插件失败: {ex.Message}");
            throw;
        }
    }

    public void OnDisable()
    {
        _context.Logger.Info("CheckinPlugin is disabling...");
        
        // 框架会自动清理命令和事件订阅
        
        _context.Logger.Info("CheckinPlugin 已禁用");
    }
}
```

---

## 📋 **第七步：创建元数据**

### **创建 plugin.json**

```json
{
  "name": "CheckinPlugin",
  "version": "1.0.0",
  "author": "Your Name",
  "description": "每日签到插件，玩家可以签到获得奖励",
  "entry_point": "CheckinPlugin.CheckinPlugin",
  "website": "https://github.com/yourname/CheckinPlugin",
  "category": "gameplay",
  "tags": ["checkin", "reward", "economy"],
  
  "nethergate_api_version": "^1.0.0",
  "minecraft_version": "1.21.x",
  
  "permissions": {
    "checkin.use": {
      "description": "允许使用签到功能",
      "default": true
    },
    "checkin.admin": {
      "description": "管理员权限",
      "default": false
    }
  }
}
```

### **创建示例配置**

创建 `config.example.yaml`：

```yaml
# CheckinPlugin 配置文件

# 最小金币奖励
min_coins: 10

# 最大金币奖励
max_coins: 50

# 连续签到奖励倍数
streak_multiplier: 1.5

# 连续签到触发天数
streak_days: 3

# 是否启用签到提醒
enable_reminder: true

# 签到后显示 BossBar 的时长（秒）
boss_bar_duration_seconds: 5
```

---

## 🔨 **第八步：构建和测试**

### **1. 构建插件**

```bash
dotnet build
```

### **2. 查看输出**

```
bin/Debug/net9.0/
├── CheckinPlugin.dll
├── CheckinPlugin.pdb
├── plugin.json
└── config.example.yaml
```

### **3. 运行 NetherGate**

```bash
cd ../NetherGate/bin/Debug
dotnet NetherGate.Host.dll
```

### **4. 测试命令**

在 Minecraft 游戏内：

```
#checkin         # 签到
#checkininfo     # 查看自己的签到信息
#checkininfo Steve  # 查看其他玩家的信息
#checkintop       # 查看排行榜
```

---

## 📦 **第九步：发布插件**

### **1. 准备发布**

```bash
# 构建 Release 版本
dotnet build --configuration Release

# 输出位置
bin/Release/net9.0/
```

### **2. 打包插件**

创建发布包：

```
CheckinPlugin-v1.0.0.zip
├── CheckinPlugin/
│   ├── CheckinPlugin.dll
│   ├── plugin.json
│   └── config.example.yaml
└── README.md
```

### **3. 创建 README.md**

```markdown
# CheckinPlugin

每日签到插件，玩家可以签到获得金币奖励。

## 功能

- ✅ 每日签到获得随机金币
- ✅ 连续签到额外奖励
- ✅ 签到排行榜
- ✅ 签到提醒

## 安装

1. 下载 `CheckinPlugin-v1.0.0.zip`
2. 解压到 `plugins/` 目录
3. 重启服务器或使用 `plugin load CheckinPlugin`

## 命令

- `#checkin` - 签到
- `#checkininfo [player]` - 查看签到信息
- `#checkintop` - 查看排行榜

## 配置

配置文件：`config/CheckinPlugin/config.yaml`

详见 `config.example.yaml`

## 许可

MIT License
```

---

## 🎉 **完成！**

恭喜！你已经创建了一个完整的 NetherGate 插件！

### **学到的内容：**

✅ 创建插件项目和配置  
✅ 定义数据模型和配置  
✅ 实现业务逻辑（签到服务）  
✅ 创建命令（签到、查询、排行榜）  
✅ 处理事件（玩家加入提醒）  
✅ 使用游戏显示 API（BossBar、标题、聊天）  
✅ 数据持久化（JSON 存储）  
✅ 构建和发布插件  

### **下一步：**

- 📚 学习更多高级功能：[插件热重载](../../04-高级功能/插件热重载.md)
- 🔧 优化插件性能：[性能优化](../../07-示例和最佳实践/性能优化.md)
- 🎨 查看更多示例：[示例插件集](../../07-示例和最佳实践/示例插件集.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05