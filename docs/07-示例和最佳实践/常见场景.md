# å¸¸è§åœºæ™¯å®ç°

æœ¬æ–‡æ¡£æä¾› NetherGate æ’ä»¶å¼€å‘ä¸­å¸¸è§åœºæ™¯çš„å®ç°æ–¹æ¡ˆå’Œä»£ç ç¤ºä¾‹ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [ç©å®¶ç®¡ç†åœºæ™¯](#ç©å®¶ç®¡ç†åœºæ™¯)
- [ç©å®¶æ¡£æ¡ˆè·å–](#ç©å®¶æ¡£æ¡ˆè·å–)
- [ç»æµç³»ç»Ÿåœºæ™¯](#ç»æµç³»ç»Ÿåœºæ™¯)
- [ä¼ é€ç³»ç»Ÿåœºæ™¯](#ä¼ é€ç³»ç»Ÿåœºæ™¯)
- [æƒé™å’Œç»„ç®¡ç†](#æƒé™å’Œç»„ç®¡ç†)
- [æ•°æ®æŒä¹…åŒ–](#æ•°æ®æŒä¹…åŒ–)
- [å®šæ—¶ä»»åŠ¡](#å®šæ—¶ä»»åŠ¡)

---

## ğŸ‘¥ **ç©å®¶ç®¡ç†åœºæ™¯**

### **åœºæ™¯1ï¼šç©å®¶é¦–æ¬¡åŠ å…¥æ¬¢è¿**

```csharp
public class WelcomePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private HashSet<string> _knownPlayers = new();

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadKnownPlayers();
        
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var playerName = e.Player.Name;
        bool isNewPlayer = !_knownPlayers.Contains(playerName);

        if (isNewPlayer)
        {
            // é¦–æ¬¡åŠ å…¥
            await ShowFirstJoinWelcome(playerName);
            _knownPlayers.Add(playerName);
            SaveKnownPlayers();
        }
        else
        {
            // å†æ¬¡åŠ å…¥
            await ShowRegularWelcome(playerName);
        }
    }

    private async Task ShowFirstJoinWelcome(string playerName)
    {
        // æ ‡é¢˜
        await _context.GameDisplayApi.ShowTitle(
            playerName,
            "Â§6Â§læ¬¢è¿åŠ å…¥ï¼",
            "Â§eè¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡æ¥åˆ°æœåŠ¡å™¨",
            fadeIn: 20, stay: 100, fadeOut: 20
        );

        // èŠå¤©æ¶ˆæ¯
        await _context.GameDisplayApi.SendChatMessage(playerName, 
            "\nÂ§6Â§lâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
            "Â§f  æ¬¢è¿æ¥åˆ° Â§6æˆ‘çš„æœåŠ¡å™¨Â§fï¼\n" +
            "\n" +
            "Â§e  æ–°æ‰‹æŒ‡å—ï¼š\n" +
            "Â§7  â€¢ è¾“å…¥ Â§f#help Â§7æŸ¥çœ‹å‘½ä»¤å¸®åŠ©\n" +
            "Â§7  â€¢ è¾“å…¥ Â§f#spawn Â§7è¿”å›å‡ºç”Ÿç‚¹\n" +
            "Â§7  â€¢ éµå®ˆæœåŠ¡å™¨è§„åˆ™ï¼Œå‹å–„å¾…äºº\n" +
            "\n" +
            "Â§a  ç¥ä½ ç©å¾—æ„‰å¿«ï¼\n" +
            "Â§6Â§lâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
        );

        // ç»™äºˆæ–°æ‰‹ç¤¼åŒ…
        await GiveStarterKit(playerName);

        // å¹¿æ’­
        await _context.GameDisplayApi.BroadcastMessage(
            $"Â§eæ¬¢è¿æ–°ç©å®¶ Â§a{playerName} Â§eåŠ å…¥æœåŠ¡å™¨ï¼"
        );

        // æ’­æ”¾éŸ³æ•ˆ
        await _context.GameDisplayApi.PlaySound(
            playerName, "entity.player.levelup", 1.0f, 1.5f
        );
    }

    private async Task GiveStarterKit(string playerName)
    {
        await _context.GameDisplayApi.GiveItem(playerName, "bread", 16);
        await _context.GameDisplayApi.GiveItem(playerName, "wooden_pickaxe", 1);
        await _context.GameDisplayApi.GiveItem(playerName, "wooden_axe", 1);
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, "Â§aä½ è·å¾—äº†æ–°æ‰‹ç¤¼åŒ…ï¼"
        );
    }

    private void LoadKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        if (File.Exists(file))
        {
            _knownPlayers = File.ReadAllLines(file).ToHashSet();
        }
    }

    private void SaveKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        File.WriteAllLines(file, _knownPlayers);
    }
}
```

---

### **åœºæ™¯2ï¼šAFKï¼ˆæŒ‚æœºï¼‰æ£€æµ‹**

```csharp
public class AfkDetector : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, PlayerActivity> _activities = new();
    private Timer? _checkTimer;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // ç›‘å¬æ´»åŠ¨
        _context.EventBus.Subscribe<PlayerChatEvent>(OnPlayerActivity);
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoin);
        _context.EventBus.Subscribe<PlayerLeftEvent>(OnPlayerLeave);
        
        // å®šæ—¶æ£€æŸ¥
        _checkTimer = new Timer(_ => CheckAfkPlayers(), 
            null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void OnPlayerActivity(PlayerChatEvent e)
    {
        UpdateActivity(e.PlayerName);
    }

    private void OnPlayerJoin(PlayerJoinedEvent e)
    {
        _activities[e.Player.Name] = new PlayerActivity
        {
            LastActivityTime = DateTime.UtcNow,
            IsAfk = false
        };
    }

    private void OnPlayerLeave(PlayerLeftEvent e)
    {
        _activities.Remove(e.Player.Name);
    }

    private void UpdateActivity(string playerName)
    {
        if (_activities.TryGetValue(playerName, out var activity))
        {
            activity.LastActivityTime = DateTime.UtcNow;
            
            if (activity.IsAfk)
            {
                activity.IsAfk = false;
                _context.GameDisplayApi.BroadcastMessage(
                    $"Â§7{playerName} ä¸å†æŒ‚æœº"
                );
            }
        }
    }

    private async void CheckAfkPlayers()
    {
        var afkThreshold = TimeSpan.FromMinutes(5);
        var now = DateTime.UtcNow;

        foreach (var (playerName, activity) in _activities)
        {
            var idleTime = now - activity.LastActivityTime;

            if (idleTime > afkThreshold && !activity.IsAfk)
            {
                activity.IsAfk = true;
                
                await _context.GameDisplayApi.BroadcastMessage(
                    $"Â§7{playerName} ç°åœ¨å¤„äºæŒ‚æœºçŠ¶æ€"
                );
                
                _context.Logger.Info($"{playerName} å·²æŒ‚æœº {idleTime.TotalMinutes:F1} åˆ†é’Ÿ");
            }
        }
    }

    public void OnDisable()
    {
        _checkTimer?.Dispose();
    }
}

public class PlayerActivity
{
    public DateTime LastActivityTime { get; set; }
    public bool IsAfk { get; set; }
}
```

---

## ğŸ­ **ç©å®¶æ¡£æ¡ˆè·å–**

### **åœºæ™¯8ï¼šè·å–ç©å®¶çš®è‚¤å’Œå¤´é¢…**

ä½¿ç”¨ç©å®¶æ¡£æ¡ˆ API è·å–ç©å®¶çš„çš®è‚¤ã€UUID ç­‰ä¿¡æ¯ï¼ˆéœ€è¦ Minecraft 1.21.9+ å’Œ RCONï¼‰ï¼š

```csharp
public class PlayerProfilePlugin : IPlugin
{
    private IPluginContext _context = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // æ³¨å†Œæ¡£æ¡ˆæŸ¥è¯¢å‘½ä»¤
        _context.CommandManager.RegisterCommand(new ProfileCommand(_context));
        
        // æ³¨å†Œå¤´é¢…è·å–å‘½ä»¤
        _context.CommandManager.RegisterCommand(new GetHeadCommand(_context));
    }
}

// æ¡£æ¡ˆæŸ¥è¯¢å‘½ä»¤
public class ProfileCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "profile";
    public string[] Aliases => new[] { "pf" };
    public string Description => "æŸ¥è¯¢ç©å®¶æ¡£æ¡ˆ";
    public string? Usage => "#profile <ç©å®¶åç§°>";

    public ProfileCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length < 1)
            return CommandResult.Fail($"ç”¨æ³•: {Usage}");

        var playerName = args[0];
        
        try
        {
            // è·å–ç©å®¶æ¡£æ¡ˆ
            var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
            
            if (profile == null)
            {
                return CommandResult.Fail($"Â§cæ‰¾ä¸åˆ°ç©å®¶: {playerName}");
            }

            // æ„å»ºæ¶ˆæ¯
            var message = $"""
                Â§6â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                Â§f  ç©å®¶æ¡£æ¡ˆ: Â§e{profile.Name}
                
                Â§7  UUID: Â§f{profile.Uuid}
                
                """;

            // è·å–çš®è‚¤ URL
            var skinUrl = profile.GetSkinUrl();
            if (skinUrl != null)
            {
                message += $"Â§7  çš®è‚¤: Â§b{skinUrl}\n\n";
            }

            // è·å–æŠ«é£ URL
            var capeUrl = profile.GetCapeUrl();
            if (capeUrl != null)
            {
                message += $"Â§7  æŠ«é£: Â§b{capeUrl}\n\n";
            }
            else
            {
                message += "Â§7  æŠ«é£: Â§cæ— \n\n";
            }

            message += "Â§6â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•";

            if (sender != null)
            {
                await _context.GameDisplay.SendChatMessage(sender.Name, message);
            }
            else
            {
                _context.Logger.Info(message);
            }

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"è·å–ç©å®¶æ¡£æ¡ˆå¤±è´¥: {ex.Message}", ex);
            return CommandResult.Fail("Â§cè·å–æ¡£æ¡ˆä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯");
        }
    }
}

// è·å–ç©å®¶å¤´é¢…å‘½ä»¤
public class GetHeadCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "gethead";
    public string[] Aliases => new[] { "head" };
    public string Description => "è·å–ç©å®¶å¤´é¢…";
    public string? Usage => "#gethead <ç©å®¶åç§°>";

    public GetHeadCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null || sender.IsConsole)
            return CommandResult.Fail("Â§cæ­¤å‘½ä»¤åªèƒ½åœ¨æ¸¸æˆå†…ä½¿ç”¨");

        if (args.Length < 1)
            return CommandResult.Fail($"ç”¨æ³•: {Usage}");

        var targetPlayer = args[0];
        
        try
        {
            // è·å–ç©å®¶å¤´é¢… NBT
            var nbt = await _context.PlayerProfileApi.GetPlayerHeadNbtAsync(targetPlayer);
            
            if (nbt == null)
            {
                return CommandResult.Fail($"Â§cæ‰¾ä¸åˆ°ç©å®¶: {targetPlayer}");
            }

            // ç»™äºˆç©å®¶å¤´é¢…
            await _context.RconClient!.ExecuteCommandAsync(
                $"give {sender.Name} minecraft:player_head{nbt}"
            );

            await _context.GameDisplay.SendChatMessage(
                sender.Name, 
                $"Â§aå·²è·å¾— {targetPlayer} çš„å¤´é¢…ï¼"
            );

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"è·å–å¤´é¢…å¤±è´¥: {ex.Message}", ex);
            return CommandResult.Fail("Â§cè·å–å¤´é¢…å¤±è´¥");
        }
    }
}
```

### **åœºæ™¯9ï¼šç©å®¶çš®è‚¤å±•ç¤ºå¢™**

åˆ›å»ºä¸€ä¸ªå±•ç¤ºå¢™ï¼Œæ˜¾ç¤ºæœåŠ¡å™¨çŸ¥åç©å®¶çš„å¤´é¢…ï¼š

```csharp
public class SkinWallPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private readonly string[] _featuredPlayers = 
    { 
        "Notch", "jeb_", "Dinnerbone", "Grumm" 
    };

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        _context.CommandManager.RegisterCommand(new BuildWallCommand(_context, this));
    }

    public async Task BuildSkinWallAsync(string targetPlayer)
    {
        _context.Logger.Info("å¼€å§‹æ„å»ºçš®è‚¤å±•ç¤ºå¢™...");
        
        // æ‰¹é‡è·å–ç©å®¶æ¡£æ¡ˆ
        var profiles = await _context.PlayerProfileApi.FetchProfilesAsync(_featuredPlayers);
        
        _context.Logger.Info($"æˆåŠŸè·å– {profiles.Count} ä¸ªç©å®¶æ¡£æ¡ˆ");
        
        // åœ¨æŒ‡å®šä½ç½®æ”¾ç½®ç©å®¶å¤´é¢…
        var x = 100; // èµ·å§‹ X åæ ‡
        var y = 64;  // èµ·å§‹ Y åæ ‡
        var z = 100; // èµ·å§‹ Z åæ ‡
        
        foreach (var profile in profiles)
        {
            var nbt = await _context.PlayerProfileApi.GetPlayerHeadNbtAsync(profile.Name);
            
            if (nbt != null)
            {
                // è®¾ç½®æ–¹å—ä¸ºç©å®¶å¤´é¢…
                await _context.RconClient!.ExecuteCommandAsync(
                    $"setblock {x} {y} {z} minecraft:player_head{{rotation:0}}{nbt}"
                );
                
                // åœ¨å¤´é¢…ä¸‹æ–¹æ”¾ç½®å‘Šç¤ºç‰Œ
                await _context.RconClient!.ExecuteCommandAsync(
                    $"setblock {x} {y - 1} {z} minecraft:oak_sign{{" +
                    $"front_text:{{messages:['{{\"text\":\"{profile.Name}\"}}','{{\"text\":\"\"}}','{{\"text\":\"\"}}','{{\"text\":\"\"}}']}}}}}"
                );
                
                x += 2; // æ¯ä¸ªå¤´é¢…é—´éš” 2 æ ¼
            }
        }
        
        await _context.GameDisplay.SendChatMessage(
            targetPlayer, 
            $"Â§açš®è‚¤å±•ç¤ºå¢™æ„å»ºå®Œæˆï¼å…± {profiles.Count} ä¸ªå¤´é¢…"
        );
    }
}

public class BuildWallCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly SkinWallPlugin _plugin;

    public string Name => "buildwall";
    public string Description => "æ„å»ºçš®è‚¤å±•ç¤ºå¢™";

    public BuildWallCommand(IPluginContext context, SkinWallPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null || sender.IsConsole)
            return CommandResult.Fail("Â§cæ­¤å‘½ä»¤åªèƒ½åœ¨æ¸¸æˆå†…ä½¿ç”¨");

        await _plugin.BuildSkinWallAsync(sender.Name);
        return CommandResult.Success();
    }
}
```

### **åœºæ™¯10ï¼šUUID æŸ¥è¯¢å·¥å…·**

å¿«é€ŸæŸ¥è¯¢ç©å®¶ UUIDï¼š

```csharp
public class UuidLookup : IPlugin
{
    private IPluginContext _context = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _context.CommandManager.RegisterCommand(new UuidCommand(_context));
    }
}

public class UuidCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "uuid";
    public string Description => "æŸ¥è¯¢ç©å®¶ UUID";
    public string? Usage => "#uuid <ç©å®¶åç§°>";

    public UuidCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length < 1)
            return CommandResult.Fail($"ç”¨æ³•: {Usage}");

        var playerName = args[0];
        
        try
        {
            var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
            
            if (profile == null)
            {
                return CommandResult.Fail($"Â§cæ‰¾ä¸åˆ°ç©å®¶: {playerName}");
            }

            var message = $"Â§e{profile.Name} Â§7çš„ UUID: Â§f{profile.Uuid}";
            
            if (sender != null)
            {
                await _context.GameDisplay.SendChatMessage(sender.Name, message);
            }
            else
            {
                _context.Logger.Info(message);
            }

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"æŸ¥è¯¢ UUID å¤±è´¥: {ex.Message}", ex);
            return CommandResult.Fail("Â§cæŸ¥è¯¢å¤±è´¥");
        }
    }
}
```

---

## ğŸ’° **ç»æµç³»ç»Ÿåœºæ™¯**

### **åœºæ™¯3ï¼šå®Œæ•´çš„ç»æµç³»ç»Ÿ**

```csharp
public class EconomyPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private EconomyService _service = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _service = new EconomyService(_context);
        
        // æ³¨å†Œå‘½ä»¤
        _context.CommandManager.RegisterCommand(new BalanceCommand(_context, _service));
        _context.CommandManager.RegisterCommand(new PayCommand(_context, _service));
        _context.CommandManager.RegisterCommand(new EcoCommand(_context, _service));
        
        // æ³¨å†Œæ’ä»¶é—´é€šä¿¡
        RegisterMessenger();
        
        _context.Logger.Info("EconomyPlugin å·²å¯ç”¨");
    }

    private void RegisterMessenger()
    {
        // æŸ¥è¯¢ä½™é¢
        _context.Messenger.SubscribeRequest<BalanceRequest, int>(
            "economy.balance",
            async req => await _service.GetBalanceAsync(req.PlayerName)
        );
        
        // è½¬è´¦
        _context.Messenger.SubscribeRequest<TransferRequest, bool>(
            "economy.transfer",
            async req => await _service.TransferAsync(req.From, req.To, req.Amount)
        );
    }
}

public class EconomyService
{
    private readonly IPluginContext _context;
    private Dictionary<string, int> _balances = new();
    private readonly string _dataFile;

    public EconomyService(IPluginContext context)
    {
        _context = context;
        _dataFile = Path.Combine(_context.DataDirectory, "balances.json");
        LoadData();
    }

    public async Task<int> GetBalanceAsync(string playerName)
    {
        return _balances.TryGetValue(playerName, out var balance) ? balance : 0;
    }

    public async Task<bool> AddMoneyAsync(string playerName, int amount)
    {
        if (amount <= 0) return false;

        _balances.TryGetValue(playerName, out var currentBalance);
        _balances[playerName] = currentBalance + amount;
        
        SaveData();
        
        // å‘é€é€šçŸ¥
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"Â§a+ {amount} é‡‘å¸ï¼ˆä½™é¢: {_balances[playerName]}ï¼‰"
        );
        
        return true;
    }

    public async Task<bool> RemoveMoneyAsync(string playerName, int amount)
    {
        if (amount <= 0) return false;

        var currentBalance = await GetBalanceAsync(playerName);
        
        if (currentBalance < amount)
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                "Â§cä½™é¢ä¸è¶³ï¼"
            );
            return false;
        }

        _balances[playerName] = currentBalance - amount;
        SaveData();
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"Â§c- {amount} é‡‘å¸ï¼ˆä½™é¢: {_balances[playerName]}ï¼‰"
        );
        
        return true;
    }

    public async Task<bool> TransferAsync(string from, string to, int amount)
    {
        if (amount <= 0) return false;
        if (from == to) return false;

        if (!await RemoveMoneyAsync(from, amount))
        {
            return false;
        }

        await AddMoneyAsync(to, amount);
        
        await _context.GameDisplayApi.SendChatMessage(
            from, 
            $"Â§eä½ å‘ {to} è½¬è´¦äº† {amount} é‡‘å¸"
        );
        
        await _context.GameDisplayApi.SendChatMessage(
            to, 
            $"Â§e{from} å‘ä½ è½¬è´¦äº† {amount} é‡‘å¸"
        );
        
        _context.Logger.Info($"è½¬è´¦: {from} -> {to}, é‡‘é¢: {amount}");
        
        return true;
    }

    private void LoadData()
    {
        if (File.Exists(_dataFile))
        {
            var json = File.ReadAllText(_dataFile);
            _balances = JsonSerializer.Deserialize<Dictionary<string, int>>(json) ?? new();
        }
    }

    private void SaveData()
    {
        var json = JsonSerializer.Serialize(_balances, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(_dataFile, json);
    }
}

// ä½™é¢å‘½ä»¤
public class BalanceCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly EconomyService _service;

    public string Name => "balance";
    public string[] Aliases => new[] { "bal", "money" };
    public string Description => "æŸ¥çœ‹ä½™é¢";

    public BalanceCommand(IPluginContext context, EconomyService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("æ­¤å‘½ä»¤åªèƒ½åœ¨æ¸¸æˆå†…ä½¿ç”¨");

        var balance = await _service.GetBalanceAsync(sender.Name);
        
        await _context.GameDisplayApi.SendChatMessage(
            sender.Name, 
            $"Â§eä½ çš„ä½™é¢: Â§6{balance} Â§eé‡‘å¸"
        );
        
        return CommandResult.Success();
    }
}

// è½¬è´¦å‘½ä»¤
public class PayCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly EconomyService _service;

    public string Name => "pay";
    public string Description => "è½¬è´¦ç»™å…¶ä»–ç©å®¶";
    public string? Usage => "#pay <ç©å®¶> <é‡‘é¢>";

    public PayCommand(IPluginContext context, EconomyService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("æ­¤å‘½ä»¤åªèƒ½åœ¨æ¸¸æˆå†…ä½¿ç”¨");

        if (args.Length < 2)
            return CommandResult.Fail($"ç”¨æ³•: {Usage}");

        var target = args[0];
        if (!int.TryParse(args[1], out var amount) || amount <= 0)
            return CommandResult.Fail("Â§cé‡‘é¢å¿…é¡»æ˜¯æ­£æ•´æ•°");

        var success = await _service.TransferAsync(sender.Name, target, amount);
        
        return success ? CommandResult.Success() : CommandResult.Fail("Â§cè½¬è´¦å¤±è´¥");
    }
}
```

---

## ğŸš€ **ä¼ é€ç³»ç»Ÿåœºæ™¯**

### **åœºæ™¯4ï¼šå®¶å›­ç³»ç»Ÿ**

```csharp
public class HomePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, List<Home>> _homes = new();
    private readonly int _maxHomes = 3;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadHomes();
        
        _context.CommandManager.RegisterCommand(new SetHomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new HomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new DelHomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new HomesCommand(_context, this));
    }

    public async Task<bool> SetHomeAsync(string playerName, string homeName)
    {
        if (!_homes.ContainsKey(playerName))
        {
            _homes[playerName] = new List<Home>();
        }

        var playerHomes = _homes[playerName];

        // æ£€æŸ¥æ•°é‡é™åˆ¶
        if (playerHomes.Count >= _maxHomes && 
            !playerHomes.Any(h => h.Name == homeName))
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"Â§cä½ æœ€å¤šåªèƒ½è®¾ç½® {_maxHomes} ä¸ªå®¶å›­ï¼"
            );
            return false;
        }

        // è·å–ç©å®¶ä½ç½®ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(playerName);
        if (playerData == null)
            return false;

        // æ›´æ–°æˆ–æ·»åŠ å®¶å›­
        var existingHome = playerHomes.FirstOrDefault(h => h.Name == homeName);
        if (existingHome != null)
        {
            existingHome.Location = playerData.Position;
            existingHome.Dimension = playerData.Dimension;
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"Â§aå®¶å›­ '{homeName}' å·²æ›´æ–°"
            );
        }
        else
        {
            playerHomes.Add(new Home
            {
                Name = homeName,
                Location = playerData.Position,
                Dimension = playerData.Dimension,
                CreatedAt = DateTime.UtcNow
            });
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"Â§aå®¶å›­ '{homeName}' å·²è®¾ç½®"
            );
        }

        SaveHomes();
        return true;
    }

    public async Task<bool> TeleportHomeAsync(string playerName, string homeName)
    {
        if (!_homes.TryGetValue(playerName, out var playerHomes))
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                "Â§cä½ è¿˜æ²¡æœ‰è®¾ç½®ä»»ä½•å®¶å›­"
            );
            return false;
        }

        var home = playerHomes.FirstOrDefault(h => h.Name == homeName);
        if (home == null)
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"Â§cå®¶å›­ '{homeName}' ä¸å­˜åœ¨"
            );
            return false;
        }

        // ä¼ é€
        await _context.GameDisplayApi.TeleportPlayer(
            playerName, 
            home.Location.X, 
            home.Location.Y, 
            home.Location.Z
        );

        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"Â§aå·²ä¼ é€åˆ°å®¶å›­ '{homeName}'"
        );

        return true;
    }

    private void LoadHomes()
    {
        var file = Path.Combine(_context.DataDirectory, "homes.json");
        if (File.Exists(file))
        {
            var json = File.ReadAllText(file);
            _homes = JsonSerializer.Deserialize<Dictionary<string, List<Home>>>(json) ?? new();
        }
    }

    private void SaveHomes()
    {
        var file = Path.Combine(_context.DataDirectory, "homes.json");
        var json = JsonSerializer.Serialize(_homes, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(file, json);
    }
}

public class Home
{
    public string Name { get; set; } = string.Empty;
    public Position Location { get; set; } = new();
    public string Dimension { get; set; } = "minecraft:overworld";
    public DateTime CreatedAt { get; set; }
}
```

---

## ğŸ”’ **æƒé™å’Œç»„ç®¡ç†**

### **åœºæ™¯5ï¼šVIP è‡ªåŠ¨åˆ°æœŸ**

```csharp
public class VipManager : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, VipData> _vips = new();
    private Timer? _checkTimer;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadVips();
        
        // å®šæ—¶æ£€æŸ¥è¿‡æœŸ
        _checkTimer = new Timer(_ => CheckExpiredVips(), 
            null, TimeSpan.Zero, TimeSpan.FromHours(1));
    }

    public async Task GrantVipAsync(string playerName, int days)
    {
        var expiresAt = DateTime.UtcNow.AddDays(days);
        
        _vips[playerName] = new VipData
        {
            ExpiresAt = expiresAt,
            GrantedAt = DateTime.UtcNow
        };
        
        // æ·»åŠ åˆ° VIP ç»„
        await _context.PermissionManager.AddUserToGroupAsync(playerName, "vip");
        
        SaveVips();
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"Â§aä½ å·²æˆä¸º VIPï¼æœ‰æ•ˆæœŸè‡³ {expiresAt:yyyy-MM-dd}"
        );
    }

    private async void CheckExpiredVips()
    {
        var now = DateTime.UtcNow;
        var expired = _vips.Where(kvp => kvp.Value.ExpiresAt < now).ToList();

        foreach (var (playerName, vipData) in expired)
        {
            // ç§»é™¤ VIP ç»„
            await _context.PermissionManager.RemoveUserFromGroupAsync(playerName, "vip");
            
            _vips.Remove(playerName);
            
            _context.Logger.Info($"{playerName} çš„ VIP å·²è¿‡æœŸ");
            
            // å¦‚æœç©å®¶åœ¨çº¿ï¼Œå‘é€é€šçŸ¥
            var players = await _context.SmpApi.GetOnlinePlayersAsync();
            if (players.Any(p => p.Name == playerName))
            {
                await _context.GameDisplayApi.SendChatMessage(
                    playerName, 
                    "Â§cä½ çš„ VIP å·²è¿‡æœŸ"
                );
            }
        }

        if (expired.Any())
        {
            SaveVips();
        }
    }

    private void LoadVips()
    {
        var file = Path.Combine(_context.DataDirectory, "vips.json");
        if (File.Exists(file))
        {
            var json = File.ReadAllText(file);
            _vips = JsonSerializer.Deserialize<Dictionary<string, VipData>>(json) ?? new();
        }
    }

    private void SaveVips()
    {
        var file = Path.Combine(_context.DataDirectory, "vips.json");
        var json = JsonSerializer.Serialize(_vips, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(file, json);
    }

    public void OnDisable()
    {
        _checkTimer?.Dispose();
    }
}

public class VipData
{
    public DateTime ExpiresAt { get; set; }
    public DateTime GrantedAt { get; set; }
}
```

---

## ğŸ’¾ **æ•°æ®æŒä¹…åŒ–**

### **åœºæ™¯6ï¼šä½¿ç”¨ SQLite æ•°æ®åº“**

```csharp
public class DatabasePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private SqliteConnection _connection = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        InitializeDatabase();
    }

    private void InitializeDatabase()
    {
        var dbPath = Path.Combine(_context.DataDirectory, "data.db");
        _connection = new SqliteConnection($"Data Source={dbPath}");
        _connection.Open();

        // åˆ›å»ºè¡¨
        using var cmd = _connection.CreateCommand();
        cmd.CommandText = @"
            CREATE TABLE IF NOT EXISTS players (
                uuid TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                last_login DATETIME,
                play_time INTEGER DEFAULT 0,
                level INTEGER DEFAULT 0
            )
        ";
        cmd.ExecuteNonQuery();
    }

    public async Task SavePlayerDataAsync(string uuid, string name)
    {
        using var cmd = _connection.CreateCommand();
        cmd.CommandText = @"
            INSERT OR REPLACE INTO players (uuid, name, last_login)
            VALUES (@uuid, @name, @login)
        ";
        cmd.Parameters.AddWithValue("@uuid", uuid);
        cmd.Parameters.AddWithValue("@name", name);
        cmd.Parameters.AddWithValue("@login", DateTime.UtcNow);
        
        await cmd.ExecuteNonQueryAsync();
    }

    public void OnDisable()
    {
        _connection?.Close();
        _connection?.Dispose();
    }
}
```

---

## â° **å®šæ—¶ä»»åŠ¡**

### **åœºæ™¯7ï¼šå®šæ—¶å…¬å‘Šå’Œäº‹ä»¶**

```csharp
public class ScheduledTasksPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private List<Timer> _timers = new();

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // å®šæ—¶å…¬å‘Šï¼ˆæ¯30åˆ†é’Ÿï¼‰
        Schedule TimeSpan.FromMinutes(30), () =>
        {
            _context.GameDisplayApi.BroadcastMessage(
                "Â§6[æç¤º] Â§fè®°å¾—å®šæœŸç­¾åˆ°è·å¾—å¥–åŠ±ï¼è¾“å…¥ #checkin"
            );
        });
        
        // æ¯æ—¥é‡ç½®ï¼ˆæ¯å¤©å‡Œæ™¨ï¼‰
        ScheduleDaily(TimeSpan.FromHours(0), async () =>
        {
            await DailyReset();
        });
        
        // æ¯å°æ—¶è‡ªåŠ¨ä¿å­˜
        Schedule(TimeSpan.FromHours(1), async () =>
        {
            await AutoSave();
        });
    }

    private void Schedule(TimeSpan interval, Action action)
    {
        var timer = new Timer(_ => action(), null, TimeSpan.Zero, interval);
        _timers.Add(timer);
    }

    private void ScheduleDaily(TimeSpan timeOfDay, Action action)
    {
        var now = DateTime.Now;
        var today = now.Date + timeOfDay;
        var firstRun = today > now ? today : today.AddDays(1);
        var delay = firstRun - now;

        var timer = new Timer(_ => action(), null, delay, TimeSpan.FromDays(1));
        _timers.Add(timer);
    }

    private async Task DailyReset()
    {
        _context.Logger.Info("æ‰§è¡Œæ¯æ—¥é‡ç½®...");
        // é‡ç½®é€»è¾‘
    }

    private async Task AutoSave()
    {
        _context.Logger.Info("æ‰§è¡Œè‡ªåŠ¨ä¿å­˜...");
        await _context.RconClient.SendCommandAsync("save-all");
    }

    public void OnDisable()
    {
        foreach (var timer in _timers)
        {
            timer.Dispose();
        }
        _timers.Clear();
    }
}
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [ç¤ºä¾‹æ’ä»¶é›†](./ç¤ºä¾‹æ’ä»¶é›†.md)
- [æ’ä»¶å¼€å‘æŒ‡å—](../03-æ’ä»¶å¼€å‘/æ’ä»¶å¼€å‘æŒ‡å—.md)
- [API å‚è€ƒ](../08-å‚è€ƒ/APIå‚è€ƒ.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
