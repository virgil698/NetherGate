# 常见场景实现

本文档提供 NetherGate 插件开发中常见场景的实现方案和代码示例。

---

## 📋 **目录**

- [玩家管理场景](#玩家管理场景)
- [玩家档案获取](#玩家档案获取)
- [经济系统场景](#经济系统场景)
- [传送系统场景](#传送系统场景)
- [权限和组管理](#权限和组管理)
- [数据持久化](#数据持久化)
- [定时任务](#定时任务)

---

## 👥 **玩家管理场景**

### **场景1：玩家首次加入欢迎**

```csharp
public class WelcomePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private HashSet<string> _knownPlayers = new();

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadKnownPlayers();
        
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var playerName = e.Player.Name;
        bool isNewPlayer = !_knownPlayers.Contains(playerName);

        if (isNewPlayer)
        {
            // 首次加入
            await ShowFirstJoinWelcome(playerName);
            _knownPlayers.Add(playerName);
            SaveKnownPlayers();
        }
        else
        {
            // 再次加入
            await ShowRegularWelcome(playerName);
        }
    }

    private async Task ShowFirstJoinWelcome(string playerName)
    {
        // 标题
        await _context.GameDisplayApi.ShowTitle(
            playerName,
            "§6§l欢迎加入！",
            "§e这是你第一次来到服务器",
            fadeIn: 20, stay: 100, fadeOut: 20
        );

        // 聊天消息
        await _context.GameDisplayApi.SendChatMessage(playerName, 
            "\n§6§l═══════════════════════════════\n" +
            "§f  欢迎来到 §6我的服务器§f！\n" +
            "\n" +
            "§e  新手指南：\n" +
            "§7  • 输入 §f#help §7查看命令帮助\n" +
            "§7  • 输入 §f#spawn §7返回出生点\n" +
            "§7  • 遵守服务器规则，友善待人\n" +
            "\n" +
            "§a  祝你玩得愉快！\n" +
            "§6§l═══════════════════════════════\n"
        );

        // 给予新手礼包
        await GiveStarterKit(playerName);

        // 广播
        await _context.GameDisplayApi.BroadcastMessage(
            $"§e欢迎新玩家 §a{playerName} §e加入服务器！"
        );

        // 播放音效
        await _context.GameDisplayApi.PlaySound(
            playerName, "entity.player.levelup", 1.0f, 1.5f
        );
    }

    private async Task GiveStarterKit(string playerName)
    {
        await _context.GameDisplayApi.GiveItem(playerName, "bread", 16);
        await _context.GameDisplayApi.GiveItem(playerName, "wooden_pickaxe", 1);
        await _context.GameDisplayApi.GiveItem(playerName, "wooden_axe", 1);
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, "§a你获得了新手礼包！"
        );
    }

    private void LoadKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        if (File.Exists(file))
        {
            _knownPlayers = File.ReadAllLines(file).ToHashSet();
        }
    }

    private void SaveKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        File.WriteAllLines(file, _knownPlayers);
    }
}
```

---

### **场景2：AFK（挂机）检测**

```csharp
public class AfkDetector : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, PlayerActivity> _activities = new();
    private Timer? _checkTimer;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 监听活动
        _context.EventBus.Subscribe<PlayerChatEvent>(OnPlayerActivity);
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoin);
        _context.EventBus.Subscribe<PlayerLeftEvent>(OnPlayerLeave);
        
        // 定时检查
        _checkTimer = new Timer(_ => CheckAfkPlayers(), 
            null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void OnPlayerActivity(PlayerChatEvent e)
    {
        UpdateActivity(e.PlayerName);
    }

    private void OnPlayerJoin(PlayerJoinedEvent e)
    {
        _activities[e.Player.Name] = new PlayerActivity
        {
            LastActivityTime = DateTime.UtcNow,
            IsAfk = false
        };
    }

    private void OnPlayerLeave(PlayerLeftEvent e)
    {
        _activities.Remove(e.Player.Name);
    }

    private void UpdateActivity(string playerName)
    {
        if (_activities.TryGetValue(playerName, out var activity))
        {
            activity.LastActivityTime = DateTime.UtcNow;
            
            if (activity.IsAfk)
            {
                activity.IsAfk = false;
                _context.GameDisplayApi.BroadcastMessage(
                    $"§7{playerName} 不再挂机"
                );
            }
        }
    }

    private async void CheckAfkPlayers()
    {
        var afkThreshold = TimeSpan.FromMinutes(5);
        var now = DateTime.UtcNow;

        foreach (var (playerName, activity) in _activities)
        {
            var idleTime = now - activity.LastActivityTime;

            if (idleTime > afkThreshold && !activity.IsAfk)
            {
                activity.IsAfk = true;
                
                await _context.GameDisplayApi.BroadcastMessage(
                    $"§7{playerName} 现在处于挂机状态"
                );
                
                _context.Logger.Info($"{playerName} 已挂机 {idleTime.TotalMinutes:F1} 分钟");
            }
        }
    }

    public void OnDisable()
    {
        _checkTimer?.Dispose();
    }
}

public class PlayerActivity
{
    public DateTime LastActivityTime { get; set; }
    public bool IsAfk { get; set; }
}
```

---

## 🎭 **玩家档案获取**

### **场景8：获取玩家皮肤和头颅**

使用玩家档案 API 获取玩家的皮肤、UUID 等信息（需要 Minecraft 1.21.9+ 和 RCON）：

```csharp
public class PlayerProfilePlugin : IPlugin
{
    private IPluginContext _context = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 注册档案查询命令
        _context.CommandManager.RegisterCommand(new ProfileCommand(_context));
        
        // 注册头颅获取命令
        _context.CommandManager.RegisterCommand(new GetHeadCommand(_context));
    }
}

// 档案查询命令
public class ProfileCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "profile";
    public string[] Aliases => new[] { "pf" };
    public string Description => "查询玩家档案";
    public string? Usage => "#profile <玩家名称>";

    public ProfileCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length < 1)
            return CommandResult.Fail($"用法: {Usage}");

        var playerName = args[0];
        
        try
        {
            // 获取玩家档案
            var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
            
            if (profile == null)
            {
                return CommandResult.Fail($"§c找不到玩家: {playerName}");
            }

            // 构建消息
            var message = $"""
                §6═══════════════════════════════
                §f  玩家档案: §e{profile.Name}
                
                §7  UUID: §f{profile.Uuid}
                
                """;

            // 获取皮肤 URL
            var skinUrl = profile.GetSkinUrl();
            if (skinUrl != null)
            {
                message += $"§7  皮肤: §b{skinUrl}\n\n";
            }

            // 获取披风 URL
            var capeUrl = profile.GetCapeUrl();
            if (capeUrl != null)
            {
                message += $"§7  披风: §b{capeUrl}\n\n";
            }
            else
            {
                message += "§7  披风: §c无\n\n";
            }

            message += "§6═══════════════════════════════";

            if (sender != null)
            {
                await _context.GameDisplay.SendChatMessage(sender.Name, message);
            }
            else
            {
                _context.Logger.Info(message);
            }

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"获取玩家档案失败: {ex.Message}", ex);
            return CommandResult.Fail("§c获取档案信息时发生错误");
        }
    }
}

// 获取玩家头颅命令
public class GetHeadCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "gethead";
    public string[] Aliases => new[] { "head" };
    public string Description => "获取玩家头颅";
    public string? Usage => "#gethead <玩家名称>";

    public GetHeadCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null || sender.IsConsole)
            return CommandResult.Fail("§c此命令只能在游戏内使用");

        if (args.Length < 1)
            return CommandResult.Fail($"用法: {Usage}");

        var targetPlayer = args[0];
        
        try
        {
            // 获取玩家头颅 NBT
            var nbt = await _context.PlayerProfileApi.GetPlayerHeadNbtAsync(targetPlayer);
            
            if (nbt == null)
            {
                return CommandResult.Fail($"§c找不到玩家: {targetPlayer}");
            }

            // 给予玩家头颅
            await _context.RconClient!.ExecuteCommandAsync(
                $"give {sender.Name} minecraft:player_head{nbt}"
            );

            await _context.GameDisplay.SendChatMessage(
                sender.Name, 
                $"§a已获得 {targetPlayer} 的头颅！"
            );

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"获取头颅失败: {ex.Message}", ex);
            return CommandResult.Fail("§c获取头颅失败");
        }
    }
}
```

### **场景9：玩家皮肤展示墙**

创建一个展示墙，显示服务器知名玩家的头颅：

```csharp
public class SkinWallPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private readonly string[] _featuredPlayers = 
    { 
        "Notch", "jeb_", "Dinnerbone", "Grumm" 
    };

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        _context.CommandManager.RegisterCommand(new BuildWallCommand(_context, this));
    }

    public async Task BuildSkinWallAsync(string targetPlayer)
    {
        _context.Logger.Info("开始构建皮肤展示墙...");
        
        // 批量获取玩家档案
        var profiles = await _context.PlayerProfileApi.FetchProfilesAsync(_featuredPlayers);
        
        _context.Logger.Info($"成功获取 {profiles.Count} 个玩家档案");
        
        // 在指定位置放置玩家头颅
        var x = 100; // 起始 X 坐标
        var y = 64;  // 起始 Y 坐标
        var z = 100; // 起始 Z 坐标
        
        foreach (var profile in profiles)
        {
            var nbt = await _context.PlayerProfileApi.GetPlayerHeadNbtAsync(profile.Name);
            
            if (nbt != null)
            {
                // 设置方块为玩家头颅
                await _context.RconClient!.ExecuteCommandAsync(
                    $"setblock {x} {y} {z} minecraft:player_head{{rotation:0}}{nbt}"
                );
                
                // 在头颅下方放置告示牌
                await _context.RconClient!.ExecuteCommandAsync(
                    $"setblock {x} {y - 1} {z} minecraft:oak_sign{{" +
                    $"front_text:{{messages:['{{\"text\":\"{profile.Name}\"}}','{{\"text\":\"\"}}','{{\"text\":\"\"}}','{{\"text\":\"\"}}']}}}}}"
                );
                
                x += 2; // 每个头颅间隔 2 格
            }
        }
        
        await _context.GameDisplay.SendChatMessage(
            targetPlayer, 
            $"§a皮肤展示墙构建完成！共 {profiles.Count} 个头颅"
        );
    }
}

public class BuildWallCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly SkinWallPlugin _plugin;

    public string Name => "buildwall";
    public string Description => "构建皮肤展示墙";

    public BuildWallCommand(IPluginContext context, SkinWallPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null || sender.IsConsole)
            return CommandResult.Fail("§c此命令只能在游戏内使用");

        await _plugin.BuildSkinWallAsync(sender.Name);
        return CommandResult.Success();
    }
}
```

### **场景10：UUID 查询工具**

快速查询玩家 UUID：

```csharp
public class UuidLookup : IPlugin
{
    private IPluginContext _context = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _context.CommandManager.RegisterCommand(new UuidCommand(_context));
    }
}

public class UuidCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "uuid";
    public string Description => "查询玩家 UUID";
    public string? Usage => "#uuid <玩家名称>";

    public UuidCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length < 1)
            return CommandResult.Fail($"用法: {Usage}");

        var playerName = args[0];
        
        try
        {
            var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
            
            if (profile == null)
            {
                return CommandResult.Fail($"§c找不到玩家: {playerName}");
            }

            var message = $"§e{profile.Name} §7的 UUID: §f{profile.Uuid}";
            
            if (sender != null)
            {
                await _context.GameDisplay.SendChatMessage(sender.Name, message);
            }
            else
            {
                _context.Logger.Info(message);
            }

            return CommandResult.Success();
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"查询 UUID 失败: {ex.Message}", ex);
            return CommandResult.Fail("§c查询失败");
        }
    }
}
```

---

## 💰 **经济系统场景**

### **场景3：完整的经济系统**

```csharp
public class EconomyPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private EconomyService _service = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _service = new EconomyService(_context);
        
        // 注册命令
        _context.CommandManager.RegisterCommand(new BalanceCommand(_context, _service));
        _context.CommandManager.RegisterCommand(new PayCommand(_context, _service));
        _context.CommandManager.RegisterCommand(new EcoCommand(_context, _service));
        
        // 注册插件间通信
        RegisterMessenger();
        
        _context.Logger.Info("EconomyPlugin 已启用");
    }

    private void RegisterMessenger()
    {
        // 查询余额
        _context.Messenger.SubscribeRequest<BalanceRequest, int>(
            "economy.balance",
            async req => await _service.GetBalanceAsync(req.PlayerName)
        );
        
        // 转账
        _context.Messenger.SubscribeRequest<TransferRequest, bool>(
            "economy.transfer",
            async req => await _service.TransferAsync(req.From, req.To, req.Amount)
        );
    }
}

public class EconomyService
{
    private readonly IPluginContext _context;
    private Dictionary<string, int> _balances = new();
    private readonly string _dataFile;

    public EconomyService(IPluginContext context)
    {
        _context = context;
        _dataFile = Path.Combine(_context.DataDirectory, "balances.json");
        LoadData();
    }

    public async Task<int> GetBalanceAsync(string playerName)
    {
        return _balances.TryGetValue(playerName, out var balance) ? balance : 0;
    }

    public async Task<bool> AddMoneyAsync(string playerName, int amount)
    {
        if (amount <= 0) return false;

        _balances.TryGetValue(playerName, out var currentBalance);
        _balances[playerName] = currentBalance + amount;
        
        SaveData();
        
        // 发送通知
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"§a+ {amount} 金币（余额: {_balances[playerName]}）"
        );
        
        return true;
    }

    public async Task<bool> RemoveMoneyAsync(string playerName, int amount)
    {
        if (amount <= 0) return false;

        var currentBalance = await GetBalanceAsync(playerName);
        
        if (currentBalance < amount)
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                "§c余额不足！"
            );
            return false;
        }

        _balances[playerName] = currentBalance - amount;
        SaveData();
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"§c- {amount} 金币（余额: {_balances[playerName]}）"
        );
        
        return true;
    }

    public async Task<bool> TransferAsync(string from, string to, int amount)
    {
        if (amount <= 0) return false;
        if (from == to) return false;

        if (!await RemoveMoneyAsync(from, amount))
        {
            return false;
        }

        await AddMoneyAsync(to, amount);
        
        await _context.GameDisplayApi.SendChatMessage(
            from, 
            $"§e你向 {to} 转账了 {amount} 金币"
        );
        
        await _context.GameDisplayApi.SendChatMessage(
            to, 
            $"§e{from} 向你转账了 {amount} 金币"
        );
        
        _context.Logger.Info($"转账: {from} -> {to}, 金额: {amount}");
        
        return true;
    }

    private void LoadData()
    {
        if (File.Exists(_dataFile))
        {
            var json = File.ReadAllText(_dataFile);
            _balances = JsonSerializer.Deserialize<Dictionary<string, int>>(json) ?? new();
        }
    }

    private void SaveData()
    {
        var json = JsonSerializer.Serialize(_balances, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(_dataFile, json);
    }
}

// 余额命令
public class BalanceCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly EconomyService _service;

    public string Name => "balance";
    public string[] Aliases => new[] { "bal", "money" };
    public string Description => "查看余额";

    public BalanceCommand(IPluginContext context, EconomyService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("此命令只能在游戏内使用");

        var balance = await _service.GetBalanceAsync(sender.Name);
        
        await _context.GameDisplayApi.SendChatMessage(
            sender.Name, 
            $"§e你的余额: §6{balance} §e金币"
        );
        
        return CommandResult.Success();
    }
}

// 转账命令
public class PayCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly EconomyService _service;

    public string Name => "pay";
    public string Description => "转账给其他玩家";
    public string? Usage => "#pay <玩家> <金额>";

    public PayCommand(IPluginContext context, EconomyService service)
    {
        _context = context;
        _service = service;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("此命令只能在游戏内使用");

        if (args.Length < 2)
            return CommandResult.Fail($"用法: {Usage}");

        var target = args[0];
        if (!int.TryParse(args[1], out var amount) || amount <= 0)
            return CommandResult.Fail("§c金额必须是正整数");

        var success = await _service.TransferAsync(sender.Name, target, amount);
        
        return success ? CommandResult.Success() : CommandResult.Fail("§c转账失败");
    }
}
```

---

## 🚀 **传送系统场景**

### **场景4：家园系统**

```csharp
public class HomePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, List<Home>> _homes = new();
    private readonly int _maxHomes = 3;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadHomes();
        
        _context.CommandManager.RegisterCommand(new SetHomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new HomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new DelHomeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new HomesCommand(_context, this));
    }

    public async Task<bool> SetHomeAsync(string playerName, string homeName)
    {
        if (!_homes.ContainsKey(playerName))
        {
            _homes[playerName] = new List<Home>();
        }

        var playerHomes = _homes[playerName];

        // 检查数量限制
        if (playerHomes.Count >= _maxHomes && 
            !playerHomes.Any(h => h.Name == homeName))
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"§c你最多只能设置 {_maxHomes} 个家园！"
            );
            return false;
        }

        // 获取玩家位置（简化示例）
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(playerName);
        if (playerData == null)
            return false;

        // 更新或添加家园
        var existingHome = playerHomes.FirstOrDefault(h => h.Name == homeName);
        if (existingHome != null)
        {
            existingHome.Location = playerData.Position;
            existingHome.Dimension = playerData.Dimension;
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"§a家园 '{homeName}' 已更新"
            );
        }
        else
        {
            playerHomes.Add(new Home
            {
                Name = homeName,
                Location = playerData.Position,
                Dimension = playerData.Dimension,
                CreatedAt = DateTime.UtcNow
            });
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"§a家园 '{homeName}' 已设置"
            );
        }

        SaveHomes();
        return true;
    }

    public async Task<bool> TeleportHomeAsync(string playerName, string homeName)
    {
        if (!_homes.TryGetValue(playerName, out var playerHomes))
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                "§c你还没有设置任何家园"
            );
            return false;
        }

        var home = playerHomes.FirstOrDefault(h => h.Name == homeName);
        if (home == null)
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"§c家园 '{homeName}' 不存在"
            );
            return false;
        }

        // 传送
        await _context.GameDisplayApi.TeleportPlayer(
            playerName, 
            home.Location.X, 
            home.Location.Y, 
            home.Location.Z
        );

        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"§a已传送到家园 '{homeName}'"
        );

        return true;
    }

    private void LoadHomes()
    {
        var file = Path.Combine(_context.DataDirectory, "homes.json");
        if (File.Exists(file))
        {
            var json = File.ReadAllText(file);
            _homes = JsonSerializer.Deserialize<Dictionary<string, List<Home>>>(json) ?? new();
        }
    }

    private void SaveHomes()
    {
        var file = Path.Combine(_context.DataDirectory, "homes.json");
        var json = JsonSerializer.Serialize(_homes, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(file, json);
    }
}

public class Home
{
    public string Name { get; set; } = string.Empty;
    public Position Location { get; set; } = new();
    public string Dimension { get; set; } = "minecraft:overworld";
    public DateTime CreatedAt { get; set; }
}
```

---

## 🔒 **权限和组管理**

### **场景5：VIP 自动到期**

```csharp
public class VipManager : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, VipData> _vips = new();
    private Timer? _checkTimer;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        LoadVips();
        
        // 定时检查过期
        _checkTimer = new Timer(_ => CheckExpiredVips(), 
            null, TimeSpan.Zero, TimeSpan.FromHours(1));
    }

    public async Task GrantVipAsync(string playerName, int days)
    {
        var expiresAt = DateTime.UtcNow.AddDays(days);
        
        _vips[playerName] = new VipData
        {
            ExpiresAt = expiresAt,
            GrantedAt = DateTime.UtcNow
        };
        
        // 添加到 VIP 组
        await _context.PermissionManager.AddUserToGroupAsync(playerName, "vip");
        
        SaveVips();
        
        await _context.GameDisplayApi.SendChatMessage(
            playerName, 
            $"§a你已成为 VIP！有效期至 {expiresAt:yyyy-MM-dd}"
        );
    }

    private async void CheckExpiredVips()
    {
        var now = DateTime.UtcNow;
        var expired = _vips.Where(kvp => kvp.Value.ExpiresAt < now).ToList();

        foreach (var (playerName, vipData) in expired)
        {
            // 移除 VIP 组
            await _context.PermissionManager.RemoveUserFromGroupAsync(playerName, "vip");
            
            _vips.Remove(playerName);
            
            _context.Logger.Info($"{playerName} 的 VIP 已过期");
            
            // 如果玩家在线，发送通知
            var players = await _context.SmpApi.GetOnlinePlayersAsync();
            if (players.Any(p => p.Name == playerName))
            {
                await _context.GameDisplayApi.SendChatMessage(
                    playerName, 
                    "§c你的 VIP 已过期"
                );
            }
        }

        if (expired.Any())
        {
            SaveVips();
        }
    }

    private void LoadVips()
    {
        var file = Path.Combine(_context.DataDirectory, "vips.json");
        if (File.Exists(file))
        {
            var json = File.ReadAllText(file);
            _vips = JsonSerializer.Deserialize<Dictionary<string, VipData>>(json) ?? new();
        }
    }

    private void SaveVips()
    {
        var file = Path.Combine(_context.DataDirectory, "vips.json");
        var json = JsonSerializer.Serialize(_vips, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(file, json);
    }

    public void OnDisable()
    {
        _checkTimer?.Dispose();
    }
}

public class VipData
{
    public DateTime ExpiresAt { get; set; }
    public DateTime GrantedAt { get; set; }
}
```

---

## 💾 **数据持久化**

### **场景6：使用 SQLite 数据库**

```csharp
public class DatabasePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private SqliteConnection _connection = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        InitializeDatabase();
    }

    private void InitializeDatabase()
    {
        var dbPath = Path.Combine(_context.DataDirectory, "data.db");
        _connection = new SqliteConnection($"Data Source={dbPath}");
        _connection.Open();

        // 创建表
        using var cmd = _connection.CreateCommand();
        cmd.CommandText = @"
            CREATE TABLE IF NOT EXISTS players (
                uuid TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                last_login DATETIME,
                play_time INTEGER DEFAULT 0,
                level INTEGER DEFAULT 0
            )
        ";
        cmd.ExecuteNonQuery();
    }

    public async Task SavePlayerDataAsync(string uuid, string name)
    {
        using var cmd = _connection.CreateCommand();
        cmd.CommandText = @"
            INSERT OR REPLACE INTO players (uuid, name, last_login)
            VALUES (@uuid, @name, @login)
        ";
        cmd.Parameters.AddWithValue("@uuid", uuid);
        cmd.Parameters.AddWithValue("@name", name);
        cmd.Parameters.AddWithValue("@login", DateTime.UtcNow);
        
        await cmd.ExecuteNonQueryAsync();
    }

    public void OnDisable()
    {
        _connection?.Close();
        _connection?.Dispose();
    }
}
```

---

## ⏰ **定时任务**

### **场景7：定时公告和事件**

```csharp
public class ScheduledTasksPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private List<Timer> _timers = new();

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 定时公告（每30分钟）
        Schedule TimeSpan.FromMinutes(30), () =>
        {
            _context.GameDisplayApi.BroadcastMessage(
                "§6[提示] §f记得定期签到获得奖励！输入 #checkin"
            );
        });
        
        // 每日重置（每天凌晨）
        ScheduleDaily(TimeSpan.FromHours(0), async () =>
        {
            await DailyReset();
        });
        
        // 每小时自动保存
        Schedule(TimeSpan.FromHours(1), async () =>
        {
            await AutoSave();
        });
    }

    private void Schedule(TimeSpan interval, Action action)
    {
        var timer = new Timer(_ => action(), null, TimeSpan.Zero, interval);
        _timers.Add(timer);
    }

    private void ScheduleDaily(TimeSpan timeOfDay, Action action)
    {
        var now = DateTime.Now;
        var today = now.Date + timeOfDay;
        var firstRun = today > now ? today : today.AddDays(1);
        var delay = firstRun - now;

        var timer = new Timer(_ => action(), null, delay, TimeSpan.FromDays(1));
        _timers.Add(timer);
    }

    private async Task DailyReset()
    {
        _context.Logger.Info("执行每日重置...");
        // 重置逻辑
    }

    private async Task AutoSave()
    {
        _context.Logger.Info("执行自动保存...");
        await _context.RconClient.SendCommandAsync("save-all");
    }

    public void OnDisable()
    {
        foreach (var timer in _timers)
        {
            timer.Dispose();
        }
        _timers.Clear();
    }
}
```

---

## 📚 **相关文档**

- [示例插件集](./示例插件集.md)
- [插件开发指南](../03-插件开发/插件开发指南.md)
- [API 参考](../08-参考/API参考.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
