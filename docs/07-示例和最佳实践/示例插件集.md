# 示例插件集

本文档提供了一系列实用的插件示例，涵盖常见的功能场景。每个示例都可以直接使用或作为你自己插件的起点。

---

## 📋 **目录**

- [欢迎消息插件](#欢迎消息插件)
- [自动广播插件](#自动广播插件)
- [传送点插件](#传送点插件)
- [在线时长统计插件](#在线时长统计插件)
- [经济系统插件](#经济系统插件)
- [自定义命令插件](#自定义命令插件)

---

## 👋 **欢迎消息插件**

当玩家加入服务器时，显示个性化的欢迎消息和标题。

### **功能**

- ✅ 首次加入和再次加入不同消息
- ✅ 显示欢迎标题
- ✅ 播放音效
- ✅ 可配置消息模板

### **完整代码**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;

namespace WelcomePlugin;

public class WelcomePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private WelcomeConfig _config = null!;
    private HashSet<string> _knownPlayers = new();

    public void OnLoad() { }

    public async void OnEnable(IPluginContext context)
    {
        _context = context;
        _config = await _context.ConfigManager.LoadConfigAsync<WelcomeConfig>("config");
        
        // 加载已知玩家列表
        LoadKnownPlayers();
        
        // 订阅玩家加入事件
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
        
        _context.Logger.Info("WelcomePlugin 已启用");
    }

    public void OnDisable()
    {
        SaveKnownPlayers();
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var playerName = e.Player.Name;
        bool isNewPlayer = !_knownPlayers.Contains(playerName);

        // 延迟2秒显示欢迎消息
        await Task.Delay(2000);

        if (isNewPlayer)
        {
            // 首次加入
            await ShowWelcomeForNewPlayer(playerName);
            _knownPlayers.Add(playerName);
            SaveKnownPlayers();
        }
        else
        {
            // 再次加入
            await ShowWelcomeForReturningPlayer(playerName);
        }
    }

    private async Task ShowWelcomeForNewPlayer(string playerName)
    {
        // 显示标题
        await _context.GameDisplayApi.ShowTitle(
            playerName,
            "§6§l欢迎加入服务器！",
            $"§e{playerName}",
            fadeIn: 20, stay: 100, fadeOut: 20
        );

        // 发送聊天消息
        await _context.GameDisplayApi.SendChatMessage(
            playerName,
            $"\n§6§l━━━━━━━━ 欢迎 ━━━━━━━━\n" +
            $"§f欢迎来到 {_config.ServerName}！\n" +
            $"§7这是你第一次加入服务器\n" +
            $"§a输入 §f/help §a查看帮助\n" +
            $"§6§l━━━━━━━━━━━━━━━━━━━━\n"
        );

        // 广播新玩家加入
        await _context.GameDisplayApi.BroadcastMessage(
            $"§e欢迎新玩家 §a{playerName} §e加入服务器！"
        );

        // 播放音效
        await _context.GameDisplayApi.PlaySound(
            playerName, 
            "entity.player.levelup", 
            volume: 1.0f, 
            pitch: 1.5f
        );
    }

    private async Task ShowWelcomeForReturningPlayer(string playerName)
    {
        await _context.GameDisplayApi.ShowTitle(
            playerName,
            "§a§l欢迎回来！",
            $"§e{playerName}",
            fadeIn: 10, stay: 60, fadeOut: 20
        );

        await _context.GameDisplayApi.SendChatMessage(
            playerName,
            $"§a欢迎回来，{playerName}！"
        );
    }

    private void LoadKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        if (File.Exists(file))
        {
            _knownPlayers = File.ReadAllLines(file).ToHashSet();
        }
    }

    private void SaveKnownPlayers()
    {
        var file = Path.Combine(_context.DataDirectory, "known_players.txt");
        File.WriteAllLines(file, _knownPlayers);
    }
}

public class WelcomeConfig
{
    public string ServerName { get; set; } = "Minecraft Server";
}
```

---

## 📢 **自动广播插件**

定时向所有玩家发送广播消息。

### **功能**

- ✅ 定时循环广播
- ✅ 多条消息随机或顺序播放
- ✅ 支持彩色消息
- ✅ 可配置时间间隔

### **完整代码**

```csharp
using NetherGate.API.Plugins;
using System.Timers;

namespace AutoBroadcastPlugin;

public class AutoBroadcastPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private BroadcastConfig _config = null!;
    private System.Timers.Timer? _timer;
    private int _currentMessageIndex = 0;

    public void OnLoad() { }

    public async void OnEnable(IPluginContext context)
    {
        _context = context;
        _config = await _context.ConfigManager.LoadConfigAsync<BroadcastConfig>("config");

        if (_config.Messages.Count == 0)
        {
            _context.Logger.Warning("广播消息列表为空，插件将不会发送任何消息");
            return;
        }

        // 启动定时器
        _timer = new System.Timers.Timer(_config.IntervalSeconds * 1000);
        _timer.Elapsed += OnTimerElapsed;
        _timer.AutoReset = true;
        _timer.Start();

        _context.Logger.Info($"AutoBroadcastPlugin 已启用，间隔: {_config.IntervalSeconds}秒");
    }

    public void OnDisable()
    {
        _timer?.Stop();
        _timer?.Dispose();
    }

    private async void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        string message;

        if (_config.RandomOrder)
        {
            // 随机选择消息
            var random = new Random();
            message = _config.Messages[random.Next(_config.Messages.Count)];
        }
        else
        {
            // 顺序播放
            message = _config.Messages[_currentMessageIndex];
            _currentMessageIndex = (_currentMessageIndex + 1) % _config.Messages.Count;
        }

        // 添加前缀
        message = $"{_config.Prefix} {message}";

        try
        {
            await _context.GameDisplayApi.BroadcastMessage(message);
            _context.Logger.Debug($"已广播消息: {message}");
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"广播消息失败: {ex.Message}");
        }
    }
}

public class BroadcastConfig
{
    /// <summary>
    /// 消息列表
    /// </summary>
    public List<string> Messages { get; set; } = new()
    {
        "§a欢迎来到服务器！",
        "§e记得定期签到哦！",
        "§b遵守服务器规则，友善待人。",
        "§d加入我们的Discord: discord.gg/example"
    };

    /// <summary>
    /// 消息前缀
    /// </summary>
    public string Prefix { get; set; } = "§6[服务器]";

    /// <summary>
    /// 间隔时间（秒）
    /// </summary>
    public int IntervalSeconds { get; set; } = 300; // 5分钟

    /// <summary>
    /// 是否随机顺序
    /// </summary>
    public bool RandomOrder { get; set; } = false;
}
```

**配置示例 (config.yaml):**

```yaml
messages:
  - "§a欢迎来到服务器！"
  - "§e记得定期签到哦！"
  - "§b遵守服务器规则，友善待人。"
  - "§d加入我们的Discord: discord.gg/example"

prefix: "§6[服务器]"
interval_seconds: 300
random_order: false
```

---

## 🚀 **传送点插件**

允许玩家设置和传送到自定义传送点。

### **功能**

- ✅ 设置和删除传送点
- ✅ 传送到传送点
- ✅ 列出所有传送点
- ✅ 权限控制

### **完整代码**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Commands;
using System.Text.Json;

namespace WarpPlugin;

public class WarpPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, WarpPoint> _warps = new();
    private string _dataFile = string.Empty;

    public void OnLoad() { }

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _dataFile = Path.Combine(_context.DataDirectory, "warps.json");
        
        LoadWarps();
        
        _context.CommandManager.RegisterCommand(new WarpCommand(_context, this));
        _context.CommandManager.RegisterCommand(new SetWarpCommand(_context, this));
        _context.CommandManager.RegisterCommand(new DelWarpCommand(_context, this));
        _context.CommandManager.RegisterCommand(new WarpsCommand(_context, this));
        
        _context.Logger.Info("WarpPlugin 已启用");
    }

    public void OnDisable()
    {
        SaveWarps();
    }

    public WarpPoint? GetWarp(string name) => 
        _warps.TryGetValue(name.ToLower(), out var warp) ? warp : null;

    public void AddWarp(string name, WarpPoint warp)
    {
        _warps[name.ToLower()] = warp;
        SaveWarps();
    }

    public bool RemoveWarp(string name)
    {
        bool removed = _warps.Remove(name.ToLower());
        if (removed) SaveWarps();
        return removed;
    }

    public Dictionary<string, WarpPoint> GetAllWarps() => _warps;

    private void LoadWarps()
    {
        if (File.Exists(_dataFile))
        {
            var json = File.ReadAllText(_dataFile);
            _warps = JsonSerializer.Deserialize<Dictionary<string, WarpPoint>>(json) ?? new();
            _context.Logger.Info($"已加载 {_warps.Count} 个传送点");
        }
    }

    private void SaveWarps()
    {
        var json = JsonSerializer.Serialize(_warps, new JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(_dataFile, json);
    }
}

public class WarpPoint
{
    public double X { get; set; }
    public double Y { get; set; }
    public double Z { get; set; }
    public float Yaw { get; set; }
    public float Pitch { get; set; }
    public string Creator { get; set; } = string.Empty;
    public DateTime CreatedAt { get; set; }
}

// 传送命令
public class WarpCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly WarpPlugin _plugin;

    public string Name => "warp";
    public string Description => "传送到传送点";
    public string? Usage => "#warp <name>";

    public WarpCommand(IPluginContext context, WarpPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("此命令只能在游戏内使用");

        if (args.Length == 0)
            return CommandResult.Fail($"用法: {Usage}");

        var warpName = args[0];
        var warp = _plugin.GetWarp(warpName);

        if (warp == null)
            return CommandResult.Fail($"§c传送点 '{warpName}' 不存在");

        await _context.GameDisplayApi.TeleportPlayer(
            sender.Name, warp.X, warp.Y, warp.Z, warp.Yaw, warp.Pitch);

        await _context.GameDisplayApi.SendChatMessage(
            sender.Name, $"§a已传送到 '{warpName}'");

        return CommandResult.Success();
    }

    public async Task<List<string>> TabCompleteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length == 1)
        {
            return _plugin.GetAllWarps().Keys.ToList();
        }
        return new List<string>();
    }
}

// 设置传送点命令
public class SetWarpCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly WarpPlugin _plugin;

    public string Name => "setwarp";
    public string Description => "设置传送点";
    public string? Permission => "warp.admin";
    public string? Usage => "#setwarp <name>";

    public SetWarpCommand(IPluginContext context, WarpPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("此命令只能在游戏内使用");

        if (args.Length == 0)
            return CommandResult.Fail($"用法: {Usage}");

        var warpName = args[0];

        // 获取玩家当前位置（这里简化处理，实际应从玩家数据读取）
        var warp = new WarpPoint
        {
            X = 0, Y = 64, Z = 0, // 实际应读取玩家位置
            Creator = sender.Name,
            CreatedAt = DateTime.UtcNow
        };

        _plugin.AddWarp(warpName, warp);

        await _context.GameDisplayApi.SendChatMessage(
            sender.Name, $"§a已设置传送点 '{warpName}'");

        return CommandResult.Success();
    }
}

// 删除传送点命令
public class DelWarpCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly WarpPlugin _plugin;

    public string Name => "delwarp";
    public string Description => "删除传送点";
    public string? Permission => "warp.admin";
    public string? Usage => "#delwarp <name>";

    public DelWarpCommand(IPluginContext context, WarpPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length == 0)
            return CommandResult.Fail($"用法: {Usage}");

        var warpName = args[0];
        bool removed = _plugin.RemoveWarp(warpName);

        if (removed)
        {
            if (sender != null)
            {
                await _context.GameDisplayApi.SendChatMessage(
                    sender.Name, $"§a已删除传送点 '{warpName}'");
            }
            return CommandResult.Success();
        }
        else
        {
            return CommandResult.Fail($"§c传送点 '{warpName}' 不存在");
        }
    }

    public async Task<List<string>> TabCompleteAsync(string[] args, ICommandSender? sender = null)
    {
        if (args.Length == 1)
        {
            return _plugin.GetAllWarps().Keys.ToList();
        }
        return new List<string>();
    }
}

// 列出传送点命令
public class WarpsCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly WarpPlugin _plugin;

    public string Name => "warps";
    public string Description => "列出所有传送点";

    public WarpsCommand(IPluginContext context, WarpPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        var warps = _plugin.GetAllWarps();

        if (warps.Count == 0)
        {
            return CommandResult.Fail("§c当前没有任何传送点");
        }

        var message = $"§6=== 传送点列表 ({warps.Count}) ===\n";
        foreach (var kvp in warps)
        {
            message += $"§e{kvp.Key} §7- §f({kvp.Value.X:F0}, {kvp.Value.Y:F0}, {kvp.Value.Z:F0})\n";
        }

        if (sender != null)
        {
            await _context.GameDisplayApi.SendChatMessage(sender.Name, message);
        }

        return CommandResult.Success(message);
    }
}
```

---

## ⏱️ **在线时长统计插件**

统计玩家在线时长并提供排行榜。

### **功能**

- ✅ 自动统计玩家在线时长
- ✅ 查询个人在线时长
- ✅ 在线时长排行榜
- ✅ 数据持久化

### **核心代码**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;
using NetherGate.API.Commands;

namespace PlaytimePlugin;

public class PlaytimePlugin : IPlugin
{
    private IPluginContext _context = null!;
    private Dictionary<string, PlayerPlaytime> _playData = new();
    private Dictionary<string, DateTime> _sessionStart = new();

    public void OnLoad() { }

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        LoadData();
        
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
        _context.EventBus.Subscribe<PlayerLeftEvent>(OnPlayerLeft);
        
        _context.CommandManager.RegisterCommand(new PlaytimeCommand(_context, this));
        _context.CommandManager.RegisterCommand(new PlaytimeTopCommand(_context, this));
        
        _context.Logger.Info("PlaytimePlugin 已启用");
    }

    public void OnDisable()
    {
        // 保存所有在线玩家的时长
        foreach (var kvp in _sessionStart)
        {
            UpdatePlaytime(kvp.Key, kvp.Value);
        }
        SaveData();
    }

    private void OnPlayerJoined(PlayerJoinedEvent e)
    {
        _sessionStart[e.Player.Name] = DateTime.UtcNow;
        
        if (!_playData.ContainsKey(e.Player.Name))
        {
            _playData[e.Player.Name] = new PlayerPlaytime { PlayerName = e.Player.Name };
        }
    }

    private void OnPlayerLeft(PlayerLeftEvent e)
    {
        if (_sessionStart.TryGetValue(e.Player.Name, out var startTime))
        {
            UpdatePlaytime(e.Player.Name, startTime);
            _sessionStart.Remove(e.Player.Name);
            SaveData();
        }
    }

    private void UpdatePlaytime(string playerName, DateTime startTime)
    {
        var duration = DateTime.UtcNow - startTime;
        
        if (_playData.TryGetValue(playerName, out var data))
        {
            data.TotalMinutes += (int)duration.TotalMinutes;
            data.LastPlayed = DateTime.UtcNow;
        }
    }

    public PlayerPlaytime? GetPlaytime(string playerName) =>
        _playData.TryGetValue(playerName, out var data) ? data : null;

    public List<PlayerPlaytime> GetTopPlayers(int count = 10) =>
        _playData.Values.OrderByDescending(p => p.TotalMinutes).Take(count).ToList();

    private void LoadData()
    {
        var file = Path.Combine(_context.DataDirectory, "playtime.json");
        if (File.Exists(file))
        {
            var json = File.ReadAllText(file);
            _playData = System.Text.Json.JsonSerializer
                .Deserialize<Dictionary<string, PlayerPlaytime>>(json) ?? new();
        }
    }

    private void SaveData()
    {
        var file = Path.Combine(_context.DataDirectory, "playtime.json");
        var json = System.Text.Json.JsonSerializer.Serialize(_playData, 
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(file, json);
    }
}

public class PlayerPlaytime
{
    public string PlayerName { get; set; } = string.Empty;
    public int TotalMinutes { get; set; }
    public DateTime? LastPlayed { get; set; }
    
    public string FormatPlaytime()
    {
        int hours = TotalMinutes / 60;
        int minutes = TotalMinutes % 60;
        
        if (hours > 24)
        {
            int days = hours / 24;
            hours = hours % 24;
            return $"{days}天 {hours}小时 {minutes}分钟";
        }
        return $"{hours}小时 {minutes}分钟";
    }
}
```

---

## 💰 **简易经济系统插件**

实现一个基础的经济系统，支持金币管理。

### **功能**

- ✅ 查询余额
- ✅ 转账
- ✅ 管理员添加/扣除金币
- ✅ 经济排行榜

### **核心代码片段**

```csharp
public class EconomyService
{
    private Dictionary<string, int> _balances = new();
    
    public int GetBalance(string playerName)
    {
        return _balances.TryGetValue(playerName, out var balance) ? balance : 0;
    }
    
    public bool AddMoney(string playerName, int amount)
    {
        if (amount < 0) return false;
        
        _balances.TryGetValue(playerName, out var balance);
        _balances[playerName] = balance + amount;
        return true;
    }
    
    public bool RemoveMoney(string playerName, int amount)
    {
        if (amount < 0) return false;
        
        var balance = GetBalance(playerName);
        if (balance < amount) return false;
        
        _balances[playerName] = balance - amount;
        return true;
    }
    
    public bool Transfer(string from, string to, int amount)
    {
        if (amount <= 0) return false;
        if (from == to) return false;
        
        if (!RemoveMoney(from, amount)) return false;
        
        AddMoney(to, amount);
        return true;
    }
}
```

---

## 📚 **更多示例**

### **获取完整示例代码**

所有示例的完整源代码可在以下位置找到：
- GitHub: https://github.com/your-org/NetherGate-Plugins
- 示例仓库: https://github.com/your-org/NetherGate-Examples

### **相关文档**

- [第一个插件](../01-快速开始/第一个插件.md) - 详细教程
- [插件开发指南](../03-插件开发/插件开发指南.md)
- [API 参考](../08-参考/API参考.md)
- [常见场景](./常见场景.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
