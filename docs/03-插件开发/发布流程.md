# 插件发布流程

本文档介绍如何打包、发布和维护 NetherGate 插件。

---

## 1. 发布前准备

### 1.1 完善插件元数据

确保 `plugin.json` 包含完整信息：

```json
{
  "id": "your-plugin",
  "name": "Your Plugin",
  "version": "1.0.0",
  "description": "A brief description of your plugin",
  "author": "Your Name",
  "website": "https://github.com/yourusername/your-plugin",
  "repository": "https://github.com/yourusername/your-plugin",
  "category": "utility",
  "tags": ["utility", "admin", "management"],
  
  "nethergate_version": ">=1.0.0",
  "minecraft_version": ["1.21.*"],
  
  "entry_point": "YourPlugin.PluginMain",
  
  "dependencies": {
    "nethergate-api": ">=1.0.0"
  },
  
  "plugin_dependencies": {
    "core-utils": ">=2.0.0"
  },
  
  "conflicts": []
}
```

**关键字段说明：**
- `id`: 插件唯一标识符（建议使用 kebab-case）
- `version`: 遵循 [语义化版本](https://semver.org/lang/zh-CN/)
- `website`: 插件主页或文档地址
- `repository`: 源代码仓库地址
- `category`: 插件分类（`utility`, `admin`, `gameplay`, `library` 等）
- `tags`: 搜索关键词
- `nethergate_version`: 框架版本要求
- `minecraft_version`: 支持的 Minecraft 版本（支持通配符）

### 1.2 编写文档

#### README.md

插件根目录应包含 `README.md`，至少包含：

```markdown
# Your Plugin

## 简介
简短描述插件的功能和用途。

## 功能特性
- 功能 1
- 功能 2
- 功能 3

## 安装
1. 下载插件 DLL 文件
2. 将文件放入 `plugins/` 目录
3. 重启服务器或执行 `plugin load your-plugin`

## 配置
配置文件位于 `plugins/your-plugin/config.yaml`：
\`\`\`yaml
setting1: value1
setting2: value2
\`\`\`

## 使用方法
### 命令
- `/yourcommand` - 命令描述

### 权限
- `yourplugin.admin` - 管理员权限
- `yourplugin.user` - 普通用户权限

## 依赖
- NetherGate API >= 1.0.0
- Minecraft 1.21.x

## 支持与反馈
- Issue: https://github.com/yourusername/your-plugin/issues
- Discord: https://discord.gg/...

## 开源协议
MIT License
```

#### 配置模板

提供默认配置模板 `config.example.yaml`：

```yaml
# Your Plugin Configuration
# 详细说明见: https://your-docs-url

# 功能开关
enabled: true

# 基本设置
settings:
  option1: value1
  option2: value2

# 高级设置（一般不需要修改）
advanced:
  cache_size: 1000
  timeout: 30
```

#### CHANGELOG.md

记录版本变更历史：

```markdown
# 更新日志

## [1.0.0] - 2025-10-05

### 新增
- 初始版本发布
- 实现核心功能 X
- 添加命令 Y

### 修复
- 无

### 变更
- 无
```

### 1.3 质量检查

#### 代码审查清单

- [ ] 所有公共 API 都有 XML 文档注释
- [ ] 异常处理完善，不会导致服务器崩溃
- [ ] 日志级别使用合理（避免在 Info 级别输出过多信息）
- [ ] 资源正确释放（实现 `IDisposable` 或在 `OnDisable` 中清理）
- [ ] 线程安全（如果使用多线程）
- [ ] 配置验证（处理无效配置）
- [ ] 命令权限检查
- [ ] 性能优化（避免阻塞主线程）

#### 测试清单

- [ ] 插件能正常加载和卸载
- [ ] 热重载功能正常
- [ ] 所有命令都能正确执行
- [ ] 配置文件能正确读取和生成
- [ ] 事件监听器正常工作
- [ ] 与其他常用插件兼容
- [ ] 在目标 Minecraft 版本上测试通过
- [ ] 性能测试（CPU、内存占用）

---

## 2. 打包插件

### 2.1 使用 dotnet build

基本打包命令：

```bash
# 开发版本（包含调试符号）
dotnet build -c Debug

# 发布版本（优化构建）
dotnet build -c Release
```

构建产物位于 `bin/Release/net9.0/`。

### 2.2 创建发布包

推荐的发布包结构：

```
YourPlugin-v1.0.0.zip
├── YourPlugin.dll          # 插件主程序
├── YourPlugin.pdb          # 调试符号（可选）
├── lib/                    # 依赖库（如有）
│   └── ThirdParty.dll
├── config.example.yaml     # 配置模板
├── README.md               # 说明文档
├── CHANGELOG.md            # 更新日志
└── LICENSE                 # 开源协议
```

**打包脚本示例（PowerShell）：**

```powershell
# package.ps1
param(
    [string]$Version = "1.0.0"
)

$ProjectName = "YourPlugin"
$OutputDir = "bin/Release/net9.0"
$PackageDir = "releases/$ProjectName-v$Version"

# 构建
Write-Host "Building $ProjectName v$Version..." -ForegroundColor Cyan
dotnet build -c Release

# 创建打包目录
New-Item -ItemType Directory -Force -Path $PackageDir | Out-Null
Remove-Item "$PackageDir/*" -Recurse -Force -ErrorAction SilentlyContinue

# 复制文件
Copy-Item "$OutputDir/$ProjectName.dll" $PackageDir
Copy-Item "config.example.yaml" $PackageDir
Copy-Item "README.md" $PackageDir
Copy-Item "CHANGELOG.md" $PackageDir
Copy-Item "LICENSE" $PackageDir

# 复制依赖库
if (Test-Path "$OutputDir/lib") {
    Copy-Item "$OutputDir/lib" $PackageDir -Recurse
}

# 创建 ZIP
$ZipPath = "releases/$ProjectName-v$Version.zip"
Compress-Archive -Path "$PackageDir/*" -DestinationPath $ZipPath -Force

Write-Host "Package created: $ZipPath" -ForegroundColor Green
```

**打包脚本示例（Bash）：**

```bash
#!/bin/bash
# package.sh

VERSION=${1:-"1.0.0"}
PROJECT_NAME="YourPlugin"
OUTPUT_DIR="bin/Release/net9.0"
PACKAGE_DIR="releases/$PROJECT_NAME-v$VERSION"

# 构建
echo "Building $PROJECT_NAME v$VERSION..."
dotnet build -c Release

# 创建打包目录
mkdir -p "$PACKAGE_DIR"
rm -rf "$PACKAGE_DIR"/*

# 复制文件
cp "$OUTPUT_DIR/$PROJECT_NAME.dll" "$PACKAGE_DIR/"
cp "config.example.yaml" "$PACKAGE_DIR/"
cp "README.md" "$PACKAGE_DIR/"
cp "CHANGELOG.md" "$PACKAGE_DIR/"
cp "LICENSE" "$PACKAGE_DIR/"

# 复制依赖库
if [ -d "$OUTPUT_DIR/lib" ]; then
    cp -r "$OUTPUT_DIR/lib" "$PACKAGE_DIR/"
fi

# 创建 ZIP
cd releases
zip -r "$PROJECT_NAME-v$VERSION.zip" "$PROJECT_NAME-v$VERSION"
cd ..

echo "Package created: releases/$PROJECT_NAME-v$VERSION.zip"
```

### 2.3 依赖处理

#### 包含第三方依赖

如果插件依赖第三方 NuGet 包（非 NetherGate API），有两种方式：

**方式 1：发布时复制依赖（推荐）**

在 `.csproj` 中设置：

```xml
<PropertyGroup>
  <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
</PropertyGroup>
```

这会将所有依赖复制到 `bin` 目录，然后将它们放入 `lib/` 子目录。

**方式 2：单文件发布**

使用 `dotnet publish` 创建包含所有依赖的单个 DLL（需要 .NET 9+ 支持）：

```bash
dotnet publish -c Release -o publish/ /p:PublishSingleFile=false
```

> **注意：** 不要包含 NetherGate API DLL，框架已经提供。

#### 依赖冲突处理

如果插件 A 依赖 `Newtonsoft.Json 12.0.0`，插件 B 依赖 `Newtonsoft.Json 13.0.0`：

1. **优先使用框架提供的版本**：检查 NetherGate 是否已包含该库
2. **使用较高版本**：通常向后兼容
3. **隔离加载**：将依赖放在 `plugins/your-plugin/lib/` 目录

---

## 3. 发布渠道

### 3.1 GitHub Releases

推荐使用 GitHub Releases 发布插件：

1. **创建 Release**：
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```

2. **在 GitHub 上创建 Release**：
   - 标题：`v1.0.0`
   - 描述：从 `CHANGELOG.md` 复制
   - 附件：上传 ZIP 包

3. **自动化（GitHub Actions）**：

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Build
      run: dotnet build -c Release
    
    - name: Package
      run: |
        mkdir -p release
        cp bin/Release/net9.0/YourPlugin.dll release/
        cp README.md release/
        cp CHANGELOG.md release/
        cd release
        zip -r ../YourPlugin-${{ github.ref_name }}.zip *
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: YourPlugin-${{ github.ref_name }}.zip
        body_path: CHANGELOG.md
```

### 3.2 NuGet 包（可选）

如果插件是库类型（提供 API 给其他插件），可以发布为 NuGet 包：

```xml
<!-- YourPlugin.csproj -->
<PropertyGroup>
  <PackageId>NetherGate.Plugin.YourPlugin</PackageId>
  <Version>1.0.0</Version>
  <Authors>Your Name</Authors>
  <Description>Your plugin description</Description>
  <PackageTags>nethergate;minecraft;plugin</PackageTags>
  <RepositoryUrl>https://github.com/yourusername/your-plugin</RepositoryUrl>
</PropertyGroup>
```

打包并发布：

```bash
dotnet pack -c Release
dotnet nuget push bin/Release/YourPlugin.1.0.0.nupkg --api-key YOUR_KEY --source https://api.nuget.org/v3/index.json
```

### 3.3 官方插件市场（规划中）

NetherGate 计划提供官方插件市场，届时可以通过以下方式发布：

1. 注册开发者账号
2. 提交插件信息和 ZIP 包
3. 审核通过后自动上架
4. 用户可通过 `plugin install <plugin-id>` 一键安装

---

## 4. 版本管理

### 4.1 语义化版本

遵循 [Semantic Versioning 2.0.0](https://semver.org/lang/zh-CN/)：

- **主版本号（Major）**：不兼容的 API 修改
- **次版本号（Minor）**：向下兼容的功能新增
- **修订号（Patch）**：向下兼容的问题修复

**示例：**
```
1.0.0 - 初始发布
1.0.1 - 修复 Bug
1.1.0 - 新增功能
2.0.0 - 重大更新，不向下兼容
```

### 4.2 版本号规范

```json
{
  "version": "1.2.3",
  "nethergate_version": ">=1.0.0 <2.0.0",
  "minecraft_version": ["1.21.*"]
}
```

**版本约束语法：**
- `1.0.0` - 精确版本
- `>=1.0.0` - 大于等于
- `<2.0.0` - 小于
- `>=1.0.0 <2.0.0` - 范围
- `1.21.*` - 通配符

### 4.3 分支策略

推荐使用 Git Flow：

```
main        - 稳定版本
  ├─ v1.0.0
  ├─ v1.1.0
  └─ v2.0.0

develop     - 开发分支
  ├─ feature/new-command
  ├─ feature/api-enhancement
  └─ bugfix/config-loading

hotfix      - 紧急修复
  └─ v1.0.1
```

### 4.4 更新策略

**兼容性承诺：**
- 同一主版本内保持 API 兼容
- 弃用功能先标记 `[Obsolete]`，下一主版本移除
- 配置文件向后兼容

**更新通知：**
```csharp
public class PluginMain : IPlugin
{
    public void OnEnable()
    {
        // 检查版本更新
        CheckForUpdates();
    }

    private async void CheckForUpdates()
    {
        try
        {
            var client = new HttpClient();
            var response = await client.GetStringAsync(
                "https://api.github.com/repos/yourusername/your-plugin/releases/latest"
            );
            
            var json = JsonDocument.Parse(response);
            var latestVersion = json.RootElement.GetProperty("tag_name").GetString();
            var currentVersion = Context.Metadata.Version;
            
            if (latestVersion != $"v{currentVersion}")
            {
                Logger.Info($"发现新版本 {latestVersion}，当前版本 v{currentVersion}");
                Logger.Info($"下载地址: https://github.com/yourusername/your-plugin/releases");
            }
        }
        catch (Exception ex)
        {
            Logger.Debug($"检查更新失败: {ex.Message}");
        }
    }
}
```

---

## 5. 维护与支持

### 5.1 Issue 管理

**Issue 模板（`.github/ISSUE_TEMPLATE/bug_report.md`）：**

```markdown
---
name: Bug 报告
about: 报告插件的问题
title: '[BUG] '
labels: bug
---

**问题描述**
简短描述遇到的问题。

**复现步骤**
1. 执行命令 '...'
2. 观察到 '...'
3. 出现错误 '...'

**预期行为**
描述应该发生什么。

**环境信息**
- NetherGate 版本: [如 1.0.0]
- 插件版本: [如 1.0.0]
- Minecraft 版本: [如 1.21.1]
- 操作系统: [如 Windows 11]

**日志**
```
粘贴相关日志
```

**附加信息**
其他有用的信息。
```

**功能请求模板（`.github/ISSUE_TEMPLATE/feature_request.md`）：**

```markdown
---
name: 功能请求
about: 建议新功能
title: '[FEATURE] '
labels: enhancement
---

**功能描述**
简短描述想要的功能。

**使用场景**
描述什么情况下需要这个功能。

**替代方案**
是否有其他解决方法？

**附加信息**
其他补充说明。
```

### 5.2 贡献指南

**CONTRIBUTING.md：**

```markdown
# 贡献指南

感谢您对本插件的关注！

## 如何贡献

1. Fork 本仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 代码规范

- 遵循 C# 编码约定
- 添加 XML 文档注释
- 编写单元测试
- 保持代码简洁

## Pull Request 规范

- 清晰描述改动内容
- 关联相关 Issue
- 确保所有测试通过
- 更新相关文档
```

### 5.3 社区支持

**建立支持渠道：**
1. **GitHub Issues**：技术问题和 Bug 报告
2. **Discussions**：使用交流和问答
3. **Discord/QQ**：实时支持（可选）
4. **文档网站**：详细使用指南

**回复 Issue 的最佳实践：**
- 24 小时内首次回复
- 礼貌、专业
- 提供清晰的解决方案或诊断步骤
- 关闭 Issue 时说明原因

### 5.4 持续改进

**收集反馈：**
```csharp
// 可选：匿名使用统计
public void OnEnable()
{
    if (Config.EnableAnalytics)
    {
        SendAnonymousStats();
    }
}

private async void SendAnonymousStats()
{
    var stats = new
    {
        plugin_id = Context.Metadata.Id,
        plugin_version = Context.Metadata.Version,
        nethergate_version = Context.NetherGateVersion,
        minecraft_version = Context.MinecraftVersion
    };
    
    // 发送到统计服务（需征得用户同意）
    await HttpClient.PostAsJsonAsync("https://your-analytics-service/stats", stats);
}
```

**定期更新：**
- 每月检查依赖更新
- 跟进 NetherGate API 变化
- 适配新的 Minecraft 版本
- 优化性能和代码质量

---

## 6. 常见问题

### Q1: 如何处理破坏性更新？

**A:** 使用主版本号变更，并提供迁移指南：

```markdown
# 从 v1.x 升级到 v2.0

## 破坏性变更
1. `OldMethod()` 已移除，请使用 `NewMethod()`
2. 配置文件格式已更改

## 迁移步骤
1. 备份旧配置
2. 更新插件
3. 使用新配置格式
4. 测试功能

## 配置迁移
### 旧格式 (v1.x)
\`\`\`yaml
setting: value
\`\`\`

### 新格式 (v2.x)
\`\`\`yaml
settings:
  option: value
\`\`\`
```

### Q2: 如何保护插件版权？

**A:** 
1. **选择合适的开源协议**（MIT, GPL, Apache 2.0 等）
2. **代码混淆**（不推荐，影响调试）
3. **许可证验证**（对商业插件）

### Q3: 插件可以收费吗？

**A:** 
- **完全可以**，NetherGate 支持商业插件
- 推荐使用双授权模式：免费社区版 + 付费专业版
- 提供试用期或功能限制版本

### Q4: 如何处理大版本的 Minecraft 更新？

**A:**
```json
{
  "minecraft_version": ["1.21.*"],  // 当前支持
  "nethergate_version": ">=1.0.0 <2.0.0"
}
```

当 Minecraft 1.22 发布时：
1. 测试插件兼容性
2. 如果兼容，更新 `minecraft_version: ["1.21.*", "1.22.*"]`
3. 如果不兼容，发布新版本专门支持 1.22

---

## 7. 发布清单

最终检查清单：

- [ ] `plugin.json` 信息完整正确
- [ ] `README.md` 编写完成
- [ ] `CHANGELOG.md` 更新
- [ ] `config.example.yaml` 提供
- [ ] 代码质量检查通过
- [ ] 所有测试通过
- [ ] 性能测试通过
- [ ] 文档审阅
- [ ] 许可证文件（LICENSE）
- [ ] 版本号更新
- [ ] Git 标签创建
- [ ] ZIP 包生成
- [ ] GitHub Release 创建
- [ ] 发布公告（可选）

---

## 参考资源

- [语义化版本](https://semver.org/lang/zh-CN/)
- [选择开源协议](https://choosealicense.com/)
- [编写优秀的 README](https://www.makeareadme.com/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)

