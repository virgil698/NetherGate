# æ’ä»¶é…ç½®æ–‡ä»¶ç®¡ç†

NetherGate æä¾›äº†å¼ºå¤§çš„é…ç½®æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒ JSON å’Œ YAML ä¸¤ç§æ ¼å¼ï¼Œå¹¶æä¾›è‡ªåŠ¨åºåˆ—åŒ–ã€çƒ­é‡è½½ç­‰åŠŸèƒ½ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ”¯æŒçš„æ ¼å¼](#æ”¯æŒçš„æ ¼å¼)
- [é…ç½®æ–‡ä»¶æ“ä½œ](#é…ç½®æ–‡ä»¶æ“ä½œ)
- [é…ç½®ç±»å®šä¹‰](#é…ç½®ç±»å®šä¹‰)
- [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **1. å®šä¹‰é…ç½®ç±»**

```csharp
public class MyPluginConfig
{
    public string WelcomeMessage { get; set; } = "æ¬¢è¿åŠ å…¥æœåŠ¡å™¨ï¼";
    public int MaxPlayers { get; set; } = 100;
    public bool EnableFeature { get; set; } = true;
    public List<string> AllowedWorlds { get; set; } = new() { "world", "world_nether" };
}
```

### **2. åŠ è½½é…ç½®**

```csharp
using NetherGate.API.Plugins;

public class MyPlugin : PluginBase
{
    private MyPluginConfig _config = null!;

    public override async Task OnEnableAsync()
    {
        // åŠ è½½é…ç½®ï¼ˆä½¿ç”¨ Config å±æ€§ï¼Œè‡ªåŠ¨åˆ›å»ºé»˜è®¤é…ç½®ï¼‰
        _config = await Config.LoadAsync<MyPluginConfig>("config");
        
        Logger.Info($"é…ç½®å·²åŠ è½½: {_config.WelcomeMessage}");
        Logger.Info($"æœ€å¤§ç©å®¶æ•°: {_config.MaxPlayers}");
    }

    public override async Task OnDisableAsync()
    {
        // æ’ä»¶ç¦ç”¨æ—¶ä¿å­˜é…ç½®
        await Config.SaveAsync("config", _config);
        Logger.Info("é…ç½®å·²ä¿å­˜");
    }
}
```

### **3. è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶**

é¦–æ¬¡è¿è¡Œåä¼šè‡ªåŠ¨ç”Ÿæˆ `config/MyPlugin/config.yaml`ï¼š

```yaml
welcome_message: "æ¬¢è¿åŠ å…¥æœåŠ¡å™¨ï¼"
max_players: 100
enable_feature: true
allowed_worlds:
  - "world"
  - "world_nether"
```

---

## ğŸ“„ **æ”¯æŒçš„æ ¼å¼**

### **YAMLï¼ˆæ¨èï¼‰**

**ä¼˜ç‚¹ï¼š**
- âœ… å¯è¯»æ€§å¼º
- âœ… æ”¯æŒæ³¨é‡Š
- âœ… å±‚çº§ç»“æ„æ¸…æ™°

**ç¤ºä¾‹ï¼š**
```yaml
# è¿™æ˜¯æ³¨é‡Š
server:
  name: "æˆ‘çš„æœåŠ¡å™¨"
  port: 25565
  
features:
  pvp: true
  mobspawn: false
```

### **JSON**

**ä¼˜ç‚¹ï¼š**
- âœ… å¹¿æ³›æ”¯æŒ
- âœ… ä¸¥æ ¼çš„è¯­æ³•

**ç¤ºä¾‹ï¼š**
```json
{
  "server": {
    "name": "æˆ‘çš„æœåŠ¡å™¨",
    "port": 25565
  },
  "features": {
    "pvp": true,
    "mobspawn": false
  }
}
```

### **æ ¼å¼é€‰æ‹©**

NetherGate æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨è¯†åˆ«æ ¼å¼ï¼š

```csharp
// ä½¿ç”¨ PluginBase çš„ Config å±æ€§

// YAMLï¼ˆæ¨èï¼‰
var config = await Config.LoadAsync<MyConfig>("config.yaml");

// JSON
var config = await Config.LoadAsync<MyConfig>("config.json");

// è‡ªåŠ¨é€‰æ‹©ï¼ˆä¼˜å…ˆ YAMLï¼‰
var config = await Config.LoadAsync<MyConfig>("config");
// ä¼šè‡ªåŠ¨æŸ¥æ‰¾ config.yamlï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŸ¥æ‰¾ config.json
```

---

## ğŸ”§ **é…ç½®æ–‡ä»¶æ“ä½œ**

### **IConfigManager æ¥å£**

```csharp
namespace NetherGate.API.Plugins
{
    /// <summary>
    /// é…ç½®ç®¡ç†å™¨æ¥å£
    /// </summary>
    public interface IConfigManager
    {
        /// <summary>
        /// åŠ è½½é…ç½®æ–‡ä»¶
        /// å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
        /// </summary>
        Task<T> LoadAsync<T>(string fileName) where T : class, new();
        
        /// <summary>
        /// ä¿å­˜é…ç½®æ–‡ä»¶
        /// </summary>
        Task SaveAsync<T>(string fileName, T config) where T : class;
        
        /// <summary>
        /// é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
    /// </summary>
    Task<T> ReloadConfigAsync<T>(string fileName) where T : class, new();
    
    /// <summary>
    /// æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    /// </summary>
    bool ConfigExists(string fileName);
    
    /// <summary>
    /// åˆ é™¤é…ç½®æ–‡ä»¶
    /// </summary>
    Task DeleteConfigAsync(string fileName);
}
```

### **åŸºæœ¬æ“ä½œ**

#### **åŠ è½½é…ç½®**

```csharp
// ä½¿ç”¨ PluginBase çš„ Config å±æ€§

// åŠ è½½é…ç½®ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
var config = await Config.LoadAsync<MyConfig>("config");
Logger.Info("é…ç½®åŠ è½½å®Œæˆ");

// åŠ è½½ç‰¹å®šæ ¼å¼
var yamlConfig = await Config.LoadAsync<MyConfig>("config.yaml");
var jsonConfig = await Config.LoadAsync<MyConfig>("settings.json");
```

#### **ä¿å­˜é…ç½®**

```csharp
// ä¿®æ”¹é…ç½®
_config.MaxPlayers = 200;
_config.WelcomeMessage = "æ–°çš„æ¬¢è¿æ¶ˆæ¯";

// ä¿å­˜é…ç½®
await Config.SaveAsync("config", _config);
Logger.Info("é…ç½®å·²ä¿å­˜");
```

#### **é‡æ–°åŠ è½½é…ç½®**

```csharp
// ä»æ–‡ä»¶é‡æ–°åŠ è½½ï¼ˆä¸¢å¼ƒå†…å­˜ä¸­çš„ä¿®æ”¹ï¼‰
_config = await Config.ReloadAsync<MyConfig>("config");
Logger.Info("é…ç½®å·²é‡æ–°åŠ è½½");
```

#### **æ£€æŸ¥å’Œåˆ é™¤**

```csharp
// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (Config.Exists("config"))
{
    Logger.Info("é…ç½®æ–‡ä»¶å­˜åœ¨");
}
else
{
    Logger.Warning("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºé»˜è®¤é…ç½®");
}

// åˆ é™¤é…ç½®æ–‡ä»¶ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
await Config.DeleteAsync("old_config");
Logger.Info("å·²åˆ é™¤æ—§é…ç½®æ–‡ä»¶");
```

---

## ğŸ“ **é…ç½®ç±»å®šä¹‰**

### **åŸºæœ¬ç±»å‹**

```csharp
public class BasicConfig
{
    // åŸºæœ¬ç±»å‹
    public string Name { get; set; } = "Default";
    public int Number { get; set; } = 100;
    public double Decimal { get; set; } = 1.5;
    public bool Flag { get; set; } = true;
    
    // é›†åˆç±»å‹
    public List<string> Items { get; set; } = new();
    public Dictionary<string, int> Scores { get; set; } = new();
    
    // æšä¸¾
    public GameMode Mode { get; set; } = GameMode.Survival;
}

public enum GameMode
{
    Survival,
    Creative,
    Adventure,
    Spectator
}
```

### **åµŒå¥—é…ç½®**

```csharp
public class ServerConfig
{
    public string Name { get; set; } = "My Server";
    public NetworkSettings Network { get; set; } = new();
    public List<WorldSettings> Worlds { get; set; } = new();
}

public class NetworkSettings
{
    public string Host { get; set; } = "0.0.0.0";
    public int Port { get; set; } = 25565;
    public int MaxConnections { get; set; } = 100;
}

public class WorldSettings
{
    public string Name { get; set; } = string.Empty;
    public string Seed { get; set; } = string.Empty;
    public Difficulty Difficulty { get; set; } = Difficulty.Normal;
}
```

ç”Ÿæˆçš„ YAMLï¼š

```yaml
name: "My Server"
network:
  host: "0.0.0.0"
  port: 25565
  max_connections: 100
worlds:
  - name: "world"
    seed: "12345"
    difficulty: Normal
  - name: "world_nether"
    seed: "67890"
    difficulty: Hard
```

### **å¯é€‰å­—æ®µ**

```csharp
public class OptionalConfig
{
    // å¯ä¸º null çš„å­—æ®µ
    public string? OptionalName { get; set; }
    public int? OptionalNumber { get; set; }
    
    // ä½¿ç”¨é»˜è®¤å€¼
    public string RequiredName { get; set; } = "Default";
}
```

---

## ğŸš€ **é«˜çº§åŠŸèƒ½**

### **1. é…ç½®éªŒè¯**

```csharp
public class ValidatedConfig
{
    private int _maxPlayers = 100;
    
    public int MaxPlayers
    {
        get => _maxPlayers;
        set
        {
            if (value < 1 || value > 1000)
                throw new ArgumentException("MaxPlayers å¿…é¡»åœ¨ 1-1000 ä¹‹é—´");
            _maxPlayers = value;
        }
    }
    
    public void Validate()
    {
        if (string.IsNullOrEmpty(ServerName))
            throw new InvalidOperationException("ServerName ä¸èƒ½ä¸ºç©º");
        
        if (Port < 1024 || Port > 65535)
            throw new InvalidOperationException("Port å¿…é¡»åœ¨ 1024-65535 ä¹‹é—´");
    }
    
    public string ServerName { get; set; } = "Server";
    public int Port { get; set; } = 25565;
}

// ä½¿ç”¨
var config = await _context.ConfigManager.LoadConfigAsync<ValidatedConfig>("config");
try
{
    config.Validate();
}
catch (Exception ex)
{
    _context.Logger.Error($"é…ç½®éªŒè¯å¤±è´¥: {ex.Message}");
}
```

### **2. é…ç½®è¿ç§»**

```csharp
public class ConfigMigration
{
    public static MyConfigV2 MigrateFrom(MyConfigV1 oldConfig)
    {
        return new MyConfigV2
        {
            // ä¿ç•™æ—§å­—æ®µ
            Name = oldConfig.Name,
            
            // è½¬æ¢å­—æ®µ
            MaxConnections = oldConfig.MaxPlayers,
            
            // æ·»åŠ æ–°å­—æ®µï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
            EnableNewFeature = true
        };
    }
}

// ä½¿ç”¨
if (_context.ConfigManager.ConfigExists("config_v1"))
{
    var oldConfig = await _context.ConfigManager.LoadConfigAsync<MyConfigV1>("config_v1");
    var newConfig = ConfigMigration.MigrateFrom(oldConfig);
    await _context.ConfigManager.SaveConfigAsync("config", newConfig);
    await _context.ConfigManager.DeleteConfigAsync("config_v1");
}
```

### **3. å¤šé…ç½®æ–‡ä»¶**

```csharp
using NetherGate.API.Plugins;

public class MyPlugin : PluginBase
{
    private MainConfig _mainConfig = null!;
    private DatabaseConfig _dbConfig = null!;
    private FeatureConfig _featureConfig = null!;

    public override async Task OnEnableAsync()
    {
        // åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶
        _mainConfig = await Config.LoadAsync<MainConfig>("config");
        _dbConfig = await Config.LoadAsync<DatabaseConfig>("database");
        _featureConfig = await Config.LoadAsync<FeatureConfig>("features");
        
        Logger.Info("æ‰€æœ‰é…ç½®æ–‡ä»¶å·²åŠ è½½");
    }
}
```

ç›®å½•ç»“æ„ï¼š
```
config/MyPlugin/
â”œâ”€â”€ config.yaml
â”œâ”€â”€ database.yaml
â””â”€â”€ features.yaml
```

### **4. é…ç½®çƒ­é‡è½½**

```csharp
public class MyPlugin : IPlugin
{
    private MyConfig _config;
    private FileSystemWatcher _watcher;

    public async void OnEnable(IPluginContext context)
    {
        _config = await context.ConfigManager.LoadConfigAsync<MyConfig>("config");
        
        // ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–
        var configPath = Path.Combine(context.DataDirectory, "config.yaml");
        _watcher = new FileSystemWatcher(Path.GetDirectoryName(configPath))
        {
            Filter = Path.GetFileName(configPath),
            NotifyFilter = NotifyFilters.LastWrite
        };
        
        _watcher.Changed += async (s, e) =>
        {
            await Task.Delay(100); // ç­‰å¾…æ–‡ä»¶å†™å…¥å®Œæˆ
            _config = await context.ConfigManager.ReloadConfigAsync<MyConfig>("config");
            context.Logger.Info("é…ç½®å·²é‡æ–°åŠ è½½");
            OnConfigReloaded();
        };
        
        _watcher.EnableRaisingEvents = true;
    }

    private void OnConfigReloaded()
    {
        // åº”ç”¨æ–°é…ç½®
        _context.Logger.Info($"æ–°çš„æœ€å¤§ç©å®¶æ•°: {_config.MaxPlayers}");
    }

    public void OnDisable()
    {
        _watcher?.Dispose();
    }
}
```

### **5. åŠ å¯†æ•æ„Ÿé…ç½®**

```csharp
public class SecureConfig
{
    public string DatabasePassword { get; set; } = "";
    public string ApiKey { get; set; } = "";
}

// ä¿å­˜å‰åŠ å¯†
public async Task SaveSecureConfigAsync(SecureConfig config)
{
    var encrypted = new SecureConfig
    {
        DatabasePassword = Encrypt(config.DatabasePassword),
        ApiKey = Encrypt(config.ApiKey)
    };
    
    await _context.ConfigManager.SaveConfigAsync("secure", encrypted);
}

// åŠ è½½åè§£å¯†
public async Task<SecureConfig> LoadSecureConfigAsync()
{
    var encrypted = await _context.ConfigManager.LoadConfigAsync<SecureConfig>("secure");
    
    return new SecureConfig
    {
        DatabasePassword = Decrypt(encrypted.DatabasePassword),
        ApiKey = Decrypt(encrypted.ApiKey)
    };
}

private string Encrypt(string text)
{
    // ä½¿ç”¨ AES æˆ–å…¶ä»–åŠ å¯†ç®—æ³•
    // è¯¦ç»†å®ç°ç•¥
    return Convert.ToBase64String(/* encrypted bytes */);
}

private string Decrypt(string encrypted)
{
    // è§£å¯†
    return /* decrypted text */;
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. ä½¿ç”¨æœ‰æ„ä¹‰çš„é»˜è®¤å€¼**

âœ… **æ¨èï¼š**
```csharp
public class Config
{
    public string ServerName { get; set; } = "My Minecraft Server";
    public int MaxPlayers { get; set; } = 20;
    public bool EnablePvP { get; set; } = true;
}
```

âŒ **ä¸æ¨èï¼š**
```csharp
public class Config
{
    public string ServerName { get; set; } = "";  // ç©ºå€¼ä¸å‹å¥½
    public int MaxPlayers { get; set; } = 0;      // æ— æ„ä¹‰çš„é»˜è®¤å€¼
}
```

### **2. åˆ†ç»„ç›¸å…³é…ç½®**

âœ… **æ¨èï¼š**
```csharp
public class Config
{
    public ServerSettings Server { get; set; } = new();
    public FeatureToggles Features { get; set; } = new();
    public MessagesConfig Messages { get; set; } = new();
}
```

âŒ **ä¸æ¨èï¼š**
```csharp
public class Config
{
    public string ServerName { get; set; }
    public bool FeatureA { get; set; }
    public string MessageA { get; set; }
    public int ServerPort { get; set; }
    public bool FeatureB { get; set; }
    // æ‚ä¹±æ— ç« 
}
```

### **3. æ·»åŠ æ³¨é‡Šï¼ˆYAMLï¼‰**

```csharp
// åœ¨ä¿å­˜æ—¶æ‰‹åŠ¨æ·»åŠ æ³¨é‡Š
var yaml = @"# æœåŠ¡å™¨é…ç½®
# ä¿®æ”¹åéœ€è¦é‡å¯

server_name: ""My Server""  # æœåŠ¡å™¨åç§°
max_players: 20             # æœ€å¤§ç©å®¶æ•°ï¼ˆ1-100ï¼‰
";
```

### **4. ç‰ˆæœ¬åŒ–é…ç½®**

```csharp
public class Config
{
    public int ConfigVersion { get; set; } = 2;  // é…ç½®ç‰ˆæœ¬å·
    
    // å…¶ä»–é…ç½®...
}

// åŠ è½½æ—¶æ£€æŸ¥ç‰ˆæœ¬
var config = await _context.ConfigManager.LoadConfigAsync<Config>("config");
if (config.ConfigVersion < 2)
{
    // æ‰§è¡Œè¿ç§»
    config = MigrateToV2(config);
    config.ConfigVersion = 2;
    await _context.ConfigManager.SaveConfigAsync("config", config);
}
```

### **5. é…ç½®å¤‡ä»½**

```csharp
// åœ¨ä¿å­˜å‰å¤‡ä»½
public async Task SaveConfigWithBackupAsync(MyConfig config)
{
    var configPath = Path.Combine(_context.DataDirectory, "config.yaml");
    
    if (File.Exists(configPath))
    {
        var backupPath = Path.Combine(
            _context.DataDirectory, 
            $"config.yaml.backup.{DateTime.Now:yyyyMMdd_HHmmss}"
        );
        File.Copy(configPath, backupPath);
    }
    
    await _context.ConfigManager.SaveConfigAsync("config", config);
}
```

---

## ğŸ› **å¸¸è§é—®é¢˜**

### **Q: é…ç½®æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ**

**A:** é…ç½®æ–‡ä»¶ä½äº `config/<PluginName>/` ç›®å½•ã€‚

ä¾‹å¦‚ï¼š
```
config/
â”œâ”€â”€ MyPlugin/
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ database.yaml
â””â”€â”€ AnotherPlugin/
    â””â”€â”€ config.yaml
```

### **Q: å¦‚ä½•å¤„ç†é…ç½®é”™è¯¯ï¼Ÿ**

**A:** ä½¿ç”¨ try-catch å¤„ç†ï¼š

```csharp
try
{
    _config = await _context.ConfigManager.LoadConfigAsync<MyConfig>("config");
    _config.Validate();
}
catch (Exception ex)
{
    _context.Logger.Error($"é…ç½®åŠ è½½å¤±è´¥: {ex.Message}");
    _config = new MyConfig(); // ä½¿ç”¨é»˜è®¤é…ç½®
}
```

### **Q: YAML å’Œ JSON å¯ä»¥æ··ç”¨å—ï¼Ÿ**

**A:** å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚å»ºè®®ç»Ÿä¸€ä½¿ç”¨ YAMLã€‚

```csharp
var config1 = await _context.ConfigManager.LoadConfigAsync<Config>("config.yaml");
var config2 = await _context.ConfigManager.LoadConfigAsync<Config>("other.json");
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ’ä»¶å¼€å‘æŒ‡å—](./æ’ä»¶å¼€å‘æŒ‡å—.md)
- [API å‚è€ƒ](./APIå‚è€ƒ.md)
- [é…ç½®æ–‡ä»¶è¯¦è§£](../05-é…ç½®å’Œéƒ¨ç½²/é…ç½®æ–‡ä»¶è¯¦è§£.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
