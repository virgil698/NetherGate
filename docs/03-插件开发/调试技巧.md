# æ’ä»¶è°ƒè¯•æŠ€å·§

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•é«˜æ•ˆåœ°è°ƒè¯• NetherGate æ’ä»¶ï¼Œå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [è°ƒè¯•ç¯å¢ƒé…ç½®](#è°ƒè¯•ç¯å¢ƒé…ç½®)
- [æ—¥å¿—è°ƒè¯•](#æ—¥å¿—è°ƒè¯•)
- [æ–­ç‚¹è°ƒè¯•](#æ–­ç‚¹è°ƒè¯•)
- [å¸¸è§é—®é¢˜è¯Šæ–­](#å¸¸è§é—®é¢˜è¯Šæ–­)
- [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
- [è°ƒè¯•å·¥å…·](#è°ƒè¯•å·¥å…·)

---

## âš™ï¸ **è°ƒè¯•ç¯å¢ƒé…ç½®**

### **1. Visual Studio é…ç½®**

**launch.json:**
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": ".NET Core Launch (console)",
            "type": "coreclr",
            "request": "launch",
            "preLaunchTask": "build",
            "program": "${workspaceFolder}/../NetherGate/bin/Debug/net9.0/NetherGate.Host.dll",
            "args": [],
            "cwd": "${workspaceFolder}/../NetherGate/bin/Debug/net9.0",
            "console": "internalConsole",
            "stopAtEntry": false
        },
        {
            "name": ".NET Core Attach",
            "type": "coreclr",
            "request": "attach",
            "processId": "${command:pickProcess}"
        }
    ]
}
```

**tasks.json:**
```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "build",
            "command": "dotnet",
            "type": "process",
            "args": [
                "build",
                "${workspaceFolder}/MyPlugin.csproj",
                "/property:GenerateFullPaths=true",
                "/consoleloggerparameters:NoSummary"
            ],
            "problemMatcher": "$msCompile"
        },
        {
            "label": "build-and-copy",
            "dependsOn": ["build"],
            "type": "shell",
            "command": "xcopy",
            "args": [
                "/Y",
                "/E",
                "${workspaceFolder}\\bin\\Debug\\net9.0\\*",
                "${workspaceFolder}\\..\\NetherGate\\bin\\Debug\\plugins\\MyPlugin\\"
            ],
            "problemMatcher": []
        }
    ]
}
```

### **2. Rider é…ç½®**

1. **åˆ›å»ºè¿è¡Œé…ç½®**
   - Run â†’ Edit Configurations
   - æ·»åŠ  .NET Project
   - é€‰æ‹© NetherGate.Host é¡¹ç›®
   - è®¾ç½®å·¥ä½œç›®å½•ä¸º NetherGate bin ç›®å½•

2. **é…ç½®æ’ä»¶è‡ªåŠ¨å¤åˆ¶**
   - Build Events â†’ Post-build event
   - æ·»åŠ å¤åˆ¶å‘½ä»¤

### **3. VS Code é…ç½®**

å®‰è£…æ‰©å±•ï¼š
- C# Dev Kit
- C# 
- .NET Runtime Install Tool

é…ç½®åŒ Visual Studioã€‚

---

## ğŸ“ **æ—¥å¿—è°ƒè¯•**

### **1. ä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«**

```csharp
using NetherGate.API.Plugins;

public class MyPlugin : PluginBase
{
    public override async Task OnEnableAsync()
    {
        // Debugï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ï¼‰
        Logger.Debug("æ’ä»¶åˆå§‹åŒ–å¼€å§‹");
        Logger.Debug($"æ•°æ®ç›®å½•: {DataDirectory}");
        
        // Infoï¼šä¸€èˆ¬ä¿¡æ¯ï¼ˆæ­£å¸¸è¿è¡Œæ—¥å¿—ï¼‰
        Logger.Info("MyPlugin å·²å¯ç”¨");
        Logger.Info($"æ’ä»¶ç‰ˆæœ¬: {Metadata.Version}");
        
        // Warningï¼šè­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ä½†éœ€è¦æ³¨æ„ï¼‰
        Logger.Warning("é…ç½®æ–‡ä»¶ä½¿ç”¨é»˜è®¤å€¼");
        
        // Errorï¼šé”™è¯¯ï¼ˆå½±å“åŠŸèƒ½ï¼Œéœ€è¦å¤„ç†ï¼‰
        Logger.Error("æ•°æ®åº“è¿æ¥å¤±è´¥");
    }
}
```

### **2. ç»“æ„åŒ–æ—¥å¿—**

```csharp
// âŒ ä¸æ¨èï¼šå•è¡Œé•¿æ–‡æœ¬
Logger.Info($"Player {playerName} joined at {position} with {health} health");

// âœ… æ¨èï¼šç»“æ„åŒ–è¾“å‡º
Logger.Info("=== ç©å®¶åŠ å…¥äº‹ä»¶ ===");
Logger.Info($"  ç©å®¶åç§°: {playerName}");
Logger.Info($"  UUID: {playerUuid}");
Logger.Info($"  ä½ç½®: X={position.X:F2}, Y={position.Y:F2}, Z={position.Z:F2}");
Logger.Info($"  ç»´åº¦: {position.Dimension}");
Logger.Info($"  ç”Ÿå‘½å€¼: {health}/20");
Logger.Info("=====================");
```

### **3. æ¡ä»¶æ—¥å¿—**

```csharp
// ä½¿ç”¨ PluginBase
public class MyPlugin : IPlugin
{
    private bool _debugMode = false;

    public void OnEnable(IPluginContext context)
    {
        // ä»é…ç½®è¯»å–
        _debugMode = config.DebugMode;
        
        if (_debugMode)
        {
            _context.Logger.Info("è°ƒè¯•æ¨¡å¼å·²å¯ç”¨");
        }
    }

    private void DebugLog(string message)
    {
        if (_debugMode)
        {
            _context.Logger.Debug($"[DEBUG] {message}");
        }
    }

    private void OnPlayerJoined(PlayerJoinedEvent e)
    {
        DebugLog($"å¤„ç†ç©å®¶åŠ å…¥: {e.Player.Name}");
        
        // ä¸šåŠ¡é€»è¾‘...
        
        DebugLog("ç©å®¶åŠ å…¥å¤„ç†å®Œæˆ");
    }
}
```

### **4. æ—¥å¿—æ–‡ä»¶åˆ†æ**

```csharp
public class LogAnalyzer
{
    public void AnalyzeLog(string logPath)
    {
        var lines = File.ReadAllLines(logPath);
        
        var errors = lines.Where(l => l.Contains("[ERROR]")).ToList();
        var warnings = lines.Where(l => l.Contains("[WARNING]")).ToList();
        
        Console.WriteLine($"é”™è¯¯æ•°é‡: {errors.Count}");
        Console.WriteLine($"è­¦å‘Šæ•°é‡: {warnings.Count}");
        
        // åˆ†ææœ€å¸¸è§çš„é”™è¯¯
        var errorGroups = errors
            .GroupBy(e => ExtractErrorMessage(e))
            .OrderByDescending(g => g.Count())
            .Take(10);
        
        Console.WriteLine("\næœ€å¸¸è§çš„é”™è¯¯:");
        foreach (var group in errorGroups)
        {
            Console.WriteLine($"{group.Count()}x: {group.Key}");
        }
    }

    private string ExtractErrorMessage(string logLine)
    {
        // æå–é”™è¯¯æ¶ˆæ¯
        var match = Regex.Match(logLine, @"\[ERROR\]:\s*(.+)");
        return match.Success ? match.Groups[1].Value : logLine;
    }
}
```

---

## ğŸ› **æ–­ç‚¹è°ƒè¯•**

### **1. è®¾ç½®æ–­ç‚¹**

```csharp
public async void OnPlayerJoined(PlayerJoinedEvent e)
{
    // åœ¨è¿™é‡Œè®¾ç½®æ–­ç‚¹ ğŸ‘‡
    var playerName = e.Player.Name;
    
    // æ£€æŸ¥ç©å®¶æ•°æ®
    var playerData = await _service.GetPlayerDataAsync(playerName);
    
    // å‘é€æ¬¢è¿æ¶ˆæ¯ ğŸ‘‡ è®¾ç½®æ¡ä»¶æ–­ç‚¹
    if (playerData.IsNewPlayer)
    {
        await SendWelcomeMessage(playerName);
    }
}
```

### **2. æ¡ä»¶æ–­ç‚¹**

åœ¨ IDE ä¸­å³é”®æ–­ç‚¹ â†’ æ·»åŠ æ¡ä»¶ï¼š

```csharp
// åªåœ¨ç‰¹å®šç©å®¶æ—¶ä¸­æ–­
playerName == "Steve"

// åªåœ¨æ»¡è¶³æ¡ä»¶æ—¶ä¸­æ–­
playerData.Level > 100

// åªåœ¨å¼‚å¸¸æ—¶ä¸­æ–­
ex != null
```

### **3. æŸ¥çœ‹å˜é‡**

åœ¨æ–­ç‚¹å¤„ï¼ŒæŸ¥çœ‹ï¼š
- **å±€éƒ¨å˜é‡**
- **this (å½“å‰å¯¹è±¡)**
- **è°ƒç”¨å †æ ˆ**

### **4. å³æ—¶çª—å£ï¼ˆImmediate Windowï¼‰**

åœ¨è°ƒè¯•æ—¶æ‰§è¡Œä»£ç ï¼š

```csharp
// æŸ¥çœ‹å˜é‡
? playerName
"Steve"

// è°ƒç”¨æ–¹æ³•
? _service.GetBalance(playerName)
100

// ä¿®æ”¹å˜é‡
playerData.Level = 999
```

---

## ğŸ” **å¸¸è§é—®é¢˜è¯Šæ–­**

### **1. æ’ä»¶æœªåŠ è½½**

**æ£€æŸ¥æ¸…å•ï¼š**

```csharp
// 1. plugin.json æ˜¯å¦å­˜åœ¨ï¼Ÿ
// 2. entry_point æ˜¯å¦æ­£ç¡®ï¼Ÿ
{
  "entry_point": "MyPlugin.MyPlugin"  // å‘½åç©ºé—´.ç±»å
}

// 3. ç±»æ˜¯å¦å®ç° IPluginï¼Ÿ
public class MyPlugin : IPlugin  // âœ…

// 4. æ˜¯å¦æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Ÿ
public class MyPlugin : IPlugin
{
    // âœ… é»˜è®¤æ„é€ å‡½æ•°
    
    // âŒ ä¸è¦åªæœ‰æœ‰å‚æ„é€ å‡½æ•°
    public MyPlugin(string arg) { }
}

// 5. æ£€æŸ¥æ—¥å¿—
// logs/latest.log ä¸­æœç´¢æ’ä»¶å
```

### **2. äº‹ä»¶æœªè§¦å‘**

```csharp
// é—®é¢˜è¯Šæ–­
public void OnEnable(IPluginContext context)
{
    _context = context;
    
    // âœ… æ­£ç¡®ï¼šè®¢é˜…äº‹ä»¶
    _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    _context.Logger.Info("å·²è®¢é˜… PlayerJoinedEvent");
    
    // âŒ å¸¸è§é”™è¯¯ï¼šå¿˜è®°è®¢é˜…
    // æ²¡æœ‰ Subscribe è°ƒç”¨
}

private void OnPlayerJoined(PlayerJoinedEvent e)
{
    // æ·»åŠ æ—¥å¿—ç¡®è®¤äº‹ä»¶è§¦å‘
    _context.Logger.Info($"[EVENT] PlayerJoinedEvent è§¦å‘: {e.Player.Name}");
    
    // ä¸šåŠ¡é€»è¾‘...
}

// æµ‹è¯•æ–¹æ³•
public void TestEvent()
{
    // æ‰‹åŠ¨è§¦å‘æµ‹è¯•
    var testEvent = new PlayerJoinedEvent(
        new PlayerInfo { Name = "TestPlayer" },
        "TestPlayer joined"
    );
    
    OnPlayerJoined(testEvent);
}
```

### **3. å‘½ä»¤æ— å“åº”**

```csharp
public class TestCommand : ICommand
{
    public string Name => "test";
    public string Description => "æµ‹è¯•å‘½ä»¤";

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        // æ·»åŠ æ—¥å¿—
        _context.Logger.Info($"å‘½ä»¤æ‰§è¡Œ: sender={sender?.Name ?? "Console"}, args={string.Join(",", args)}");
        
        try
        {
            // ä¸šåŠ¡é€»è¾‘
            return CommandResult.Success("å‘½ä»¤æ‰§è¡ŒæˆåŠŸ");
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"å‘½ä»¤æ‰§è¡Œå¤±è´¥: {ex.Message}");
            _context.Logger.Error($"å †æ ˆ: {ex.StackTrace}");
            return CommandResult.Fail($"é”™è¯¯: {ex.Message}");
        }
    }
}

// æ³¨å†Œæ£€æŸ¥
public void OnEnable(IPluginContext context)
{
    _context.CommandManager.RegisterCommand(new TestCommand());
    _context.Logger.Info("TestCommand å·²æ³¨å†Œ");
    
    // éªŒè¯æ³¨å†Œ
    var commands = _context.CommandManager.GetRegisteredCommands();
    _context.Logger.Info($"å·²æ³¨å†Œå‘½ä»¤: {string.Join(", ", commands)}");
}
```

### **4. é…ç½®åŠ è½½å¤±è´¥**

```csharp
public async void OnEnable(IPluginContext context)
{
    try
    {
        _context.Logger.Info("å¼€å§‹åŠ è½½é…ç½®");
        
        // æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        var configPath = Path.Combine(_context.DataDirectory, "config.yaml");
        _context.Logger.Info($"é…ç½®æ–‡ä»¶è·¯å¾„: {configPath}");
        _context.Logger.Info($"æ–‡ä»¶æ˜¯å¦å­˜åœ¨: {File.Exists(configPath)}");
        
        // åŠ è½½é…ç½®
        _config = await _context.ConfigManager.LoadConfigAsync<MyConfig>("config");
        _context.Logger.Info($"é…ç½®åŠ è½½æˆåŠŸ: {JsonSerializer.Serialize(_config)}");
    }
    catch (Exception ex)
    {
        _context.Logger.Error($"é…ç½®åŠ è½½å¤±è´¥: {ex.Message}");
        _context.Logger.Error($"å¼‚å¸¸ç±»å‹: {ex.GetType().Name}");
        _context.Logger.Error($"å †æ ˆ: {ex.StackTrace}");
        
        // ä½¿ç”¨é»˜è®¤é…ç½®
        _config = new MyConfig();
        _context.Logger.Info("ä½¿ç”¨é»˜è®¤é…ç½®");
    }
}
```

---

## ğŸ“Š **æ€§èƒ½åˆ†æ**

### **1. è®¡æ—¶å™¨**

```csharp
public class PerformanceTimer : IDisposable
{
    private readonly string _operationName;
    private readonly ILogger _logger;
    private readonly Stopwatch _stopwatch;
    private readonly int _warningThresholdMs;

    public PerformanceTimer(string operationName, ILogger logger, int warningThresholdMs = 100)
    {
        _operationName = operationName;
        _logger = logger;
        _warningThresholdMs = warningThresholdMs;
        _stopwatch = Stopwatch.StartNew();
        
        _logger.Debug($"[æ€§èƒ½] {_operationName} å¼€å§‹");
    }

    public void Dispose()
    {
        _stopwatch.Stop();
        var elapsed = _stopwatch.ElapsedMilliseconds;
        
        if (elapsed > _warningThresholdMs)
        {
            _logger.Warning($"[æ€§èƒ½] {_operationName} è€—æ—¶ {elapsed}ms (è¶…è¿‡é˜ˆå€¼ {_warningThresholdMs}ms)");
        }
        else
        {
            _logger.Debug($"[æ€§èƒ½] {_operationName} è€—æ—¶ {elapsed}ms");
        }
    }
}

// ä½¿ç”¨
public async Task ProcessDataAsync()
{
    using (new PerformanceTimer("å¤„ç†æ•°æ®", _context.Logger, 500))
    {
        // ä¸šåŠ¡é€»è¾‘
        await LoadDataAsync();
        await ProcessAsync();
        await SaveAsync();
    }
}
```

### **2. å†…å­˜åˆ†æ**

```csharp
public class MemoryAnalyzer
{
    public void LogMemoryUsage(ILogger logger)
    {
        var before = GC.GetTotalMemory(false);
        
        GC.Collect();
        GC.WaitForPendingFinalizers();
        GC.Collect();
        
        var after = GC.GetTotalMemory(false);
        
        logger.Info($"=== å†…å­˜ä½¿ç”¨ ===");
        logger.Info($"å›æ”¶å‰: {before / 1024 / 1024} MB");
        logger.Info($"å›æ”¶å: {after / 1024 / 1024} MB");
        logger.Info($"å›æ”¶é‡: {(before - after) / 1024 / 1024} MB");
        
        // åˆ†ä»£ç»Ÿè®¡
        logger.Info($"Gen 0 å›æ”¶æ¬¡æ•°: {GC.CollectionCount(0)}");
        logger.Info($"Gen 1 å›æ”¶æ¬¡æ•°: {GC.CollectionCount(1)}");
        logger.Info($"Gen 2 å›æ”¶æ¬¡æ•°: {GC.CollectionCount(2)}");
    }
}

// å®šæœŸç›‘æ§
private Timer? _memoryMonitor;

public void OnEnable(IPluginContext context)
{
    _memoryMonitor = new Timer(_ =>
    {
        new MemoryAnalyzer().LogMemoryUsage(_context.Logger);
    }, null, TimeSpan.FromMinutes(5), TimeSpan.FromMinutes(5));
}
```

---

## ğŸ› ï¸ **è°ƒè¯•å·¥å…·**

### **1. è¯Šæ–­å‘½ä»¤**

```csharp
public class DiagnoseCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "diagnose";
    public string Description => "è¯Šæ–­æ’ä»¶çŠ¶æ€";
    public string? Permission => "myplugin.admin";

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        var report = new StringBuilder();
        report.AppendLine("=== æ’ä»¶è¯Šæ–­æŠ¥å‘Š ===");
        report.AppendLine($"æ’ä»¶ç‰ˆæœ¬: {_context.Metadata.Version}");
        report.AppendLine($"å¯åŠ¨æ—¶é—´: {_startTime}");
        report.AppendLine($"è¿è¡Œæ—¶é•¿: {DateTime.UtcNow - _startTime}");
        
        // å†…å­˜
        var memory = GC.GetTotalMemory(false) / 1024 / 1024;
        report.AppendLine($"å†…å­˜ä½¿ç”¨: {memory} MB");
        
        // ç¼“å­˜
        report.AppendLine($"ç¼“å­˜æ¡ç›®: {_cache.Count}");
        
        // äº‹ä»¶è®¢é˜…
        report.AppendLine($"äº‹ä»¶è®¢é˜…æ•°: {_eventSubscriptions.Count}");
        
        // æ€§èƒ½ç»Ÿè®¡
        report.AppendLine($"æ€»è¯·æ±‚æ•°: {_totalRequests}");
        report.AppendLine($"å¹³å‡å“åº”æ—¶é—´: {_avgResponseTime:F2}ms");
        
        return CommandResult.Success(report.ToString());
    }
}
```

### **2. å•å…ƒæµ‹è¯•**

```csharp
using Xunit;
using Moq;

public class MyPluginTests
{
    [Fact]
    public async Task TestPlayerJoinedEvent()
    {
        // Arrange
        var mockContext = new Mock<IPluginContext>();
        var mockLogger = new Mock<ILogger>();
        mockContext.Setup(c => c.Logger).Returns(mockLogger.Object);
        
        var plugin = new MyPlugin();
        plugin.OnEnable(mockContext.Object);
        
        // Act
        var testEvent = new PlayerJoinedEvent(
            new PlayerInfo { Name = "TestPlayer" },
            "TestPlayer joined"
        );
        
        // è§¦å‘äº‹ä»¶å¤„ç†
        // ...
        
        // Assert
        mockLogger.Verify(l => l.Info(It.IsAny<string>()), Times.AtLeastOnce());
    }
}
```

### **3. é›†æˆæµ‹è¯•**

```csharp
public class IntegrationTests
{
    [Fact]
    public async Task TestFullWorkflow()
    {
        // å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
        var testEnv = new TestEnvironment();
        await testEnv.StartAsync();
        
        try
        {
            // åŠ è½½æ’ä»¶
            await testEnv.LoadPluginAsync("MyPlugin");
            
            // æ¨¡æ‹Ÿç©å®¶åŠ å…¥
            await testEnv.SimulatePlayerJoinAsync("TestPlayer");
            
            // éªŒè¯ç»“æœ
            var logs = testEnv.GetLogs();
            Assert.Contains("TestPlayer åŠ å…¥äº†æœåŠ¡å™¨", logs);
            
            // æ‰§è¡Œå‘½ä»¤
            var result = await testEnv.ExecuteCommandAsync("test", "TestPlayer");
            Assert.True(result.Success);
        }
        finally
        {
            await testEnv.StopAsync();
        }
    }
}
```

---

## ğŸ’¡ **è°ƒè¯•æŠ€å·§æ€»ç»“**

### **å¿«é€Ÿå®šä½é—®é¢˜**

1. **æ£€æŸ¥æ—¥å¿—** - 90% çš„é—®é¢˜éƒ½èƒ½é€šè¿‡æ—¥å¿—æ‰¾åˆ°
2. **æ·»åŠ æ–­ç‚¹** - æŸ¥çœ‹è¿è¡Œæ—¶çŠ¶æ€
3. **é€æ­¥æ‰§è¡Œ** - è·Ÿè¸ªä»£ç æµç¨‹
4. **éªŒè¯å‡è®¾** - ä½¿ç”¨æ–­è¨€å’Œæ—¥å¿—éªŒè¯

### **æé«˜è°ƒè¯•æ•ˆç‡**

1. **ç»“æ„åŒ–ä»£ç ** - æ˜“äºè°ƒè¯•å’Œæµ‹è¯•
2. **æ·»åŠ æ—¥å¿—** - å…³é”®è·¯å¾„éƒ½è¦æœ‰æ—¥å¿—
3. **å•å…ƒæµ‹è¯•** - åŠæ—©å‘ç°é—®é¢˜
4. **ä»£ç å®¡æŸ¥** - é¿å…å¸¸è§é”™è¯¯

### **é¿å…çš„åšæ³•**

- âŒ åˆ é™¤æ‰€æœ‰æ—¥å¿—ï¼ˆä¸Šç”Ÿäº§åæ— æ³•æ’æŸ¥ï¼‰
- âŒ ä½¿ç”¨ `try-catch` åæ‰æ‰€æœ‰å¼‚å¸¸
- âŒ ä¸è®°å½•å¼‚å¸¸å †æ ˆ
- âŒ åœ¨å¾ªç¯ä¸­æ‰“å°å¤§é‡æ—¥å¿—

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ€§èƒ½ä¼˜åŒ–](../07-ç¤ºä¾‹å’Œæœ€ä½³å®è·µ/æ€§èƒ½ä¼˜åŒ–.md)
- [æ’ä»¶å¼€å‘æŒ‡å—](./æ’ä»¶å¼€å‘æŒ‡å—.md)
- [FAQ](../08-å‚è€ƒ/FAQ.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
