# NetherGate æ’ä»¶å¼€å‘æŒ‡å—

æœ¬æŒ‡å—å°†å¸¦ä½ ä»é›¶å¼€å§‹åˆ›å»ºç¬¬ä¸€ä¸ª NetherGate æ’ä»¶ï¼Œå¹¶ä»‹ç»æ’ä»¶å¼€å‘çš„æ ¸å¿ƒæ¦‚å¿µå’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‹ **ç›®å½•**

- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶](#åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶)
- [æ’ä»¶ç»“æ„](#æ’ä»¶ç»“æ„)
- [plugin.json é…ç½®](#pluginjson-é…ç½®)
- [æ’ä»¶ç”Ÿå‘½å‘¨æœŸ](#æ’ä»¶ç”Ÿå‘½å‘¨æœŸ)
- [IPluginContext æ¥å£](#iplugincontext-æ¥å£)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)
- [è°ƒè¯•æ’ä»¶](#è°ƒè¯•æ’ä»¶)
- [å‘å¸ƒæ’ä»¶](#å‘å¸ƒæ’ä»¶)

---

## ğŸ”§ **ç¯å¢ƒå‡†å¤‡**

### **1. å®‰è£…å·¥å…·**

- **.NET 9.0 SDK** æˆ–æ›´é«˜ç‰ˆæœ¬
  - ä¸‹è½½ï¼šhttps://dotnet.microsoft.com/download
  - éªŒè¯ï¼š`dotnet --version`

- **IDE**ï¼ˆé€‰æ‹©ä¸€ä¸ªï¼‰
  - Visual Studio 2022
  - JetBrains Rider
  - Visual Studio Code + C# Dev Kit

### **2. è·å– NetherGate.API**

#### **æ–¹å¼ 1ï¼šä»æºç å¼•ç”¨**

```bash
git clone https://github.com/your-org/NetherGate.git
# ç„¶ååœ¨æ’ä»¶é¡¹ç›®ä¸­å¼•ç”¨ NetherGate.API.csproj
```

#### **æ–¹å¼ 2ï¼šä» NuGet å®‰è£…**ï¼ˆå¦‚æœå·²å‘å¸ƒï¼‰

```bash
dotnet add package NetherGate.API
```

---

## ğŸš€ **åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶**

### **1. åˆ›å»ºé¡¹ç›®**

```bash
# åˆ›å»ºæ–°çš„ç±»åº“é¡¹ç›®
dotnet new classlib -n HelloWorldPlugin
cd HelloWorldPlugin

# æ·»åŠ  NetherGate.API å¼•ç”¨
dotnet add reference ../NetherGate/src/NetherGate.API/NetherGate.API.csproj
```

### **2. é…ç½®é¡¹ç›®æ–‡ä»¶**

ç¼–è¾‘ `HelloWorldPlugin.csproj`ï¼š

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <!-- ç›®æ ‡æ¡†æ¶ -->
    <TargetFramework>net9.0</TargetFramework>
    
    <!-- å¯ç”¨åŠ¨æ€åŠ è½½ï¼ˆå¿…é¡»ï¼‰ -->
    <EnableDynamicLoading>true</EnableDynamicLoading>
    
    <!-- å¯ä¸º null çš„å¼•ç”¨ç±»å‹ -->
    <Nullable>enable</Nullable>
    
    <!-- æ’ä»¶ç‰ˆæœ¬ -->
    <Version>1.0.0</Version>
  </PropertyGroup>

  <ItemGroup>
    <!-- NetherGate API å¼•ç”¨ -->
    <PackageReference Include="NetherGate.API" Version="1.0.0" PrivateAssets="all" />
  </ItemGroup>

  <!-- æ„å»ºåè‡ªåŠ¨å¤åˆ¶åˆ° plugins ç›®å½• -->
  <Target Name="CopyToPlugins" AfterTargets="Build">
    <ItemGroup>
      <PluginFiles Include="$(OutputPath)**\*.*" />
    </ItemGroup>
    <Copy 
      SourceFiles="@(PluginFiles)" 
      DestinationFolder="$(SolutionDir)..\NetherGate\bin\$(Configuration)\plugins\$(ProjectName)\%(RecursiveDir)" 
      SkipUnchangedFiles="true" />
  </Target>
</Project>
```

### **3. åˆ›å»ºæ’ä»¶ä¸»ç±»**

åˆ é™¤ `Class1.cs`ï¼Œåˆ›å»º `HelloWorldPlugin.cs`ï¼š

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;

namespace HelloWorldPlugin;

public class HelloWorldPlugin : PluginBase
{
    public override Task OnLoadAsync()
    {
        // æ’ä»¶åŠ è½½æ—¶è°ƒç”¨
        Console.WriteLine("[HelloWorld] æ’ä»¶æ­£åœ¨åŠ è½½...");
        return Task.CompletedTask;
    }

    public override Task OnEnableAsync()
    {
        // æ’ä»¶å¯ç”¨æ—¶è°ƒç”¨
        Logger.Info("Hello World æ’ä»¶å·²å¯ç”¨ï¼");
        
        // è®¢é˜…ç©å®¶åŠ å…¥äº‹ä»¶ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
        Events.Subscribe<PlayerJoinedEvent>(OnPlayerJoined, EventPriority.Normal);
        
        // æ³¨å†Œå‘½ä»¤
        Commands.RegisterCommand(new HelloCommand(this));
        
        return Task.CompletedTask;
    }

    public override Task OnDisableAsync()
    {
        // æ’ä»¶ç¦ç”¨æ—¶è°ƒç”¨
        Logger.Info("Hello World æ’ä»¶å·²ç¦ç”¨");
        return Task.CompletedTask;
    }

    private async Task OnPlayerJoined(PlayerJoinedEvent e)
    {
        Logger.Info($"ç©å®¶ {e.Player.Name} åŠ å…¥äº†æœåŠ¡å™¨");
        
        // å‘é€æ¬¢è¿æ¶ˆæ¯
        await GameDisplay.SendChatMessage(
            e.Player.Name, 
            "Â§aæ¬¢è¿æ¥åˆ°æœåŠ¡å™¨ï¼è¿™æ˜¯æ¥è‡ª HelloWorld æ’ä»¶çš„é—®å€™ã€‚"
        );
    }
}
```

### **4. åˆ›å»ºå‘½ä»¤**

åˆ›å»º `HelloCommand.cs`ï¼š

```csharp
using NetherGate.API.Commands;
using NetherGate.API.Plugins;

namespace HelloWorldPlugin;

public class HelloCommand : ICommand
{
    private readonly HelloWorldPlugin _plugin;

    public string Name => "hello";
    public string Description => "å‘ç©å®¶æ‰“æ‹›å‘¼";
    public string Usage => "/hello [name]";
    public string[] Aliases => new[] { "hi" };
    public string Permission => "helloworld.use";
    public string PluginId => _plugin.Metadata.Id;

    public HelloCommand(HelloWorldPlugin plugin)
    {
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        if (sender.IsConsole)
        {
            // æ§åˆ¶å°æ‰§è¡Œ
            _plugin.Logger.Info("Hello from console!");
            return CommandResult.Ok("Hello from console!");
        }
        
        // æ¸¸æˆå†…æ‰§è¡Œ
        string playerName = sender.Name;
        string greeting = args.Length > 0 
            ? $"Â§aHello, {args[0]}! From {playerName}." 
            : $"Â§aHello, {playerName}!";
        
        await _plugin.GameDisplay.SendChatMessage(playerName, greeting);
        
        return CommandResult.Ok("Greeting sent!");
    }
    
    public async Task<List<string>> TabCompleteAsync(ICommandSender sender, string[] args)
    {
        // æä¾›åœ¨çº¿ç©å®¶åˆ—è¡¨ä½œä¸ºTabè¡¥å…¨
        if (args.Length == 1)
        {
            var players = await _plugin.Server.GetOnlinePlayersAsync();
            return players
                .Select(p => p.Name)
                .Where(name => name.StartsWith(args[0], StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        return new List<string>();
    }
}
```

### **5. åˆ›å»º plugin.json**

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `plugin.json`ï¼š

```json
{
  "name": "HelloWorldPlugin",
  "version": "1.0.0",
  "author": "Your Name",
  "description": "My first NetherGate plugin",
  "entry_point": "HelloWorldPlugin.HelloWorldPlugin",
  "dependencies": {},
  "nethergate_api_version": "1.0.0"
}
```

**è®¾ç½®ä¸ºå§‹ç»ˆå¤åˆ¶ï¼š**

ç¼–è¾‘ `.csproj`ï¼Œæ·»åŠ ï¼š

```xml
<ItemGroup>
  <None Update="plugin.json">
    <CopyToOutputDirectory>Always</CopyToOutputDirectory>
  </None>
</ItemGroup>
```

### **6. æ„å»ºå’Œè¿è¡Œ**

```bash
# æ„å»ºæ’ä»¶
dotnet build

# è¾“å‡ºä½ç½®ï¼šbin/Debug/net9.0/

# å¤åˆ¶åˆ° NetherGate plugins ç›®å½•
# ï¼ˆå¦‚æœé…ç½®äº† CopyToPluginsï¼Œä¼šè‡ªåŠ¨å¤åˆ¶ï¼‰

# è¿è¡Œ NetherGate
cd ../NetherGate/bin/Debug
dotnet NetherGate.Host.dll
```

### **7. æµ‹è¯•æ’ä»¶**

```bash
# åœ¨ NetherGate æ§åˆ¶å°
plugin list          # æŸ¥çœ‹æ’ä»¶åˆ—è¡¨
hello                # æ‰§è¡Œå‘½ä»¤ï¼ˆæ§åˆ¶å°ï¼‰

# åœ¨ Minecraft æ¸¸æˆå†…
#hello                # æ‰§è¡Œå‘½ä»¤ï¼ˆæ¸¸æˆå†…ï¼‰
#hi                   # ä½¿ç”¨åˆ«å
```

---

## ğŸ“ **æ’ä»¶ç»“æ„**

### **æœ€å°æ’ä»¶ç»“æ„**

```
HelloWorldPlugin/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ HelloWorldPlugin.cs        # ä¸»ç±»
â”œâ”€â”€ resources/
â”‚   â””â”€â”€ plugin.json                # å…ƒæ•°æ®ï¼ˆå¿…éœ€ï¼‰
â””â”€â”€ HelloWorldPlugin.csproj        # é¡¹ç›®æ–‡ä»¶
```

### **æ ‡å‡†æ’ä»¶ç»“æ„**

```
MyPlugin/
â”œâ”€â”€ MyPlugin.csproj                # é¡¹ç›®æ–‡ä»¶
â”œâ”€â”€ README.md                      # æ’ä»¶è¯´æ˜
â”‚
â”œâ”€â”€ src/                           # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ MyPlugin.cs                # ä¸»ç±»
â”‚   â”œâ”€â”€ Commands/                  # å‘½ä»¤å¤„ç†
â”‚   â”‚   â”œâ”€â”€ AdminCommand.cs
â”‚   â”‚   â””â”€â”€ UserCommand.cs
â”‚   â”œâ”€â”€ Events/                    # äº‹ä»¶ç›‘å¬å™¨
â”‚   â”‚   â”œâ”€â”€ PlayerEventHandler.cs
â”‚   â”‚   â””â”€â”€ ServerEventHandler.cs
â”‚   â”œâ”€â”€ Services/                  # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ DatabaseService.cs
â”‚   â””â”€â”€ Models/                    # æ•°æ®æ¨¡å‹
â”‚       â”œâ”€â”€ PlayerData.cs
â”‚       â””â”€â”€ Config.cs
â”‚
â””â”€â”€ resources/                     # èµ„æºæ–‡ä»¶ç›®å½•
    â”œâ”€â”€ plugin.json                # æ’ä»¶å…ƒæ•°æ®ï¼ˆå¿…éœ€ï¼‰
    â”œâ”€â”€ config.json                # é»˜è®¤é…ç½®æ¨¡æ¿ï¼ˆJSON æˆ– YAMLï¼‰
    â”œâ”€â”€ config.yaml                # YAML æ ¼å¼é…ç½®ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ lang/                      # å¤šè¯­è¨€æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        â”œâ”€â”€ en_US.json
        â””â”€â”€ zh_CN.json
```

### **ç¼–è¯‘è¾“å‡ºç»“æ„**

ç¼–è¯‘åçš„è¾“å‡ºç›®å½•ï¼ˆ`bin/Release/net9.0/`ï¼‰ï¼š

```
MyPlugin/
â”œâ”€â”€ MyPlugin.dll                   # æ’ä»¶ä¸» DLL
â”œâ”€â”€ MyPlugin.pdb                   # è°ƒè¯•ç¬¦å·ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ plugin.json                    # æ’ä»¶å…ƒæ•°æ®
â””â”€â”€ Newtonsoft.Json.dll            # ä¾èµ– DLLï¼ˆå¦‚æœæœ‰ï¼‰
```

**éƒ¨ç½²åˆ° NetherGateï¼š**

å°†æ•´ä¸ªè¾“å‡ºç›®å½•å¤åˆ¶åˆ° `NetherGate/plugins/my-plugin/` å³å¯ã€‚

**è¿è¡Œæ—¶ç»“æ„ï¼š**

```
NetherGate/
â”œâ”€â”€ lib/                           # å…¨å±€å…±äº«ä¾èµ–
â”‚   â””â”€â”€ Newtonsoft.Json.dll        # ï¼ˆå¯é€‰ï¼‰æ”¾åœ¨è¿™é‡Œè¢«æ‰€æœ‰æ’ä»¶å…±äº«
â”‚
â”œâ”€â”€ plugins/
â”‚   â””â”€â”€ my-plugin/
â”‚       â”œâ”€â”€ MyPlugin.dll
â”‚       â”œâ”€â”€ plugin.json
â”‚       â”œâ”€â”€ config.json            # é»˜è®¤é…ç½®æ¨¡æ¿
â”‚       â””â”€â”€ Newtonsoft.Json.dll    # æˆ–æ”¾åœ¨æ’ä»¶ç›®å½•ï¼ˆæ’ä»¶ç§æœ‰ï¼‰
â”‚
â””â”€â”€ config/                        # é…ç½®ç›®å½•
    â””â”€â”€ my-plugin/
        â””â”€â”€ config.yaml            # ç”¨æˆ·é…ç½®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

---

## ğŸ“ **plugin.json é…ç½®**

### **å®Œæ•´ plugin.json ç¤ºä¾‹**

```json
{
  "id": "com.example.myplugin",
  "name": "MyPlugin",
  "version": "1.0.0",
  "description": "A powerful Minecraft plugin",
  "author": "Your Name",
  "website": "https://example.com",
  "license": "MIT",
  
  "main": "MyPlugin.MyPluginMain",
  
  "dependencies": [],
  "soft_dependencies": [],
  
  "library_dependencies": [
    {
      "name": "Newtonsoft.Json",
      "version": "13.0.3",
      "location": "lib",
      "optional": false
    },
    {
      "name": "MySql.Data",
      "version": ">=8.0.0",
      "location": "auto",
      "optional": true
    }
  ],
  
  "load_order": 100,
  "nethergate_version": ">=1.0.0",
  "minecraft_version": ">=1.21.0",
  "target_framework": "net9.0",
  
  "tags": ["economy", "teleport"],
  
  "properties": {
    "custom_property": "custom_value"
  }
}
```

**å…³é”®å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| `id` | âœ… | æ’ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå»ºè®®ä½¿ç”¨åå‘åŸŸåï¼Œå¦‚ `com.example.myplugin`ï¼‰ |
| `name` | âœ… | æ’ä»¶æ˜¾ç¤ºåç§° |
| `version` | âœ… | æ’ä»¶ç‰ˆæœ¬ï¼ˆéµå¾ª[è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/)ï¼‰ |
| `main` | âœ… | æ’ä»¶ä¸»ç±»å®Œæ•´åç§°ï¼ˆ`å‘½åç©ºé—´.ç±»å`ï¼Œå¦‚ `MyPlugin.MyPluginMain`ï¼‰ |
| `description` | âŒ | æ’ä»¶æè¿° |
| `author` | âŒ | ä½œè€…åç§° |
| `website` | âŒ | æ’ä»¶ç½‘ç«™ |
| `dependencies` | âŒ | æ’ä»¶ä¾èµ–ï¼ˆå…¶ä»– NetherGate æ’ä»¶çš„ ID åˆ—è¡¨ï¼‰ |
| `soft_dependencies` | âŒ | è½¯ä¾èµ–ï¼ˆå¯é€‰ä¾èµ–ï¼Œä¸å­˜åœ¨ä¸å½±å“åŠ è½½ï¼‰ |
| `library_dependencies` | âŒ | åº“ä¾èµ–ï¼ˆDLL æ–‡ä»¶ä¾èµ–ï¼‰ |
| `nethergate_version` | âŒ | æ‰€éœ€ NetherGate ç‰ˆæœ¬ï¼ˆå¦‚ `>=1.0.0`ï¼‰ |
| `minecraft_version` | âŒ | æ‰€éœ€ Minecraft ç‰ˆæœ¬ï¼ˆå¦‚ `>=1.21.0`ï¼‰ |
| `target_framework` | âŒ | ç›®æ ‡ .NET æ¡†æ¶ï¼ˆå¦‚ `net9.0`ï¼‰ |
| `load_order` | âŒ | åŠ è½½é¡ºåºï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆåŠ è½½ï¼Œé»˜è®¤ 100ï¼‰ |
| `tags` | âŒ | æ ‡ç­¾åˆ—è¡¨ï¼ˆç”¨äºåˆ†ç±»å’Œæœç´¢ï¼‰ |

---

## ğŸ› ï¸ **é¡¹ç›®æ–‡ä»¶é…ç½®**

### **MyPlugin.csproj é…ç½®**

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    
    <!-- å¤åˆ¶æ‰€æœ‰ä¾èµ–åˆ°è¾“å‡ºç›®å½• -->
    <CopyLocalLockFileAssemblies>true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <!-- NetherGate API ä¾èµ– -->
  <ItemGroup>
    <PackageReference Include="NetherGate.API" Version="1.0.0">
      <PrivateAssets>all</PrivateAssets>
      <ExcludeAssets>runtime</ExcludeAssets>
    </PackageReference>
  </ItemGroup>

  <!-- å¤–éƒ¨ä¾èµ–ï¼ˆç¤ºä¾‹ï¼‰ -->
  <ItemGroup>
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  </ItemGroup>

  <!-- èµ„æºæ–‡ä»¶å¤„ç† -->
  <ItemGroup>
    <!-- plugin.json å¿…é¡»å¤åˆ¶åˆ°è¾“å‡ºç›®å½•æ ¹ -->
    <None Include="resources\plugin.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>plugin.json</Link>
    </None>
    
    <!-- é»˜è®¤é…ç½®æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ -->
    <None Include="resources\config.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>config.json</Link>
    </None>
    
    <!-- å¤šè¯­è¨€æ–‡ä»¶ï¼šå¤åˆ¶åˆ° lang/ å­ç›®å½• -->
    <None Include="resources\lang\**\*.json">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>lang\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </None>
  </ItemGroup>

  <!-- æºä»£ç ç»„ç»‡ -->
  <ItemGroup>
    <Compile Include="src\**\*.cs" />
  </ItemGroup>

</Project>
```

### **é…ç½®è¦ç‚¹**

1. **`CopyLocalLockFileAssemblies`**: ç¡®ä¿ä¾èµ– DLL è¢«å¤åˆ¶åˆ°è¾“å‡ºç›®å½•
2. **`PrivateAssets` / `ExcludeAssets`**: NetherGate API ä¸å¤åˆ¶ï¼ˆæ¡†æ¶å·²æä¾›ï¼‰
3. **èµ„æºæ–‡ä»¶æ˜ å°„**: ä½¿ç”¨ `<Link>` æ ‡ç­¾å°† `resources/` ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°è¾“å‡ºç›®å½•çš„æ­£ç¡®ä½ç½®

---

## ğŸ“ **æœ€ä½³å®è·µ**

### **ç›®å½•ç»„ç»‡**

âœ… **æ¨è**ï¼š
```
src/
â”œâ”€â”€ Commands/           # æŒ‰åŠŸèƒ½åˆ†ç±»
â”œâ”€â”€ Events/
â”œâ”€â”€ Services/
â””â”€â”€ Models/
```

âŒ **ä¸æ¨è**ï¼š
```
src/
â”œâ”€â”€ File1.cs           # æ‰€æœ‰æ–‡ä»¶å †åœ¨ä¸€èµ·
â”œâ”€â”€ File2.cs
â””â”€â”€ File3.cs
```
| `nethergate_api_version` | âŒ | è¦æ±‚çš„ NetherGate API ç‰ˆæœ¬ |
| `minecraft_version` | âŒ | æ”¯æŒçš„ Minecraft ç‰ˆæœ¬ |
| `permissions` | âŒ | æƒé™å®šä¹‰ |

### **ç‰ˆæœ¬çº¦æŸ**


### **IPlugin æ¥å£**

æ‰€æœ‰æ’ä»¶å¿…é¡»å®ç° `IPlugin` æ¥å£ï¼š

```csharp
namespace NetherGate.API.Plugins
{
    /// <summary>
    /// æ’ä»¶æ¥å£ï¼Œæ‰€æœ‰æ’ä»¶å¿…é¡»å®ç°æ­¤æ¥å£
    /// </summary>
    public interface IPlugin
    {
        /// <summary>
        /// æ’ä»¶å…ƒæ•°æ®
        /// </summary>
        PluginMetadata Metadata { get; }
        
        /// <summary>
        /// å½“å‰çŠ¶æ€
        /// </summary>
        PluginState State { get; }
        
        /// <summary>
        /// æ’ä»¶åŠ è½½æ—¶è°ƒç”¨ï¼ˆä»…ä¸€æ¬¡ï¼‰
        /// æ­¤æ—¶å°šæœªæ³¨å…¥ä¾èµ–ï¼Œä»…ç”¨äºåˆå§‹åŒ–é™æ€èµ„æº
        /// </summary>
        Task OnLoadAsync();
        
        /// <summary>
        /// æ’ä»¶å¯ç”¨æ—¶è°ƒç”¨
        /// å¯ä»¥è®¿é—® IPluginContextï¼Œæ³¨å†Œå‘½ä»¤ã€è®¢é˜…äº‹ä»¶ç­‰
        /// </summary>
        Task OnEnableAsync();
        
        /// <summary>
        /// æ’ä»¶ç¦ç”¨æ—¶è°ƒç”¨
        /// åº”æ¸…ç†èµ„æºã€å–æ¶ˆè®¢é˜…äº‹ä»¶ã€ä¿å­˜æ•°æ®
        /// </summary>
        Task OnDisableAsync();
        
        /// <summary>
        /// æ’ä»¶å¸è½½æ—¶è°ƒç”¨ï¼ˆä»…ä¸€æ¬¡ï¼‰
        /// æœ€ç»ˆæ¸…ç†ï¼Œé‡Šæ”¾æ‰€æœ‰èµ„æº
        /// </summary>
        Task OnUnloadAsync();
    }
    
    /// <summary>
    /// æ’ä»¶çŠ¶æ€æšä¸¾
    /// </summary>
    public enum PluginState
    {
        Unloaded,   // æœªåŠ è½½
        Loaded,     // å·²åŠ è½½
        Enabled,    // å·²å¯ç”¨
        Disabled,   // å·²ç¦ç”¨
        Failed      // å¤±è´¥
    }
}
```

### **PluginBase æŠ½è±¡ç±»**ï¼ˆæ¨èï¼‰

NetherGate æä¾›äº† `PluginBase` æŠ½è±¡ç±»ï¼Œç®€åŒ–æ’ä»¶å¼€å‘ï¼š

```csharp
namespace NetherGate.API.Plugins
{
    /// <summary>
    /// æ’ä»¶åŸºç±»ï¼Œæä¾›å¸¸ç”¨åŠŸèƒ½çš„ä¾¿æ·è®¿é—®
    /// </summary>
    public abstract class PluginBase : IPlugin
    {
        // è‡ªåŠ¨æ³¨å…¥çš„å±æ€§
        public PluginMetadata Metadata { get; internal set; } = null!;
        public PluginState State { get; internal set; }
        
        /// <summary>æ—¥å¿—è®°å½•å™¨</summary>
        protected ILogger Logger { get; private set; } = null!;
        
        /// <summary>é…ç½®ç®¡ç†</summary>
        protected IConfigManager Config { get; private set; } = null!;
        
        /// <summary>SMP APIï¼ˆæœåŠ¡ç«¯ç®¡ç†åè®®ï¼‰</summary>
        protected ISmpApi Server { get; private set; } = null!;
        
        /// <summary>RCON å®¢æˆ·ç«¯</summary>
        protected IRconClient? Rcon { get; private set; }
        
        /// <summary>äº‹ä»¶æ€»çº¿</summary>
        protected IEventBus Events { get; private set; } = null!;
        
        /// <summary>å‘½ä»¤ç®¡ç†å™¨</summary>
        protected ICommandManager Commands { get; private set; } = null!;
        
        /// <summary>æ¸¸æˆæ˜¾ç¤º API</summary>
        protected IGameDisplayApi GameDisplay { get; private set; } = null!;
        
        /// <summary>æ’ä»¶é—´é€šä¿¡</summary>
        protected IPluginMessenger Messenger { get; private set; } = null!;
        
        /// <summary>æ’ä»¶æ•°æ®ç›®å½•</summary>
        protected string DataDirectory { get; private set; } = null!;
        
        // ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå­ç±»å¯é‡å†™ï¼‰
        public virtual Task OnLoadAsync() => Task.CompletedTask;
        public virtual Task OnEnableAsync() => Task.CompletedTask;
        public virtual Task OnDisableAsync() => Task.CompletedTask;
        public virtual Task OnUnloadAsync() => Task.CompletedTask;
    }
}
```

**ä½¿ç”¨ PluginBase çš„ä¼˜åŠ¿ï¼š**
- âœ… è‡ªåŠ¨æ³¨å…¥å¸¸ç”¨æœåŠ¡ï¼Œæ— éœ€æ‰‹åŠ¨ä¿å­˜ `IPluginContext`
- âœ… æä¾› `protected` å±æ€§ï¼Œä»£ç æ›´ç®€æ´
- âœ… é»˜è®¤å®ç°ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œåªéœ€é‡å†™éœ€è¦çš„æ–¹æ³•
```

### **ç”Ÿå‘½å‘¨æœŸé¡ºåº**

```
1. åŠ è½½é˜¶æ®µï¼ˆLoadï¼‰
   â”œâ”€ åŠ è½½ç¨‹åºé›†
   â”œâ”€ è¯»å– plugin.json
   â”œâ”€ æ£€æŸ¥ä¾èµ–
   â”œâ”€ åˆ›å»ºæ’ä»¶å®ä¾‹
   â””â”€ è°ƒç”¨ OnLoadAsync()  â† åˆå§‹åŒ–é™æ€èµ„æº

2. å¯ç”¨é˜¶æ®µï¼ˆEnableï¼‰
   â”œâ”€ åˆ›å»º IPluginContext
   â”œâ”€ æ³¨å…¥ä¾èµ–
   â””â”€ è°ƒç”¨ OnEnableAsync()
      â”œâ”€ åŠ è½½é…ç½®
      â”œâ”€ è®¢é˜…äº‹ä»¶ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
      â”œâ”€ æ³¨å†Œå‘½ä»¤
      â”œâ”€ åˆå§‹åŒ–æœåŠ¡
      â””â”€ å¯åŠ¨å®šæ—¶ä»»åŠ¡

3. è¿è¡Œé˜¶æ®µï¼ˆRunningï¼‰
   â”œâ”€ å“åº”äº‹ä»¶
   â”œâ”€ å¤„ç†å‘½ä»¤
   â”œâ”€ æ‰§è¡Œä»»åŠ¡
   â””â”€ æ’ä»¶é—´é€šä¿¡

4. ç¦ç”¨é˜¶æ®µï¼ˆDisableï¼‰
   â”œâ”€ è°ƒç”¨ OnDisableAsync()
   â”‚  â”œâ”€ åœæ­¢å®šæ—¶ä»»åŠ¡
   â”‚  â”œâ”€ ä¿å­˜æ•°æ®
   â”‚  â”œâ”€ å–æ¶ˆäº‹ä»¶è®¢é˜…ï¼ˆè‡ªåŠ¨ï¼‰
   â”‚  â”œâ”€ æ³¨é”€å‘½ä»¤ï¼ˆè‡ªåŠ¨ï¼‰
   â”‚  â””â”€ é‡Šæ”¾èµ„æº
   â””â”€ æ¸…ç† IPluginContext

5. å¸è½½é˜¶æ®µï¼ˆUnloadï¼‰
   â”œâ”€ è°ƒç”¨ OnUnloadAsync()  â† æœ€ç»ˆæ¸…ç†
   â””â”€ å¸è½½ç¨‹åºé›†
```

### **å®ç°ç¤ºä¾‹ 1ï¼šä½¿ç”¨ IPlugin**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;

public class MyPlugin : IPlugin
{
    public PluginMetadata Metadata { get; set; } = null!;
    public PluginState State { get; set; }
    
    private IPluginContext _context = null!;
    private Timer? _heartbeatTimer;
    private DatabaseConnection? _database;

    public Task OnLoadAsync()
    {
        // å°½æ—©åˆå§‹åŒ–ï¼Œä¸ä¾èµ–å¤–éƒ¨èµ„æº
        Console.WriteLine("[MyPlugin] Loading...");
        return Task.CompletedTask;
    }

    public async Task OnEnableAsync()
    {
        _context.Logger.Info("MyPlugin is enabling...");
        
        // 1. åŠ è½½é…ç½®
        var config = await _context.ConfigManager.LoadConfigAsync<MyConfig>("config");
        
        // 2. è¿æ¥æ•°æ®åº“
        _database = new DatabaseConnection(config.DatabaseUrl);
        await _database.ConnectAsync();
        
        // 3. è®¢é˜…äº‹ä»¶ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined, EventPriority.Normal);
        _context.EventBus.Subscribe<PlayerLeftEvent>(OnPlayerLeft, EventPriority.Normal);
        
        // 4. æ³¨å†Œå‘½ä»¤
        _context.CommandManager.RegisterCommand(new MyCommand(_context));
        
        // 5. å¯åŠ¨å®šæ—¶ä»»åŠ¡
        _heartbeatTimer = new Timer(OnHeartbeat, null, 
            TimeSpan.Zero, TimeSpan.FromMinutes(1));
        
        _context.Logger.Info("MyPlugin enabled successfully");
    }

    public async Task OnDisableAsync()
    {
        _context.Logger.Info("MyPlugin is disabling...");
        
        // 1. åœæ­¢å®šæ—¶ä»»åŠ¡
        _heartbeatTimer?.Dispose();
        
        // 2. ä¿å­˜æ•°æ®
        await SaveAllPlayerDataAsync();
        
        // 3. æ–­å¼€æ•°æ®åº“
        await _database?.DisconnectAsync();
        
        // 4. æ¡†æ¶ä¼šè‡ªåŠ¨å–æ¶ˆäº‹ä»¶è®¢é˜…å’Œå‘½ä»¤æ³¨å†Œ
        
        _context.Logger.Info("MyPlugin disabled");
    }
    
    public Task OnUnloadAsync()
    {
        // æœ€ç»ˆæ¸…ç†
        _database = null;
        return Task.CompletedTask;
    }

    private void OnHeartbeat(object? state)
    {
        _context.Logger.Debug("Heartbeat");
    }
}
```

### **å®ç°ç¤ºä¾‹ 2ï¼šä½¿ç”¨ PluginBase**ï¼ˆæ¨èï¼‰

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;

public class MyPlugin : PluginBase
{
    private Timer? _heartbeatTimer;
    private DatabaseConnection? _database;

    public override Task OnLoadAsync()
    {
        // é™æ€åˆå§‹åŒ–
        Console.WriteLine("[MyPlugin] Loading...");
        return Task.CompletedTask;
    }

    public override async Task OnEnableAsync()
    {
        Logger.Info("MyPlugin is enabling...");
        
        // 1. åŠ è½½é…ç½®ï¼ˆä½¿ç”¨ protected å±æ€§ï¼‰
        var config = await Config.LoadConfigAsync<MyConfig>("config");
        
        // 2. è¿æ¥æ•°æ®åº“
        _database = new DatabaseConnection(config.DatabaseUrl);
        await _database.ConnectAsync();
        
        // 3. è®¢é˜…äº‹ä»¶ï¼ˆä½¿ç”¨ protected Events å±æ€§ï¼‰
        Events.Subscribe<PlayerJoinedEvent>(OnPlayerJoined, EventPriority.Normal);
        Events.Subscribe<ServerStartedEvent>(OnServerStarted, EventPriority.High);
        
        // 4. æ³¨å†Œå‘½ä»¤ï¼ˆä½¿ç”¨ protected Commands å±æ€§ï¼‰
        Commands.RegisterCommand(new MyCommand(this));
        
        // 5. å¯åŠ¨å®šæ—¶ä»»åŠ¡
        _heartbeatTimer = new Timer(OnHeartbeat, null, 
            TimeSpan.Zero, TimeSpan.FromMinutes(1));
        
        Logger.Info("MyPlugin enabled successfully");
    }

    public override async Task OnDisableAsync()
    {
        Logger.Info("MyPlugin is disabling...");
        
        _heartbeatTimer?.Dispose();
        await SaveAllPlayerDataAsync();
        await _database?.DisconnectAsync();
        
        Logger.Info("MyPlugin disabled");
    }
    
    public override Task OnUnloadAsync()
    {
        _database = null;
        return Task.CompletedTask;
    }
    
    private async Task OnPlayerJoined(PlayerJoinedEvent e)
    {
        Logger.Info($"{e.Player.Name} joined");
        
        var playerData = await _database!.LoadPlayerAsync(e.Player.Uuid);
        
        // ä½¿ç”¨ protected GameDisplay å±æ€§
        await GameDisplay.SendChatMessage(
            e.Player.Name, 
            $"Â§aWelcome back! You have {playerData.Points} points."
        );
    }
}
```

---

## ğŸ”Œ **IPluginContext æ¥å£**

### **å®Œæ•´æ¥å£**

```csharp
public interface IPluginContext
{
    // ========== æ ¸å¿ƒæœåŠ¡ ==========
    
    /// <summary>
    /// æ—¥å¿—è®°å½•å™¨
    /// </summary>
    ILogger Logger { get; }
    
    /// <summary>
    /// äº‹ä»¶æ€»çº¿
    /// </summary>
    IEventBus EventBus { get; }
    
    /// <summary>
    /// å‘½ä»¤ç®¡ç†å™¨
    /// </summary>
    ICommandManager CommandManager { get; }
    
    /// <summary>
    /// é…ç½®ç®¡ç†å™¨
    /// </summary>
    IConfigManager ConfigManager { get; }
    
    /// <summary>
    /// æƒé™ç®¡ç†å™¨
    /// </summary>
    IPermissionManager PermissionManager { get; }
    
    // ========== æ’ä»¶ç®¡ç† ==========
    
    /// <summary>
    /// æ’ä»¶ç®¡ç†å™¨
    /// </summary>
    IPluginManager PluginManager { get; }
    
    /// <summary>
    /// æ’ä»¶å…ƒæ•°æ®
    /// </summary>
    PluginMetadata Metadata { get; }
    
    /// <summary>
    /// æ’ä»¶æ•°æ®ç›®å½•
    /// </summary>
    string DataDirectory { get; }
    
    // ========== æœåŠ¡å™¨äº¤äº’ ==========
    
    /// <summary>
    /// æ¸¸æˆæ˜¾ç¤º API
    /// </summary>
    IGameDisplayApi GameDisplayApi { get; }
    
    /// <summary>
    /// RCON å®¢æˆ·ç«¯
    /// </summary>
    IRconClient RconClient { get; }
    
    /// <summary>
    /// SMP å®¢æˆ·ç«¯
    /// </summary>
    ISmpApi SmpApi { get; }
    
    // ========== æ•°æ®è¯»å– ==========
    
    /// <summary>
    /// ç©å®¶æ•°æ®è¯»å–å™¨
    /// </summary>
    IPlayerDataReader PlayerDataReader { get; }
    
    /// <summary>
    /// ä¸–ç•Œæ•°æ®è¯»å–å™¨
    /// </summary>
    IWorldDataReader WorldDataReader { get; }
    
    /// <summary>
    /// NBT æ•°æ®å†™å…¥å™¨
    /// </summary>
    INbtDataWriter NbtDataWriter { get; }
    
    // ========== é«˜çº§åŠŸèƒ½ ==========
    
    /// <summary>
    /// æ–‡ä»¶ç›‘è§†å™¨
    /// </summary>
    IFileWatcher FileWatcher { get; }
    
    /// <summary>
    /// å¤‡ä»½ç®¡ç†å™¨
    /// </summary>
    IBackupManager BackupManager { get; }
    
    /// <summary>
    /// æ€§èƒ½ç›‘è§†å™¨
    /// </summary>
    IPerformanceMonitor PerformanceMonitor { get; }
    
    /// <summary>
    /// ç½‘ç»œäº‹ä»¶ç›‘å¬å™¨
    /// </summary>
    INetworkEventListener NetworkEventListener { get; }
    
    /// <summary>
    /// æ’ä»¶é—´é€šä¿¡
    /// </summary>
    IPluginMessenger Messenger { get; }
}
```

### **ä½¿ç”¨ç¤ºä¾‹**

```csharp
public async Task OnEnableAsync(IPluginContext context)
{
    // æ—¥å¿—
    context.Logger.Info("æ’ä»¶å¯åŠ¨");
    context.Logger.Warning("è¿™æ˜¯è­¦å‘Š");
    context.Logger.Error("è¿™æ˜¯é”™è¯¯");
    context.Logger.Debug("è°ƒè¯•ä¿¡æ¯");
    
    // äº‹ä»¶ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
    context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined, EventPriority.Normal);
    context.EventBus.Subscribe<ServerStartedEvent>(OnServerStarted, EventPriority.High);
    await context.EventBus.PublishAsync(new CustomEvent());
    
    // å‘½ä»¤
    context.CommandManager.RegisterCommand(new MyCommand(context));
    
    // é…ç½®
    var config = await context.ConfigManager.LoadConfigAsync<MyConfig>("config");
    await context.ConfigManager.SaveConfigAsync("config", config);
    
    // æƒé™
    bool hasPermission = await context.PermissionManager
        .HasPermissionAsync("Steve", "myplugin.use");
    
    // æ¸¸æˆæ˜¾ç¤º
    await context.GameDisplayApi.SendChatMessage("Steve", "Hello!");
    await context.GameDisplayApi.ShowTitle("Steve", "Welcome", "Enjoy the server!", 10, 70, 20);
    
    // RCON å‘½ä»¤
    var result = await context.RconClient.SendCommandAsync("list");
    
    // SMP API
    var players = await context.SmpApi.GetOnlinePlayersAsync();
    
    // æ•°æ®è¯»å–
    var playerData = await context.PlayerDataReader.ReadPlayerDataAsync("Steve");
    var worldData = await context.WorldDataReader.ReadWorldDataAsync("world");
    
    // æ’ä»¶é—´é€šä¿¡
    await context.Messenger.SendMessageAsync("OtherPlugin", "Hello", data);
}
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [é…ç½®æ–‡ä»¶ç®¡ç†](./é…ç½®æ–‡ä»¶.md)
- [å‘½ä»¤ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/å‘½ä»¤ç³»ç»Ÿ.md)
- [äº‹ä»¶ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/äº‹ä»¶ç³»ç»Ÿ.md)
- [æƒé™ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/æƒé™ç³»ç»Ÿ.md)
- [æ¸¸æˆæ˜¾ç¤º API](../04-é«˜çº§åŠŸèƒ½/æ¸¸æˆæ˜¾ç¤ºAPI.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
