# 构建和打包

本文档介绍如何构建、打包和发布 NetherGate 和插件项目。

---

## 📋 **目录**

- [环境要求](#环境要求)
- [NetherGate 核心构建](#nethergate-核心构建)
- [插件构建](#插件构建)
- [发布和部署](#发布和部署)
- [Docker 部署](#docker-部署)
- [常见问题](#常见问题)

---

## 🔧 **环境要求**

### **必需工具**

- **.NET 9.0 SDK** 或更高版本
  - 下载：https://dotnet.microsoft.com/download
  - 验证安装：`dotnet --version`

- **Git**（可选，用于克隆源代码）
  - 下载：https://git-scm.com/

### **可选工具**

- **Visual Studio 2022** 或 **Rider** （IDE）
- **Docker**（用于容器化部署）

### **验证环境**

```bash
# 检查 .NET SDK
dotnet --version
# 应显示: 9.0.x 或更高

# 检查 .NET runtime
dotnet --list-runtimes

# 检查 .NET SDK
dotnet --list-sdks
```

---

## 🏗️ **NetherGate 核心构建**

### **1. 克隆源代码**

```bash
git clone https://github.com/your-org/NetherGate.git
cd NetherGate
```

### **2. 恢复依赖**

```bash
dotnet restore
```

### **3. 构建项目**

#### **Debug 构建**

```bash
# 构建所有项目
dotnet build

# 构建特定项目
dotnet build src/NetherGate.Core/NetherGate.Core.csproj
```

输出位置：
- `src/NetherGate.API/bin/Debug/net9.0/`
- `src/NetherGate.Core/bin/Debug/net9.0/`
- `src/NetherGate.Host/bin/Debug/net9.0/`

#### **Release 构建**

```bash
# 构建 Release 版本
dotnet build --configuration Release

# 或使用构建脚本
cd scripts
./build.sh    # Linux/macOS
build.bat     # Windows
```

### **4. 运行项目**

```bash
# 直接运行
dotnet run --project src/NetherGate.Host/NetherGate.Host.csproj

# 或运行已构建的程序
cd src/NetherGate.Host/bin/Debug/net9.0/
dotnet NetherGate.Host.dll
```

---

## 📦 **发布（Publish）**

发布会创建一个独立的、可分发的应用程序包。

### **1. 使用发布脚本（推荐）**

```bash
cd scripts

# Windows
publish.bat

# Linux/macOS
chmod +x publish.sh
./publish.sh
```

发布脚本会自动：
- 清理旧的输出
- 构建 Release 版本
- 发布到 `bin/Release/` 目录
- 包含所有必需的 runtime

### **2. 手动发布**

#### **单文件发布（推荐）**

```bash
dotnet publish src/NetherGate.Host/NetherGate.Host.csproj \
  --configuration Release \
  --output bin/Release \
  --runtime win-x64 \
  --self-contained false
```

#### **自包含发布**

```bash
# Windows x64
dotnet publish src/NetherGate.Host/NetherGate.Host.csproj \
  --configuration Release \
  --output bin/Release/win-x64 \
  --runtime win-x64 \
  --self-contained true

# Linux x64
dotnet publish src/NetherGate.Host/NetherGate.Host.csproj \
  --configuration Release \
  --output bin/Release/linux-x64 \
  --runtime linux-x64 \
  --self-contained true

# macOS ARM64
dotnet publish src/NetherGate.Host/NetherGate.Host.csproj \
  --configuration Release \
  --output bin/Release/osx-arm64 \
  --runtime osx-arm64 \
  --self-contained true
```

### **3. 发布选项说明**

| 选项 | 说明 |
|------|------|
| `--configuration Release` | 使用 Release 配置（优化性能） |
| `--output <path>` | 输出目录 |
| `--runtime <RID>` | 目标运行时标识符（见下表） |
| `--self-contained true` | 包含 .NET runtime（体积大但独立） |
| `--self-contained false` | 不包含 runtime（需要目标机器安装 .NET） |

### **4. Runtime Identifiers (RID)**

| 平台 | RID |
|------|-----|
| Windows 64-bit | `win-x64` |
| Windows 32-bit | `win-x86` |
| Windows ARM64 | `win-arm64` |
| Linux 64-bit | `linux-x64` |
| Linux ARM64 | `linux-arm64` |
| macOS Intel | `osx-x64` |
| macOS Apple Silicon | `osx-arm64` |

更多 RID：https://docs.microsoft.com/en-us/dotnet/core/rid-catalog

---

## 🔌 **插件构建**

### **1. 创建插件项目**

```bash
dotnet new classlib -n MyPlugin
cd MyPlugin

# 添加 NetherGate.API 引用
dotnet add reference path/to/NetherGate.API/NetherGate.API.csproj

# 或使用 NuGet 包（如果已发布）
dotnet add package NetherGate.API
```

### **2. 配置项目文件**

编辑 `MyPlugin.csproj`：

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <EnableDynamicLoading>true</EnableDynamicLoading>
  </PropertyGroup>

  <ItemGroup>
    <!-- 引用 NetherGate.API -->
    <PackageReference Include="NetherGate.API" Version="1.0.0" PrivateAssets="all" />
    
    <!-- 其他依赖（会被复制到插件目录） -->
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
  </ItemGroup>

  <!-- 构建后自动复制到 plugins 目录 -->
  <Target Name="CopyToPlugins" AfterTargets="Build">
    <ItemGroup>
      <PluginFiles Include="$(OutputPath)**\*.*" />
    </ItemGroup>
    <Copy SourceFiles="@(PluginFiles)" 
          DestinationFolder="$(SolutionDir)bin\$(Configuration)\plugins\$(ProjectName)\%(RecursiveDir)" 
          SkipUnchangedFiles="true" />
  </Target>
</Project>
```

### **3. 构建插件**

```bash
# Debug 构建
dotnet build

# Release 构建
dotnet build --configuration Release
```

### **4. 插件输出结构**

```
plugins/
└── MyPlugin/
    ├── MyPlugin.dll         # 插件主程序集
    ├── MyPlugin.pdb         # 调试符号（可选）
    ├── plugin.json          # 插件元数据
    ├── config.yaml          # 默认配置（可选）
    └── dependencies/        # 依赖库
        └── Newtonsoft.Json.dll
```

---

## 🚀 **发布和部署**

### **1. 准备发布包**

#### **核心框架**

```
NetherGate-v1.0.0/
├── NetherGate.Host.exe         # 主程序
├── NetherGate.Core.dll
├── NetherGate.API.dll
├── lib/                        # 依赖库
│   ├── fNbt.dll
│   └── YamlDotNet.dll
├── config/                     # 配置目录（空）
├── plugins/                    # 插件目录（空）
├── logs/                       # 日志目录（空）
├── nethergate-config.yaml      # 默认配置
└── README.txt                  # 使用说明
```

#### **插件包**

```
MyPlugin-v1.0.0.zip
├── MyPlugin/
│   ├── MyPlugin.dll
│   ├── plugin.json
│   ├── config.example.yaml     # 示例配置
│   └── dependencies/
│       └── ...
└── README.md                   # 安装说明
```

### **2. 打包脚本**

创建 `scripts/package.sh`：

```bash
#!/bin/bash

VERSION="1.0.0"
OUTPUT="releases/NetherGate-v${VERSION}"

# 清理
rm -rf "$OUTPUT"
mkdir -p "$OUTPUT"/{config,plugins,logs}

# 复制文件
cp -r bin/Release/* "$OUTPUT/"

# 创建默认配置
cp docs/config.example.yaml "$OUTPUT/nethergate-config.yaml"

# 打包
cd releases
zip -r "NetherGate-v${VERSION}.zip" "NetherGate-v${VERSION}"

echo "✅ 打包完成: releases/NetherGate-v${VERSION}.zip"
```

### **3. 安装部署**

#### **Windows**

```batch
REM 1. 解压到目标目录
unzip NetherGate-v1.0.0.zip -d C:\NetherGate

REM 2. 编辑配置文件
notepad C:\NetherGate\nethergate-config.yaml

REM 3. 运行
cd C:\NetherGate
NetherGate.Host.exe
```

#### **Linux**

```bash
# 1. 解压
unzip NetherGate-v1.0.0.zip -d /opt/nethergate

# 2. 赋予执行权限
chmod +x /opt/nethergate/NetherGate.Host

# 3. 编辑配置
nano /opt/nethergate/nethergate-config.yaml

# 4. 运行
cd /opt/nethergate
./NetherGate.Host
```

### **4. systemd 服务（Linux）**

创建 `/etc/systemd/system/nethergate.service`：

```ini
[Unit]
Description=NetherGate Minecraft Server Manager
After=network.target

[Service]
Type=simple
User=minecraft
WorkingDirectory=/opt/nethergate
ExecStart=/opt/nethergate/NetherGate.Host
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用和启动：

```bash
sudo systemctl enable nethergate
sudo systemctl start nethergate
sudo systemctl status nethergate
```

---

## 🐳 **Docker 部署**

### **1. Dockerfile**

```dockerfile
# 构建阶段
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# 复制项目文件
COPY ["src/NetherGate.API/NetherGate.API.csproj", "NetherGate.API/"]
COPY ["src/NetherGate.Core/NetherGate.Core.csproj", "NetherGate.Core/"]
COPY ["src/NetherGate.Host/NetherGate.Host.csproj", "NetherGate.Host/"]

# 恢复依赖
RUN dotnet restore "NetherGate.Host/NetherGate.Host.csproj"

# 复制所有源代码
COPY src/ .

# 构建
WORKDIR "/src/NetherGate.Host"
RUN dotnet build "NetherGate.Host.csproj" -c Release -o /app/build

# 发布
FROM build AS publish
RUN dotnet publish "NetherGate.Host.csproj" -c Release -o /app/publish

# 运行时阶段
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS final
WORKDIR /app

# 安装 Java（用于运行 Minecraft 服务器）
RUN apt-get update && \
    apt-get install -y openjdk-21-jre-headless && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 复制应用
COPY --from=publish /app/publish .

# 创建目录
RUN mkdir -p /app/config /app/plugins /app/logs /app/server

# 数据卷
VOLUME ["/app/config", "/app/plugins", "/app/server", "/app/logs"]

# 端口
EXPOSE 25565 25575

# 入口点
ENTRYPOINT ["dotnet", "NetherGate.Host.dll"]
```

### **2. docker-compose.yml**

```yaml
version: '3.8'

services:
  nethergate:
    build: .
    container_name: nethergate
    restart: unless-stopped
    ports:
      - "25565:25565"  # Minecraft
      - "25575:25575"  # RCON
    volumes:
      - ./config:/app/config
      - ./plugins:/app/plugins
      - ./server:/app/server
      - ./logs:/app/logs
    environment:
      - DOTNET_ENVIRONMENT=Production
    networks:
      - minecraft

networks:
  minecraft:
    driver: bridge
```

### **3. 构建和运行**

```bash
# 构建镜像
docker build -t nethergate:latest .

# 运行容器
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down
```

---

## ❓ **常见问题**

### **Q: 构建失败，提示找不到 SDK？**

**A:** 确保安装了 .NET 9.0 SDK：
```bash
dotnet --version
# 如果版本低于 9.0，请更新
```

### **Q: 发布后文件很大？**

**A:** 使用 `--self-contained false` 来减小体积（需要目标机器安装 .NET）：
```bash
dotnet publish --configuration Release --self-contained false
```

### **Q: 插件加载失败？**

**A:** 检查：
1. 插件是否在 `plugins/` 目录
2. `plugin.json` 是否正确
3. `EnableDynamicLoading` 是否设置为 `true`
4. 查看日志中的详细错误信息

### **Q: Docker 容器无法启动？**

**A:** 检查：
1. 端口是否被占用：`netstat -tulpn | grep 25565`
2. 数据卷权限是否正确
3. 查看容器日志：`docker logs nethergate`

---

## 📚 **相关文档**

- [配置文件详解](./配置文件详解.md)
- [插件开发指南](../03-插件开发/插件开发指南.md)
- [项目结构说明](../06-架构和设计/项目结构.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
