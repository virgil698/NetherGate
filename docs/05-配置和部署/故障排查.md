# 故障排查指南

本文档提供 NetherGate 常见问题的诊断和解决方案。

---

## 📋 **目录**

- [快速诊断](#快速诊断)
- [启动问题](#启动问题)
- [连接问题](#连接问题)
- [插件问题](#插件问题)
- [性能问题](#性能问题)
- [数据问题](#数据问题)

---

## 🔍 **快速诊断**

### **检查清单**

```bash
# 1. 检查 .NET Runtime
dotnet --version
# 应显示: 9.0.x 或更高

# 2. 检查 Java
java -version
# 应显示: Java 21 或更高

# 3. 查看日志
tail -f logs/latest.log

# 4. 检查端口占用
# Windows
netstat -ano | findstr "25575 25580"
# Linux
netstat -tulpn | grep "25575\|25580"

# 5. 检查文件权限（Linux）
ls -la
# 确保有读写权限
```

### **常见错误代码**

| 错误代码 | 说明 | 解决方案 |
|---------|------|---------|
| `E001` | .NET Runtime 未找到 | 安装 .NET 9.0 |
| `E002` | 配置文件格式错误 | 检查 YAML 语法 |
| `E003` | RCON 连接失败 | 检查密码和端口 |
| `E004` | SMP 连接失败 | 检查 auth_key |
| `E005` | 插件加载失败 | 检查 plugin.json |

---

## 🚀 **启动问题**

### **问题：NetherGate 无法启动**

**错误信息：**
```
It was not possible to find any compatible framework version
The framework 'Microsoft.NETCore.App', version '9.0.0' was not found.
```

**解决方案：**

1. **安装 .NET 9.0 Runtime**
   ```bash
   # 下载并安装
   https://dotnet.microsoft.com/download/dotnet/9.0
   
   # 验证安装
   dotnet --version
   ```

2. **检查环境变量**
   ```bash
   # Windows
   echo %PATH%
   # 应包含：C:\Program Files\dotnet\
   
   # Linux
   echo $PATH
   # 应包含：/usr/share/dotnet/
   ```

---

### **问题：配置文件加载失败**

**错误信息：**
```
[ERROR] 配置加载失败: invalid yaml syntax
```

**解决方案：**

1. **检查 YAML 语法**
   ```yaml
   # ❌ 错误：缩进不对
   server:
   working_directory: "path"
   
   # ✅ 正确
   server:
     working_directory: "path"
   ```

2. **使用 YAML 验证器**
   - 在线工具：https://yamllint.com/
   - 或使用命令：
     ```bash
     python -m yaml nethergate-config.yaml
     ```

3. **重新生成配置**
   ```bash
   # 删除配置文件
   rm nethergate-config.yaml
   
   # 重新启动（会生成默认配置）
   ./NetherGate.Host
   ```

---

### **问题：服务器无法启动**

**错误信息：**
```
[ERROR] 服务器启动失败: Cannot find server.jar
```

**解决方案：**

1. **检查文件路径**
   ```yaml
   server:
     working_directory: "E:/Minecraft/Server"  # 检查路径是否正确
     jar_file: "server.jar"  # 检查文件名是否正确
   ```

2. **验证文件存在**
   ```bash
   # Windows
   dir "E:\Minecraft\Server\server.jar"
   
   # Linux
   ls -l /opt/minecraft/server/server.jar
   ```

3. **检查 Java**
   ```bash
   # 测试手动启动
   cd /opt/minecraft/server
   java -jar server.jar nogui
   ```

---

## 🔌 **连接问题**

### **问题：RCON 连接失败**

**错误信息：**
```
[ERROR] RCON 连接失败: Connection refused
```

**诊断步骤：**

```bash
# 1. 检查服务器是否启动
ps aux | grep java

# 2. 检查端口是否监听
netstat -tulpn | grep 25575

# 3. 测试 RCON 连接（使用 mcrcon 工具）
mcrcon -H 127.0.0.1 -P 25575 -p your_password "list"
```

**解决方案：**

1. **检查 server.properties**
   ```properties
   enable-rcon=true
   rcon.port=25575
   rcon.password=your_password
   ```

2. **重启 Minecraft 服务器**
   - RCON 配置更改需要重启

3. **检查防火墙**
   ```bash
   # Linux
   sudo ufw allow 25575/tcp
   
   # Windows
   netsh advfirewall firewall add rule name="RCON" dir=in action=allow protocol=TCP localport=25575
   ```

4. **检查密码**
   ```yaml
   rcon:
     password: "your_password"  # 必须与 server.properties 一致
   ```

---

### **问题：SMP 连接失败**

**错误信息：**
```
[ERROR] SMP 连接失败: Authentication failed
```

**诊断步骤：**

```bash
# 1. 检查 SMP 插件是否安装
ls plugins/ | grep NetherGate-SMP

# 2. 检查服务器日志
grep "NetherGate-SMP" logs/latest.log

# 3. 测试 WebSocket 连接
wscat -c ws://localhost:25580
```

**解决方案：**

1. **安装 SMP 插件**
   - 下载对应版本的 SMP 插件
   - 放入 plugins/ 目录
   - 重启服务器

2. **检查配置一致性**
   ```yaml
   # nethergate-config.yaml
   smp:
     auth_key: "secret_key_123"
   ```
   
   ```yaml
   # plugins/NetherGate-SMP/config.yml
   websocket:
     auth_key: "secret_key_123"  # 必须一致
   ```

3. **检查端口**
   ```bash
   # 确保端口未被占用
   netstat -tulpn | grep 25580
   ```

---

## 🔧 **插件问题**

### **问题：插件加载失败**

**错误信息：**
```
[ERROR] 插件加载失败: Plugin entry point not found
```

**诊断步骤：**

1. **检查 plugin.json**
   ```json
   {
     "name": "MyPlugin",
     "entry_point": "MyPlugin.MyPlugin"  // 命名空间.类名
   }
   ```

2. **检查类定义**
   ```csharp
   namespace MyPlugin  // 与 plugin.json 中的命名空间一致
   {
       public class MyPlugin : IPlugin  // 类名一致
       {
           // ...
       }
   }
   ```

3. **检查 DLL 文件**
   ```bash
   ls plugins/MyPlugin/
   # 应该有 MyPlugin.dll
   ```

**解决方案：**

1. **重新构建插件**
   ```bash
   dotnet build --configuration Release
   ```

2. **检查输出目录**
   - 确保 DLL 和 plugin.json 都在 plugins/MyPlugin/ 目录

3. **查看详细日志**
   ```yaml
   logging:
     level: "Debug"  # 启用详细日志
   ```

---

### **问题：插件热重载失败**

**错误信息：**
```
[ERROR] 插件重载失败: Assembly load error
```

**解决方案：**

1. **确保插件支持热重载**
   ```csharp
   public void OnDisable()
   {
       // 必须正确清理资源
       _timer?.Dispose();
       _context.EventBus.Unsubscribe(_handler);
   }
   ```

2. **检查静态变量**
   ```csharp
   // ❌ 静态变量不会重置
   public static Dictionary<string, int> Cache = new();
   
   // ✅ 在 OnDisable 中清理
   public void OnDisable()
   {
       Cache.Clear();
   }
   ```

3. **查看堆栈跟踪**
   ```bash
   grep "Assembly load error" -A 20 logs/latest.log
   ```

---

## ⚡ **性能问题**

### **问题：NetherGate 占用 CPU 过高**

**诊断步骤：**

```bash
# 1. 查看进程 CPU 使用率
# Windows
tasklist /FI "IMAGENAME eq NetherGate.Host.exe"

# Linux
top -p $(pgrep -f NetherGate.Host)

# 2. 查看线程
# Linux
ps -eLf | grep NetherGate.Host

# 3. 性能分析
dotnet-trace collect --process-id <pid>
```

**解决方案：**

1. **检查插件循环**
   ```csharp
   // ❌ 死循环
   while (true)
   {
       DoWork();  // 没有延迟
   }
   
   // ✅ 使用延迟
   while (true)
   {
       DoWork();
       await Task.Delay(1000);  // 1秒延迟
   }
   ```

2. **检查事件订阅**
   ```csharp
   // ❌ 事件中执行耗时操作
   _context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
   {
       Thread.Sleep(5000);  // 阻塞！
   });
   
   // ✅ 使用异步
   _context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
   {
       await Task.Delay(5000);
   });
   ```

3. **禁用调试日志**
   ```yaml
   logging:
     level: "Info"  # 不要用 Debug
   ```

---

### **问题：内存占用过高**

**诊断步骤：**

```csharp
// 在插件中添加内存监控
var memoryMB = GC.GetTotalMemory(false) / 1024 / 1024;
_context.Logger.Info($"内存使用: {memoryMB} MB");

GC.Collect();
var afterMB = GC.GetTotalMemory(true) / 1024 / 1024;
_context.Logger.Info($"回收后: {afterMB} MB");
```

**解决方案：**

1. **检查缓存**
   ```csharp
   // ❌ 无限增长的缓存
   private Dictionary<string, PlayerData> _cache = new();
   
   // ✅ 限制大小
   if (_cache.Count > 1000)
   {
       _cache.Clear();  // 或使用 LRU 缓存
   }
   ```

2. **检查事件订阅泄漏**
   ```csharp
   public void OnDisable()
   {
       // 必须取消订阅
       _context.EventBus.Unsubscribe(_handler);
   }
   ```

3. **使用弱引用**
   ```csharp
   private Dictionary<string, WeakReference<PlayerData>> _cache = new();
   ```

---

## 💾 **数据问题**

### **问题：玩家数据丢失**

**诊断步骤：**

1. **检查玩家数据文件**
   ```bash
   ls -lh world/playerdata/
   ```

2. **验证 NBT 数据**
   ```bash
   # 使用 NBT 工具
   nbt-dump world/playerdata/<uuid>.dat
   ```

3. **检查备份**
   ```bash
   ls -lh backups/
   ```

**解决方案：**

1. **从备份恢复**
   ```bash
   # 停止服务器
   stop
   
   # 恢复备份
   cp backups/latest/world/playerdata/<uuid>.dat world/playerdata/
   
   # 重启服务器
   ```

2. **修复损坏的数据**
   - 使用 NBT 编辑器
   - 或使用插件修复工具

---

### **问题：配置更改不生效**

**解决方案：**

1. **重启 NetherGate**
   - 某些配置需要重启

2. **检查配置文件位置**
   ```bash
   # 确保修改的是正确的配置文件
   pwd
   ls -la nethergate-config.yaml
   ```

3. **清除缓存**
   ```bash
   rm -rf cache/
   ```

---

## 🆘 **获取帮助**

### **提交 Bug 报告**

**需要提供的信息：**

1. **系统信息**
   ```bash
   # OS 版本
   cat /etc/os-release  # Linux
   ver  # Windows
   
   # .NET 版本
   dotnet --version
   
   # Java 版本
   java -version
   ```

2. **NetherGate 版本**
   ```bash
   ./NetherGate.Host --version
   ```

3. **日志文件**
   ```bash
   # 最近的日志
   tail -n 1000 logs/latest.log > bug-report.log
   ```

4. **配置文件**（移除密码）
   ```bash
   # 复制配置（记得移除密码）
   cp nethergate-config.yaml bug-report-config.yaml
   # 编辑移除敏感信息
   ```

5. **复现步骤**
   - 详细描述如何触发问题
   - 提供最小复现示例

### **社区支持**

- **GitHub Issues**: https://github.com/your-org/NetherGate/issues
- **Discord**: https://discord.gg/example
- **文档**: https://nethergate.dev/docs
- **FAQ**: [常见问题](../08-参考/FAQ.md)

---

## 📚 **相关文档**

- [FAQ](../08-参考/FAQ.md)
- [配置文件详解](./配置文件详解.md)
- [调试技巧](../03-插件开发/调试技巧.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
