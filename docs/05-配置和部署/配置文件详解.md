# 配置文件详解

本文档详细说明 NetherGate 所有配置选项及其用途。

---

## 📋 **目录**

- [nethergate-config.yaml](#nethergate-configyaml)
- [websocket-config.yaml](#websocket-configyaml)
- [permissions.yaml](#permissionsyaml)
- [环境变量](#环境变量)
- [配置最佳实践](#配置最佳实践)

---

## ⚙️ **nethergate-config.yaml**

NetherGate 的主配置文件。

### **完整配置示例**

```yaml
#==========================================
# NetherGate 主配置文件
#==========================================

# 服务器进程配置
server:
  # 启动方法
  # java: 直接使用 Java 启动服务器
  # script: 执行自定义启动脚本
  # external: 连接到已运行的服务器
  launch_method: "java"
  
  # 工作目录（服务器所在目录）
  # 相对路径或绝对路径
  working_directory: "E:/Minecraft/Server"
  
  # Java 配置（launch_method=java 时使用）
  java_path: "java"  # Java 可执行文件路径
  java_args: "-Xmx4G -Xms2G -XX:+UseG1GC"  # JVM 参数
  jar_file: "server.jar"  # 服务器 JAR 文件名
  
  # 脚本配置（launch_method=script 时使用）
  script_path: ""  # 启动脚本路径（如 start.sh）
  script_args: ""  # 脚本参数
  
  # 自动重启
  auto_restart: true  # 是否自动重启
  restart_delay_seconds: 10  # 重启延迟（秒）
  max_restart_attempts: 3  # 最大重启次数（0=无限制）
  
  # 优雅关闭
  shutdown_timeout_seconds: 60  # 关闭超时（秒）
  force_kill_after_timeout: true  # 超时后强制结束进程

# RCON 配置
rcon:
  # 是否启用 RCON
  enabled: true
  
  # 连接配置
  host: "127.0.0.1"  # RCON 主机地址
  port: 25575  # RCON 端口
  password: "your_rcon_password"  # RCON 密码（与 server.properties 一致）
  
  # 超时配置
  timeout_seconds: 5  # 命令超时（秒）
  connect_timeout_seconds: 10  # 连接超时（秒）
  
  # 重试配置
  max_retries: 3  # 最大重试次数
  retry_delay_seconds: 2  # 重试延迟（秒）

# SMP (Server Management Protocol) 配置
smp:
  # 是否启用 SMP
  enabled: true
  
  # WebSocket 配置
  websocket_url: "ws://127.0.0.1:25580"  # WebSocket 地址
  # 或者使用单独的主机和端口：
  # websocket_host: "127.0.0.1"
  # websocket_port: 25580
  
  # 认证配置
  auth_key: "your_secret_auth_key"  # 认证密钥（必须与 SMP 插件一致）
  
  # 连接配置
  reconnect_interval_seconds: 5  # 重连间隔（秒）
  max_reconnect_attempts: 10  # 最大重连次数（0=无限制）
  connection_timeout_seconds: 30  # 连接超时（秒）
  
  # 心跳配置
  enable_heartbeat: true  # 是否启用心跳
  heartbeat_interval_seconds: 30  # 心跳间隔（秒）
  heartbeat_timeout_seconds: 60  # 心跳超时（秒）

# 插件配置
plugins:
  # 插件目录
  directory: "plugins"
  
  # 是否自动加载插件
  auto_load: true
  
  # 是否启用插件热重载
  enable_hot_reload: true
  
  # 文件监视
  watch_for_changes: true  # 监视插件文件变化
  reload_on_change: true  # 文件变化时自动重载
  
  # 依赖解析
  resolve_dependencies: true  # 自动解析依赖
  allow_circular_dependencies: false  # 是否允许循环依赖

# 日志配置
logging:
  # 日志级别
  # Debug: 详细调试信息
  # Info: 一般信息
  # Warning: 警告信息
  # Error: 错误信息
  level: "Info"
  
  # 控制台输出
  console_enabled: true  # 是否输出到控制台
  console_colors: true  # 是否使用彩色输出
  console_timestamps: true  # 是否显示时间戳
  
  # 文件输出
  file_enabled: true  # 是否输出到文件
  file_path: "logs/latest.log"  # 日志文件路径
  
  # 文件轮转
  max_file_size_mb: 10  # 单个日志文件最大大小（MB）
  max_file_count: 5  # 保留的日志文件数量
  compress_old_logs: true  # 是否压缩旧日志
  
  # 日志格式
  timestamp_format: "yyyy-MM-dd HH:mm:ss"  # 时间戳格式
  include_thread_id: false  # 是否包含线程 ID
  include_source: false  # 是否包含源文件信息

# 性能监控配置
performance:
  # 是否启用性能监控
  enabled: true
  
  # 监控间隔（秒）
  monitor_interval_seconds: 60
  
  # 性能告警阈值
  thresholds:
    cpu_percent: 80  # CPU 使用率阈值（%）
    memory_mb: 6144  # 内存使用阈值（MB）
    tps: 15  # 服务器 TPS 阈值
    
  # 是否记录性能指标到文件
  log_metrics: true
  metrics_file: "logs/performance.log"
  
  # 是否在告警时发送通知
  alert_on_threshold: true

# 备份配置
backup:
  # 是否启用自动备份
  enabled: false
  
  # 备份配置
  directory: "backups"  # 备份目录
  interval_hours: 6  # 备份间隔（小时）
  max_backups: 5  # 保留的备份数量
  
  # 备份内容
  include_world: true  # 是否备份世界
  include_plugins: true  # 是否备份插件
  include_config: true  # 是否备份配置
  
  # 压缩配置
  compress: true  # 是否压缩备份
  compression_level: 6  # 压缩级别（1-9）
  
  # 备份前命令
  pre_backup_commands:
    - "save-all"  # 保存世界
    - "save-off"  # 关闭自动保存
  
  # 备份后命令
  post_backup_commands:
    - "save-on"  # 开启自动保存

# 安全配置
security:
  # 是否启用安全模式
  enabled: true
  
  # 插件验证
  verify_plugin_signatures: false  # 是否验证插件签名
  allow_unsigned_plugins: true  # 是否允许未签名插件
  
  # 权限
  require_permissions: true  # 是否要求权限验证
  
  # 限流
  rate_limiting:
    enabled: true  # 是否启用限流
    max_requests_per_second: 100  # 每秒最大请求数
    max_requests_per_minute: 1000  # 每分钟最大请求数

# WebSocket 服务器配置（用于外部连接）
websocket_server:
  # 是否启用
  enabled: false
  
  # 监听配置
  host: "0.0.0.0"  # 监听地址（0.0.0.0=所有接口）
  port: 25581  # 监听端口
  
  # 安全配置
  require_auth: true  # 是否要求认证
  auth_tokens:  # 认证令牌列表
    - "token1"
    - "token2"
  
  # SSL/TLS 配置（可选）
  use_ssl: false
  ssl_cert_path: ""
  ssl_key_path: ""

# 高级配置
advanced:
  # 线程池配置
  thread_pool_size: 4  # 线程池大小（0=自动）
  
  # 缓存配置
  enable_cache: true
  cache_size_mb: 256  # 缓存大小（MB）
  cache_ttl_seconds: 300  # 缓存过期时间（秒）
  
  # 调试配置
  debug_mode: false  # 是否启用调试模式
  verbose_logging: false  # 是否启用详细日志
  dump_nbt_on_error: false  # 错误时是否转储 NBT 数据
  
  # 实验性功能
  experimental_features:
    - "feature1"
    - "feature2"
```

### **配置说明**

#### **server 部分**

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `launch_method` | string | `java` | 启动方法（java/script/external） |
| `working_directory` | string | - | 服务器工作目录 |
| `java_path` | string | `java` | Java 可执行文件路径 |
| `java_args` | string | `-Xmx4G -Xms2G` | JVM 参数 |
| `jar_file` | string | `server.jar` | 服务器 JAR 文件 |
| `auto_restart` | boolean | `true` | 是否自动重启 |
| `restart_delay_seconds` | int | `10` | 重启延迟（秒） |

#### **rcon 部分**

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | boolean | `true` | 是否启用 RCON |
| `host` | string | `127.0.0.1` | RCON 主机地址 |
| `port` | int | `25575` | RCON 端口 |
| `password` | string | - | RCON 密码 |
| `timeout_seconds` | int | `5` | 超时时间 |

#### **logging 部分**

| 选项 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `level` | string | `Info` | 日志级别 |
| `console_enabled` | boolean | `true` | 控制台输出 |
| `file_enabled` | boolean | `true` | 文件输出 |
| `max_file_size_mb` | int | `10` | 最大文件大小 |
| `max_file_count` | int | `5` | 保留文件数量 |

---

## 🌐 **websocket-config.yaml**

WebSocket 服务器配置文件（用于外部连接）。

```yaml
# WebSocket 服务器配置
server:
  host: "0.0.0.0"
  port: 25581
  
# 认证配置
auth:
  enabled: true
  tokens:
    - "external_client_token_1"
    - "external_client_token_2"

# 限流配置
rate_limit:
  enabled: true
  max_connections: 10
  max_messages_per_second: 100

# 日志配置
logging:
  level: "Info"
  log_messages: false  # 是否记录所有消息
```

---

## 🔒 **permissions.yaml**

权限系统配置文件。

完整示例请参考：[权限系统](../02-核心功能/权限系统.md)

---

## 🌍 **环境变量**

NetherGate 支持通过环境变量覆盖配置：

```bash
# 服务器配置
export NETHERGATE_SERVER_WORKING_DIR="/opt/minecraft/server"
export NETHERGATE_SERVER_JAVA_ARGS="-Xmx8G -Xms4G"

# RCON 配置
export NETHERGATE_RCON_PASSWORD="secret_password"
export NETHERGATE_RCON_PORT="25575"

# SMP 配置
export NETHERGATE_SMP_AUTH_KEY="secret_auth_key"
export NETHERGATE_SMP_PORT="25580"

# 日志配置
export NETHERGATE_LOG_LEVEL="Debug"

# 启动 NetherGate
./NetherGate.Host
```

**优先级：**
```
环境变量 > 配置文件 > 默认值
```

---

## 💡 **配置最佳实践**

### **1. 使用环境变量存储敏感信息**

```yaml
# ❌ 不推荐：敏感信息直接写在配置文件
rcon:
  password: "my_secret_password"

smp:
  auth_key: "my_secret_auth_key"
```

```bash
# ✅ 推荐：使用环境变量
export NETHERGATE_RCON_PASSWORD="my_secret_password"
export NETHERGATE_SMP_AUTH_KEY="my_secret_auth_key"
```

### **2. 不同环境使用不同配置**

```
config/
├── nethergate-config.yaml        # 生产环境
├── nethergate-config.dev.yaml    # 开发环境
└── nethergate-config.test.yaml   # 测试环境
```

```bash
# 指定配置文件
./NetherGate.Host --config nethergate-config.dev.yaml
```

### **3. 注释配置文件**

```yaml
# 服务器配置
server:
  # 工作目录：Minecraft 服务器所在的完整路径
  # 示例：E:/Minecraft/Server 或 /opt/minecraft/server
  working_directory: "E:/Minecraft/Server"
  
  # JVM 参数：根据服务器内存调整
  # -Xmx: 最大堆内存
  # -Xms: 初始堆内存
  # 建议：-Xms 和 -Xmx 设置相同值
  java_args: "-Xmx4G -Xms4G -XX:+UseG1GC"
```

### **4. 版本控制**

```bash
# ✅ 提交到 Git
git add nethergate-config.example.yaml

# ❌ 不要提交实际配置（包含密码）
echo "nethergate-config.yaml" >> .gitignore
```

### **5. 配置验证**

```bash
# 验证配置文件语法
./NetherGate.Host --validate-config

# 显示最终配置（合并环境变量）
./NetherGate.Host --show-config
```

---

## 📚 **相关文档**

- [安装和配置](../01-快速开始/安装和配置.md)
- [权限系统](../02-核心功能/权限系统.md)
- [RCON 集成](../02-核心功能/RCON集成.md)
- [SMP 协议](../02-核心功能/SMP协议.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
