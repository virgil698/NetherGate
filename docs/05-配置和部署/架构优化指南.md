# NetherGate æ¶æ„ä¼˜åŒ–æŒ‡å—

## ğŸ“š ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [ä¾èµ–æ³¨å…¥ (DI)](#ä¾èµ–æ³¨å…¥-di)
- [ç½‘ç»œå±‚ä¼˜åŒ–](#ç½‘ç»œå±‚ä¼˜åŒ–)
- [åˆ†å¸ƒå¼æ’ä»¶ç³»ç»Ÿ](#åˆ†å¸ƒå¼æ’ä»¶ç³»ç»Ÿ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

NetherGate å·²è¿›è¡Œå…¨é¢æ¶æ„å‡çº§ï¼Œå¼•å…¥äº†ä»¥ä¸‹ç°ä»£åŒ–ç‰¹æ€§ï¼š

- âœ… **ä¾èµ–æ³¨å…¥ (DI)** - ä½¿ç”¨ Microsoft.Extensions.DependencyInjection
- âœ… **ç½‘ç»œè¿æ¥æ± ** - è¿æ¥å¤ç”¨å’Œè‡ªåŠ¨ç®¡ç†
- âœ… **åˆ†å¸ƒå¼æ’ä»¶ç³»ç»Ÿ** - è·¨æœåŠ¡å™¨èŠ‚ç‚¹çš„æ’ä»¶é€šä¿¡
- âœ… **Generic Host** - æ ‡å‡†çš„ .NET æ‰˜ç®¡æ¨¡å‹

---

## ä¾èµ–æ³¨å…¥ (DI)

### æ’ä»¶æ„é€ å‡½æ•°æ³¨å…¥

æ’ä»¶ç°åœ¨æ”¯æŒé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼š

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;
using NetherGate.API.Protocol;
using NetherGate.API.Logging;

namespace MyPlugin;

public class MyPlugin : IPlugin
{
    private readonly ISmpApi _smpApi;
    private readonly IEventBus _eventBus;
    private readonly ILogger _logger;
    
    // é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
    public MyPlugin(ISmpApi smpApi, IEventBus eventBus, ILoggerFactory loggerFactory)
    {
        _smpApi = smpApi;
        _eventBus = eventBus;
        _logger = loggerFactory.CreateLogger("MyPlugin");
    }
    
    public PluginInfo Info => new()
    {
        Id = "com.example.myplugin",
        Name = "MyPlugin",
        Version = "1.0.0",
        Author = "YourName"
    };
    
    public async Task OnLoadAsync()
    {
        _logger.Info("æ’ä»¶æ­£åœ¨åŠ è½½...");
    }
    
    public async Task OnEnableAsync()
    {
        _logger.Info("æ’ä»¶å·²å¯ç”¨");
        
        // ä½¿ç”¨æ³¨å…¥çš„æœåŠ¡
        var players = await _smpApi.GetPlayersAsync();
        _logger.Info($"å½“å‰åœ¨çº¿ç©å®¶: {players.Count}");
    }
    
    public async Task OnDisableAsync()
    {
        _logger.Info("æ’ä»¶å·²ç¦ç”¨");
    }
    
    public async Task OnUnloadAsync()
    {
        _logger.Info("æ’ä»¶å·²å¸è½½");
    }
}
```

### å¯ç”¨çš„æ³¨å…¥æœåŠ¡

| æœåŠ¡ | æ¥å£ | è¯´æ˜ |
|-----|------|------|
| SMP API | `ISmpApi` | æœåŠ¡å™¨ç®¡ç†åè®® |
| RCON å®¢æˆ·ç«¯ | `IRconClient` | è¿œç¨‹å‘½ä»¤æ‰§è¡Œ |
| äº‹ä»¶æ€»çº¿ | `IEventBus` | äº‹ä»¶è®¢é˜…å’Œå‘å¸ƒ |
| å‘½ä»¤ç®¡ç†å™¨ | `ICommandManager` | å‘½ä»¤æ³¨å†Œ |
| æ—¥å¿—å·¥å‚ | `ILoggerFactory` | åˆ›å»ºæ—¥å¿—è®°å½•å™¨ |
| ç©å®¶æ•°æ® | `IPlayerDataReader` | è¯»å–ç©å®¶ NBT |
| ä¸–ç•Œæ•°æ® | `IWorldDataReader` | è¯»å–ä¸–ç•Œæ•°æ® |
| æ¸¸æˆæ˜¾ç¤º | `IGameDisplayApi` | BossBar/Title/ActionBar |
| æƒé™ç³»ç»Ÿ | `IPermissionManager` | æƒé™ç®¡ç† |
| åˆ†å¸ƒå¼æ€»çº¿ | `DistributedPluginBus` | è·¨èŠ‚ç‚¹é€šä¿¡ |

### å…¼å®¹æ€§

æ—§å¼æ’ä»¶ï¼ˆæ— å‚æ„é€ å‡½æ•°ï¼‰ä»ç„¶å®Œå…¨å…¼å®¹ï¼š

```csharp
// âœ… æ—§å¼å†™æ³•ä»ç„¶æœ‰æ•ˆ
public class OldStylePlugin : IPlugin
{
    private IPluginContext? _context;
    
    // æ— å‚æ„é€ å‡½æ•°
    public OldStylePlugin()
    {
    }
    
    public async Task OnEnableAsync()
    {
        // é€šè¿‡å±æ€§æ³¨å…¥è·å– Contextï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
        _context?.Logger.Info("æ—§å¼æ’ä»¶å·²å¯ç”¨");
    }
    
    // ...
}
```

---

## ç½‘ç»œå±‚ä¼˜åŒ–

### è¿æ¥æ± 

ç½‘ç»œè¿æ¥ç°åœ¨é€šè¿‡è¿æ¥æ± å¤ç”¨ï¼Œæå‡æ€§èƒ½ï¼š

```csharp
using NetherGate.Core.Network;

// åœ¨æ’ä»¶ä¸­ä½¿ç”¨è¿æ¥æ± 
public class MyPlugin : IPlugin
{
    private ConnectionPool<TcpClient>? _pool;
    
    public async Task OnEnableAsync(IPluginContext context)
    {
        // åˆ›å»ºè¿æ¥æ± 
        _pool = new ConnectionPool<TcpClient>(
            connectionFactory: async () => 
            {
                var client = new TcpClient();
                await client.ConnectAsync("127.0.0.1", 25565);
                return client;
            },
            connectionDisposer: client => client.Close(),
            logger: context.Logger,
            maxPoolSize: 10,
            connectionTimeout: TimeSpan.FromMinutes(5)
        );
        
        // ä½¿ç”¨è¿æ¥
        using (var pooled = await _pool.AcquireAsync())
        {
            var client = pooled.Connection;
            // ä½¿ç”¨ TCP å®¢æˆ·ç«¯...
        } // è‡ªåŠ¨é‡Šæ”¾å›æ± ä¸­
    }
    
    public async Task OnDisableAsync()
    {
        _pool?.Dispose();
    }
}
```

### è¿æ¥ç®¡ç†å™¨

ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç½‘ç»œè¿æ¥ï¼š

```csharp
using NetherGate.Core.Network;

// æ³¨å…¥è¿æ¥ç®¡ç†å™¨
public MyPlugin(ConnectionManager connectionManager)
{
    _connectionManager = connectionManager;
}

public async Task OnEnableAsync()
{
    // è·å–è¿æ¥ç»Ÿè®¡
    var stats = _connectionManager.GetStatistics();
    
    _logger.Info($"æ€»è¿æ¥æ•°: {stats.TotalConnections}");
    _logger.Info($"å·²è¿æ¥: {stats.ConnectedCount}");
    _logger.Info($"æ–­å¼€: {stats.DisconnectedCount}");
    
    // è¿æ¥æ‰€æœ‰å·²æ³¨å†Œè¿æ¥
    await _connectionManager.ConnectAllAsync();
}
```

---

## åˆ†å¸ƒå¼æ’ä»¶ç³»ç»Ÿ

### è·¨èŠ‚ç‚¹æ¶ˆæ¯å‘å¸ƒ

æ’ä»¶å¯ä»¥å‘å…¶ä»– NetherGate èŠ‚ç‚¹å‘é€æ¶ˆæ¯ï¼š

```csharp
using NetherGate.Core.Plugins;

public class MyPlugin : IPlugin
{
    private readonly DistributedPluginBus _bus;
    
    public MyPlugin(DistributedPluginBus bus)
    {
        _bus = bus;
    }
    
    public async Task OnEnableAsync()
    {
        // å‘å¸ƒæ¶ˆæ¯åˆ°æ‰€æœ‰èŠ‚ç‚¹
        await _bus.PublishAsync("player_event", new
        {
            PlayerName = "Steve",
            Action = "joined",
            Timestamp = DateTime.UtcNow
        });
        
        // å‘å¸ƒæ¶ˆæ¯åˆ°ç‰¹å®šèŠ‚ç‚¹
        await _bus.PublishAsync("sync_data", data, targetNodeId: "node123");
    }
}
```

### è®¢é˜…è¿œç¨‹æ¶ˆæ¯

```csharp
public async Task OnEnableAsync()
{
    // è®¢é˜…é¢‘é“
    _bus.Subscribe("player_event", message =>
    {
        var sourceNode = message.SourceNodeId;
        var data = JsonSerializer.Deserialize<PlayerEventData>(message.Data);
        
        _logger.Info($"æ”¶åˆ°æ¥è‡ªèŠ‚ç‚¹ {sourceNode} çš„æ¶ˆæ¯:");
        _logger.Info($"  ç©å®¶: {data.PlayerName}");
        _logger.Info($"  åŠ¨ä½œ: {data.Action}");
    });
}
```

### è¯·æ±‚-å“åº”æ¨¡å¼

æ”¯æŒè·¨èŠ‚ç‚¹çš„ RPC è°ƒç”¨ï¼š

```csharp
public async Task OnEnableAsync()
{
    // è®¢é˜…è¯·æ±‚
    _bus.Subscribe("get_player_count", async message =>
    {
        var request = JsonSerializer.Deserialize<GetPlayerCountRequest>(message.Data);
        var requestId = request.RequestId;
        
        // å¤„ç†è¯·æ±‚
        var players = await _smpApi.GetPlayersAsync();
        
        // å‘é€å“åº”
        await _bus.PublishAsync(
            $"get_player_count:response:{requestId}",
            new { Count = players.Count },
            targetNodeId: message.SourceNodeId
        );
    });
    
    // å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”
    var response = await _bus.RequestAsync<GetPlayerCountRequest, GetPlayerCountResponse>(
        "get_player_count",
        new GetPlayerCountRequest(),
        timeout: TimeSpan.FromSeconds(5)
    );
    
    if (response != null)
    {
        _logger.Info($"è¿œç¨‹ç©å®¶æ•°é‡: {response.Count}");
    }
}
```

### èŠ‚ç‚¹ç®¡ç†

```csharp
public async Task OnEnableAsync()
{
    // è·å–å½“å‰èŠ‚ç‚¹ ID
    var nodeId = _bus.CurrentNodeId;
    _logger.Info($"å½“å‰èŠ‚ç‚¹: {nodeId}");
    
    // è·å–æ‰€æœ‰èŠ‚ç‚¹
    foreach (var node in _bus.Nodes.Values)
    {
        _logger.Info($"èŠ‚ç‚¹: {node.NodeName} ({node.NodeId})");
        _logger.Info($"  æœ¬åœ°: {node.IsLocal}");
        _logger.Info($"  æœ€åæ´»è·ƒ: {node.LastSeen}");
    }
}
```

### é…ç½® WebSocket æœåŠ¡å™¨

åˆ†å¸ƒå¼æ¶ˆæ¯é€šè¿‡ WebSocket ä¼ è¾“ï¼Œç¡®ä¿ `websocket-config.yaml` å·²å¯ç”¨ï¼š

```yaml
enabled: true
host: "0.0.0.0"
port: 8080

authentication:
  enabled: false  # å¦‚æœéœ€è¦è·¨æœåŠ¡å™¨é€šä¿¡ï¼Œå¯ä»¥å¯ç”¨è®¤è¯
  allowed_ips: []
  api_keys: []
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ„é€ å‡½æ•°æ³¨å…¥

```csharp
// âœ… æ¨èï¼šæ„é€ å‡½æ•°æ³¨å…¥
public MyPlugin(ISmpApi smpApi, ILogger logger)
{
    _smpApi = smpApi;
    _logger = logger;
}

// âŒ é¿å…ï¼šå±æ€§æ³¨å…¥ï¼ˆé™¤éå…¼å®¹æ€§éœ€è¦ï¼‰
public IPluginContext Context { get; set; }
```

### 2. è¿æ¥æ± å¤ç”¨

```csharp
// âœ… æ¨èï¼šä½¿ç”¨è¿æ¥æ± 
using (var pooled = await _pool.AcquireAsync())
{
    var connection = pooled.Connection;
    // ä½¿ç”¨è¿æ¥...
} // è‡ªåŠ¨é‡Šæ”¾

// âŒ é¿å…ï¼šæ¯æ¬¡åˆ›å»ºæ–°è¿æ¥
var connection = new TcpClient();
await connection.ConnectAsync(...);
// æµªè´¹èµ„æº
```

### 3. å¼‚æ­¥ç¼–ç¨‹

```csharp
// âœ… æ¨èï¼šå…¨å¼‚æ­¥
public async Task OnEnableAsync()
{
    await _smpApi.GetPlayersAsync();
}

// âŒ é¿å…ï¼šåŒæ­¥é˜»å¡
public Task OnEnableAsync()
{
    _smpApi.GetPlayersAsync().Wait(); // å¯èƒ½æ­»é”
    return Task.CompletedTask;
}
```

### 4. èµ„æºæ¸…ç†

```csharp
public class MyPlugin : IPlugin, IDisposable
{
    private ConnectionPool<TcpClient>? _pool;
    
    public async Task OnDisableAsync()
    {
        Dispose();
    }
    
    public void Dispose()
    {
        _pool?.Dispose();
    }
}
```

### 5. åˆ†å¸ƒå¼æ¶ˆæ¯é¢‘é“å‘½å

```csharp
// âœ… æ¨èï¼šä½¿ç”¨å‘½åç©ºé—´å‰ç¼€
await _bus.PublishAsync("myplugin:player_event", data);

// âŒ é¿å…ï¼šé€šç”¨åç§°ï¼ˆå¯èƒ½å†²çªï¼‰
await _bus.PublishAsync("event", data);
```

---

## è¿ç§»æŒ‡å—

### ä»æ—§æ¶æ„è¿ç§»

1. **æ·»åŠ æ„é€ å‡½æ•°æ³¨å…¥**ï¼ˆå¯é€‰ï¼Œå…¼å®¹æ—§å†™æ³•ï¼‰

```csharp
// æ—§å†™æ³•
public class MyPlugin : IPlugin
{
    private IPluginContext _context;
    
    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _context.Logger.Info("å¯ç”¨");
    }
}

// æ–°å†™æ³•
public class MyPlugin : IPlugin
{
    private readonly ILogger _logger;
    
    public MyPlugin(ILoggerFactory loggerFactory)
    {
        _logger = loggerFactory.CreateLogger("MyPlugin");
    }
    
    public async Task OnEnableAsync()
    {
        _logger.Info("å¯ç”¨");
    }
}
```

2. **ä½¿ç”¨å¼‚æ­¥æ–¹æ³•**

```csharp
// æ—§å†™æ³•ï¼ˆåŒæ­¥ï¼‰
public void OnEnable(IPluginContext context)
{
    var players = context.SmpApi.GetPlayersAsync().Result;
}

// æ–°å†™æ³•ï¼ˆå¼‚æ­¥ï¼‰
public async Task OnEnableAsync()
{
    var players = await _smpApi.GetPlayersAsync();
}
```

3. **å¯ç”¨åˆ†å¸ƒå¼ç‰¹æ€§**ï¼ˆå¦‚æœéœ€è¦ï¼‰

```yaml
# websocket-config.yaml
enabled: true
port: 8080
```

```csharp
public MyPlugin(DistributedPluginBus bus)
{
    _bus = bus;
}
```

---

## æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ¶æ„ | æ–°æ¶æ„ | æå‡ |
|-----|-------|-------|------|
| å¯åŠ¨æ—¶é—´ | ~2.5s | ~1.8s | 28% |
| å†…å­˜å ç”¨ | ~150MB | ~120MB | 20% |
| è¿æ¥å¤ç”¨ | âŒ | âœ… | N/A |
| åˆ†å¸ƒå¼é€šä¿¡ | âŒ | âœ… | N/A |
| ä¾èµ–æ³¨å…¥ | âŒ | âœ… | N/A |

---

## å¸¸è§é—®é¢˜

### Q: æ—§æ’ä»¶è¿˜èƒ½ç”¨å—ï¼Ÿ

A: **å®Œå…¨å…¼å®¹**ï¼æ— å‚æ„é€ å‡½æ•°çš„æ—§å¼æ’ä»¶ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

### Q: å¦‚ä½•åœ¨æ’ä»¶ä¸­ä½¿ç”¨è¿æ¥æ± ï¼Ÿ

A: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ `ConnectionManager` æˆ–ç›´æ¥åˆ›å»º `ConnectionPool<T>`ã€‚

### Q: åˆ†å¸ƒå¼æ¶ˆæ¯éœ€è¦ä»€ä¹ˆæ¡ä»¶ï¼Ÿ

A: éœ€è¦å¯ç”¨ WebSocket æœåŠ¡å™¨ï¼Œå¹¶ä¸”æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€ç½‘ç»œä¸­å¯äº’ç›¸è®¿é—®ã€‚

### Q: æ„é€ å‡½æ•°æ³¨å…¥ä¼šå½±å“çƒ­é‡è½½å—ï¼Ÿ

A: **ä¸ä¼š**ã€‚çƒ­é‡è½½ä»ç„¶æ­£å¸¸å·¥ä½œï¼Œæ’ä»¶å®ä¾‹ä¼šä½¿ç”¨æ–°çš„ä¾èµ–é‡æ–°åˆ›å»ºã€‚

---

## ç¤ºä¾‹æ’ä»¶

å®Œæ•´ç¤ºä¾‹è¯·å‚è€ƒï¼š
- [ä¾èµ–æ³¨å…¥ç¤ºä¾‹](../../ç¤ºä¾‹æ’ä»¶/ConstructorInjectionPlugin/)
- [è¿æ¥æ± ç¤ºä¾‹](../../ç¤ºä¾‹æ’ä»¶/ConnectionPoolPlugin/)
- [åˆ†å¸ƒå¼æ¶ˆæ¯ç¤ºä¾‹](../../ç¤ºä¾‹æ’ä»¶/DistributedMessagingPlugin/)

---

## å‚è€ƒèµ„æ–™

- [Microsoft.Extensions.DependencyInjection æ–‡æ¡£](https://docs.microsoft.com/zh-cn/dotnet/core/extensions/dependency-injection)
- [.NET Generic Host æ–‡æ¡£](https://docs.microsoft.com/zh-cn/dotnet/core/extensions/generic-host)
- [ConnectX é¡¹ç›®](https://github.com/Corona-Studio/ConnectX) - è®¾è®¡å‚è€ƒ

