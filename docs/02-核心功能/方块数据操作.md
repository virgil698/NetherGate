# æ–¹å—æ•°æ®æ“ä½œ

NetherGate æä¾›äº†å¼ºå¤§çš„æ–¹å—æ•°æ®è¯»å†™åŠŸèƒ½ï¼Œè®©ä½ å¯ä»¥è½»æ¾è¯»å–å’Œä¿®æ”¹å®¹å™¨ï¼ˆç®±å­ã€æ¼æ–—ç­‰ï¼‰çš„ç‰©å“æ•°æ®ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [è¯»å–æ•°æ®](#è¯»å–æ•°æ®)
- [å†™å…¥æ•°æ®](#å†™å…¥æ•°æ®)
- [æ”¯æŒçš„å®¹å™¨](#æ”¯æŒçš„å®¹å™¨)
- [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **è·å–æœåŠ¡å®ä¾‹**

```csharp
public class MyPlugin : IPlugin
{
    private IBlockDataReader _blockReader;
    private IBlockDataWriter _blockWriter;
    
    public void OnEnable(IPluginContext context)
    {
        _blockReader = context.BlockDataReader;
        _blockWriter = context.BlockDataWriter;
    }
}
```

### **ç®€å•ç¤ºä¾‹**

```csharp
// è¯»å–ç®±å­å†…å®¹
var position = new Position(100, 64, 200);
var items = await _blockReader.GetChestItemsAsync(position);

// è¾“å‡ºç‰©å“ä¿¡æ¯
foreach (var item in items)
{
    _logger.Info($"æ§½ä½ {item.Slot}: {item.Id} x{item.Count}");
}

// ä¿®æ”¹ç®±å­å†…å®¹
var newItems = items.Where(i => i.Id.Contains("diamond")).ToList();
await _blockWriter.SetContainerItemsAsync(position, newItems);
```

---

## ğŸ“– **è¯»å–æ•°æ®**

### **IBlockDataReader æ¥å£**

```csharp
public interface IBlockDataReader
{
    /// <summary>
    /// è¯»å–ç®±å­ç‰©å“
    /// </summary>
    Task<List<ItemStack>> GetChestItemsAsync(Position position);
    
    /// <summary>
    /// è¯»å–å®¹å™¨ç‰©å“ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
    /// </summary>
    Task<List<ItemStack>> GetContainerItemsAsync(Position position);
    
    /// <summary>
    /// è¯»å–æ–¹å— NBT æ•°æ®
    /// </summary>
    Task<NbtCompound> GetBlockDataAsync(Position position);
    
    /// <summary>
    /// è¯»å–æ–¹å— ID
    /// </summary>
    Task<string> GetBlockIdAsync(Position position);
}
```

### **è¯»å–ç®±å­**

```csharp
var chestPos = new Position(100, 64, 200);
var items = await _blockReader.GetChestItemsAsync(chestPos);

// ç»Ÿè®¡ç‰©å“
var totalItems = items.Count;
var diamondCount = items
    .Where(i => i.Id == "minecraft:diamond")
    .Sum(i => i.Count);

_logger.Info($"ç®±å­æœ‰ {totalItems} ä¸ªç‰©å“ï¼Œå…¶ä¸­ {diamondCount} ä¸ªé’»çŸ³");
```

### **è¯»å–å…¶ä»–å®¹å™¨**

```csharp
// è¯»å–æ¼æ–—
var hopperItems = await _blockReader.GetContainerItemsAsync(hopperPos);

// è¯»å–æ½œå½±ç›’
var shulkerItems = await _blockReader.GetContainerItemsAsync(shulkerPos);

// è¯»å–å‘å°„å™¨
var dispenserItems = await _blockReader.GetContainerItemsAsync(dispenserPos);
```

### **è¯»å–æ–¹å—æ•°æ®**

```csharp
// è¯»å–å®Œæ•´çš„ NBT æ•°æ®
var nbtData = await _blockReader.GetBlockDataAsync(position);

// è®¿é—®è‡ªå®šä¹‰æ•°æ®
if (nbtData.TryGet("CustomName", out NbtString customName))
{
    _logger.Info($"è‡ªå®šä¹‰åç§°: {customName.Value}");
}

// è¯»å–æ–¹å— ID
var blockId = await _blockReader.GetBlockIdAsync(position);
_logger.Info($"æ–¹å—ç±»å‹: {blockId}");
```

---

## âœï¸ **å†™å…¥æ•°æ®**

### **IBlockDataWriter æ¥å£**

```csharp
public interface IBlockDataWriter
{
    /// <summary>
    /// è®¾ç½®å®¹å™¨ç‰©å“
    /// </summary>
    Task SetContainerItemsAsync(Position position, List<ItemStack> items);
    
    /// <summary>
    /// æ·»åŠ ç‰©å“åˆ°å®¹å™¨
    /// </summary>
    Task AddItemsToContainerAsync(Position position, List<ItemStack> items);
    
    /// <summary>
    /// æ¸…ç©ºå®¹å™¨
    /// </summary>
    Task ClearContainerAsync(Position position);
    
    /// <summary>
    /// ä¿®æ”¹æ–¹å— NBT æ•°æ®
    /// </summary>
    Task SetBlockDataAsync(Position position, NbtCompound data);
}
```

### **è®¾ç½®å®¹å™¨å†…å®¹**

```csharp
// åˆ›å»ºç‰©å“åˆ—è¡¨
var items = new List<ItemStack>
{
    new ItemStack
    {
        Slot = 0,
        Id = "minecraft:diamond",
        Count = 64
    },
    new ItemStack
    {
        Slot = 1,
        Id = "minecraft:gold_ingot",
        Count = 32
    }
};

// å†™å…¥åˆ°ç®±å­
await _blockWriter.SetContainerItemsAsync(chestPos, items);
```

### **æ·»åŠ ç‰©å“**

```csharp
// æ·»åŠ ç‰©å“ï¼ˆä¸ä¼šè¦†ç›–ç°æœ‰å†…å®¹ï¼‰
var newItems = new List<ItemStack>
{
    new ItemStack { Id = "minecraft:emerald", Count = 16 }
};

await _blockWriter.AddItemsToContainerAsync(chestPos, newItems);
```

### **æ¸…ç©ºå®¹å™¨**

```csharp
// æ¸…ç©ºç®±å­
await _blockWriter.ClearContainerAsync(chestPos);
```

### **ä¿®æ”¹ NBT æ•°æ®**

```csharp
// è®¾ç½®ç®±å­çš„è‡ªå®šä¹‰åç§°
var nbtData = new NbtCompound("BlockData")
{
    new NbtString("CustomName", "{\"text\":\"æˆ‘çš„ç®±å­\"}")
};

await _blockWriter.SetBlockDataAsync(chestPos, nbtData);
```

---

## ğŸ“¦ **æ”¯æŒçš„å®¹å™¨**

| å®¹å™¨ç±»å‹ | æ–¹å— ID | æ§½ä½æ•° | è¯´æ˜ |
|---------|---------|--------|------|
| **ç®±å­** | `minecraft:chest` | 27 | æ™®é€šç®±å­ |
| **å¤§ç®±å­** | `minecraft:chest` (åŒ) | 54 | ä¸¤ä¸ªç®±å­å¹¶æ’ |
| **æ½œå½±ç›’** | `minecraft:shulker_box` | 27 | å¯æºå¸¦çš„ç®±å­ |
| **æ¼æ–—** | `minecraft:hopper` | 5 | è‡ªåŠ¨ä¼ è¾“ç‰©å“ |
| **å‘å°„å™¨** | `minecraft:dispenser` | 9 | å‘å°„ç‰©å“ |
| **æŠ•æ·å™¨** | `minecraft:dropper` | 9 | æŠ•æ·ç‰©å“ |
| **ç†”ç‚‰** | `minecraft:furnace` | 3 | è¾“å…¥ã€ç‡ƒæ–™ã€è¾“å‡º |
| **çƒŸç†ç‚‰** | `minecraft:smoker` | 3 | å¿«é€Ÿçƒ¹é¥ªé£Ÿç‰© |
| **é«˜ç‚‰** | `minecraft:blast_furnace` | 3 | å¿«é€Ÿå†¶ç‚¼çŸ¿ç‰© |
| **é…¿é€ å°** | `minecraft:brewing_stand` | 5 | é…¿é€ è¯æ°´ |
| **æœ«å½±ç®±** | `minecraft:ender_chest` | 27 | ç©å®¶ä¸“å±å­˜å‚¨ |

---

## ğŸ’¼ **å®æˆ˜ç¤ºä¾‹**

### **ç¤ºä¾‹1ï¼šç®±å­æ•´ç†å‘½ä»¤**

```csharp
public class SortChestCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var pos = ParsePosition(args);
        
        // è¯»å–ç®±å­å†…å®¹
        var items = await _blockReader.GetChestItemsAsync(pos);
        
        if (items.Count == 0)
        {
            return CommandResult.Fail("ç®±å­æ˜¯ç©ºçš„");
        }
        
        // æ’åºï¼šæŒ‰ç‰©å“IDæ’åº
        var sorted = items
            .OrderBy(i => i.Id)
            .ThenByDescending(i => i.Count)
            .Select((item, index) => new ItemStack
            {
                Slot = (byte)index,
                Id = item.Id,
                Count = item.Count,
                Tag = item.Tag
            })
            .ToList();
        
        // å†™å›ç®±å­
        await _blockWriter.SetContainerItemsAsync(pos, sorted);
        
        return CommandResult.Ok($"å·²æ•´ç† {items.Count} ä¸ªç‰©å“");
    }
}
```

### **ç¤ºä¾‹2ï¼šæ‰¹é‡å¡«å……ç®±å­**

```csharp
public class FillChestCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var pos = ParsePosition(args[0]);
        var itemId = args[1];
        var count = int.Parse(args[2]);
        
        // åˆ›å»ºç‰©å“åˆ—è¡¨
        var items = new List<ItemStack>();
        var maxStackSize = 64;
        var slot = 0;
        
        while (count > 0 && slot < 27)
        {
            var stackCount = Math.Min(count, maxStackSize);
            items.Add(new ItemStack
            {
                Slot = (byte)slot,
                Id = itemId,
                Count = (byte)stackCount
            });
            
            count -= stackCount;
            slot++;
        }
        
        // å†™å…¥ç®±å­
        await _blockWriter.SetContainerItemsAsync(pos, items);
        
        return CommandResult.Ok($"å·²å¡«å…… {items.Count} ç»„ç‰©å“");
    }
}
```

### **ç¤ºä¾‹3ï¼šç®±å­å¤åˆ¶**

```csharp
public class CopyChestCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var sourcePos = ParsePosition(args[0]);
        var targetPos = ParsePosition(args[1]);
        
        // è¯»å–æºç®±å­
        var items = await _blockReader.GetChestItemsAsync(sourcePos);
        
        // å¤åˆ¶åˆ°ç›®æ ‡ç®±å­
        await _blockWriter.SetContainerItemsAsync(targetPos, items);
        
        return CommandResult.Ok($"å·²å¤åˆ¶ {items.Count} ä¸ªç‰©å“");
    }
}
```

### **ç¤ºä¾‹4ï¼šç‰©å“æœç´¢ç³»ç»Ÿ**

```csharp
public class FindItemCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var itemId = args[0];
        var searchRadius = int.Parse(args[1]);
        var playerPos = await GetPlayerPositionAsync(sender.Name);
        
        var results = new List<(Position, int)>();
        
        // æ‰«æå‘¨å›´çš„ç®±å­
        var positions = playerPos.GetSurroundingPositions(searchRadius);
        
        foreach (var pos in positions)
        {
            var blockId = await _blockReader.GetBlockIdAsync(pos);
            
            if (blockId == "minecraft:chest")
            {
                var items = await _blockReader.GetChestItemsAsync(pos);
                var count = items
                    .Where(i => i.Id == itemId)
                    .Sum(i => i.Count);
                
                if (count > 0)
                {
                    results.Add((pos, count));
                }
            }
        }
        
        if (results.Count == 0)
        {
            return CommandResult.Fail($"æœªæ‰¾åˆ° {itemId}");
        }
        
        var report = new StringBuilder();
        report.AppendLine($"æ‰¾åˆ° {results.Count} ä¸ªç®±å­åŒ…å« {itemId}:");
        
        foreach (var (pos, count) in results.OrderByDescending(r => r.Item2))
        {
            report.AppendLine($"  {pos.ToFormattedString()}: {count} ä¸ª");
        }
        
        return CommandResult.Ok(report.ToString());
    }
}
```

### **ç¤ºä¾‹5ï¼šè‡ªåŠ¨å‹ç¼©ç³»ç»Ÿ**

```csharp
public class CompressChestCommand : ICommand
{
    private readonly Dictionary<string, string> _compressionRecipes = new()
    {
        { "minecraft:iron_ingot", "minecraft:iron_block" },      // 9ä¸ªé“é”­ -> 1ä¸ªé“å—
        { "minecraft:gold_ingot", "minecraft:gold_block" },
        { "minecraft:diamond", "minecraft:diamond_block" },
        { "minecraft:emerald", "minecraft:emerald_block" },
        { "minecraft:coal", "minecraft:coal_block" }
    };
    
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var pos = ParsePosition(args);
        var items = await _blockReader.GetChestItemsAsync(pos);
        
        var compressed = new List<ItemStack>();
        var itemGroups = items.GroupBy(i => i.Id);
        
        foreach (var group in itemGroups)
        {
            var totalCount = group.Sum(i => i.Count);
            var itemId = group.Key;
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‹ç¼©
            if (_compressionRecipes.TryGetValue(itemId, out var blockId))
            {
                var blocks = totalCount / 9;
                var remainder = totalCount % 9;
                
                // æ·»åŠ å‹ç¼©åçš„æ–¹å—
                if (blocks > 0)
                {
                    compressed.Add(new ItemStack
                    {
                        Id = blockId,
                        Count = (byte)blocks
                    });
                }
                
                // æ·»åŠ å‰©ä½™çš„ç‰©å“
                if (remainder > 0)
                {
                    compressed.Add(new ItemStack
                    {
                        Id = itemId,
                        Count = (byte)remainder
                    });
                }
            }
            else
            {
                // ä¸èƒ½å‹ç¼©çš„ç‰©å“ç›´æ¥ä¿ç•™
                compressed.AddRange(group);
            }
        }
        
        // é‡æ–°åˆ†é…æ§½ä½
        for (int i = 0; i < compressed.Count; i++)
        {
            compressed[i].Slot = (byte)i;
        }
        
        await _blockWriter.SetContainerItemsAsync(pos, compressed);
        
        return CommandResult.Ok($"å‹ç¼©å®Œæˆï¼Œä» {items.Count} å‡å°‘åˆ° {compressed.Count} ç»„");
    }
}
```

### **ç¤ºä¾‹6ï¼šç®±å­å•†åº—ç³»ç»Ÿ**

```csharp
public class ChestShopPlugin : IPlugin
{
    private readonly Dictionary<Position, ShopConfig> _shops = new();
    
    public void OnEnable(IPluginContext context)
    {
        // ç›‘å¬ç®±å­äº¤äº’
        context.EventBus.Subscribe<PlayerInteractEvent>(async e =>
        {
            if (e.Action != InteractionAction.RightClick) return;
            
            var pos = e.BlockPosition;
            if (!_shops.ContainsKey(pos)) return;
            
            var shop = _shops[pos];
            var items = await context.BlockDataReader.GetChestItemsAsync(pos);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å•†å“
            var availableCount = items
                .Where(i => i.Id == shop.ItemId)
                .Sum(i => i.Count);
            
            if (availableCount < shop.ItemsPerPurchase)
            {
                await context.GameDisplay.SendMessageAsync(
                    e.PlayerName,
                    "Â§cå•†åº—åº“å­˜ä¸è¶³ï¼"
                );
                return;
            }
            
            // æ£€æŸ¥ç©å®¶è´§å¸
            if (!await HasEnoughMoneyAsync(e.PlayerName, shop.Price))
            {
                await context.GameDisplay.SendMessageAsync(
                    e.PlayerName,
                    $"Â§cé‡‘é’±ä¸è¶³ï¼éœ€è¦ {shop.Price} é‡‘å¸"
                );
                return;
            }
            
            // æ‰§è¡Œäº¤æ˜“
            await DeductMoneyAsync(e.PlayerName, shop.Price);
            await GiveItemAsync(e.PlayerName, shop.ItemId, shop.ItemsPerPurchase);
            
            // ä»ç®±å­æ‰£é™¤ç‰©å“
            var remaining = items
                .Where(i => i.Id == shop.ItemId)
                .Take(shop.ItemsPerPurchase)
                .ToList();
            
            items.RemoveAll(i => remaining.Contains(i));
            await context.BlockDataWriter.SetContainerItemsAsync(pos, items);
            
            await context.GameDisplay.SendMessageAsync(
                e.PlayerName,
                $"Â§aè´­ä¹°æˆåŠŸï¼èŠ±è´¹ {shop.Price} é‡‘å¸"
            );
        });
    }
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. é”™è¯¯å¤„ç†**

âœ… **æ¨èï¼š** å§‹ç»ˆå¤„ç†å¼‚å¸¸
```csharp
try
{
    var items = await _blockReader.GetChestItemsAsync(pos);
    // å¤„ç†ç‰©å“...
}
catch (Exception ex)
{
    _logger.Error($"è¯»å–ç®±å­å¤±è´¥: {ex.Message}");
    return CommandResult.Fail("ç®±å­è¯»å–å¤±è´¥");
}
```

### **2. éªŒè¯æ–¹å—ç±»å‹**

âœ… **æ¨èï¼š** å…ˆæ£€æŸ¥æ–¹å—ç±»å‹
```csharp
var blockId = await _blockReader.GetBlockIdAsync(pos);

if (blockId != "minecraft:chest")
{
    return CommandResult.Fail("ç›®æ ‡ä¸æ˜¯ç®±å­");
}

var items = await _blockReader.GetChestItemsAsync(pos);
```

### **3. æ§½ä½ç®¡ç†**

âœ… **æ¨èï¼š** æ­£ç¡®è®¾ç½®æ§½ä½
```csharp
var items = new List<ItemStack>();

for (int i = 0; i < itemData.Count; i++)
{
    items.Add(new ItemStack
    {
        Slot = (byte)i,  // ç¡®ä¿æ§½ä½è¿ç»­
        // ...
    });
}
```

### **4. ç»“åˆæ‰©å±•æ–¹æ³•**

âœ… **æ¨èï¼š** ä½¿ç”¨æ‰©å±•æ–¹æ³•ç®€åŒ–æ“ä½œ
```csharp
var items = await _blockReader.GetChestItemsAsync(pos);

// ä½¿ç”¨æ‰©å±•æ–¹æ³•
var sorted = items
    .FilterEnchanted()
    .SortByRarity()
    .ToList();

await _blockWriter.SetContainerItemsAsync(pos, sorted);
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [NBTæ•°æ®æ“ä½œ](./NBTæ•°æ®æ“ä½œ.md)
- [ç‰©å“ç»„ä»¶ç³»ç»Ÿ](./ç‰©å“ç»„ä»¶ç³»ç»Ÿ.md)
- [æ‰©å±•æ–¹æ³•](../04-é«˜çº§åŠŸèƒ½/æ‰©å±•æ–¹æ³•.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-01-08  
**è®¸å¯è¯ï¼š** LGPL-3.0

