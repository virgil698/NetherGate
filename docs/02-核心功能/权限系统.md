# NetherGate 权限系统

NetherGate 提供了一个功能完整的权限管理系统，支持权限组、继承、优先级和用户特定权限。

---

## 📋 **目录**

- [快速开始](#快速开始)
- [核心概念](#核心概念)
- [配置文件](#配置文件)
- [API 使用](#api-使用)
- [权限节点](#权限节点)
- [最佳实践](#最佳实践)

---

## 🚀 **快速开始**

### **1. 创建权限配置**

首次运行后会自动生成 `permissions.yaml`：

```yaml
# 权限组定义
groups:
  # 默认组（所有玩家）
  default:
    priority: 0
    permissions:
      - "nethergate.help"
      - "nethergate.plugin.list"
    inherit_from: []
    is_default: true
  
  # VIP 组
  vip:
    priority: 10
    permissions:
      - "nethergate.plugin.*"
      - "myplugin.vip"
    inherit_from:
      - default
  
  # 管理员组
  admin:
    priority: 50
    permissions:
      - "*"  # 所有权限
    inherit_from:
      - vip
  
  # 超级管理员
  owner:
    priority: 100
    permissions:
      - "*"
    inherit_from: []

# 玩家分组
players:
  "Steve":
    - admin
  "Alex":
    - vip
```

### **2. 在插件中检查权限**

```csharp
public class MyPlugin : IPlugin
{
    private IPluginContext _context;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 订阅玩家加入事件
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var playerName = e.Player.Name;
        
        // 检查权限
        if (await _context.PermissionManager.HasPermissionAsync(playerName, "myplugin.vip"))
        {
            _context.Logger.Info($"{playerName} 拥有 VIP 权限");
            // 给予 VIP 福利
        }
    }
}
```

---

## 🎯 **核心概念**

### **1. 权限节点**

权限节点使用点分隔的字符串：

```
nethergate.plugin.reload
nethergate.plugin.*
myplugin.command.spawn
myplugin.*
*
```

**通配符支持：**
- `*` - 匹配所有权限
- `plugin.*` - 匹配 plugin 下的所有权限
- `-permission` - 否定权限（移除权限）

### **通配符详细说明**

#### **1. 全局通配符 (`*`)**

授予所有权限：

```yaml
owner:
  priority: 100
  permissions:
    - "*"  # 所有权限，包括核心和所有插件
```

等价于：
```
nethergate.*
myplugin.*
otherplugin.*
... 所有权限
```

#### **2. 命名空间通配符 (`namespace.*`)**

授予特定命名空间下的所有权限：

```yaml
admin:
  permissions:
    - "nethergate.*"      # 所有 NetherGate 核心权限
    - "myplugin.*"        # 所有 myplugin 权限
```

**匹配规则**：
```
nethergate.*  →  匹配:
  - nethergate.help
  - nethergate.plugin.reload
  - nethergate.permission.grant
  
myplugin.*  →  匹配:
  - myplugin.command.spawn
  - myplugin.teleport
  - myplugin.admin.kick
```

#### **3. 多级通配符**

通配符可以在任意级别使用：

```yaml
moderator:
  permissions:
    - "nethergate.plugin.*"       # 所有插件管理权限
    - "myplugin.command.*"        # 所有命令权限
    - "myplugin.teleport.*"       # 所有传送相关权限
```

**匹配示例**：
```
nethergate.plugin.*  →  匹配:
  - nethergate.plugin.reload
  - nethergate.plugin.enable
  - nethergate.plugin.disable
  - nethergate.plugin.info
  
myplugin.command.*  →  匹配:
  - myplugin.command.spawn
  - myplugin.command.home
  - myplugin.command.warp
```

#### **4. 否定权限 (`-permission`)**

移除特定权限，即使通过继承获得：

```yaml
admin:
  priority: 50
  permissions:
    - "nethergate.*"              # 所有核心权限
    - "-nethergate.plugin.disable" # 但不能禁用插件
    
moderator:
  inherit_from: [admin]
  permissions:
    - "myplugin.*"                # 所有插件权限
    - "-myplugin.admin.delete"    # 但不能删除数据
```

**否定权限优先级**：
```
明确的否定权限 > 明确的授权权限 > 通配符授权
```

**示例**：
```yaml
# 场景：给予所有传送权限，但禁止跨世界传送
teleporter:
  permissions:
    - "myplugin.teleport.*"       # 所有传送权限
    - "-myplugin.teleport.cross_world"  # 禁止跨世界传送
```

#### **5. 通配符使用最佳实践**

**✅ 推荐做法**：

```yaml
# 1. 分层授权
moderator:
  permissions:
    - "nethergate.plugin.*"    # 插件管理
    - "nethergate.kick"        # 踢人
    - "nethergate.mute"        # 禁言

# 2. 最小权限原则
builder:
  permissions:
    - "myplugin.build.*"       # 仅建筑相关
    - "-myplugin.build.admin"  # 排除管理功能

# 3. 细粒度控制
vip:
  permissions:
    - "myplugin.teleport.home"     # 回家
    - "myplugin.teleport.spawn"    # 出生点
    - "-myplugin.teleport.admin"   # 不能使用管理传送
```

**❌ 不推荐做法**：

```yaml
# 过于宽泛的权限
guest:
  permissions:
    - "*"  # ❌ 不要给普通用户所有权限

# 滥用否定权限
user:
  permissions:
    - "myplugin.*"
    - "-myplugin.feature1"
    - "-myplugin.feature2"
    - "-myplugin.feature3"  # ❌ 如果需要禁止很多，应该重新设计权限结构
```

#### **6. 通配符匹配示例**

完整的权限匹配示例：

```yaml
player_permissions:
  "Steve":
    - "nethergate.*"           # 所有核心权限
    - "backup.create"          # backup 插件的创建权限
    - "backup.restore"         # backup 插件的恢复权限
    - "-backup.delete"         # 但不能删除备份
    
  "Alex":
    - "myplugin.command.*"     # 所有命令
    - "myplugin.teleport.home" # 回家传送
    - "-myplugin.command.admin.*"  # 但不能使用管理命令
```

**权限检查结果**：

| 玩家 | 检查权限 | 结果 | 说明 |
|------|---------|------|------|
| Steve | `nethergate.plugin.reload` | ✅ 允许 | 匹配 `nethergate.*` |
| Steve | `backup.create` | ✅ 允许 | 明确授权 |
| Steve | `backup.delete` | ❌ 拒绝 | 被否定权限移除 |
| Alex | `myplugin.command.spawn` | ✅ 允许 | 匹配 `myplugin.command.*` |
| Alex | `myplugin.command.admin.kick` | ❌ 拒绝 | 被否定权限移除 |
| Alex | `myplugin.teleport.home` | ✅ 允许 | 明确授权 |
| Alex | `myplugin.teleport.warp` | ❌ 拒绝 | 未授权 |

### **2. 权限组**

权限组定义了一组权限的集合：

```yaml
groups:
  moderator:
    priority: 30  # 优先级（数字越大优先级越高）
    permissions:
      - "nethergate.kick"
      - "nethergate.ban"
      - "myplugin.moderate"
    inherit_from:
      - vip  # 继承 VIP 组的所有权限
    is_default: false
```

**属性说明：**
- `priority` - 优先级，用于冲突解决（高优先级覆盖低优先级）
- `permissions` - 权限列表
- `inherit_from` - 继承的组（支持多继承）
- `is_default` - 是否为默认组（新玩家自动加入）

### **3. 权限继承**

```
owner (100)
  └─ 拥有所有权限

admin (50)
  └─ 继承自 vip
      └─ 管理权限 + VIP 权限

vip (10)
  └─ 继承自 default
      └─ VIP 权限 + 默认权限

default (0)
  └─ 基础权限
```

**继承规则：**
1. 子组继承父组的所有权限
2. 支持多继承（从多个组继承）
3. 高优先级权限覆盖低优先级
4. 否定权限（`-permission`）可以移除继承的权限

### **4. 用户特定权限**

除了组权限，还可以为单个玩家设置特定权限：

```csharp
// 给予玩家特定权限
await _context.PermissionManager.GrantPermissionAsync("Steve", "special.permission");

// 移除玩家特定权限
await _context.PermissionManager.RevokePermissionAsync("Steve", "special.permission");
```

**优先级：**
```
用户特定权限 > 最高优先级组权限 > 继承的组权限 > 默认组权限
```

---

## 📝 **配置文件**

### **完整配置示例**

```yaml
# ============================================
# 权限组定义
# ============================================
groups:
  # 默认组（所有玩家自动加入）
  default:
    priority: 0
    permissions:
      - "nethergate.help"
      - "nethergate.plugin.list"
      - "myplugin.basic"
    inherit_from: []
    is_default: true
  
  # VIP 玩家
  vip:
    priority: 10
    permissions:
      - "nethergate.plugin.info"
      - "myplugin.vip.*"
      - "myplugin.teleport"
    inherit_from:
      - default
  
  # 管理助手
  helper:
    priority: 20
    permissions:
      - "nethergate.kick"
      - "myplugin.moderate"
    inherit_from:
      - vip
  
  # 版主
  moderator:
    priority: 30
    permissions:
      - "nethergate.ban"
      - "nethergate.whitelist.*"
      - "myplugin.moderate.*"
    inherit_from:
      - helper
  
  # 管理员
  admin:
    priority: 50
    permissions:
      - "nethergate.*"
      - "myplugin.*"
      - "-myplugin.dangerous"  # 否定权限
    inherit_from:
      - moderator
  
  # 超级管理员/服主
  owner:
    priority: 100
    permissions:
      - "*"  # 所有权限
    inherit_from: []

# ============================================
# 玩家组分配
# ============================================
players:
  "Steve":
    - owner
  
  "Alex":
    - admin
  
  "Bob":
    - moderator
    - vip  # 一个玩家可以在多个组
  
  "Charlie":
    - helper
```

### **配置热重载**

修改 `permissions.yaml` 后，可以热重载：

```bash
# 控制台命令
permission reload

# 或使用 API
await _context.PermissionManager.ReloadAsync();
```

---

## 🔧 **API 使用**

### **IPermissionManager 接口**

```csharp
public interface IPermissionManager
{
    // ========== 权限检查 ==========
    
    /// <summary>
    /// 检查玩家是否拥有权限
    /// </summary>
    Task<bool> HasPermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 获取玩家的权限等级
    /// </summary>
    Task<PermissionLevel> GetPermissionLevelAsync(string playerName);
    
    // ========== 用户权限管理 ==========
    
    /// <summary>
    /// 给予玩家权限
    /// </summary>
    Task GrantPermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 移除玩家权限
    /// </summary>
    Task RevokePermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 获取玩家的所有权限
    /// </summary>
    Task<List<string>> GetUserPermissionsAsync(string playerName);
    
    // ========== 用户组管理 ==========
    
    /// <summary>
    /// 将玩家添加到组
    /// </summary>
    Task AddUserToGroupAsync(string playerName, string groupName);
    
    /// <summary>
    /// 从组移除玩家
    /// </summary>
    Task RemoveUserFromGroupAsync(string playerName, string groupName);
    
    /// <summary>
    /// 获取玩家所在的组
    /// </summary>
    Task<List<string>> GetUserGroupsAsync(string playerName);
    
    // ========== 权限组管理 ==========
    
    /// <summary>
    /// 创建权限组
    /// </summary>
    Task CreateGroupAsync(string groupName, int priority = 0);
    
    /// <summary>
    /// 删除权限组
    /// </summary>
    Task DeleteGroupAsync(string groupName);
    
    /// <summary>
    /// 给予组权限
    /// </summary>
    Task GrantGroupPermissionAsync(string groupName, string permission);
    
    /// <summary>
    /// 移除组权限
    /// </summary>
    Task RevokeGroupPermissionAsync(string groupName, string permission);
    
    /// <summary>
    /// 获取组的所有权限
    /// </summary>
    Task<List<string>> GetGroupPermissionsAsync(string groupName);
    
    // ========== 配置管理 ==========
    
    /// <summary>
    /// 重新加载权限配置
    /// </summary>
    Task ReloadAsync();
    
    /// <summary>
    /// 保存权限配置
    /// </summary>
    Task SaveAsync();
}
```

### **使用示例**

#### **1. 权限检查**

```csharp
// 检查单个权限
if (await _context.PermissionManager.HasPermissionAsync("Steve", "myplugin.admin"))
{
    // 执行管理员操作
}

// 检查权限等级
var level = await _context.PermissionManager.GetPermissionLevelAsync("Steve");
switch (level)
{
    case PermissionLevel.Owner:
        // 服主权限
        break;
    case PermissionLevel.Admin:
        // 管理员权限
        break;
    case PermissionLevel.Moderator:
        // 版主权限
        break;
    case PermissionLevel.User:
        // 普通用户
        break;
}
```

#### **2. 动态权限管理**

```csharp
// 临时给予权限（如购买 VIP）
await _context.PermissionManager.AddUserToGroupAsync("Steve", "vip");

// 移除权限（如 VIP 过期）
await _context.PermissionManager.RemoveUserFromGroupAsync("Steve", "vip");

// 给予特定权限
await _context.PermissionManager.GrantPermissionAsync("Steve", "special.event.access");

// 移除特定权限
await _context.PermissionManager.RevokePermissionAsync("Steve", "special.event.access");
```

#### **3. 组管理**

```csharp
// 创建新组
await _context.PermissionManager.CreateGroupAsync("builder", priority: 15);

// 给组添加权限
await _context.PermissionManager.GrantGroupPermissionAsync("builder", "myplugin.build.*");
await _context.PermissionManager.GrantGroupPermissionAsync("builder", "myplugin.worldedit");

// 查询组权限
var permissions = await _context.PermissionManager.GetGroupPermissionsAsync("builder");
foreach (var perm in permissions)
{
    _context.Logger.Info($"- {perm}");
}

// 删除组
await _context.PermissionManager.DeleteGroupAsync("builder");
```

#### **4. 在命令中使用**

```csharp
public class AdminCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "admin";
    public string Description => "管理员命令";

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        // 检查权限
        if (sender != null && !await _context.PermissionManager.HasPermissionAsync(
            sender.Name, "myplugin.admin"))
        {
            return CommandResult.Fail("你没有权限使用此命令");
        }

        // 执行管理员操作
        return CommandResult.Success("管理员命令执行成功");
    }
}
```

---

## 🎯 **权限节点约定**

### **NetherGate 核心权限**

```
nethergate.*                    # 所有核心权限
nethergate.help                 # 查看帮助
nethergate.plugin.*             # 所有插件管理权限
nethergate.plugin.list          # 列出插件
nethergate.plugin.info          # 查看插件信息
nethergate.plugin.reload        # 重载插件
nethergate.plugin.enable        # 启用插件
nethergate.plugin.disable       # 禁用插件
nethergate.permission.*         # 所有权限管理权限
nethergate.permission.reload    # 重载权限配置
nethergate.permission.grant     # 授予权限
nethergate.permission.revoke    # 移除权限
```

### **插件权限命名建议**

```
<插件名>.*                       # 插件所有权限
<插件名>.command.*               # 所有命令权限
<插件名>.command.<命令名>        # 特定命令
<插件名>.feature.*               # 所有功能权限
<插件名>.feature.<功能名>        # 特定功能
<插件名>.admin                   # 管理权限
```

**示例：**
```
economy.*
economy.command.*
economy.command.balance
economy.command.pay
economy.command.admin
economy.feature.shop
economy.feature.auction
economy.admin
```

---

## 💡 **最佳实践**

### **1. 权限粒度**

✅ **推荐：** 细粒度权限
```yaml
permissions:
  - "myplugin.command.tp"
  - "myplugin.command.tphere"
  - "myplugin.feature.home"
```

❌ **不推荐：** 过于粗粒度
```yaml
permissions:
  - "myplugin.*"  # 给予所有权限
```

### **2. 组织结构**

```yaml
# 按角色组织
groups:
  player:    # 玩家
  vip:       # 付费玩家
  helper:    # 管理助手
  moderator: # 版主
  admin:     # 管理员
  owner:     # 服主
```

### **3. 继承链**

```
owner
 └─ admin
     └─ moderator
         └─ helper
             └─ vip
                 └─ player (default)
```

### **4. 否定权限**

```yaml
admin:
  permissions:
    - "nethergate.*"
    - "-nethergate.server.stop"  # 禁止停服
    - "myplugin.*"
    - "-myplugin.dangerous"      # 禁止危险操作
```

### **5. 临时权限**

对于临时权限，建议在代码中动态管理而不是写入配置：

```csharp
// 活动期间给予特殊权限
await _context.PermissionManager.GrantPermissionAsync(playerName, "event.halloween");

// 活动结束移除
await _context.PermissionManager.RevokePermissionAsync(playerName, "event.halloween");
```

---

## 🔍 **调试和测试**

### **查看玩家权限**

```bash
# 控制台命令
permission check Steve myplugin.admin
# 输出: Steve 拥有权限 myplugin.admin: true

permission user Steve list
# 输出: Steve 的权限:
#   - nethergate.*
#   - myplugin.*
#   组: admin, vip
```

### **调试日志**

```csharp
// 启用权限调试日志
_context.Logger.Debug($"检查权限: {playerName} - {permission}");

var hasPermission = await _context.PermissionManager.HasPermissionAsync(playerName, permission);

_context.Logger.Debug($"结果: {hasPermission}");
```

---

## 🚨 **常见问题**

### **Q: 权限不生效？**

**A:** 检查：
1. 配置文件语法是否正确
2. 权限节点是否拼写正确
3. 组的优先级是否合理
4. 是否有否定权限覆盖

### **Q: 如何给所有玩家默认权限？**

**A:** 在 default 组中设置：
```yaml
groups:
  default:
    is_default: true  # 所有玩家自动加入
    permissions:
      - "your.default.permissions"
```

### **Q: 如何实现权限过期？**

**A:** 在插件中使用定时器：
```csharp
// 定时检查 VIP 过期
_timer = new Timer(async _ => {
    foreach (var player in expiredVips)
    {
        await _context.PermissionManager.RemoveUserFromGroupAsync(player, "vip");
    }
}, null, TimeSpan.Zero, TimeSpan.FromHours(1));
```

---

## 📚 **相关文档**

- [命令系统](./命令系统.md) - 在命令中使用权限
- [插件开发指南](../03-插件开发/插件开发指南.md)
- [API 参考](../03-插件开发/API参考.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-05
