# NetherGate 权限系统 API

NetherGate 提供了权限系统的核心 API 接口，支持权限检查、用户组管理等功能。

> 💡 **注意**：NetherGate 核心只提供权限 API 接口，具体的权限管理功能（如权限配置、命令管理等）由独立的权限管理插件实现。

---

## 📋 **目录**

- [核心概念](#核心概念)
- [API 接口](#api-接口)
- [使用示例](#使用示例)
- [权限节点约定](#权限节点约定)
- [插件集成](#插件集成)
- [最佳实践](#最佳实践)

---

## 🎯 **核心概念**

### **权限系统架构**

```
┌─────────────────────────────────────┐
│   NetherGate.API (权限接口)         │
│   - IPermissionManager              │
│   - 权限检查和查询 API              │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│   权限管理插件 (单独实现)            │
│   - 权限配置文件管理                 │
│   - 权限命令                         │
│   - 权限组系统                       │
│   - 用户权限管理                     │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│   业务插件 (使用权限)                │
│   - 检查玩家权限                     │
│   - 控制功能访问                     │
└─────────────────────────────────────┘
```

---

## 🚀 **快速开始**

### **在插件中使用权限 API**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Permissions;

public class MyPlugin : IPlugin
{
    private IPluginContext _context;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 订阅玩家加入事件
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var playerName = e.Player.Name;
        
        // 检查权限
        if (await _context.PermissionManager.HasPermissionAsync(playerName, "myplugin.vip"))
        {
            _context.Logger.Info($"{playerName} 拥有 VIP 权限");
            // 给予 VIP 福利
        }
    }
}
```

---

## 🎯 **核心概念（由权限插件实现）**

### **1. 权限节点**

权限节点使用点分隔的字符串：

```
nethergate.plugin.reload
nethergate.plugin.*
myplugin.command.spawn
myplugin.*
*
```

**通配符支持：**
- `*` - 匹配所有权限
- `plugin.*` - 匹配 plugin 下的所有权限
- `-permission` - 否定权限（移除权限）

### **通配符详细说明**

#### **1. 全局通配符 (`*`)**

授予所有权限：

```yaml
owner:
  priority: 100
  permissions:
    - "*"  # 所有权限，包括核心和所有插件
```

等价于：
```
nethergate.*
myplugin.*
otherplugin.*
... 所有权限
```

#### **2. 命名空间通配符 (`namespace.*`)**

授予特定命名空间下的所有权限：

```yaml
admin:
  permissions:
    - "nethergate.*"      # 所有 NetherGate 核心权限
    - "myplugin.*"        # 所有 myplugin 权限
```

**匹配规则**：
```
nethergate.*  →  匹配:
  - nethergate.help
  - nethergate.plugin.reload
  - nethergate.permission.grant
  
myplugin.*  →  匹配:
  - myplugin.command.spawn
  - myplugin.teleport
  - myplugin.admin.kick
```

#### **3. 多级通配符**

通配符可以在任意级别使用：

```yaml
moderator:
  permissions:
    - "nethergate.plugin.*"       # 所有插件管理权限
    - "myplugin.command.*"        # 所有命令权限
    - "myplugin.teleport.*"       # 所有传送相关权限
```

**匹配示例**：
```
nethergate.plugin.*  →  匹配:
  - nethergate.plugin.reload
  - nethergate.plugin.enable
  - nethergate.plugin.disable
  - nethergate.plugin.info
  
myplugin.command.*  →  匹配:
  - myplugin.command.spawn
  - myplugin.command.home
  - myplugin.command.warp
```

#### **4. 否定权限 (`-permission`)**

移除特定权限，即使通过继承获得：

```yaml
admin:
  priority: 50
  permissions:
    - "nethergate.*"              # 所有核心权限
    - "-nethergate.plugin.disable" # 但不能禁用插件
    
moderator:
  inherit_from: [admin]
  permissions:
    - "myplugin.*"                # 所有插件权限
    - "-myplugin.admin.delete"    # 但不能删除数据
```

**否定权限优先级**：
```
明确的否定权限 > 明确的授权权限 > 通配符授权
```

**示例**：
```yaml
# 场景：给予所有传送权限，但禁止跨世界传送
teleporter:
  permissions:
    - "myplugin.teleport.*"       # 所有传送权限
    - "-myplugin.teleport.cross_world"  # 禁止跨世界传送
```

#### **5. 通配符使用最佳实践**

**✅ 推荐做法**：

```yaml
# 1. 分层授权
moderator:
  permissions:
    - "nethergate.plugin.*"    # 插件管理
    - "nethergate.kick"        # 踢人
    - "nethergate.mute"        # 禁言

# 2. 最小权限原则
builder:
  permissions:
    - "myplugin.build.*"       # 仅建筑相关
    - "-myplugin.build.admin"  # 排除管理功能

# 3. 细粒度控制
vip:
  permissions:
    - "myplugin.teleport.home"     # 回家
    - "myplugin.teleport.spawn"    # 出生点
    - "-myplugin.teleport.admin"   # 不能使用管理传送
```

**❌ 不推荐做法**：

```yaml
# 过于宽泛的权限
guest:
  permissions:
    - "*"  # ❌ 不要给普通用户所有权限

# 滥用否定权限
user:
  permissions:
    - "myplugin.*"
    - "-myplugin.feature1"
    - "-myplugin.feature2"
    - "-myplugin.feature3"  # ❌ 如果需要禁止很多，应该重新设计权限结构
```

#### **6. 通配符匹配示例**

完整的权限匹配示例：

```yaml
player_permissions:
  "Steve":
    - "nethergate.*"           # 所有核心权限
    - "backup.create"          # backup 插件的创建权限
    - "backup.restore"         # backup 插件的恢复权限
    - "-backup.delete"         # 但不能删除备份
    
  "Alex":
    - "myplugin.command.*"     # 所有命令
    - "myplugin.teleport.home" # 回家传送
    - "-myplugin.command.admin.*"  # 但不能使用管理命令
```

**权限检查结果**：

| 玩家 | 检查权限 | 结果 | 说明 |
|------|---------|------|------|
| Steve | `nethergate.plugin.reload` | ✅ 允许 | 匹配 `nethergate.*` |
| Steve | `backup.create` | ✅ 允许 | 明确授权 |
| Steve | `backup.delete` | ❌ 拒绝 | 被否定权限移除 |
| Alex | `myplugin.command.spawn` | ✅ 允许 | 匹配 `myplugin.command.*` |
| Alex | `myplugin.command.admin.kick` | ❌ 拒绝 | 被否定权限移除 |
| Alex | `myplugin.teleport.home` | ✅ 允许 | 明确授权 |
| Alex | `myplugin.teleport.warp` | ❌ 拒绝 | 未授权 |

### **2. 权限组**

权限组定义了一组权限的集合：

```yaml
groups:
  moderator:
    priority: 30  # 优先级（数字越大优先级越高）
    permissions:
      - "nethergate.kick"
      - "nethergate.ban"
      - "myplugin.moderate"
    inherit_from:
      - vip  # 继承 VIP 组的所有权限
    is_default: false
```

**属性说明：**
- `priority` - 优先级，用于冲突解决（高优先级覆盖低优先级）
- `permissions` - 权限列表
- `inherit_from` - 继承的组（支持多继承）
- `is_default` - 是否为默认组（新玩家自动加入）

### **3. 权限继承**

```
owner (100)
  └─ 拥有所有权限

admin (50)
  └─ 继承自 vip
      └─ 管理权限 + VIP 权限

vip (10)
  └─ 继承自 default
      └─ VIP 权限 + 默认权限

default (0)
  └─ 基础权限
```

**继承规则：**
1. 子组继承父组的所有权限
2. 支持多继承（从多个组继承）
3. 高优先级权限覆盖低优先级
4. 否定权限（`-permission`）可以移除继承的权限

### **4. 用户特定权限**

除了组权限，还可以为单个玩家设置特定权限：

```csharp
// 给予玩家特定权限
await _context.PermissionManager.GrantPermissionAsync("Steve", "special.permission");

// 移除玩家特定权限
await _context.PermissionManager.RevokePermissionAsync("Steve", "special.permission");
```

**优先级：**
```
用户特定权限 > 最高优先级组权限 > 继承的组权限 > 默认组权限
```

---

## 🔧 **API 接口**

### **IPermissionManager 接口**

NetherGate 提供的核心权限管理接口：

```csharp
namespace NetherGate.API.Permissions;

public interface IPermissionManager
{
    // ========== 权限检查（核心功能）==========
    
    /// <summary>
    /// 检查玩家是否拥有权限
    /// </summary>
    Task<bool> HasPermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 获取玩家的所有权限
    /// </summary>
    Task<List<string>> GetUserPermissionsAsync(string playerName);
    
    // ========== 用户组管理（由权限插件实现）==========
    
    /// <summary>
    /// 将玩家添加到组
    /// </summary>
    Task AddUserToGroupAsync(string playerName, string groupName);
    
    /// <summary>
    /// 从组移除玩家
    /// </summary>
    Task RemoveUserFromGroupAsync(string playerName, string groupName);
    
    /// <summary>
    /// 获取玩家所在的组
    /// </summary>
    Task<List<string>> GetUserGroupsAsync(string playerName);
    
    // ========== 权限管理（由权限插件实现）==========
    
    /// <summary>
    /// 给予玩家权限
    /// </summary>
    Task GrantPermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 移除玩家权限
    /// </summary>
    Task RevokePermissionAsync(string playerName, string permission);
    
    /// <summary>
    /// 创建权限组
    /// </summary>
    Task CreateGroupAsync(string groupName, int priority = 0);
    
    /// <summary>
    /// 删除权限组
    /// </summary>
    Task DeleteGroupAsync(string groupName);
    
    /// <summary>
    /// 给予组权限
    /// </summary>
    Task GrantGroupPermissionAsync(string groupName, string permission);
    
    /// <summary>
    /// 移除组权限
    /// </summary>
    Task RevokeGroupPermissionAsync(string groupName, string permission);
    
    /// <summary>
    /// 获取组的所有权限
    /// </summary>
    Task<List<string>> GetGroupPermissionsAsync(string groupName);
    
    /// <summary>
    /// 重新加载权限配置
    /// </summary>
    Task ReloadAsync();
    
    /// <summary>
    /// 保存权限配置
    /// </summary>
    Task SaveAsync();
}
```

---

## 💼 **使用示例**

### **1. 权限检查**

```csharp
// 检查单个权限
if (await _context.PermissionManager.HasPermissionAsync("Steve", "myplugin.admin"))
{
    // 执行管理员操作
}

// 获取玩家的所有权限
var permissions = await _context.PermissionManager.GetUserPermissionsAsync("Steve");
foreach (var perm in permissions)
{
    _context.Logger.Info($"权限: {perm}");
}
```

### **2. 在命令中使用**

```csharp
public class AdminCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "admin";
    public string Description => "管理员命令";

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        // 检查权限
        if (sender != null && !await _context.PermissionManager.HasPermissionAsync(
            sender.Name, "myplugin.admin"))
        {
            return CommandResult.Fail("你没有权限使用此命令");
        }

        // 执行管理员操作
        return CommandResult.Success("管理员命令执行成功");
    }
}
```

---

## 🔌 **插件集成**

### **实现权限管理插件**

如果你需要实现一个权限管理插件，需要提供 `IPermissionManager` 接口的实现，并注册到 NetherGate：

```csharp
public class PermissionPlugin : IPlugin
{
    private IPluginContext _context;
    
    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 创建权限管理器实现
        var permissionManager = new MyPermissionManager();
        
        // 注册到 NetherGate（通过服务注入）
        // 具体注册方式取决于 NetherGate 的服务管理机制
    }
}

// 实现权限管理器
public class MyPermissionManager : IPermissionManager
{
    private readonly Dictionary<string, List<string>> _userPermissions = new();
    private readonly Dictionary<string, List<string>> _groupPermissions = new();
    
    public async Task<bool> HasPermissionAsync(string playerName, string permission)
    {
        // 1. 检查用户特定权限
        if (_userPermissions.TryGetValue(playerName, out var userPerms))
        {
            if (CheckPermission(userPerms, permission))
                return true;
        }
        
        // 2. 检查组权限
        var groups = await GetUserGroupsAsync(playerName);
        foreach (var group in groups)
        {
            if (_groupPermissions.TryGetValue(group, out var groupPerms))
            {
                if (CheckPermission(groupPerms, permission))
                    return true;
            }
        }
        
        return false;
    }
    
    private bool CheckPermission(List<string> permissions, string required)
    {
        // 实现通配符匹配逻辑
        // 支持 * 和 namespace.* 格式
        // 支持否定权限 -permission
        
        foreach (var perm in permissions)
        {
            if (perm == "*") return true;
            if (perm == required) return true;
            if (perm.EndsWith(".*") && required.StartsWith(perm[..^1]))
                return true;
        }
        
        return false;
    }
    
    // 实现其他接口方法...
}
```

### **权限数据存储**

权限管理插件可以选择不同的存储方式：

#### **1. 文件存储（YAML/JSON）**

```csharp
public class FilePermissionStorage
{
    public async Task SavePermissionsAsync(PermissionData data)
    {
        var yaml = new SerializerBuilder().Build();
        var yamlContent = yaml.Serialize(data);
        await File.WriteAllTextAsync("permissions.yaml", yamlContent);
    }
    
    public async Task<PermissionData> LoadPermissionsAsync()
    {
        var yamlContent = await File.ReadAllTextAsync("permissions.yaml");
        var deserializer = new DeserializerBuilder().Build();
        return deserializer.Deserialize<PermissionData>(yamlContent);
    }
}
```

#### **2. 数据库存储（SQLite/MySQL）**

```csharp
public class DatabasePermissionStorage
{
    private readonly DbContext _db;
    
    public async Task<List<string>> GetUserPermissionsAsync(string playerName)
    {
        return await _db.UserPermissions
            .Where(p => p.PlayerName == playerName)
            .Select(p => p.Permission)
            .ToListAsync();
    }
    
    public async Task GrantPermissionAsync(string playerName, string permission)
    {
        _db.UserPermissions.Add(new UserPermission
        {
            PlayerName = playerName,
            Permission = permission
        });
        await _db.SaveChangesAsync();
    }
}
```

---

## 🎯 **权限节点约定**

### **NetherGate 核心权限**

```
nethergate.*                    # 所有核心权限
nethergate.help                 # 查看帮助
nethergate.plugin.*             # 所有插件管理权限
nethergate.plugin.list          # 列出插件
nethergate.plugin.info          # 查看插件信息
nethergate.plugin.reload        # 重载插件
nethergate.plugin.enable        # 启用插件
nethergate.plugin.disable       # 禁用插件
nethergate.permission.*         # 所有权限管理权限
nethergate.permission.reload    # 重载权限配置
nethergate.permission.grant     # 授予权限
nethergate.permission.revoke    # 移除权限
```

### **插件权限命名建议**

```
<插件名>.*                       # 插件所有权限
<插件名>.command.*               # 所有命令权限
<插件名>.command.<命令名>        # 特定命令
<插件名>.feature.*               # 所有功能权限
<插件名>.feature.<功能名>        # 特定功能
<插件名>.admin                   # 管理权限
```

**示例：**
```
economy.*
economy.command.*
economy.command.balance
economy.command.pay
economy.command.admin
economy.feature.shop
economy.feature.auction
economy.admin
```

---

## 💡 **最佳实践**

### **1. 权限粒度**

✅ **推荐：** 细粒度权限
```yaml
permissions:
  - "myplugin.command.tp"
  - "myplugin.command.tphere"
  - "myplugin.feature.home"
```

❌ **不推荐：** 过于粗粒度
```yaml
permissions:
  - "myplugin.*"  # 给予所有权限
```

### **2. 组织结构**

```yaml
# 按角色组织
groups:
  player:    # 玩家
  vip:       # 付费玩家
  helper:    # 管理助手
  moderator: # 版主
  admin:     # 管理员
  owner:     # 服主
```

### **3. 继承链**

```
owner
 └─ admin
     └─ moderator
         └─ helper
             └─ vip
                 └─ player (default)
```

### **4. 否定权限**

```yaml
admin:
  permissions:
    - "nethergate.*"
    - "-nethergate.server.stop"  # 禁止停服
    - "myplugin.*"
    - "-myplugin.dangerous"      # 禁止危险操作
```

### **5. 临时权限**

对于临时权限，建议在代码中动态管理而不是写入配置：

```csharp
// 活动期间给予特殊权限
await _context.PermissionManager.GrantPermissionAsync(playerName, "event.halloween");

// 活动结束移除
await _context.PermissionManager.RevokePermissionAsync(playerName, "event.halloween");
```

---

## 🚨 **常见问题**

### **Q: NetherGate 核心提供权限管理吗？**

**A:** NetherGate 核心只提供权限 API 接口 (`IPermissionManager`)，具体的权限管理功能（配置文件、命令等）需要由独立的权限管理插件实现。

### **Q: 如何获取权限管理插件？**

**A:** 你可以：
1. 使用社区提供的权限管理插件
2. 参考本文档的"插件集成"部分，自己实现一个权限管理插件

### **Q: 权限系统支持哪些功能？**

**A:** API 支持：
- 权限检查（核心）
- 用户组管理
- 权限授予/撤销
- 权限组管理

具体功能的实现取决于权限管理插件的设计。

---

## 📚 **相关文档**

- [命令系统](./命令系统.md) - 在命令中使用权限
- [插件开发指南](../03-插件开发/插件开发指南.md) - 插件开发基础
- [示例插件集](../07-示例和最佳实践/示例插件集.md) - 权限插件示例

---

## 💡 **推荐的权限插件示例**

实现一个完整的权限管理插件，建议包含以下功能：

1. **配置管理**
   - YAML/JSON 配置文件
   - 权限组定义
   - 用户分组
   - 继承关系

2. **命令系统**
   - `/perm user <player> add/remove <permission>` - 用户权限管理
   - `/perm group <group> add/remove <permission>` - 组权限管理
   - `/perm user <player> group add/remove <group>` - 用户组管理
   - `/perm reload` - 重载配置

3. **通配符支持**
   - 全局通配符 `*`
   - 命名空间通配符 `namespace.*`
   - 否定权限 `-permission`

4. **优先级系统**
   - 组优先级
   - 权限继承
   - 冲突解决

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-01-08  
**许可证：** LGPL-3.0
