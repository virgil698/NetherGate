# NetherGate äº‹ä»¶ç³»ç»Ÿ

NetherGate æä¾›äº†å…¨é¢çš„äº‹ä»¶ç³»ç»Ÿï¼Œå…è®¸æ’ä»¶ç›‘å¬å’Œå“åº”æœåŠ¡å™¨ã€ç©å®¶ã€ç½‘ç»œç­‰å„ç§äº‹ä»¶ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [äº‹ä»¶ç±»å‹](#äº‹ä»¶ç±»å‹)
- [è®¢é˜…äº‹ä»¶](#è®¢é˜…äº‹ä»¶)
- [å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶](#å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶)
- [äº‹ä»¶ä¼˜å…ˆçº§](#äº‹ä»¶ä¼˜å…ˆçº§)
- [å¼‚æ­¥äº‹ä»¶å¤„ç†](#å¼‚æ­¥äº‹ä»¶å¤„ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **è®¢é˜…äº‹ä»¶**

```csharp
using NetherGate.API.Plugins;
using NetherGate.API.Events;

public class MyPlugin : PluginBase
{
    public override Task OnEnableAsync()
    {
        // è®¢é˜…ç©å®¶åŠ å…¥äº‹ä»¶ï¼ˆå¸¦ä¼˜å…ˆçº§ï¼‰
        Events.Subscribe<PlayerJoinedEvent>(OnPlayerJoined, EventPriority.Normal);
        
        // è®¢é˜…ç©å®¶ç¦»å¼€äº‹ä»¶
        Events.Subscribe<PlayerLeftEvent>(OnPlayerLeft, EventPriority.Normal);
        
        // è®¢é˜…æœåŠ¡å™¨å¯åŠ¨äº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
        Events.Subscribe<ServerReadyEvent>(OnServerReady, EventPriority.High);
        
        Logger.Info("äº‹ä»¶å·²è®¢é˜…");
        return Task.CompletedTask;
    }

    private async Task OnPlayerJoined(PlayerJoinedEvent e)
    {
        Logger.Info($"ç©å®¶ {e.Player.Name} åŠ å…¥äº†æœåŠ¡å™¨");
        
        // å‘é€æ¬¢è¿æ¶ˆæ¯
        await GameDisplay.SendChatMessage(
            e.Player.Name, 
            "Â§aæ¬¢è¿æ¥åˆ°æœåŠ¡å™¨ï¼"
        );
    }

    private Task OnPlayerLeft(PlayerLeftEvent e)
    {
        Logger.Info($"ç©å®¶ {e.Player.Name} ç¦»å¼€äº†æœåŠ¡å™¨");
        return Task.CompletedTask;
    }
    
    private Task OnServerReady(ServerReadyEvent e)
    {
        Logger.Info($"æœåŠ¡å™¨å¯åŠ¨å®Œæˆï¼Œè€—æ—¶ {e.StartupTime}");
        return Task.CompletedTask;
    }

    public override Task OnDisableAsync()
    {
        // æ’ä»¶ç¦ç”¨æ—¶è‡ªåŠ¨å–æ¶ˆè®¢é˜…
        Logger.Info("äº‹ä»¶è®¢é˜…å·²å–æ¶ˆ");
        return Task.CompletedTask;
    }
}
```

---

## ğŸ“š **äº‹ä»¶ç±»å‹**

### **1. æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶**

#### **ServerStartingEvent**
æœåŠ¡å™¨è¿›ç¨‹å³å°†å¯åŠ¨

```csharp
_context.EventBus.Subscribe<ServerStartingEvent>(e =>
{
    _context.Logger.Info("æœåŠ¡å™¨å³å°†å¯åŠ¨");
});
```

#### **ServerReadyEvent**
æœåŠ¡å™¨å®Œå…¨å¯åŠ¨ï¼ˆæ£€æµ‹åˆ° "Done (X.XXXs)!" æ—¥å¿—ï¼‰

```csharp
_context.EventBus.Subscribe<ServerReadyEvent>(e =>
{
    _context.Logger.Info($"æœåŠ¡å™¨å¯åŠ¨å®Œæˆï¼Œè€—æ—¶ {e.StartupTime}");
    // å¯ä»¥å¼€å§‹å‘é€å‘½ä»¤
});
```

#### **ServerShuttingDownEvent**
æœåŠ¡å™¨å¼€å§‹å…³é—­ï¼ˆæ£€æµ‹åˆ° "Stopping server" æ—¥å¿—ï¼‰

```csharp
_context.EventBus.Subscribe<ServerShuttingDownEvent>(e =>
{
    _context.Logger.Info("æœåŠ¡å™¨æ­£åœ¨å…³é—­");
    // ä¿å­˜æ•°æ®
});
```

#### **ServerStoppedEvent**
æœåŠ¡å™¨è¿›ç¨‹å·²åœæ­¢

```csharp
_context.EventBus.Subscribe<ServerStoppedEvent>(e =>
{
    _context.Logger.Info("æœåŠ¡å™¨å·²åœæ­¢");
});
```

#### **ServerCrashedEvent**
æœåŠ¡å™¨å´©æºƒ

```csharp
_context.EventBus.Subscribe<ServerCrashedEvent>(e =>
{
    _context.Logger.Error($"æœåŠ¡å™¨å´©æºƒ: {e.Reason}");
    _context.Logger.Error($"é€€å‡ºä»£ç : {e.ExitCode}");
    // å‘é€å‘Šè­¦é€šçŸ¥
});
```

#### **ServerHeartbeatEvent**
æœåŠ¡å™¨å¿ƒè·³ï¼ˆé€šè¿‡ SMP å®šæœŸæ¥æ”¶æœåŠ¡å™¨çŠ¶æ€ï¼‰

```csharp
_context.EventBus.Subscribe<ServerHeartbeatEvent>(e =>
{
    _context.Logger.Debug($"TPS: {e.State.Tps}, åœ¨çº¿ç©å®¶: {e.State.PlayerCount}");
});
```

---

### **2. ç©å®¶äº‹ä»¶**

#### **PlayerJoinedEvent**
ç©å®¶åŠ å…¥æœåŠ¡å™¨

```csharp
public record PlayerJoinedEvent(PlayerInfo Player, string JoinMessage);

_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    _context.Logger.Info($"{e.Player.Name} åŠ å…¥äº†æœåŠ¡å™¨");
    
    // æ¬¢è¿æ¶ˆæ¯
    await _context.GameDisplayApi.ShowTitle(
        e.Player.Name,
        "Â§6æ¬¢è¿å›æ¥",
        $"Â§e{e.Player.Name}",
        fadeIn: 10, stay: 70, fadeOut: 20
    );
});
```

#### **PlayerLeftEvent**
ç©å®¶ç¦»å¼€æœåŠ¡å™¨

```csharp
public record PlayerLeftEvent(PlayerInfo Player, string LeaveMessage);

_context.EventBus.Subscribe<PlayerLeftEvent>(e =>
{
    _context.Logger.Info($"{e.Player.Name} ç¦»å¼€äº†æœåŠ¡å™¨");
    
    // ä¿å­˜ç©å®¶æ•°æ®
    SavePlayerData(e.Player);
});
```

#### **PlayerChatEvent**
ç©å®¶èŠå¤©

```csharp
public record PlayerChatEvent(string PlayerName, string Message);

_context.EventBus.Subscribe<PlayerChatEvent>(async e =>
{
    // æ£€æµ‹æ•æ„Ÿè¯
    if (ContainsBadWords(e.Message))
    {
        _context.Logger.Warning($"{e.PlayerName} å‘é€äº†ä¸å½“æ¶ˆæ¯: {e.Message}");
        await _context.GameDisplayApi.SendChatMessage(
            e.PlayerName, 
            "Â§cè¯·æ³¨æ„è¨€è¾ï¼"
        );
    }
});
```

#### **PlayerDeathEvent**
ç©å®¶æ­»äº¡

```csharp
public record PlayerDeathEvent(string PlayerName, string DeathMessage);

_context.EventBus.Subscribe<PlayerDeathEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} æ­»äº¡: {e.DeathMessage}");
    
    // å‘é€å¤æ´»æç¤º
    await Task.Delay(3000);
    await _context.GameDisplayApi.SendChatMessage(
        e.PlayerName, 
        "Â§eè¾“å…¥ #back è¿”å›æ­»äº¡åœ°ç‚¹"
    );
});
```

#### **PlayerAdvancementEvent**
ç©å®¶è·å¾—æˆå°±

```csharp
public record PlayerAdvancementEvent(string PlayerName, string AdvancementKey, string Title);

_context.EventBus.Subscribe<PlayerAdvancementEvent>(async e =>
{
    _context.Logger.Info($"{e.PlayerName} è·å¾—æˆå°±: {e.Title}");
    
    // å¹¿æ’­æ¶ˆæ¯
    await _context.GameDisplayApi.BroadcastMessage(
        $"Â§6[æˆå°±] Â§e{e.PlayerName} Â§fè·å¾—äº†æˆå°± Â§a{e.Title}"
    );
});
```

---

### **3. å…è®¸åˆ—è¡¨/å°ç¦äº‹ä»¶**

#### **AllowlistAddedEvent / AllowlistRemovedEvent**

```csharp
public record AllowlistAddedEvent(string PlayerName, string Operator);

_context.EventBus.Subscribe<AllowlistAddedEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} è¢« {e.Operator} æ·»åŠ åˆ°ç™½åå•");
});

_context.EventBus.Subscribe<AllowlistRemovedEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} è¢« {e.Operator} ä»ç™½åå•ç§»é™¤");
});
```

#### **AllowlistSetEvent / AllowlistClearedEvent**

```csharp
// æ‰¹é‡è®¾ç½®ç™½åå•
_context.EventBus.Subscribe<AllowlistSetEvent>(e =>
{
    _context.Logger.Info($"ç™½åå•å·²æ‰¹é‡è®¾ç½®ï¼Œå…± {e.PlayerNames.Count} ä¸ªç©å®¶");
});

// ç™½åå•æ¸…ç©º
_context.EventBus.Subscribe<AllowlistClearedEvent>(e =>
{
    _context.Logger.Warning("ç™½åå•å·²æ¸…ç©º");
});
```

#### **BanAddedEvent / BanRemovedEvent**

```csharp
public record BanAddedEvent(string PlayerName, string Reason, string Operator, DateTime? Expires);

_context.EventBus.Subscribe<BanAddedEvent>(e =>
{
    var expireStr = e.Expires.HasValue ? $"è‡³ {e.Expires.Value}" : "æ°¸ä¹…";
    _context.Logger.Info($"{e.PlayerName} è¢« {e.Operator} å°ç¦ ({expireStr}): {e.Reason}");
});
```

#### **IpBanAddedEvent / IpBanRemovedEvent**

```csharp
_context.EventBus.Subscribe<IpBanAddedEvent>(e =>
{
    _context.Logger.Info($"IP {e.IpAddress} è¢« {e.Operator} å°ç¦: {e.Reason}");
});
```

#### **OperatorAddedEvent / OperatorRemovedEvent**

```csharp
_context.EventBus.Subscribe<OperatorAddedEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} è¢«æˆäºˆ OP æƒé™ (ç­‰çº§ {e.Level})");
});
```

---

### **4. ç½‘ç»œå±‚äº‹ä»¶**

#### **PlayerConnectionAttemptEvent**
ç©å®¶å°è¯•è¿æ¥

```csharp
public record PlayerConnectionAttemptEvent(string PlayerName, string IpAddress, DateTime Timestamp);

_context.EventBus.Subscribe<PlayerConnectionAttemptEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} å°è¯•è¿æ¥ï¼ŒIP: {e.IpAddress}");
    
    // æ£€æŸ¥ IP é»‘åå•
    if (IsBlacklisted(e.IpAddress))
    {
        _context.Logger.Warning($"é˜»æ­¢é»‘åå• IP è¿æ¥: {e.IpAddress}");
    }
});
```

#### **PlayerLoginEvent**
ç©å®¶ç™»å½•

```csharp
public record PlayerLoginEvent(string PlayerName, string Uuid, string IpAddress);

_context.EventBus.Subscribe<PlayerLoginEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} ({e.Uuid}) ç™»å½•æˆåŠŸ");
});
```

#### **PlayerDisconnectEvent**
ç©å®¶æ–­å¼€è¿æ¥

```csharp
public record PlayerDisconnectEvent(string PlayerName, string Reason);

_context.EventBus.Subscribe<PlayerDisconnectEvent>(e =>
{
    _context.Logger.Info($"{e.PlayerName} æ–­å¼€è¿æ¥: {e.Reason}");
});
```

#### **PacketSentEvent / PacketReceivedEvent**
æ•°æ®åŒ…å‘é€/æ¥æ”¶ï¼ˆè°ƒè¯•ç”¨ï¼‰

```csharp
_context.EventBus.Subscribe<PacketReceivedEvent>(e =>
{
    _context.Logger.Debug($"æ”¶åˆ°æ•°æ®åŒ…: {e.PacketType}, å¤§å°: {e.Size} å­—èŠ‚");
});
```

---

### **5. SMP äº‹ä»¶**

#### **SmpConnectedEvent / SmpDisconnectedEvent**

```csharp
_context.EventBus.Subscribe<SmpConnectedEvent>(e =>
{
    _context.Logger.Info("SMP è¿æ¥å·²å»ºç«‹");
});

_context.EventBus.Subscribe<SmpDisconnectedEvent>(e =>
{
    _context.Logger.Warning("SMP è¿æ¥å·²æ–­å¼€");
});
```

---

## ğŸ”§ **è®¢é˜…äº‹ä»¶**

### **åŸºæœ¬è®¢é˜…**

```csharp
// è®¢é˜…äº‹ä»¶
_context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);

// å¤„ç†æ–¹æ³•
private void OnPlayerJoined(PlayerJoinedEvent e)
{
    _context.Logger.Info($"ç©å®¶åŠ å…¥: {e.Player.Name}");
}
```

### **Lambda è¡¨è¾¾å¼**

```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    _context.Logger.Info($"ç©å®¶åŠ å…¥: {e.Player.Name}");
});
```

### **å¼‚æ­¥å¤„ç†**

```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    await Task.Delay(1000);
    await _context.GameDisplayApi.SendChatMessage(e.Player.Name, "æ¬¢è¿ï¼");
});
```

### **å–æ¶ˆè®¢é˜…**

```csharp
// æ‰‹åŠ¨å–æ¶ˆè®¢é˜…
_context.EventBus.Unsubscribe<PlayerJoinedEvent>(OnPlayerJoined);

// æ’ä»¶ç¦ç”¨æ—¶è‡ªåŠ¨å–æ¶ˆæ‰€æœ‰è®¢é˜…
public void OnDisable()
{
    // æ¡†æ¶ä¼šè‡ªåŠ¨å¤„ç†
}
```

---

## ğŸ“£ **å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶**

### **å®šä¹‰äº‹ä»¶**

```csharp
// ä½¿ç”¨ record å®šä¹‰äº‹ä»¶ï¼ˆæ¨èï¼‰
public record EconomyTransactionEvent(
    string FromPlayer,
    string ToPlayer,
    decimal Amount,
    string Reason
);

// æˆ–ä½¿ç”¨ class
public class CustomEvent
{
    public string Data { get; set; }
    public DateTime Timestamp { get; set; }
}
```

### **å‘å¸ƒäº‹ä»¶**

```csharp
// å‘å¸ƒäº‹ä»¶
var transactionEvent = new EconomyTransactionEvent(
    FromPlayer: "Steve",
    ToPlayer: "Alex",
    Amount: 100.0m,
    Reason: "è´­ä¹°ç‰©å“"
);

await _context.EventBus.PublishAsync(transactionEvent);
```

### **è®¢é˜…è‡ªå®šä¹‰äº‹ä»¶**

```csharp
// å…¶ä»–æ’ä»¶å¯ä»¥è®¢é˜…
_context.EventBus.Subscribe<EconomyTransactionEvent>(e =>
{
    _context.Logger.Info($"äº¤æ˜“: {e.FromPlayer} -> {e.ToPlayer}, é‡‘é¢: {e.Amount}");
});
```

---

## âš¡ **äº‹ä»¶ä¼˜å…ˆçº§**

### **ä¼˜å…ˆçº§æšä¸¾**

```csharp
public enum EventPriority
{
    Lowest = 0,    // æœ€ä½ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
    Low = 1,
    Normal = 2,    // é»˜è®¤
    High = 3,
    Highest = 4,   // æœ€é«˜ï¼ˆæœ€åæ‰§è¡Œï¼‰
    Monitor = 5    // ç›‘è§†å™¨ï¼ˆä»…ç”¨äºç›‘å¬ï¼Œä¸åº”ä¿®æ”¹äº‹ä»¶ï¼‰
}
```

### **ä½¿ç”¨ä¼˜å…ˆçº§**

```csharp
// é«˜ä¼˜å…ˆçº§ï¼ˆåæ‰§è¡Œï¼‰
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    // åœ¨å…¶ä»–æ’ä»¶å¤„ç†åæ‰§è¡Œ
    _context.Logger.Info("æœ€åçš„æ¬¢è¿æ¶ˆæ¯");
}, EventPriority.Highest);

// ä½ä¼˜å…ˆçº§ï¼ˆå…ˆæ‰§è¡Œï¼‰
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    // åœ¨å…¶ä»–æ’ä»¶ä¹‹å‰æ‰§è¡Œ
    _context.Logger.Info("é¦–å…ˆæ£€æŸ¥ç©å®¶");
}, EventPriority.Lowest);

// ç›‘è§†å™¨ä¼˜å…ˆçº§ï¼ˆåªè¯»ï¼‰
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    // ä»…ç”¨äºè®°å½•ï¼Œä¸ä¿®æ”¹ä»»ä½•æ•°æ®
    LogPlayerJoin(e.Player);
}, EventPriority.Monitor);
```

### **æ‰§è¡Œé¡ºåº**

```
Lowest (0) â†’ Low (1) â†’ Normal (2) â†’ High (3) â†’ Highest (4) â†’ Monitor (5)
   â†“           â†“          â†“           â†“           â†“            â†“
 å…ˆæ‰§è¡Œ     ä¼˜å…ˆå¤„ç†    é»˜è®¤ä¼˜å…ˆçº§   åå¤„ç†      æœ€åæ‰§è¡Œ      ä»…ç›‘å¬
```

---

## ğŸ“¡ **ä¸‰å±‚äº‹ä»¶ç›‘å¬ç­–ç•¥**

NetherGate é‡‡ç”¨**æ™ºèƒ½ä¸‰å±‚äº‹ä»¶ç›‘å¬ç­–ç•¥**ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„äº‹ä»¶æºï¼š

### **ç›‘å¬ä¼˜å…ˆçº§**

```
1ï¸âƒ£ SMP åè®®ï¼ˆServer Management Protocolï¼‰ - ğŸŸ¢ æœ€é«˜ä¼˜å…ˆçº§
    â†“ å¦‚æœ SMP ä¸æ”¯æŒè¯¥äº‹ä»¶
2ï¸âƒ£ RCON åè®®ï¼ˆRemote Consoleï¼‰ - ğŸŸ¡ æ¬¡ä¼˜å…ˆçº§
    â†“ å¦‚æœ RCON ä¸æ”¯æŒè¯¥äº‹ä»¶
3ï¸âƒ£ æ—¥å¿—è§£æï¼ˆLog Parsingï¼‰ - ğŸ”´ æœ€ä½ä¼˜å…ˆçº§
```

### **åè®®å¯¹æ¯”**

| åè®®/æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|---------|
| **SMP** | âœ… ç»“æ„åŒ–æ•°æ®<br>âœ… å®æ—¶æ¨é€<br>âœ… åŒ…å« UUID<br>âœ… å®˜æ–¹æ”¯æŒ | âŒ è¦†ç›–èŒƒå›´æœ‰é™<br>âŒ éœ€è¦ MC 1.21.9+ | ç®¡ç†æ“ä½œã€ç©å®¶åŠ å…¥/ç¦»å¼€ |
| **RCON** | âœ… å‘½ä»¤æ‰§è¡Œ<br>âœ… å¹¿æ³›æ”¯æŒ | âŒ æ— äº‹ä»¶ç›‘å¬<br>âŒ å•å‘é€šä¿¡ | æ‰§è¡Œæ¸¸æˆå‘½ä»¤ |
| **æ—¥å¿—è§£æ** | âœ… è¦†ç›–æ‰€æœ‰äº‹ä»¶<br>âœ… æ— ç‰ˆæœ¬é™åˆ¶ | âŒ ä¸å¯é ï¼ˆæ ¼å¼å˜æ›´ï¼‰<br>âŒ ç¼ºå°‘ç»“æ„åŒ–æ•°æ®<br>âŒ æœ‰å»¶è¿Ÿ | SMP/RCON ä¸æ”¯æŒçš„äº‹ä»¶ |

### **ç¬¬ä¸€å±‚ï¼šSMP åè®®äº‹ä»¶**

SMP æ”¯æŒä»¥ä¸‹å®æ—¶é€šçŸ¥ï¼š

#### **ç©å®¶äº‹ä»¶**
- âœ… **ç©å®¶åŠ å…¥** (`players/joined`) â†’ `PlayerJoinedEvent`
  - åŒ…å«ï¼šUUIDã€ç©å®¶åã€IP åœ°å€
- âœ… **ç©å®¶ç¦»å¼€** (`players/left`) â†’ `PlayerLeftEvent`
  - åŒ…å«ï¼šUUIDã€ç©å®¶å

#### **ç®¡ç†æ“ä½œäº‹ä»¶**
- âœ… **ç®¡ç†å‘˜æ·»åŠ /ç§»é™¤** â†’ `OperatorAddedEvent` / `OperatorRemovedEvent`
- âœ… **ç™½åå•æ“ä½œ** â†’ `AllowlistChangedEvent`
- âœ… **ç©å®¶å°ç¦/è§£å°** â†’ `PlayerBannedEvent` / `PlayerUnbannedEvent`
- âœ… **IP å°ç¦/è§£å°** â†’ `IpBannedEvent` / `IpUnbannedEvent`

#### **æœåŠ¡å™¨äº‹ä»¶**
- âœ… **æ¸¸æˆè§„åˆ™æ›´æ–°** â†’ `GameRuleChangedEvent`
- âœ… **æœåŠ¡å™¨çŠ¶æ€å¿ƒè·³** â†’ `ServerHeartbeatEvent`

**å®ç°æ–‡ä»¶**ï¼š
- `src/NetherGate.Core/Protocol/SmpClient.cs`
- `src/NetherGate.API/Events/SmpEvents.cs`

### **ç¬¬äºŒå±‚ï¼šRCON åè®®**

#### **æ”¯æŒçš„åŠŸèƒ½**
- âœ… **æ‰§è¡Œæ¸¸æˆå‘½ä»¤** (`SendCommandAsync()`)
  - ç¤ºä¾‹ï¼š`/say`, `/give`, `/tp`, `/gamemode`, `/effect` ç­‰

#### **ä¸æ”¯æŒçš„åŠŸèƒ½**
- âŒ **äº‹ä»¶ç›‘å¬**ï¼ˆRCON æ˜¯å•å‘é€šä¿¡åè®®ï¼Œåªèƒ½å‘é€å‘½ä»¤ï¼Œæ— æ³•æ¥æ”¶äº‹ä»¶æ¨é€ï¼‰

**å®ç°æ–‡ä»¶**ï¼š
- `src/NetherGate.Core/Protocol/RconClient.cs`
- `src/NetherGate.API/Protocol/IRconClient.cs`

### **ç¬¬ä¸‰å±‚ï¼šæ—¥å¿—è§£æäº‹ä»¶**

ç”¨äºç›‘å¬ SMP å’Œ RCON éƒ½ä¸æ”¯æŒçš„äº‹ä»¶ã€‚

#### **æ”¯æŒçš„äº‹ä»¶**
- âœ… **ç©å®¶èŠå¤©** â†’ `PlayerChatEvent`
  - è§£æï¼š`<PlayerName> message`
- âœ… **ç©å®¶å‘½ä»¤** â†’ `PlayerCommandEvent`
  - è§£æï¼š`PlayerName issued server command: /command`
- âœ… **ç©å®¶æ­»äº¡** â†’ `PlayerDeathEvent`
  - è§£æï¼šå…³é”®è¯åŒ¹é…ï¼ˆwas killed, died, drowned ç­‰ï¼‰
- âœ… **ç©å®¶æˆå°±** â†’ `PlayerAchievementEvent`
  - è§£æï¼š`PlayerName has made the advancement [Achievement]`
- âœ… **é€šç”¨æ—¥å¿—** â†’ `ServerLogEvent`
  - æ‰€æœ‰æœåŠ¡å™¨è¾“å‡º

#### **æœåŠ¡å™¨è¿›ç¨‹ç›‘æ§**
- âœ… **è¿›ç¨‹å¯åŠ¨** â†’ `ServerProcessStartedEvent`
- âœ… **è¿›ç¨‹åœæ­¢** â†’ `ServerProcessStoppedEvent`
- âœ… **è¿›ç¨‹å´©æºƒ** â†’ `ServerProcessCrashedEvent`

**å®ç°æ–‡ä»¶**ï¼š
- `src/NetherGate.Core/Process/LogParser.cs`
- `src/NetherGate.Core/Process/ServerProcessManager.cs`

**æ³¨æ„äº‹é¡¹**ï¼š
- æ—¥å¿—æ ¼å¼å¯èƒ½å›  Minecraft ç‰ˆæœ¬ã€è¯­è¨€ã€MOD è€Œå˜åŒ–
- ä¸å¦‚ SMP å¯é ï¼Œå»ºè®®ä»…ç”¨äºè¡¥å……

### **äº‹ä»¶è¦†ç›–çŸ©é˜µ**

| äº‹ä»¶ç±»å‹ | SMP | RCON | æ—¥å¿—è§£æ | å½“å‰å®ç° |
|---------|-----|------|---------|---------|
| ç©å®¶åŠ å…¥ | âœ… | âŒ | âœ… | **SMP** |
| ç©å®¶ç¦»å¼€ | âœ… | âŒ | âœ… | **SMP** |
| ç©å®¶èŠå¤© | âŒ | âŒ | âœ… | **æ—¥å¿—è§£æ** |
| ç©å®¶å‘½ä»¤ | âŒ | âŒ | âœ… | **æ—¥å¿—è§£æ** |
| ç©å®¶æ­»äº¡ | âŒ | âŒ | âœ… | **æ—¥å¿—è§£æ** |
| ç©å®¶æˆå°± | âŒ | âŒ | âœ… | **æ—¥å¿—è§£æ** |
| ç®¡ç†å‘˜æ“ä½œ | âœ… | âŒ | âŒ | **SMP** |
| ç™½åå•æ“ä½œ | âœ… | âŒ | âŒ | **SMP** |
| å°ç¦æ“ä½œ | âœ… | âŒ | âŒ | **SMP** |
| æ¸¸æˆè§„åˆ™å˜æ›´ | âœ… | âŒ | âŒ | **SMP** |
| æ‰§è¡Œå‘½ä»¤ | âŒ | âœ… | âŒ | **RCON** |
| æœåŠ¡å™¨è¿›ç¨‹ | âŒ | âŒ | âœ… | **è¿›ç¨‹ç›‘æ§** |

### **é¿å…é‡å¤ç›‘å¬**

NetherGate å†…éƒ¨å·²å®ç°æ™ºèƒ½å»é‡ï¼Œä¼˜å…ˆä½¿ç”¨ SMP äº‹ä»¶ï¼Œä»…åœ¨ SMP ä¸æ”¯æŒæ—¶æ‰ä½¿ç”¨æ—¥å¿—è§£æã€‚

**å·²ç§»é™¤çš„æ—¥å¿—è§£æ**ï¼ˆæ”¹ç”¨ SMPï¼‰ï¼š
- ~~ç©å®¶åŠ å…¥~~ â†’ æ”¹ç”¨ SMP `players/joined`
- ~~ç©å®¶ç¦»å¼€~~ â†’ æ”¹ç”¨ SMP `players/left`

**ä¿ç•™çš„æ—¥å¿—è§£æ**ï¼ˆSMP ä¸æ”¯æŒï¼‰ï¼š
- âœ… ç©å®¶èŠå¤©
- âœ… ç©å®¶å‘½ä»¤
- âœ… ç©å®¶æ­»äº¡
- âœ… ç©å®¶æˆå°±

---

## ğŸ”„ **å¼‚æ­¥äº‹ä»¶å¤„ç†**

### **async/await**

```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    // å¼‚æ­¥æ“ä½œ
    await Task.Delay(1000);
    await _context.GameDisplayApi.SendChatMessage(e.Player.Name, "æ¬¢è¿ï¼");
    
    // åŠ è½½ç©å®¶æ•°æ®
    var playerData = await LoadPlayerDataAsync(e.Player.Name);
    
    // æ›´æ–°ç©å®¶çŠ¶æ€
    await UpdatePlayerStatusAsync(e.Player.Name, playerData);
});
```

### **å¹¶å‘å¤„ç†**

```csharp
_context.EventBus.Subscribe<ServerReadyEvent>(async e =>
{
    // å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡
    var tasks = new List<Task>
    {
        InitializeDatabaseAsync(),
        LoadConfigurationsAsync(),
        ConnectToExternalServiceAsync()
    };
    
    await Task.WhenAll(tasks);
    
    _context.Logger.Info("æ‰€æœ‰åˆå§‹åŒ–ä»»åŠ¡å®Œæˆ");
});
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. ä½¿ç”¨ record å®šä¹‰äº‹ä»¶**

âœ… **æ¨èï¼š**
```csharp
public record PlayerJoinedEvent(PlayerInfo Player, string JoinMessage);
```

âŒ **ä¸æ¨èï¼š**
```csharp
public class PlayerJoinedEvent
{
    public PlayerInfo Player { get; set; }
    public string JoinMessage { get; set; }
}
```

**åŸå› ï¼š** `record` æä¾›ä¸å¯å˜æ€§ã€å€¼æ¯”è¾ƒå’Œç®€æ´è¯­æ³•ã€‚

### **2. å‘½åçº¦å®š**

- äº‹ä»¶åç§°ä½¿ç”¨ **è¿‡å»æ—¶** æˆ– **ç°åœ¨è¿›è¡Œæ—¶**
  - âœ… `PlayerJoinedEvent` (å·²åŠ å…¥)
  - âœ… `ServerStartingEvent` (æ­£åœ¨å¯åŠ¨)
  - âŒ `PlayerJoinEvent` (æ¨¡ç³Š)

### **3. å¼‚å¸¸å¤„ç†**

```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    try
    {
        await ProcessPlayerJoin(e.Player);
    }
    catch (Exception ex)
    {
        _context.Logger.Error($"å¤„ç†ç©å®¶åŠ å…¥äº‹ä»¶æ—¶å‡ºé”™: {ex.Message}");
        // ä¸è¦æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“å…¶ä»–è®¢é˜…è€…
    }
});
```

### **4. é¿å…é•¿æ—¶é—´é˜»å¡**

```csharp
// âŒ ä¸æ¨èï¼šé˜»å¡äº‹ä»¶å¤„ç†
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    Thread.Sleep(5000);  // é˜»å¡ 5 ç§’
    // ä¼šå½±å“å…¶ä»–è®¢é˜…è€…
});

// âœ… æ¨èï¼šä½¿ç”¨å¼‚æ­¥
_context.EventBus.Subscribe<PlayerJoinedEvent>(async e =>
{
    await Task.Delay(5000);  // å¼‚æ­¥ç­‰å¾…
});
```

### **5. ç›‘è§†å™¨ä¼˜å…ˆçº§çš„æ­£ç¡®ä½¿ç”¨**

```csharp
// âœ… ç›‘è§†å™¨ï¼šåªè¯»ï¼Œä¸ä¿®æ”¹æ•°æ®
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    LogToDatabase(e.Player);  // ä»…è®°å½•
}, EventPriority.Monitor);

// âŒ é”™è¯¯ï¼šåœ¨ç›‘è§†å™¨ä¸­ä¿®æ”¹æ•°æ®
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    e.Player.Name = "Modified";  // ä¸åº”è¯¥ä¿®æ”¹
}, EventPriority.Monitor);
```

### **6. å–æ¶ˆè®¢é˜…**

```csharp
private Action<PlayerJoinedEvent> _joinHandler;

public void OnEnable(IPluginContext context)
{
    _joinHandler = OnPlayerJoined;
    _context.EventBus.Subscribe(_joinHandler);
}

public void OnDisable()
{
    // æ‰‹åŠ¨å–æ¶ˆè®¢é˜…ï¼ˆå¯é€‰ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
    if (_joinHandler != null)
    {
        _context.EventBus.Unsubscribe(_joinHandler);
    }
}
```

---

## ğŸ” **è°ƒè¯•äº‹ä»¶**

### **äº‹ä»¶æ—¥å¿—**

```csharp
_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    _context.Logger.Debug($"[Event] PlayerJoinedEvent: {e.Player.Name}");
});
```

### **äº‹ä»¶ç»Ÿè®¡**

```csharp
private int _joinCount = 0;

_context.EventBus.Subscribe<PlayerJoinedEvent>(e =>
{
    _joinCount++;
    _context.Logger.Info($"æ€»åŠ å…¥æ¬¡æ•°: {_joinCount}");
});
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ’ä»¶å¼€å‘æŒ‡å—](../03-æ’ä»¶å¼€å‘/æ’ä»¶å¼€å‘æŒ‡å—.md)
- [API å‚è€ƒ](../03-æ’ä»¶å¼€å‘/APIå‚è€ƒ.md)
- [SMP åè®®](../02-æ ¸å¿ƒåŠŸèƒ½/SMPåè®®.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
