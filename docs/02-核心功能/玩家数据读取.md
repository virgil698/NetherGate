# 玩家数据读取

NetherGate 提供了强大的玩家数据读取 API，允许您直接读取玩家的 NBT 数据文件，获取详细的游戏信息。

---

## 📋 **目录**

- [功能概述](#功能概述)
- [快速开始](#快速开始)
- [数据模型](#数据模型)
- [使用示例](#使用示例)
- [重生点数据（1.21.9+）](#重生点数据1219)
- [最佳实践](#最佳实践)

---

## 🌟 **功能概述**

玩家数据读取 API 提供以下功能：

- ✅ 读取玩家基础信息（位置、生命值、饥饿度等）
- ✅ 读取玩家背包和装备
- ✅ 读取玩家状态效果
- ✅ 读取玩家统计数据
- ✅ 读取玩家成就进度
- ✅ 读取重生点信息（Minecraft 1.21.9+）

---

## 🚀 **快速开始**

### **读取玩家数据**

```csharp
public class PlayerDataPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 通过 UUID 读取玩家数据
        var playerUuid = Guid.Parse("069a79f4-44e9-4726-a5be-fca90e38aaf5");
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(playerUuid);
        
        if (playerData != null)
        {
            _context.Logger.Info($"玩家位置: X={playerData.Pos.X}, Y={playerData.Pos.Y}, Z={playerData.Pos.Z}");
            _context.Logger.Info($"生命值: {playerData.Health}");
            _context.Logger.Info($"等级: {playerData.XpLevel}");
        }
    }
}
```

---

## 📖 **数据模型**

### **PlayerData 类**

```csharp
public class PlayerData
{
    /// <summary>
    /// 玩家位置
    /// </summary>
    public Position Pos { get; init; }
    
    /// <summary>
    /// 玩家旋转角度（俯仰角和偏航角）
    /// </summary>
    public Rotation Rotation { get; init; }
    
    /// <summary>
    /// 生命值
    /// </summary>
    public float Health { get; init; }
    
    /// <summary>
    /// 饥饿值
    /// </summary>
    public int FoodLevel { get; init; }
    
    /// <summary>
    /// 饱和度
    /// </summary>
    public float FoodSaturationLevel { get; init; }
    
    /// <summary>
    /// 经验等级
    /// </summary>
    public int XpLevel { get; init; }
    
    /// <summary>
    /// 当前经验值
    /// </summary>
    public float XpP { get; init; }
    
    /// <summary>
    /// 总经验值
    /// </summary>
    public int XpTotal { get; init; }
    
    /// <summary>
    /// 游戏模式（0=生存, 1=创造, 2=冒险, 3=旁观）
    /// </summary>
    public int PlayerGameType { get; init; }
    
    /// <summary>
    /// 维度
    /// </summary>
    public string Dimension { get; init; }
    
    /// <summary>
    /// 背包物品
    /// </summary>
    public List<ItemStack> Inventory { get; init; }
    
    /// <summary>
    /// 末影箱物品
    /// </summary>
    public List<ItemStack> EnderItems { get; init; }
    
    /// <summary>
    /// 玩家装备
    /// </summary>
    public PlayerArmor Armor { get; init; }
    
    /// <summary>
    /// 状态效果
    /// </summary>
    public List<StatusEffect> ActiveEffects { get; init; }
    
    /// <summary>
    /// 玩家统计数据
    /// </summary>
    public PlayerStats? Stats { get; init; }
    
    /// <summary>
    /// 玩家成就进度
    /// </summary>
    public PlayerAdvancements? Advancements { get; init; }
    
    /// <summary>
    /// 重生点信息（Minecraft 1.21.9+）
    /// </summary>
    public RespawnData? RespawnData { get; init; }
}
```

---

## 💡 **使用示例**

### **示例 1：玩家信息查询命令**

```csharp
public class PlayerInfoCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "playerinfo";
    public string Description => "查询玩家详细信息";
    public string Usage => "#playerinfo <玩家名>";
    public List<string> Aliases => new() { "pi" };
    public string PluginId => "PlayerInfo";
    public string? Permission => null;

    public PlayerInfoCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        if (args.Length < 1)
            return CommandResult.Fail($"用法: {Usage}");

        var playerName = args[0];
        
        // 获取玩家档案（UUID）
        var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
        if (profile == null)
        {
            return CommandResult.Fail($"§c找不到玩家: {playerName}");
        }
        
        // 读取玩家数据
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(profile.Uuid);
        if (playerData == null)
        {
            return CommandResult.Fail($"§c无法读取玩家数据");
        }
        
        var gameMode = playerData.PlayerGameType switch
        {
            0 => "生存",
            1 => "创造",
            2 => "冒险",
            3 => "旁观",
            _ => "未知"
        };
        
        var message = $"""
            §6═══════════════════════════════
            §f  玩家信息: §e{playerName}
            
            §7  生命值: §c{playerData.Health:F1}§7/§c20.0
            §7  饥饿值: §6{playerData.FoodLevel}§7/§620
            §7  等级: §a{playerData.XpLevel}
            §7  游戏模式: §f{gameMode}
            §7  维度: §f{playerData.Dimension}
            §7  坐标: §f{playerData.Pos.X:F1}, {playerData.Pos.Y:F1}, {playerData.Pos.Z:F1}
            §6═══════════════════════════════
            """;
        
        sender.SendMessage(message);
        return CommandResult.Ok();
    }
}
```

### **示例 2：背包检查**

```csharp
public async Task CheckInventory(Guid playerUuid)
{
    var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(playerUuid);
    
    if (playerData != null)
    {
        _context.Logger.Info($"背包中共有 {playerData.Inventory.Count} 个物品");
        
        foreach (var item in playerData.Inventory)
        {
            _context.Logger.Info($"  - {item.Id} x{item.Count} (槽位 {item.Slot})");
            
            // 检查附魔
            if (item.Enchantments.Count > 0)
            {
                foreach (var ench in item.Enchantments)
                {
                    _context.Logger.Info($"    附魔: {ench.Id} Lv.{ench.Level}");
                }
            }
        }
    }
}
```

### **示例 3：装备查询**

```csharp
public async Task CheckArmor(Guid playerUuid)
{
    var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(playerUuid);
    
    if (playerData?.Armor != null)
    {
        _context.Logger.Info("玩家装备:");
        
        if (playerData.Armor.Head != null)
            _context.Logger.Info($"  头盔: {playerData.Armor.Head.Id}");
        
        if (playerData.Armor.Chest != null)
            _context.Logger.Info($"  胸甲: {playerData.Armor.Chest.Id}");
        
        if (playerData.Armor.Legs != null)
            _context.Logger.Info($"  护腿: {playerData.Armor.Legs.Id}");
        
        if (playerData.Armor.Feet != null)
            _context.Logger.Info($"  靴子: {playerData.Armor.Feet.Id}");
        
        if (playerData.Armor.MainHand != null)
            _context.Logger.Info($"  主手: {playerData.Armor.MainHand.Id}");
        
        if (playerData.Armor.OffHand != null)
            _context.Logger.Info($"  副手: {playerData.Armor.OffHand.Id}");
    }
}
```

---

## 🔄 **重生点数据（1.21.9+）**

从 Minecraft 1.21.9 开始，NetherGate 支持读取玩家的详细重生点信息，包括俯仰角、偏航角和重生锚位置。

### **RespawnData 数据模型**

```csharp
/// <summary>
/// 重生点数据（Minecraft 1.21.9+）
/// </summary>
public class RespawnData
{
    /// <summary>
    /// 重生点 X 坐标
    /// </summary>
    public int X { get; init; }
    
    /// <summary>
    /// 重生点 Y 坐标
    /// </summary>
    public int Y { get; init; }
    
    /// <summary>
    /// 重生点 Z 坐标
    /// </summary>
    public int Z { get; init; }
    
    /// <summary>
    /// 重生时的俯仰角（1.21.9+ 新增）
    /// </summary>
    public float Pitch { get; init; }
    
    /// <summary>
    /// 重生时的偏航角（可选）
    /// </summary>
    public float? Yaw { get; init; }
    
    /// <summary>
    /// 重生点所在维度
    /// </summary>
    public string Dimension { get; init; } = "minecraft:overworld";
    
    /// <summary>
    /// 是否强制重生在此位置
    /// </summary>
    public bool Forced { get; init; }
    
    /// <summary>
    /// 重生锚位置（如果使用重生锚）
    /// </summary>
    public RespawnAnchorPosition? RespawnAnchor { get; init; }
}

/// <summary>
/// 重生锚位置
/// </summary>
public class RespawnAnchorPosition
{
    /// <summary>
    /// X 坐标
    /// </summary>
    public int X { get; init; }
    
    /// <summary>
    /// Y 坐标
    /// </summary>
    public int Y { get; init; }
    
    /// <summary>
    /// Z 坐标
    /// </summary>
    public int Z { get; init; }
}
```

### **重生点查询示例**

```csharp
public class RespawnInfoCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "respawninfo";
    public string Description => "查看重生点信息";
    public List<string> Aliases => new() { "ri" };
    public string PluginId => "RespawnPlugin";
    public string? Permission => null;
    public string Usage => "#respawninfo [玩家]";

    public RespawnInfoCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var targetName = args.Length > 0 ? args[0] : sender.Name;
        
        // 获取玩家 UUID
        var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(targetName);
        if (profile == null)
        {
            return CommandResult.Fail($"§c找不到玩家: {targetName}");
        }
        
        // 读取玩家数据
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(profile.Uuid);
        if (playerData?.RespawnData == null)
        {
            return CommandResult.Fail($"§c{targetName} 没有设置重生点");
        }
        
        var respawn = playerData.RespawnData;
        
        var message = $"""
            §6═══════════════════════════════
            §f  {targetName} 的重生点信息
            
            §7  位置: §f{respawn.X}, {respawn.Y}, {respawn.Z}
            §7  维度: §f{respawn.Dimension}
            §7  俯仰角: §f{respawn.Pitch:F2}°
            """;
        
        if (respawn.Yaw.HasValue)
        {
            message += $"\n§7  偏航角: §f{respawn.Yaw.Value:F2}°";
        }
        
        message += $"\n§7  强制重生: §f{(respawn.Forced ? "是" : "否")}";
        
        if (respawn.RespawnAnchor != null)
        {
            var anchor = respawn.RespawnAnchor;
            message += $"\n§7  重生锚: §f{anchor.X}, {anchor.Y}, {anchor.Z}";
        }
        
        message += "\n§6═══════════════════════════════";
        
        sender.SendMessage(message);
        return CommandResult.Ok();
    }
}
```

### **重生点传送插件**

```csharp
public class TeleportToRespawnCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "tprespawn";
    public string Description => "传送到重生点";
    public string Usage => "#tprespawn [玩家]";
    public List<string> Aliases => new() { "tpr" };
    public string PluginId => "RespawnPlugin";
    public string? Permission => "respawn.teleport";

    public TeleportToRespawnCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var targetName = args.Length > 0 ? args[0] : sender.Name;
        
        // 获取玩家 UUID
        var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(targetName);
        if (profile == null)
        {
            return CommandResult.Fail($"§c找不到玩家: {targetName}");
        }
        
        // 读取玩家数据
        var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(profile.Uuid);
        if (playerData?.RespawnData == null)
        {
            return CommandResult.Fail($"§c{targetName} 没有设置重生点");
        }
        
        var respawn = playerData.RespawnData;
        
        // 执行传送命令
        var dimension = respawn.Dimension.Replace("minecraft:", "");
        var command = $"execute in {respawn.Dimension} run tp {targetName} {respawn.X} {respawn.Y} {respawn.Z}";
        
        await _context.RconClient!.ExecuteCommandAsync(command);
        
        sender.SendMessage($"§a已将 {targetName} 传送到重生点");
        return CommandResult.Ok();
    }
}
```

---

## ✅ **最佳实践**

### **1. 错误处理**

始终检查返回值是否为 `null`：

```csharp
var playerData = await _context.PlayerDataReader.ReadPlayerDataAsync(uuid);
if (playerData == null)
{
    _context.Logger.Warning($"无法读取玩家数据: {uuid}");
    return;
}
```

### **2. 缓存数据**

如果需要频繁访问玩家数据，考虑缓存：

```csharp
private Dictionary<Guid, PlayerData> _playerCache = new();
private DateTime _lastCacheTime;

public async Task<PlayerData?> GetCachedPlayerData(Guid uuid)
{
    // 缓存 5 分钟
    if ((DateTime.Now - _lastCacheTime).TotalMinutes > 5)
    {
        _playerCache.Clear();
        _lastCacheTime = DateTime.Now;
    }
    
    if (!_playerCache.ContainsKey(uuid))
    {
        var data = await _context.PlayerDataReader.ReadPlayerDataAsync(uuid);
        if (data != null)
        {
            _playerCache[uuid] = data;
        }
    }
    
    return _playerCache.GetValueOrDefault(uuid);
}
```

### **3. 版本兼容性**

检查 1.21.9+ 特性是否可用：

```csharp
if (playerData.RespawnData != null)
{
    // 使用 1.21.9+ 的重生点数据
    var pitch = playerData.RespawnData.Pitch;
    _context.Logger.Info($"重生俯仰角: {pitch}");
}
else
{
    _context.Logger.Info("此服务器不支持详细重生点数据");
}
```

---

## 📦 **系统要求**

- ✅ Minecraft Java 版 **1.16+**
- ✅ 重生点扩展数据需要 **Minecraft 1.21.9+**
- ✅ NetherGate **1.0.0+**

---

## 🐛 **已知限制**

1. **离线玩家**：只能读取已登录过服务器的玩家数据
2. **实时性**：数据是从文件读取的，可能与当前游戏状态有延迟
3. **文件锁定**：玩家在线时，文件可能被服务器锁定

---

## 📚 **相关文档**

- [玩家档案API](./玩家档案API.md)
- [NBT数据操作](./NBT数据操作.md)
- [命令系统](./命令系统.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-09

