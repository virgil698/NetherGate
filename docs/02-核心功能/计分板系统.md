# 计分板系统

NetherGate 提供了完整的计分板系统 API，支持目标管理、分数操作和队伍管理。完全基于 RCON `/scoreboard` 命令实现，无需文件系统支持。

> **参考资料：** [Minecraft Wiki - 计分板](https://zh.minecraft.wiki/w/计分板)

---

## 📋 **目录**

- [什么是计分板系统](#什么是计分板系统)
- [API 接口](#api-接口)
- [使用示例](#使用示例)
- [标准类型](#标准类型)
- [队伍系统](#队伍系统)
- [最佳实践](#最佳实践)

---

## 🏆 **什么是计分板系统**

**计分板（Scoreboard）**是 Minecraft 的核心数据存储和显示机制，用于追踪分数、统计数据和管理队伍。

### **核心功能**

- ✅ **目标管理** - 创建不同类型的计分板目标
- ✅ **分数操作** - 设置、增加、减少、获取玩家分数
- ✅ **队伍管理** - 创建队伍、管理成员、设置队伍属性
- ✅ **实时显示** - 在侧边栏、玩家列表或名字下方显示分数

### **与其他系统的区别**

| 特性 | 计分板 | 标签系统 |
|------|--------|----------|
| 数据存储 | RCON 命令 | 文件系统 |
| 实时性 | 完全实时 | 需要缓存刷新 |
| 可见性 | 可在游戏中显示 | 仅用于逻辑判断 |
| 性能 | 高（服务器内存） | 中（需读取文件） |

---

## 📖 **API 接口**

### **IScoreboardApi 接口**

```csharp
namespace NetherGate.API.Scoreboard
{
    public interface IScoreboardApi
    {
        // 目标管理
        Task<bool> CreateObjectiveAsync(string name, ScoreboardCriteria criteria, string? displayName = null);
        Task<bool> RemoveObjectiveAsync(string name);
        Task<bool> SetDisplaySlotAsync(DisplaySlot slot, string objectiveName);
        
        // 分数操作
        Task<bool> SetScoreAsync(string holder, string objectiveName, int score);
        Task<bool> AddScoreAsync(string holder, string objectiveName, int amount);
        Task<bool> RemoveScoreAsync(string holder, string objectiveName, int amount);
        Task<int?> GetScoreAsync(string holder, string objectiveName);
        Task<bool> ResetScoreAsync(string holder, string? objectiveName = null);
        
        // 队伍管理
        Task<bool> CreateTeamAsync(string teamName, string? displayName = null);
        Task<bool> JoinTeamAsync(string teamName, string members);
        Task<bool> SetTeamColorAsync(string teamName, TeamColor color);
        
        // 高级功能
        Task<List<ScoreEntry>> GetTopScoresAsync(string objectiveName, int limit = 10);
    }
}
```

---

## 💡 **使用示例**

### **示例 1：创建金币系统**

```csharp
public class CoinSystemPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 创建金币计分板
        await _context.ScoreboardApi.CreateObjectiveAsync(
            name: "coins",
            criteria: ScoreboardCriteria.Dummy,
            displayName: "{\"text\":\"§6金币\",\"bold\":true}"
        );
        
        // 在侧边栏显示
        await _context.ScoreboardApi.SetDisplaySlotAsync(
            DisplaySlot.Sidebar,
            "coins"
        );
        
        // 给玩家初始金币
        await _context.ScoreboardApi.SetScoreAsync("Steve", "coins", 100);
        
        _context.Logger.Info("金币系统已启动");
    }
}
```

### **示例 2：击杀排行榜**

```csharp
public class KillLeaderboardPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 创建击杀计数（使用自动统计）
        await _context.ScoreboardApi.CreateObjectiveAsync(
            name: "kills",
            criteria: ScoreboardCriteria.PlayerKillCount,
            displayName: "{\"text\":\"击杀排行榜\",\"color\":\"red\"}"
        );
        
        // 在侧边栏显示
        await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.Sidebar, "kills");
        
        // 在玩家列表显示
        await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.List, "kills");
    }
}
```

### **示例 3：队伍 PvP 系统**

```csharp
public class TeamPvPPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 创建红队
        await _context.ScoreboardApi.CreateTeamAsync("red", "{\"text\":\"红队\",\"color\":\"red\"}");
        await _context.ScoreboardApi.SetTeamColorAsync("red", TeamColor.Red);
        await _context.ScoreboardApi.SetTeamFriendlyFireAsync("red", false);
        await _context.ScoreboardApi.SetTeamPrefixAsync("red", "{\"text\":\"[红队] \",\"color\":\"red\"}");
        
        // 创建蓝队
        await _context.ScoreboardApi.CreateTeamAsync("blue", "{\"text\":\"蓝队\",\"color\":\"blue\"}");
        await _context.ScoreboardApi.SetTeamColorAsync("blue", TeamColor.Blue);
        await _context.ScoreboardApi.SetTeamFriendlyFireAsync("blue", false);
        await _context.ScoreboardApi.SetTeamPrefixAsync("blue", "{\"text\":\"[蓝队] \",\"color\":\"blue\"}");
        
        // 创建队伍积分
        await _context.ScoreboardApi.CreateObjectiveAsync("team_score", ScoreboardCriteria.Dummy, "队伍积分");
        await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.Sidebar, "team_score");
    }

    // 玩家加入红队
    public async Task JoinRedTeamAsync(string playerName)
    {
        await _context.ScoreboardApi.JoinTeamAsync("red", playerName);
        await _context.GameDisplayApi.SendChatMessageAsync(playerName, 
            "{\"text\":\"你加入了红队！\",\"color\":\"red\"}");
    }
}
```

### **示例 4：等级系统**

```csharp
public class LevelSystemPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 创建等级目标
        await _context.ScoreboardApi.CreateObjectiveAsync("level", ScoreboardCriteria.Dummy, "等级");
        await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.BelowName, "level");
        
        // 修改渲染类型为红心显示
        await _context.ScoreboardApi.ModifyObjectiveRenderTypeAsync("level", RenderType.Hearts);
        
        // 注册命令
        _context.CommandManager.RegisterCommand(new LevelUpCommand(_context));
    }
}

public class LevelUpCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "levelup";
    public string Description => "升级";
    public string Usage => "#levelup";
    public List<string> Aliases => new();
    public string PluginId => "LevelSystem";
    public string? Permission => null;

    public LevelUpCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        // 获取当前等级
        var currentLevel = await _context.ScoreboardApi.GetScoreAsync(sender.Name, "level") ?? 0;
        
        // 升级
        var newLevel = currentLevel + 1;
        await _context.ScoreboardApi.SetScoreAsync(sender.Name, "level", newLevel);
        
        // 发送消息
        await _context.GameDisplayApi.ShowTitleAsync(
            sender.Name,
            title: "{\"text\":\"升级！\",\"color\":\"gold\",\"bold\":true}",
            subtitle: $"{{\"text\":\"等级 {newLevel}\",\"color\":\"yellow\"}}"
        );
        
        sender.SendMessage($"§a恭喜！你已升级到 §e{newLevel} §a级");
        return CommandResult.Ok();
    }
}
```

### **示例 5：商店系统**

```csharp
public class ShopSystemPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        // 创建金币系统
        await _context.ScoreboardApi.CreateObjectiveAsync("coins", ScoreboardCriteria.Dummy);
        
        // 注册购买命令
        _context.CommandManager.RegisterCommand(new BuyCommand(_context));
    }
}

public class BuyCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "buy";
    public string Description => "购买物品";
    public string Usage => "#buy <物品>";
    public List<string> Aliases => new();
    public string PluginId => "ShopSystem";
    public string? Permission => null;

    public BuyCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        if (args.Length < 1)
            return CommandResult.Fail("§c用法: /buy <物品>");

        var item = args[0];
        var price = GetItemPrice(item);
        
        if (price == null)
            return CommandResult.Fail("§c该物品不存在");

        // 检查金币
        var coins = await _context.ScoreboardApi.GetScoreAsync(sender.Name, "coins") ?? 0;
        
        if (coins < price.Value)
        {
            return CommandResult.Fail($"§c金币不足！需要 §e{price.Value} §c金币，你只有 §e{coins} §c金币");
        }
        
        // 扣除金币
        await _context.ScoreboardApi.RemoveScoreAsync(sender.Name, "coins", price.Value);
        
        // 给予物品
        await _context.GameDisplayApi.GiveItemAsync(sender.Name, item, 1);
        
        sender.SendMessage($"§a购买成功！花费 §e{price.Value} §a金币");
        return CommandResult.Ok();
    }

    private int? GetItemPrice(string item)
    {
        return item switch
        {
            "minecraft:diamond" => 100,
            "minecraft:iron_ingot" => 10,
            "minecraft:gold_ingot" => 20,
            _ => null
        };
    }
}
```

---

## 📚 **标准类型**

### **计分板标准 (ScoreboardCriteria)**

| 标准 | 说明 | 自动更新 |
|------|------|----------|
| `Dummy` | 自定义标准 | ❌ 需手动修改 |
| `Trigger` | 触发器 | ⚠️ 玩家可触发 |
| `DeathCount` | 死亡次数 | ✅ 玩家死亡时 |
| `PlayerKillCount` | 玩家击杀数 | ✅ 击杀玩家时 |
| `TotalKillCount` | 总击杀数 | ✅ 击杀任何实体时 |
| `Health` | 生命值 | ✅ 实时更新 |
| `Xp` | 经验值 | ✅ 实时更新 |
| `Level` | 等级 | ✅ 实时更新 |
| `Food` | 饥饿值 | ✅ 实时更新 |
| `Air` | 空气值 | ✅ 实时更新 |
| `Armor` | 护甲值 | ✅ 实时更新 |

---

## 👥 **队伍系统**

### **队伍功能**

```csharp
// 创建队伍并设置属性
await _context.ScoreboardApi.CreateTeamAsync("myteam", "我的队伍");
await _context.ScoreboardApi.SetTeamColorAsync("myteam", TeamColor.Green);
await _context.ScoreboardApi.SetTeamPrefixAsync("myteam", "[VIP] ");
await _context.ScoreboardApi.SetTeamFriendlyFireAsync("myteam", false);

// 成员管理
await _context.ScoreboardApi.JoinTeamAsync("myteam", "Steve");
await _context.ScoreboardApi.JoinTeamAsync("myteam", "@a[team=]");  // 所有无队伍的玩家
await _context.ScoreboardApi.LeaveTeamAsync("Steve");
```

### **队伍颜色**

所有 Minecraft 文本颜色可用：`Black`、`DarkBlue`、`DarkGreen`、`DarkAqua`、`DarkRed`、`DarkPurple`、`Gold`、`Gray`、`DarkGray`、`Blue`、`Green`、`Aqua`、`Red`、`LightPurple`、`Yellow`、`White`

---

## ✅ **最佳实践**

### **1. 合理使用标准类型**

```csharp
// ✅ 推荐：使用自动更新的标准
await _context.ScoreboardApi.CreateObjectiveAsync("deaths", ScoreboardCriteria.DeathCount);

// ⚠️ 需手动维护：Dummy 标准
await _context.ScoreboardApi.CreateObjectiveAsync("custom", ScoreboardCriteria.Dummy);
```

### **2. 优化显示性能**

```csharp
// ❌ 避免频繁切换显示
for (int i = 0; i < 100; i++)
{
    await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.Sidebar, "obj" + i);
}

// ✅ 固定一个目标，修改分数
await _context.ScoreboardApi.SetDisplaySlotAsync(DisplaySlot.Sidebar, "stats");
await _context.ScoreboardApi.SetScoreAsync("Player1", "stats", 100);
await _context.ScoreboardApi.SetScoreAsync("Player2", "stats", 200);
```

### **3. 使用虚拟条目显示文本**

```csharp
// 在侧边栏显示固定文本
await _context.ScoreboardApi.SetScoreAsync("§6═══════════", "sidebar", 10);
await _context.ScoreboardApi.SetScoreAsync("§e服务器状态", "sidebar", 9);
await _context.ScoreboardApi.SetScoreAsync("§a在线: 25人", "sidebar", 8);
await _context.ScoreboardApi.SetScoreAsync("§6═══════════", "sidebar", 7);
```

### **4. 错误处理**

```csharp
try
{
    var score = await _context.ScoreboardApi.GetScoreAsync("Steve", "coins");
    if (score == null)
    {
        _context.Logger.Warning("玩家没有该分数");
        return;
    }
    
    _context.Logger.Info($"Steve 的金币: {score.Value}");
}
catch (Exception ex)
{
    _context.Logger.Error("获取分数失败", ex);
}
```

---

## ⚙️ **技术细节**

### **实现方式**

- ✅ 100% 基于 RCON `/scoreboard` 命令
- ✅ 无文件系统依赖
- ✅ 实时性强，响应快速
- ✅ 数据存储在服务器内存中

### **性能特点**

- **读取速度**：极快（直接从服务器内存读取）
- **写入速度**：极快（RCON 命令执行）
- **缓存策略**：无需缓存（数据已在服务器端）

---

## 🐛 **已知限制**

### **未完全实现的功能**

以下方法需要额外的数据收集功能支持，当前版本暂未完全实现：

1. **`GetTopScoresAsync`** - 获取排行榜前 N 名
   - **原因**：Minecraft 没有直接的分数排序命令
   - **临时方案**：手动收集并排序所有玩家的分数
   - **计划**：未来版本将实现基于日志解析的自动排序

2. **`GetPlayerRankAsync`** - 获取玩家排名
   - **原因**：需要先获取所有分数并排序
   - **临时方案**：使用 `GetTopScoresAsync` 后手动查找
   - **计划**：未来版本将提供完整支持

**示例替代方案：**

```csharp
// 获取前10名玩家的分数（需要先知道玩家列表）
var players = new[] { "Steve", "Alex", "Bob" };  // 需要从其他途径获取玩家列表
var scores = new List<(string player, int score)>();

foreach (var player in players)
{
    var score = await _context.ScoreboardApi.GetScoreAsync(player, "kills");
    if (score.HasValue)
    {
        scores.Add((player, score.Value));
    }
}

// 手动排序
var topPlayers = scores.OrderByDescending(s => s.score).Take(10).ToList();
```

---

## 📦 **系统要求**

- ✅ Minecraft Java 版 **1.5+** （计分板基础功能）
- ✅ Minecraft Java 版 **1.13+** （JSON 显示名称）
- ✅ NetherGate **1.0.0+**
- ✅ RCON 连接必须启用

---

## 📚 **相关文档**

- [标签系统](./标签系统.md) - 数据分组机制
- [游戏显示API](../04-高级功能/游戏显示API.md) - 显示相关功能
- [排行榜系统](../04-高级功能/排行榜系统.md) - 基于计分板的排行榜

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-09

