# NetherGate æœåŠ¡å™¨è¿›ç¨‹ç®¡ç†

NetherGate æä¾›äº†å®Œæ•´çš„ Minecraft æœåŠ¡å™¨è¿›ç¨‹ç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒè‡ªåŠ¨å¯åŠ¨ã€ç›‘æ§ã€å´©æºƒæ£€æµ‹å’Œè‡ªåŠ¨é‡å¯ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [å¯åŠ¨æµç¨‹](#å¯åŠ¨æµç¨‹)
- [è¿›ç¨‹ç›‘æ§](#è¿›ç¨‹ç›‘æ§)
- [å´©æºƒæ£€æµ‹](#å´©æºƒæ£€æµ‹)
- [è‡ªåŠ¨é‡å¯](#è‡ªåŠ¨é‡å¯)
- [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **åŸºç¡€é…ç½®**

```yaml
server_process:
  # æ˜¯å¦å¯ç”¨è¿›ç¨‹ç®¡ç†
  enabled: true
  
  # å¯åŠ¨æ–¹å¼
  launch_method: java
  
  # Java é…ç½®
  java:
    path: java
    version_check: true
  
  # æœåŠ¡å™¨é…ç½®
  server:
    jar: server.jar
    working_directory: ./minecraft_server
  
  # å†…å­˜é…ç½®
  memory:
    min: 2048  # æœ€å°å†…å­˜ï¼ˆMBï¼‰
    max: 4096  # æœ€å¤§å†…å­˜ï¼ˆMBï¼‰
  
  # ç›‘æ§é…ç½®
  monitoring:
    startup_timeout: 300  # å¯åŠ¨è¶…æ—¶ï¼ˆç§’ï¼‰
    show_server_output: true
    
    startup_detection:
      enabled: true
      keywords:
        - "Done ("
    
    crash_detection:
      enabled: true
      keywords:
        - "Exception in server tick loop"
  
  # è‡ªåŠ¨é‡å¯é…ç½®
  auto_restart:
    enabled: true
    delay_seconds: 5
    max_retries: 3
    retry_delay: 5000
    reset_timer: 600000
```

---

## ğŸ—ï¸ **æ¶æ„è®¾è®¡**

### **æ¨¡å—ç»“æ„**

```
ServerProcessManager
â”œâ”€â”€ ProcessLauncher          # è¿›ç¨‹å¯åŠ¨å™¨
â”‚   â”œâ”€â”€ å‘½ä»¤æ„å»º
â”‚   â”œâ”€â”€ è¿›ç¨‹åˆ›å»º
â”‚   â””â”€â”€ ç¯å¢ƒé…ç½®
â”‚
â”œâ”€â”€ OutputMonitor            # è¾“å‡ºç›‘æ§å™¨
â”‚   â”œâ”€â”€ æ ‡å‡†è¾“å‡ºç›‘å¬
â”‚   â”œâ”€â”€ é”™è¯¯è¾“å‡ºç›‘å¬
â”‚   â””â”€â”€ è¾“å‡ºè½¬å‘
â”‚
â”œâ”€â”€ StateDetector            # çŠ¶æ€æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ å¯åŠ¨å®Œæˆæ£€æµ‹
â”‚   â”œâ”€â”€ å´©æºƒæ£€æµ‹
â”‚   â””â”€â”€ å¿ƒè·³æ£€æµ‹
â”‚
â”œâ”€â”€ CrashHandler             # å´©æºƒå¤„ç†å™¨
â”‚   â”œâ”€â”€ å´©æºƒåˆ†æ
â”‚   â”œâ”€â”€ æ—¥å¿—æ”¶é›†
â”‚   â””â”€â”€ é‡å¯å†³ç­–
â”‚
â””â”€â”€ CommandBuilder           # å‘½ä»¤æ„å»ºå™¨
    â”œâ”€â”€ JVM å‚æ•°æ„å»º
    â”œâ”€â”€ å†…å­˜å‚æ•°æ„å»º
    â””â”€â”€ æœåŠ¡å™¨å‚æ•°æ„å»º
```

---

## ğŸ”„ **å¯åŠ¨æµç¨‹**

### **å®Œæ•´å¯åŠ¨æµç¨‹å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. NetherGate å¯åŠ¨                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯»å–é…ç½®æ–‡ä»¶                                         â”‚
â”‚    - nethergate-config.yaml                             â”‚
â”‚    - éªŒè¯é…ç½®æœ‰æ•ˆæ€§                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ£€æŸ¥ Java ç¯å¢ƒ                                       â”‚
â”‚    - æ£€æµ‹ Java ç‰ˆæœ¬                                     â”‚
â”‚    - éªŒè¯ Java è·¯å¾„                                     â”‚
â”‚    - ç¡®è®¤ç‰ˆæœ¬å…¼å®¹æ€§                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ„å»º Java å¯åŠ¨å‘½ä»¤                                   â”‚
â”‚    java [jvm_prefix] -Xms2048M -Xmx4096M [jvm_middle]  â”‚
â”‚         -jar server.jar [server_args]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å¯åŠ¨æœåŠ¡å™¨è¿›ç¨‹                                       â”‚
â”‚    - è®¾ç½®å·¥ä½œç›®å½•                                       â”‚
â”‚    - å¯åŠ¨è¿›ç¨‹                                           â”‚
â”‚    - è®°å½•è¿›ç¨‹ ID                                        â”‚
â”‚    - å‘å¸ƒ ServerProcessStartedEvent                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç›‘å¬è¾“å‡ºæµ                                           â”‚
â”‚    â”œâ”€ æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰â”€â”€â”€â”€â†’ è½¬å‘åˆ° NetherGate æ§åˆ¶å° â”‚
â”‚    â””â”€ é”™è¯¯è¾“å‡ºï¼ˆstderrï¼‰â”€â”€â”€â”€â†’ è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ£€æµ‹å¯åŠ¨å®Œæˆ                                         â”‚
â”‚    - æ‰«æè¾“å‡ºæ—¥å¿—                                       â”‚
â”‚    - åŒ¹é…å…³é”®å­— "Done ("                                â”‚
â”‚    - è®¡ç®—å¯åŠ¨è€—æ—¶                                       â”‚
â”‚    - å‘å¸ƒ ServerReadyEvent                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. è¿æ¥ç®¡ç†åè®®                                         â”‚
â”‚    â”œâ”€ RCON è¿æ¥                                         â”‚
â”‚    â””â”€ SMP è¿æ¥                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. åŠ è½½å’Œåˆå§‹åŒ–æ’ä»¶                                     â”‚
â”‚    - æ‰«æ plugins ç›®å½•                                  â”‚
â”‚    - åŠ è½½æ’ä»¶ç¨‹åºé›†                                     â”‚
â”‚    - è°ƒç”¨æ’ä»¶ OnLoad/OnEnable                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. NetherGate å°±ç»ª                                     â”‚
â”‚     - ç³»ç»Ÿå®Œå…¨å¯ç”¨                                      â”‚
â”‚     - å¼€å§‹å¤„ç†å‘½ä»¤å’Œäº‹ä»¶                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å‘½ä»¤æ„å»ºè¯¦è§£**

**å®Œæ•´å‘½ä»¤æ ¼å¼**ï¼š
```bash
java [jvm_prefix] -Xms<min>M -Xmx<max>M [jvm_middle] -jar <server.jar> [server]
```

**ç¤ºä¾‹**ï¼š
```bash
java -Xms2048M -Xmx4096M -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Dfile.encoding=UTF-8 -jar server.jar --nogui
```

**å‚æ•°é¡ºåº**ï¼š
1. `java` - Java å¯æ‰§è¡Œæ–‡ä»¶
2. `jvm_prefix` - JVM å‰ç½®å‚æ•°
3. `-Xms<min>M` - æœ€å°å†…å­˜
4. `-Xmx<max>M` - æœ€å¤§å†…å­˜
5. `jvm_middle` - JVM ä¸­é—´å‚æ•°ï¼ˆGCã€æ€§èƒ½ä¼˜åŒ–ç­‰ï¼‰
6. `-jar <server.jar>` - æœåŠ¡å™¨ JAR æ–‡ä»¶
7. `server` - æœåŠ¡å™¨å‚æ•°

---

## ğŸ“Š **è¿›ç¨‹ç›‘æ§**

### **è¾“å‡ºç›‘æ§å™¨ï¼ˆOutputMonitorï¼‰**

ç›‘å¬æœåŠ¡å™¨çš„æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºï¼Œå®æ—¶è½¬å‘åˆ° NetherGate æ§åˆ¶å°ã€‚

#### **å·¥ä½œåŸç†**

```csharp
// ä¼ªä»£ç ç¤ºä¾‹
public class OutputMonitor
{
    public void StartMonitoring(Process process)
    {
        // ç›‘å¬æ ‡å‡†è¾“å‡º
        process.OutputDataReceived += (sender, e) =>
        {
            if (!string.IsNullOrEmpty(e.Data))
            {
                // è½¬å‘åˆ°æ§åˆ¶å°
                Console.WriteLine($"[MC] {e.Data}");
                
                // æ£€æµ‹å¯åŠ¨å®Œæˆ
                CheckStartupComplete(e.Data);
                
                // æ£€æµ‹å´©æºƒ
                CheckCrash(e.Data);
                
                // å‘å¸ƒäº‹ä»¶
                OnOutputReceived(e.Data);
            }
        };
        
        // ç›‘å¬é”™è¯¯è¾“å‡º
        process.ErrorDataReceived += (sender, e) =>
        {
            if (!string.IsNullOrEmpty(e.Data))
            {
                Logger.Error($"[MC Error] {e.Data}");
                OnErrorReceived(e.Data);
            }
        };
        
        // å¼€å§‹å¼‚æ­¥è¯»å–
        process.BeginOutputReadLine();
        process.BeginErrorReadLine();
    }
}
```

#### **è¾“å‡ºæ ¼å¼åŒ–**

```
[14:23:45 INFO]: [MC] Starting minecraft server version 1.20.1
[14:23:45 INFO]: [MC] Loading properties
[14:23:46 INFO]: [MC] Default game type: SURVIVAL
[14:23:50 INFO]: [MC] Done (4.827s)! For help, type "help"
```

---

## ğŸ” **å¯åŠ¨å®Œæˆæ£€æµ‹**

### **æ£€æµ‹æœºåˆ¶**

ç›‘å¬æœåŠ¡å™¨è¾“å‡ºï¼ŒåŒ¹é…å…³é”®å­—åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨å®Œæˆã€‚

#### **é»˜è®¤å…³é”®å­—**

```yaml
startup_detection:
  enabled: true
  keywords:
    - "Done ("                    # ä¸»è¦æ£€æµ‹ç‚¹
    - "For help, type \"help\""   # è¾…åŠ©æ£€æµ‹ç‚¹
```

#### **æ£€æµ‹æµç¨‹**

```
æœåŠ¡å™¨è¾“å‡ºæµ
    â†“
[MC] Starting minecraft server...
    â†“
[MC] Loading libraries...
    â†“
[MC] Preparing level "world"
    â†“
[MC] Done (4.827s)! For help, type "help"  â† åŒ¹é…åˆ°å…³é”®å­—
    â†“
è®¡ç®—å¯åŠ¨è€—æ—¶: 4.827 ç§’
    â†“
å‘å¸ƒ ServerReadyEvent
    â†“
æ›´æ–°çŠ¶æ€: Starting â†’ Running
```

#### **è¶…æ—¶å¤„ç†**

```yaml
monitoring:
  startup_timeout: 300  # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

å¦‚æœè¶…è¿‡ 300 ç§’æœªæ£€æµ‹åˆ°å¯åŠ¨å®Œæˆï¼š
1. è®°å½•è­¦å‘Šæ—¥å¿—
2. å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹
3. å‘å¸ƒ `ServerCrashedEvent`
4. æ ¹æ®é…ç½®å†³å®šæ˜¯å¦é‡å¯

---

## ğŸš¨ **å´©æºƒæ£€æµ‹**

### **æ£€æµ‹ç­–ç•¥**

#### **1. é€€å‡ºç æ£€æµ‹**

```csharp
process.Exited += (sender, e) =>
{
    int exitCode = process.ExitCode;
    
    if (exitCode == 0)
    {
        // æ­£å¸¸é€€å‡º
        OnServerStopped(new ServerStoppedEventArgs 
        { 
            ExitCode = 0,
            WasClean = true 
        });
    }
    else
    {
        // å¼‚å¸¸é€€å‡ºï¼ˆå´©æºƒï¼‰
        OnServerCrashed(new ServerCrashedEventArgs 
        { 
            ExitCode = exitCode,
            WillRestart = ShouldRestart()
        });
    }
};
```

#### **2. å…³é”®å­—æ£€æµ‹**

```yaml
crash_detection:
  enabled: true
  keywords:
    - "Exception in server tick loop"
    - "OutOfMemoryError"
    - "StackOverflowError"
    - "java.lang.Error"
```

åŒ¹é…åˆ°è¿™äº›å…³é”®å­—æ—¶ï¼Œå³ä½¿è¿›ç¨‹æœªé€€å‡ºä¹Ÿæ ‡è®°ä¸ºæ½œåœ¨å´©æºƒã€‚

#### **3. å¿ƒè·³æ£€æµ‹**

å®šæœŸæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å“åº”ï¼ˆé€šè¿‡ RCON æˆ– SMPï¼‰ï¼š

```csharp
// æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
Timer heartbeatTimer = new(30000);
heartbeatTimer.Elapsed += async (sender, e) =>
{
    if (!await PingServerAsync())
    {
        Logger.Warning("Server is not responding!");
        // å¯é€‰ï¼šè§¦å‘é‡å¯
    }
};
```

### **å´©æºƒåˆ†æ**

å´©æºƒæ—¶è‡ªåŠ¨æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **é€€å‡ºç **
2. **æœ€å 100 è¡Œæ—¥å¿—**
3. **å´©æºƒæ—¶é—´**
4. **è¿è¡Œæ—¶é•¿**
5. **é‡å¯æ¬¡æ•°**
6. **ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ**

---

## ğŸ”„ **è‡ªåŠ¨é‡å¯**

### **é‡å¯ç­–ç•¥**

```yaml
auto_restart:
  enabled: true         # æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡å¯
  delay_seconds: 5      # é‡å¯å‰å»¶è¿Ÿï¼ˆç§’ï¼‰
  max_retries: 3        # æœ€å¤§é‡è¯•æ¬¡æ•°
  retry_delay: 5000     # é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  reset_timer: 600000   # é‡å¯è®¡æ•°å™¨é‡ç½®æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œ10åˆ†é’Ÿï¼‰
```

### **å·¥ä½œæµç¨‹**

```
æœåŠ¡å™¨å´©æºƒ
    â†“
æ£€æŸ¥ auto_restart.enabled
    â”œâ”€ false â†’ åœæ­¢ï¼Œç­‰å¾…æ‰‹åŠ¨å¤„ç†
    â””â”€ true  â†’ ç»§ç»­
    â†“
æ£€æŸ¥é‡è¯•æ¬¡æ•° < max_retries
    â”œâ”€ false â†’ åœæ­¢ï¼Œè®°å½•é”™è¯¯æ—¥å¿—
    â””â”€ true  â†’ ç»§ç»­
    â†“
ç­‰å¾… delay_seconds ç§’
    â†“
è®°å½•æ—¥å¿—ï¼š"Restarting server... (Attempt X/Y)"
    â†“
é‡æ–°å¯åŠ¨æœåŠ¡å™¨
    â†“
é‡è¯•æ¬¡æ•° +1
    â†“
ç›‘æ§å¯åŠ¨ç»“æœ
    â”œâ”€ æˆåŠŸ â†’ å¯åŠ¨è®¡æ—¶å™¨ï¼ŒX åˆ†é’Ÿåé‡ç½®è®¡æ•°å™¨
    â””â”€ å¤±è´¥ â†’ è¿”å›"æœåŠ¡å™¨å´©æºƒ"æ­¥éª¤
```

### **è®¡æ•°å™¨é‡ç½®**

```
æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
    â†“
å¯åŠ¨è®¡æ—¶å™¨ï¼ˆ10 åˆ†é’Ÿï¼‰
    â†“
æœåŠ¡å™¨ç¨³å®šè¿è¡Œ 10 åˆ†é’Ÿ
    â†“
é‡ç½®é‡è¯•è®¡æ•°å™¨ä¸º 0
    â†“
ä¸‹æ¬¡å´©æºƒæ—¶ä»å¤´å¼€å§‹è®¡æ•°
```

### **ç¤ºä¾‹åœºæ™¯**

#### **åœºæ™¯ 1ï¼šè¿ç»­å´©æºƒ**

```
æ—¶é—´    äº‹ä»¶              é‡è¯•æ¬¡æ•°  åŠ¨ä½œ
0:00   æœåŠ¡å™¨å´©æºƒ         0      â†’ ç­‰å¾… 5 ç§’
0:05   é‡å¯              1      â†’ å¯åŠ¨å¤±è´¥
0:05   å†æ¬¡å´©æºƒ          1      â†’ ç­‰å¾… 5 ç§’
0:10   é‡å¯              2      â†’ å¯åŠ¨å¤±è´¥
0:10   å†æ¬¡å´©æºƒ          2      â†’ ç­‰å¾… 5 ç§’
0:15   é‡å¯              3      â†’ å¯åŠ¨å¤±è´¥
0:15   å†æ¬¡å´©æºƒ          3      â†’ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
0:15   åœæ­¢é‡å¯          3      â†’ éœ€è¦æ‰‹åŠ¨å¤„ç†
```

#### **åœºæ™¯ 2ï¼šç¨³å®šè¿è¡Œåå´©æºƒ**

```
æ—¶é—´    äº‹ä»¶              é‡è¯•æ¬¡æ•°  åŠ¨ä½œ
0:00   æœåŠ¡å™¨å´©æºƒ         0      â†’ é‡å¯
0:05   æˆåŠŸå¯åŠ¨          1      â†’ å¯åŠ¨è®¡æ—¶å™¨
10:05  è®¡æ—¶å™¨è§¦å‘         1      â†’ é‡ç½®è®¡æ•°å™¨ä¸º 0
15:00  æœåŠ¡å™¨å´©æºƒ         0      â†’ é‡å¯ï¼ˆé‡æ–°è®¡æ•°ï¼‰
```

---

## ğŸ“¡ **çŠ¶æ€ç®¡ç†**

### **è¿›ç¨‹çŠ¶æ€**

```csharp
public enum ServerProcessState
{
    Stopped,        // æœªå¯åŠ¨
    Starting,       // å¯åŠ¨ä¸­
    Running,        // è¿è¡Œä¸­
    Stopping,       // åœæ­¢ä¸­
    Crashed,        // å´©æºƒ
    Restarting      // é‡å¯ä¸­
}
```

### **çŠ¶æ€è½¬æ¢å›¾**

```
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Stopped  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
                   â”‚ Start()          â”‚
                   â–¼                  â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
              â”‚ Starting â”‚            â”‚
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
                   â”‚                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
          â”‚                 â”‚         â”‚
    å¯åŠ¨æˆåŠŸ               å¯åŠ¨å¤±è´¥    â”‚
          â”‚                 â”‚         â”‚
          â–¼                 â–¼         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚ Running  â”‚      â”‚ Crashed â”‚    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚
         â”‚                 â”‚         â”‚
         â”‚ Stop()    è‡ªåŠ¨é‡å¯/       â”‚
         â”‚           æ‰‹åŠ¨å¤„ç†        â”‚
         â–¼                 â”‚         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚         â”‚
    â”‚ Stopping â”‚           â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚         â”‚
         â”‚                 â”‚         â”‚
    å®Œæˆåœæ­¢          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚           â”‚ Restarting  â”‚ â”‚
         â”‚           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚                  â”‚        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **çŠ¶æ€æŸ¥è¯¢**

```csharp
// åœ¨æ’ä»¶ä¸­æŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€
var state = await Context.Server.GetStateAsync();

switch (state)
{
    case ServerProcessState.Running:
        Logger.Info("æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ");
        break;
    
    case ServerProcessState.Starting:
        Logger.Info("æœåŠ¡å™¨æ­£åœ¨å¯åŠ¨...");
        break;
    
    case ServerProcessState.Crashed:
        Logger.Error("æœåŠ¡å™¨å·²å´©æºƒï¼");
        break;
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. å†…å­˜é…ç½®**

```yaml
# âœ… æ¨èï¼šæ ¹æ®æœåŠ¡å™¨è§„æ¨¡é…ç½®
memory:
  min: 2048  # å°å‹æœåŠ¡å™¨ï¼ˆ<10äººï¼‰
  max: 4096

memory:
  min: 4096  # ä¸­å‹æœåŠ¡å™¨ï¼ˆ10-50äººï¼‰
  max: 8192

memory:
  min: 8192  # å¤§å‹æœåŠ¡å™¨ï¼ˆ50+äººï¼‰
  max: 16384

# âŒ ä¸æ¨èï¼šmin å’Œ max ç›¸å·®è¿‡å¤§
memory:
  min: 1024
  max: 16384  # å¯èƒ½å¯¼è‡´ GC å‹åŠ›
```

### **2. JVM å‚æ•°ä¼˜åŒ–**

**G1GC æ¨èé…ç½®**ï¼ˆJava 8+ï¼‰ï¼š

```yaml
jvm_middle:
  - -XX:+UseG1GC
  - -XX:+ParallelRefProcEnabled
  - -XX:MaxGCPauseMillis=200
  - -XX:+UnlockExperimentalVMOptions
  - -XX:+DisableExplicitGC
  - -XX:+AlwaysPreTouch
  - -XX:G1NewSizePercent=30
  - -XX:G1MaxNewSizePercent=40
  - -XX:G1HeapRegionSize=8M
  - -Dfile.encoding=UTF-8
```

**ZGC é…ç½®**ï¼ˆJava 17+ï¼Œå¤§å†…å­˜æœåŠ¡å™¨ï¼‰ï¼š

```yaml
jvm_middle:
  - -XX:+UseZGC
  - -XX:AllocatePrefetchStyle=1
  - -XX:-ZProactive
  - -Dfile.encoding=UTF-8
```

### **3. å´©æºƒæ£€æµ‹é…ç½®**

```yaml
# æ ¹æ®æœåŠ¡å™¨ç±»å‹è°ƒæ•´å…³é”®å­—
crash_detection:
  keywords:
    # é€šç”¨å´©æºƒ
    - "Exception in server tick loop"
    - "OutOfMemoryError"
    
    # Paper/Spigot ç‰¹å®š
    - "Could not pass event"
    
    # æ¨¡ç»„æœåŠ¡å™¨
    - "FML ModContainer"
    - "Exception loading model"
```

### **4. è‡ªåŠ¨é‡å¯ç­–ç•¥**

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
auto_restart:
  enabled: true
  delay_seconds: 10      # ç¨é•¿å»¶è¿Ÿï¼Œä¾¿äºæŸ¥çœ‹å´©æºƒæ—¥å¿—
  max_retries: 5         # é€‚å½“å¢åŠ é‡è¯•æ¬¡æ•°
  retry_delay: 10000     # 10 ç§’å»¶è¿Ÿ
  reset_timer: 3600000   # 1 å°æ—¶åé‡ç½®è®¡æ•°å™¨
```

### **5. å¯åŠ¨è¶…æ—¶æ—¶é—´**

```yaml
# æ ¹æ®ä¸–ç•Œå¤§å°è°ƒæ•´
monitoring:
  startup_timeout: 300   # å°ä¸–ç•Œï¼ˆ<500MBï¼‰
  startup_timeout: 600   # ä¸­ç­‰ä¸–ç•Œï¼ˆ500MB-2GBï¼‰
  startup_timeout: 1200  # å¤§ä¸–ç•Œï¼ˆ>2GBï¼‰
```

---

## ğŸ”§ **æ•…éšœæ’æŸ¥**

### **é—®é¢˜ 1ï¼šæœåŠ¡å™¨æ— æ³•å¯åŠ¨**

**ç—‡çŠ¶**ï¼šå¯åŠ¨åç«‹å³é€€å‡ºï¼Œé€€å‡ºç é 0

**æ’æŸ¥æ­¥éª¤**ï¼š

1. æ£€æŸ¥ Java ç‰ˆæœ¬ï¼š
   ```bash
   java -version
   ```

2. æ£€æŸ¥æœåŠ¡å™¨ JAR æ˜¯å¦å­˜åœ¨ï¼š
   ```bash
   ls minecraft_server/server.jar
   ```

3. å°è¯•æ‰‹åŠ¨å¯åŠ¨ï¼š
   ```bash
   cd minecraft_server
   java -Xms2048M -Xmx4096M -jar server.jar nogui
   ```

4. æŸ¥çœ‹ NetherGate æ—¥å¿—ï¼š
   ```bash
   tail -f logs/latest.log
   ```

### **é—®é¢˜ 2ï¼šå¯åŠ¨è¶…æ—¶**

**ç—‡çŠ¶**ï¼šæœåŠ¡å™¨å¯åŠ¨æ—¶é—´è¶…è¿‡ `startup_timeout`

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. å¢åŠ è¶…æ—¶æ—¶é—´ï¼š
   ```yaml
   monitoring:
     startup_timeout: 600  # ä» 300 å¢åŠ åˆ° 600
   ```

2. æ£€æŸ¥ä¸–ç•Œå¤§å°ï¼Œè€ƒè™‘ä¼˜åŒ–æˆ–å¤‡ä»½æ—§ä¸–ç•Œ

3. å‡çº§ç¡¬ä»¶ï¼ˆç‰¹åˆ«æ˜¯ç£ç›˜ I/Oï¼‰

### **é—®é¢˜ 3ï¼šé¢‘ç¹å´©æºƒé‡å¯**

**ç—‡çŠ¶**ï¼šæœåŠ¡å™¨ä¸æ–­å´©æºƒå’Œé‡å¯

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. ç¦ç”¨è‡ªåŠ¨é‡å¯ï¼Œæ‰‹åŠ¨æ’æŸ¥ï¼š
   ```yaml
   auto_restart:
     enabled: false
   ```

2. æ£€æŸ¥å´©æºƒæ—¥å¿—ï¼š
   ```bash
   tail -100 minecraft_server/logs/latest.log
   ```

3. å¸¸è§åŸå› ï¼š
   - å†…å­˜ä¸è¶³ï¼šå¢åŠ  `memory.max`
   - æ’ä»¶å†²çªï¼šé€ä¸ªç¦ç”¨æ’ä»¶æµ‹è¯•
   - ä¸–ç•ŒæŸåï¼šæ¢å¤å¤‡ä»½æˆ–ä¿®å¤ä¸–ç•Œ

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [é…ç½®æ–‡ä»¶è¯¦è§£](../01-å¿«é€Ÿå¼€å§‹/é…ç½®æ–‡ä»¶è¯¦è§£.md) - å®Œæ•´é…ç½®å‚æ•°è¯´æ˜
- [äº‹ä»¶ç³»ç»Ÿ](./äº‹ä»¶ç³»ç»Ÿ.md) - æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
- [æ•…éšœæ’æŸ¥](../05-é…ç½®å’Œéƒ¨ç½²/æ•…éšœæ’æŸ¥.md) - å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

---

**æœ€åæ›´æ–°**: 2025-10-05  
**NetherGate ç‰ˆæœ¬**: v0.1.0

