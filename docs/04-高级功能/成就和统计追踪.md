# 成就和统计追踪系统

NetherGate 提供了强大的成就和统计追踪系统，灵感来自 [AATool](https://github.com/DarwinBaker/AATool)，能够实时追踪玩家的成就进度和游戏统计数据。

## 功能概述

- ✅ **实时成就追踪** - 监控玩家的成就完成情况
- ✅ **统计数据分析** - 追踪游戏时间、移动距离、方块破坏等
- ✅ **方块收集进度** - 追踪 All Blocks 挑战进度
- ✅ **事件通知** - 成就完成和统计更新的实时事件
- ✅ **优化的文件读取** - 使用安全的文件访问，不锁定 Minecraft 文件

## 成就追踪

### 基本用法

```csharp
// 获取玩家的成就数据
var advancements = await context.AdvancementTracker.GetPlayerAdvancementsAsync(playerUuid);

if (advancements != null)
{
    context.Logger.Info($"玩家进度: {advancements.CompletedCount}/{advancements.TotalAdvancements}");
    context.Logger.Info($"完成度: {advancements.ProgressPercentage:F2}%");
}
```

### 检查特定成就

```csharp
// 检查玩家是否完成了特定成就
bool hasKilledDragon = await context.AdvancementTracker.HasCompletedAdvancementAsync(
    playerUuid, 
    "minecraft:end/kill_dragon"
);

if (hasKilledDragon)
{
    await context.GameDisplay.SendChatMessageAsync("@a", "§6玩家已击败末影龙！");
}
```

### 分类进度

```csharp
// 获取特定类别的成就进度
var netherProgress = await context.AdvancementTracker.GetAdvancementProgressAsync(
    playerUuid, 
    "nether"  // story, nether, end, adventure, husbandry
);

context.Logger.Info($"下界成就进度: {netherProgress:F2}%");
```

### 监听成就完成事件

```csharp
public void OnEnable(IPluginContext context)
{
    // 订阅成就完成事件
    context.AdvancementTracker.AdvancementCompleted += OnAdvancementCompleted;
    
    // 启动追踪
    await context.AdvancementTracker.StartTrackingAsync();
}

private async void OnAdvancementCompleted(object? sender, AdvancementCompletedEventArgs e)
{
    context.Logger.Info($"{e.PlayerName} 完成了成就: {e.AdvancementName}");
    
    // 发送庆祝消息
    await context.GameDisplay.SendChatMessageAsync(
        "@a",
        $"§a恭喜 {e.PlayerName} 完成了成就 §6{e.AdvancementName}§a！"
    );
    
    // 释放烟花
    var playerData = await context.PlayerDataReader.ReadPlayerDataAsync(e.PlayerUuid);
    if (playerData != null)
    {
        await context.GameUtilities.LaunchFireworkAsync(
            playerData.Position,
            FireworkType.LargeBall,
            colors: new[] { FireworkColor.Gold, FireworkColor.Yellow }
        );
    }
}
```

### 获取所有玩家的成就

```csharp
// 获取所有在线玩家的成就数据
var allAdvancements = await context.AdvancementTracker.GetAllPlayerAdvancementsAsync();

foreach (var (uuid, data) in allAdvancements)
{
    context.Logger.Info($"{data.PlayerName}: {data.ProgressPercentage:F2}%");
}
```

## 统计数据追踪

### 基本统计

```csharp
// 获取玩家统计数据
var stats = await context.StatisticsTracker.GetPlayerStatisticsAsync(playerUuid);

if (stats != null)
{
    // 游戏时间
    context.Logger.Info($"游戏时间: {stats.PlayTimeSpan.TotalHours:F1} 小时");
    
    // 总击杀数
    context.Logger.Info($"总击杀数: {stats.TotalKills}");
    
    // 总死亡次数
    context.Logger.Info($"总死亡次数: {stats.TotalDeaths}");
}
```

### 移动距离统计

```csharp
var stats = await context.StatisticsTracker.GetPlayerStatisticsAsync(playerUuid);

if (stats != null)
{
    foreach (var (method, distance) in stats.TravelDistances)
    {
        var km = distance / 100000.0;  // 厘米转千米
        context.Logger.Info($"{method}: {km:F2} km");
    }
}
```

### 方块和物品统计

```csharp
// 获取破坏的方块统计
var minedStone = stats.MinedBlocks.GetValueOrDefault("minecraft:stone", 0);
context.Logger.Info($"破坏的石头: {minedStone}");

// 获取使用的物品统计
var usedPickaxe = stats.UsedItems.GetValueOrDefault("minecraft:diamond_pickaxe", 0);
context.Logger.Info($"使用钻石镐次数: {usedPickaxe}");

// 获取击杀的生物统计
var killedZombies = stats.KilledMobs.GetValueOrDefault("minecraft:zombie", 0);
context.Logger.Info($"击杀僵尸数: {killedZombies}");
```

### 方块收集进度（All Blocks）

```csharp
// 获取方块收集进度
var blockProgress = await context.StatisticsTracker.GetBlockProgressAsync(playerUuid);

context.Logger.Info($"方块收集进度: {blockProgress.CollectedCount}/{blockProgress.TotalBlocks}");
context.Logger.Info($"完成度: {blockProgress.ProgressPercentage:F2}%");

// 列出缺失的方块
context.Logger.Info("缺失的方块:");
foreach (var block in blockProgress.MissingBlocks.Take(10))
{
    context.Logger.Info($"  - {block}");
}
```

### 监听统计更新事件

```csharp
public void OnEnable(IPluginContext context)
{
    context.StatisticsTracker.StatisticsUpdated += OnStatisticsUpdated;
    await context.StatisticsTracker.StartTrackingAsync();
}

private void OnStatisticsUpdated(object? sender, StatisticsUpdatedEventArgs e)
{
    context.Logger.Info($"{e.PlayerName} 的统计数据已更新");
    
    foreach (var stat in e.UpdatedStatistics)
    {
        context.Logger.Info($"  - {stat}");
    }
}
```

## 实战示例

### 示例 1: 成就挑战系统

```csharp
public class AchievementChallengePlugin : IPlugin
{
    private IPluginContext _context;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 订阅成就完成事件
        context.AdvancementTracker.AdvancementCompleted += OnAdvancementCompleted;
        
        // 启动追踪
        await context.AdvancementTracker.StartTrackingAsync();
    }

    private async void OnAdvancementCompleted(object? sender, AdvancementCompletedEventArgs e)
    {
        // 检查是否完成了所有成就
        var data = await _context.AdvancementTracker.GetPlayerAdvancementsAsync(e.PlayerUuid);
        
        if (data != null && data.ProgressPercentage >= 100)
        {
            // 全成就达成！
            await _context.GameDisplay.SendTitleAsync(
                "@a",
                "§6§l恭喜！",
                $"§e{e.PlayerName} 完成了所有成就！"
            );
            
            // 给予奖励
            await _context.CommandExecutor.ExecuteCommandAsync(
                $"give {e.PlayerName} minecraft:nether_star 1"
            );
        }
    }

    public void OnDisable()
    {
        _context.AdvancementTracker.StopTrackingAsync().Wait();
    }
}
```

### 示例 2: 统计排行榜

```csharp
public class StatisticsLeaderboardPlugin : IPlugin
{
    private IPluginContext _context;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // 创建排行榜
        await CreateLeaderboards();
        
        // 订阅统计更新事件
        context.StatisticsTracker.StatisticsUpdated += OnStatisticsUpdated;
        await context.StatisticsTracker.StartTrackingAsync();
    }

    private async Task CreateLeaderboards()
    {
        // 创建游戏时间排行榜
        await _context.LeaderboardSystem.CreateLeaderboardAsync(
            "playtime",
            LeaderboardType.HighestScore,
            "游戏时间排行"
        );
        
        // 创建击杀数排行榜
        await _context.LeaderboardSystem.CreateLeaderboardAsync(
            "kills",
            LeaderboardType.HighestScore,
            "击杀排行"
        );
    }

    private async void OnStatisticsUpdated(object? sender, StatisticsUpdatedEventArgs e)
    {
        var stats = await _context.StatisticsTracker.GetPlayerStatisticsAsync(e.PlayerUuid);
        
        if (stats != null)
        {
            // 更新游戏时间排行榜
            await _context.LeaderboardSystem.UpdateScoreAsync(
                "playtime",
                e.PlayerUuid,
                stats.PlayTime,
                e.PlayerName
            );
            
            // 更新击杀数排行榜
            await _context.LeaderboardSystem.UpdateScoreAsync(
                "kills",
                e.PlayerUuid,
                stats.TotalKills,
                e.PlayerName
            );
        }
    }
}
```

### 示例 3: 速通追踪器

```csharp
public class SpeedrunTrackerPlugin : IPlugin
{
    private IPluginContext _context;
    private readonly Dictionary<string, DateTime> _runStarts = new();

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        context.AdvancementTracker.AdvancementCompleted += OnAdvancementCompleted;
        await context.AdvancementTracker.StartTrackingAsync();
    }

    private async void OnAdvancementCompleted(object? sender, AdvancementCompletedEventArgs e)
    {
        // 检查是否完成了所有成就（All Advancements）
        var data = await _context.AdvancementTracker.GetPlayerAdvancementsAsync(e.PlayerUuid);
        
        if (data != null && data.ProgressPercentage >= 100)
        {
            if (_runStarts.TryGetValue(e.PlayerUuid, out var startTime))
            {
                var duration = DateTime.UtcNow - startTime;
                
                await _context.GameDisplay.SendTitleAsync(
                    e.PlayerName,
                    "§6§l完成！",
                    $"§e用时: {duration:hh\\:mm\\:ss}"
                );
                
                // 更新速通排行榜
                await _context.LeaderboardSystem.UpdateScoreAsync(
                    "all_advancements_speedrun",
                    e.PlayerUuid,
                    duration.TotalSeconds,
                    e.PlayerName
                );
                
                _runStarts.Remove(e.PlayerUuid);
            }
        }
    }
}
```

## 性能优化

### 文件访问优化

NetherGate 使用了 AATool 的最佳实践进行文件读取：

```csharp
// 使用安全文件读取器（已内置）
var data = await SafeFileReader.ReadJsonAsync<AdvancementData>(filePath);

// 特点：
// - FileAccess.Read 只读权限
// - FileShare.ReadWrite | FileShare.Delete 允许 Minecraft 同时访问
// - 异步读取，不阻塞主线程
```

### 缓存机制

追踪器自动缓存玩家数据，减少文件读取次数：

```csharp
// 数据会自动缓存，重复获取不会重新读取文件
var data1 = await context.AdvancementTracker.GetPlayerAdvancementsAsync(uuid);
var data2 = await context.AdvancementTracker.GetPlayerAdvancementsAsync(uuid); // 从缓存获取
```

## 最佳实践

1. **启动追踪** - 在插件启用时调用 `StartTrackingAsync()`
2. **停止追踪** - 在插件禁用时调用 `StopTrackingAsync()`
3. **使用事件** - 订阅事件而不是轮询，提高性能
4. **批量处理** - 使用 `GetAll*Async()` 方法批量获取数据
5. **错误处理** - 妥善处理文件不存在或损坏的情况

## 相关 API

- [排行榜系统](排行榜系统.md)
- [WebSocket 数据推送](WebSocket数据推送.md)
- [文件系统](文件系统.md)
- [事件系统](../02-核心功能/事件系统.md)

## 致谢

成就和统计追踪系统的设计灵感来自 [CTM's AATool](https://github.com/DarwinBaker/AATool)，一个优秀的 Minecraft 成就追踪工具。

