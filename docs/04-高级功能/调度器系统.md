# è°ƒåº¦å™¨ç³»ç»Ÿ

NetherGate æä¾›äº†å¼ºå¤§çš„è°ƒåº¦å™¨ç³»ç»Ÿï¼Œç”¨äºæ‰§è¡Œå»¶è¿Ÿä»»åŠ¡å’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚è¯¥åŠŸèƒ½å— [MCDReforged](https://github.com/Fallen-Breath/MCDReforged) è°ƒåº¦å™¨å¯å‘ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **åŸºæœ¬ç”¨æ³•**

```csharp
using NetherGate.API.Scheduling;

public class MyPlugin : IPlugin
{
    private IScheduler _scheduler;
    
    public void OnEnable(IPluginContext context)
    {
        _scheduler = context.Scheduler;
        
        // å»¶è¿Ÿæ‰§è¡Œï¼ˆ5ç§’åï¼‰
        _scheduler.ScheduleDelayed(() =>
        {
            context.Logger.Info("5ç§’åæ‰§è¡Œ");
        }, TimeSpan.FromSeconds(5));
        
        // å‘¨æœŸæ€§æ‰§è¡Œï¼ˆæ¯10ç§’ï¼‰
        _scheduler.ScheduleRepeating(() =>
        {
            context.Logger.Info("æ¯10ç§’æ‰§è¡Œä¸€æ¬¡");
        }, TimeSpan.FromSeconds(10));
    }
}
```

---

## ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**

### **1. ä»»åŠ¡ç±»å‹**

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| **å»¶è¿Ÿä»»åŠ¡** | å»¶è¿ŸæŒ‡å®šæ—¶é—´åæ‰§è¡Œä¸€æ¬¡ | å»¶è¿Ÿé€šçŸ¥ã€å®šæ—¶æ“ä½œ |
| **å‘¨æœŸä»»åŠ¡** | æŒ‰å›ºå®šé—´éš”é‡å¤æ‰§è¡Œ | è‡ªåŠ¨ä¿å­˜ã€æ•°æ®åŒæ­¥ |
| **å¼‚æ­¥ä»»åŠ¡** | æ”¯æŒ async/await | ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œ |

### **2. æ—¶é—´å•ä½**

```csharp
// ä½¿ç”¨ TimeSpan
TimeSpan.FromSeconds(30)    // 30 ç§’
TimeSpan.FromMinutes(5)     // 5 åˆ†é’Ÿ
TimeSpan.FromHours(1)       // 1 å°æ—¶
TimeSpan.FromDays(1)        // 1 å¤©

// ç»„åˆæ—¶é—´
TimeSpan.FromMinutes(5) + TimeSpan.FromSeconds(30)  // 5åˆ†30ç§’
```

---

## ğŸ“– **API å‚è€ƒ**

### **IScheduler æ¥å£**

```csharp
public interface IScheduler
{
    /// <summary>
    /// å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡
    /// </summary>
    void ScheduleDelayed(Action task, TimeSpan delay);
    
    /// <summary>
    /// å»¶è¿Ÿæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
    /// </summary>
    void ScheduleDelayed(Func<Task> task, TimeSpan delay);
    
    /// <summary>
    /// å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡
    /// </summary>
    /// <returns>ä»»åŠ¡IDï¼Œå¯ç”¨äºå–æ¶ˆ</returns>
    string ScheduleRepeating(Action task, TimeSpan interval);
    
    /// <summary>
    /// å‘¨æœŸæ€§æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
    /// </summary>
    string ScheduleRepeating(Func<Task> task, TimeSpan interval);
    
    /// <summary>
    /// å–æ¶ˆä»»åŠ¡
    /// </summary>
    void CancelTask(string taskId);
    
    /// <summary>
    /// å–æ¶ˆæ‰€æœ‰ä»»åŠ¡
    /// </summary>
    void CancelAllTasks();
}
```

---

## ğŸ“ **ä½¿ç”¨ç¤ºä¾‹**

### **1. å»¶è¿Ÿä»»åŠ¡**

```csharp
// å»¶è¿Ÿ3ç§’å‘é€æ¶ˆæ¯
_scheduler.ScheduleDelayed(() =>
{
    context.GameDisplay.BroadcastMessage("Â§aæœåŠ¡å™¨å°†åœ¨10ç§’åé‡å¯ï¼");
}, TimeSpan.FromSeconds(3));

// å»¶è¿Ÿ10ç§’æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
_scheduler.ScheduleDelayed(async () =>
{
    await SaveWorldAsync();
    context.Logger.Info("ä¸–ç•Œå·²ä¿å­˜");
}, TimeSpan.FromSeconds(10));
```

### **2. å‘¨æœŸæ€§ä»»åŠ¡**

```csharp
// æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
var taskId = _scheduler.ScheduleRepeating(async () =>
{
    await SaveWorldAsync();
    context.Logger.Info("è‡ªåŠ¨ä¿å­˜å®Œæˆ");
}, TimeSpan.FromMinutes(5));

// ç¨åå–æ¶ˆä»»åŠ¡
_scheduler.CancelTask(taskId);
```

### **3. å€’è®¡æ—¶ç³»ç»Ÿ**

```csharp
public class CountdownCommand : ICommand
{
    private readonly IScheduler _scheduler;
    private readonly IGameDisplayApi _gameDisplay;
    
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var seconds = int.Parse(args[0]);
        
        // å€’è®¡æ—¶
        for (int i = seconds; i > 0; i--)
        {
            var current = i;
            _scheduler.ScheduleDelayed(() =>
            {
                _gameDisplay.BroadcastMessage($"Â§c{current}...");
            }, TimeSpan.FromSeconds(seconds - current));
        }
        
        // æœ€åçš„æ¶ˆæ¯
        _scheduler.ScheduleDelayed(() =>
        {
            _gameDisplay.BroadcastMessage("Â§aæ—¶é—´åˆ°ï¼");
        }, TimeSpan.FromSeconds(seconds));
        
        return CommandResult.Ok($"å¼€å§‹ {seconds} ç§’å€’è®¡æ—¶");
    }
}
```

### **4. è‡ªåŠ¨å¤‡ä»½ç³»ç»Ÿ**

```csharp
public class AutoBackupPlugin : IPlugin
{
    private IScheduler _scheduler;
    private string _backupTaskId;
    
    public void OnEnable(IPluginContext context)
    {
        _scheduler = context.Scheduler;
        
        // æ¯6å°æ—¶è‡ªåŠ¨å¤‡ä»½
        _backupTaskId = _scheduler.ScheduleRepeating(async () =>
        {
            context.Logger.Info("å¼€å§‹è‡ªåŠ¨å¤‡ä»½...");
            
            var backupName = $"auto_backup_{DateTime.Now:yyyyMMdd_HHmmss}";
            await CreateBackupAsync(backupName);
            
            context.Logger.Info($"è‡ªåŠ¨å¤‡ä»½å®Œæˆ: {backupName}");
            
            // æ¸…ç†7å¤©å‰çš„å¤‡ä»½
            await CleanOldBackupsAsync(TimeSpan.FromDays(7));
            
        }, TimeSpan.FromHours(6));
    }
    
    public void OnDisable()
    {
        // æ’ä»¶å¸è½½æ—¶å–æ¶ˆä»»åŠ¡
        _scheduler.CancelTask(_backupTaskId);
    }
}
```

### **5. å®šæ—¶å…¬å‘Šç³»ç»Ÿ**

```csharp
public class AnnouncementPlugin : IPlugin
{
    private readonly string[] _announcements = new[]
    {
        "Â§6æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼",
        "Â§bè®°å¾—é˜…è¯»æœåŠ¡å™¨è§„åˆ™",
        "Â§aä½¿ç”¨ #help æŸ¥çœ‹å‘½ä»¤å¸®åŠ©",
        "Â§eå‘ç°bugè¯·æŠ¥å‘Šç»™ç®¡ç†å‘˜"
    };
    
    public void OnEnable(IPluginContext context)
    {
        var index = 0;
        
        // æ¯5åˆ†é’Ÿå‘é€ä¸€æ¡å…¬å‘Š
        context.Scheduler.ScheduleRepeating(() =>
        {
            var message = _announcements[index];
            context.GameDisplay.BroadcastMessage(message);
            
            index = (index + 1) % _announcements.Length;
        }, TimeSpan.FromMinutes(5));
    }
}
```

### **6. ç©å®¶AFKæ£€æµ‹**

```csharp
public class AfkDetectionPlugin : IPlugin
{
    private readonly Dictionary<string, DateTime> _lastActivity = new();
    private readonly TimeSpan _afkThreshold = TimeSpan.FromMinutes(5);
    
    public void OnEnable(IPluginContext context)
    {
        // ç›‘å¬ç©å®¶æ´»åŠ¨
        context.EventBus.Subscribe<PlayerChatEvent>(e =>
        {
            _lastActivity[e.PlayerName] = DateTime.UtcNow;
        });
        
        // æ¯30ç§’æ£€æŸ¥AFKçŠ¶æ€
        context.Scheduler.ScheduleRepeating(async () =>
        {
            var players = await context.SmpApi.GetPlayersAsync();
            
            foreach (var player in players)
            {
                if (_lastActivity.TryGetValue(player.Name, out var lastTime))
                {
                    var inactive = DateTime.UtcNow - lastTime;
                    
                    if (inactive > _afkThreshold)
                    {
                        await context.GameDisplay.ShowActionBarAsync(
                            player.Name,
                            $"Â§7[AFK] ç¦»å¼€ {inactive.TotalMinutes:F0} åˆ†é’Ÿ"
                        );
                    }
                }
            }
        }, TimeSpan.FromSeconds(30));
    }
}
```

### **7. æœåŠ¡å™¨é‡å¯è°ƒåº¦**

```csharp
public class RestartScheduler : IPlugin
{
    public void OnEnable(IPluginContext context)
    {
        // è®¾ç½®åœ¨å‡Œæ™¨4ç‚¹é‡å¯
        var now = DateTime.Now;
        var nextRestart = new DateTime(now.Year, now.Month, now.Day, 4, 0, 0);
        
        if (nextRestart < now)
        {
            nextRestart = nextRestart.AddDays(1);
        }
        
        var delay = nextRestart - now;
        
        context.Scheduler.ScheduleDelayed(async () =>
        {
            // æå‰10åˆ†é’Ÿé€šçŸ¥
            await context.GameDisplay.BroadcastMessageAsync("Â§cæœåŠ¡å™¨å°†åœ¨10åˆ†é’Ÿåé‡å¯ï¼");
            
            context.Scheduler.ScheduleDelayed(async () =>
            {
                // æå‰5åˆ†é’Ÿé€šçŸ¥
                await context.GameDisplay.BroadcastMessageAsync("Â§cæœåŠ¡å™¨å°†åœ¨5åˆ†é’Ÿåé‡å¯ï¼");
                
                context.Scheduler.ScheduleDelayed(async () =>
                {
                    // æå‰1åˆ†é’Ÿé€šçŸ¥
                    await context.GameDisplay.BroadcastMessageAsync("Â§cæœåŠ¡å™¨å°†åœ¨1åˆ†é’Ÿåé‡å¯ï¼");
                    
                    context.Scheduler.ScheduleDelayed(async () =>
                    {
                        // æ‰§è¡Œé‡å¯
                        await context.RconClient.ExecuteCommandAsync("stop");
                    }, TimeSpan.FromMinutes(1));
                    
                }, TimeSpan.FromMinutes(4));
                
            }, TimeSpan.FromMinutes(5));
            
        }, delay);
        
        context.Logger.Info($"å·²å®‰æ’ä¸‹æ¬¡é‡å¯æ—¶é—´: {nextRestart}");
    }
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**

âœ… **æ¨èï¼š** ä¿å­˜ä»»åŠ¡IDå¹¶åœ¨é€‚å½“æ—¶æœºå–æ¶ˆ
```csharp
public class MyPlugin : IPlugin
{
    private readonly List<string> _taskIds = new();
    
    public void OnEnable(IPluginContext context)
    {
        var taskId = context.Scheduler.ScheduleRepeating(...);
        _taskIds.Add(taskId);
    }
    
    public void OnDisable()
    {
        // æ¸…ç†æ‰€æœ‰ä»»åŠ¡
        foreach (var id in _taskIds)
        {
            context.Scheduler.CancelTask(id);
        }
    }
}
```

### **2. å¼‚å¸¸å¤„ç†**

âœ… **æ¨èï¼š** åœ¨ä»»åŠ¡ä¸­å¤„ç†å¼‚å¸¸
```csharp
_scheduler.ScheduleRepeating(async () =>
{
    try
    {
        await DoSomethingAsync();
    }
    catch (Exception ex)
    {
        _logger.Error("å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥", ex);
    }
}, TimeSpan.FromMinutes(5));
```

### **3. é¿å…é˜»å¡**

âœ… **æ¨èï¼š** ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡å¤„ç†è€—æ—¶æ“ä½œ
```csharp
// å¥½çš„åšæ³•
_scheduler.ScheduleRepeating(async () =>
{
    await LongRunningOperationAsync();  // ä¸ä¼šé˜»å¡
}, interval);
```

âŒ **ä¸æ¨èï¼š** åœ¨åŒæ­¥ä»»åŠ¡ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
```csharp
_scheduler.ScheduleRepeating(() =>
{
    Thread.Sleep(5000);  // ä¼šé˜»å¡è°ƒåº¦å™¨ï¼
}, interval);
```

### **4. åˆç†è®¾ç½®é—´éš”æ—¶é—´**

âœ… **æ¨èï¼š** æ ¹æ®å®é™…éœ€æ±‚è®¾ç½®é—´éš”
```csharp
// è‡ªåŠ¨ä¿å­˜ - 5-10åˆ†é’Ÿ
_scheduler.ScheduleRepeating(SaveAsync, TimeSpan.FromMinutes(5));

// çŠ¶æ€æ£€æŸ¥ - 30ç§’-1åˆ†é’Ÿ
_scheduler.ScheduleRepeating(CheckStatusAsync, TimeSpan.FromSeconds(30));

// å…¬å‘Š - 3-5åˆ†é’Ÿ
_scheduler.ScheduleRepeating(SendAnnouncementAsync, TimeSpan.FromMinutes(3));
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [å‘½ä»¤ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/å‘½ä»¤ç³»ç»Ÿ.md) - ç»“åˆå‘½ä»¤ä½¿ç”¨è°ƒåº¦å™¨
- [äº‹ä»¶ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/äº‹ä»¶ç³»ç»Ÿ.md) - äº‹ä»¶è§¦å‘çš„ä»»åŠ¡è°ƒåº¦
- [å›½é™…åŒ– (i18n)](./å›½é™…åŒ–.md) - å¤šè¯­è¨€å…¬å‘Š

---

## ğŸ™ **è‡´è°¢**

è°ƒåº¦å™¨ç³»ç»Ÿçš„è®¾è®¡å— [MCDReforged](https://github.com/Fallen-Breath/MCDReforged) å¯å‘ã€‚

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-01-08  
**å‚è€ƒé¡¹ç›®ï¼š** [MCDReforged](https://github.com/Fallen-Breath/MCDReforged) (GPL-3.0)

