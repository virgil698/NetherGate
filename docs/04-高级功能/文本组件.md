# 文本组件

NetherGate 提供了强大的文本组件系统，让你可以创建富文本消息，支持颜色、格式、点击和悬停事件等高级功能。

---

## 📋 **目录**

- [快速开始](#快速开始)
- [基本样式](#基本样式)
- [交互事件](#交互事件)
- [组合文本](#组合文本)
- [实战示例](#实战示例)
- [最佳实践](#最佳实践)

---

## 🚀 **快速开始**

### **创建简单文本**

```csharp
using NetherGate.API.GameDisplay;

// 创建彩色文本
var text = new TextComponent("欢迎来到服务器！")
    .SetColor(TextColor.Gold)
    .SetBold(true);

await _gameDisplay.SendTextComponentAsync(playerName, text);
```

### **发送到玩家**

```csharp
// 发送到特定玩家
await _gameDisplay.SendTextComponentAsync("Steve", text);

// 广播给所有玩家
await _gameDisplay.BroadcastTextComponentAsync(text);
```

---

## 🎨 **基本样式**

### **颜色**

```csharp
public enum TextColor
{
    Black,       // §0
    DarkBlue,    // §1
    DarkGreen,   // §2
    DarkAqua,    // §3
    DarkRed,     // §4
    DarkPurple,  // §5
    Gold,        // §6
    Gray,        // §7
    DarkGray,    // §8
    Blue,        // §9
    Green,       // §a
    Aqua,        // §b
    Red,         // §c
    LightPurple, // §d
    Yellow,      // §e
    White        // §f
}
```

**使用示例：**
```csharp
var redText = new TextComponent("警告！").SetColor(TextColor.Red);
var goldText = new TextComponent("提示：").SetColor(TextColor.Gold);
```

### **格式**

```csharp
var formatted = new TextComponent("格式化文本")
    .SetBold(true)           // §l 粗体
    .SetItalic(true)         // §o 斜体
    .SetUnderlined(true)     // §n 下划线
    .SetStrikethrough(true)  // §m 删除线
    .SetObfuscated(true);    // §k 混淆（动态随机字符）
```

### **重置格式**

```csharp
var text = new TextComponent("正常文本")
    .SetBold(true)
    .Append(" 继续粗体 ")
    .Append(new TextComponent("普通文本").SetReset(true));
    // 使用 SetReset() 清除所有格式
```

---

## 🖱️ **交互事件**

### **点击事件**

```csharp
public enum ClickAction
{
    RunCommand,      // 执行命令
    SuggestCommand,  // 建议命令（填充到聊天框）
    OpenUrl,         // 打开URL
    CopyToClipboard  // 复制到剪贴板
}
```

**使用示例：**

```csharp
// 点击执行命令
var clickText = new TextComponent("[点击领取奖励]")
    .SetColor(TextColor.Green)
    .SetClickEvent(new ClickEvent(
        ClickAction.RunCommand,
        "/give @s diamond 64"
    ));

// 点击打开网站
var urlText = new TextComponent("访问官网")
    .SetColor(TextColor.Blue)
    .SetUnderlined(true)
    .SetClickEvent(new ClickEvent(
        ClickAction.OpenUrl,
        "https://example.com"
    ));

// 点击建议命令
var suggestText = new TextComponent("[传送]")
    .SetColor(TextColor.Yellow)
    .SetClickEvent(new ClickEvent(
        ClickAction.SuggestCommand,
        "/tp @s "
    ));
```

### **悬停事件**

```csharp
public enum HoverAction
{
    ShowText,   // 显示文本
    ShowItem,   // 显示物品
    ShowEntity  // 显示实体
}
```

**使用示例：**

```csharp
// 悬停显示说明
var hoverText = new TextComponent("神秘箱子")
    .SetColor(TextColor.Gold)
    .SetHoverEvent(new HoverEvent(
        HoverAction.ShowText,
        "点击打开箱子\n可能包含：\n- 钻石 x64\n- 金锭 x32"
    ));

// 悬停显示物品
var itemText = new TextComponent("[钻石剑]")
    .SetColor(TextColor.Aqua)
    .SetHoverEvent(new HoverEvent(
        HoverAction.ShowItem,
        "{id:\"minecraft:diamond_sword\",Count:1}"
    ));
```

### **组合点击和悬停**

```csharp
var interactive = new TextComponent("[商店]")
    .SetColor(TextColor.Gold)
    .SetBold(true)
    .SetClickEvent(new ClickEvent(
        ClickAction.RunCommand,
        "/shop open"
    ))
    .SetHoverEvent(new HoverEvent(
        HoverAction.ShowText,
        "§6点击打开商店\n§7购买各种道具"
    ));
```

---

## 🔗 **组合文本**

### **追加文本**

```csharp
var message = new TextComponent("欢迎 ")
    .SetColor(TextColor.Yellow)
    .Append(new TextComponent("Steve").SetColor(TextColor.Gold).SetBold(true))
    .Append(new TextComponent(" 加入服务器！").SetColor(TextColor.Yellow));
// 结果: "欢迎 Steve 加入服务器！" (Steve 是粗体金色)
```

### **添加额外文本**

```csharp
var complex = new TextComponent("系统")
    .SetColor(TextColor.DarkGray)
    .AddExtra(new TextComponent(" > ").SetColor(TextColor.Gray))
    .AddExtra(new TextComponent("消息内容").SetColor(TextColor.White));
```

### **换行**

```csharp
var multiLine = new TextComponent("第一行")
    .Append("\n")
    .Append(new TextComponent("第二行"))
    .Append("\n")
    .Append(new TextComponent("第三行"));
```

---

## 💼 **实战示例**

### **示例1：交互式菜单**

```csharp
public class MenuCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var menu = new TextComponent("=== 主菜单 ===\n")
            .SetColor(TextColor.Gold)
            .SetBold(true)
            .Append(new TextComponent("\n"))
            
            // 传送选项
            .Append(new TextComponent("⚡ ")
                .SetColor(TextColor.Yellow))
            .Append(new TextComponent("[传送]")
                .SetColor(TextColor.Green)
                .SetClickEvent(new ClickEvent(
                    ClickAction.RunCommand,
                    "/teleport menu"
                ))
                .SetHoverEvent(new HoverEvent(
                    HoverAction.ShowText,
                    "§a打开传送菜单"
                )))
            .Append(new TextComponent(" | "))
            
            // 商店选项
            .Append(new TextComponent("🛒 ")
                .SetColor(TextColor.Yellow))
            .Append(new TextComponent("[商店]")
                .SetColor(TextColor.Green)
                .SetClickEvent(new ClickEvent(
                    ClickAction.RunCommand,
                    "/shop"
                ))
                .SetHoverEvent(new HoverEvent(
                    HoverAction.ShowText,
                    "§a打开商店"
                )))
            .Append(new TextComponent(" | "))
            
            // 帮助选项
            .Append(new TextComponent("❓ ")
                .SetColor(TextColor.Yellow))
            .Append(new TextComponent("[帮助]")
                .SetColor(TextColor.Green)
                .SetClickEvent(new ClickEvent(
                    ClickAction.RunCommand,
                    "/help"
                ))
                .SetHoverEvent(new HoverEvent(
                    HoverAction.ShowText,
                    "§a查看帮助文档"
                )));
        
        await _gameDisplay.SendTextComponentAsync(sender.Name, menu);
        return CommandResult.Ok();
    }
}
```

### **示例2：玩家信息卡片**

```csharp
public async Task ShowPlayerCardAsync(string targetPlayer, string viewer)
{
    var stats = await GetPlayerStatsAsync(targetPlayer);
    
    var card = new TextComponent($"=== {targetPlayer} 的信息 ===\n")
        .SetColor(TextColor.Gold)
        .SetBold(true)
        .Append(new TextComponent("\n"))
        
        // 等级
        .Append(new TextComponent("⭐ 等级: ")
            .SetColor(TextColor.Yellow))
        .Append(new TextComponent($"{stats.Level}\n")
            .SetColor(TextColor.White))
        
        // 游戏时间
        .Append(new TextComponent("⏰ 游戏时间: ")
            .SetColor(TextColor.Yellow))
        .Append(new TextComponent($"{stats.PlayTime} 小时\n")
            .SetColor(TextColor.White))
        
        // 操作按钮
        .Append(new TextComponent("\n"))
        .Append(new TextComponent("[添加好友]")
            .SetColor(TextColor.Green)
            .SetClickEvent(new ClickEvent(
                ClickAction.RunCommand,
                $"/friend add {targetPlayer}"
            ))
            .SetHoverEvent(new HoverEvent(
                HoverAction.ShowText,
                $"§a添加 {targetPlayer} 为好友"
            )))
        .Append(new TextComponent(" "))
        .Append(new TextComponent("[传送请求]")
            .SetColor(TextColor.Aqua)
            .SetClickEvent(new ClickEvent(
                ClickAction.RunCommand,
                $"/tpa {targetPlayer}"
            ))
            .SetHoverEvent(new HoverEvent(
                HoverAction.ShowText,
                $"§b请求传送到 {targetPlayer}"
            )));
    
    await _gameDisplay.SendTextComponentAsync(viewer, card);
}
```

### **示例3：任务系统**

```csharp
public async Task ShowQuestListAsync(string playerName)
{
    var quests = await GetPlayerQuestsAsync(playerName);
    
    var questList = new TextComponent("=== 可用任务 ===\n")
        .SetColor(TextColor.Gold)
        .SetBold(true);
    
    foreach (var quest in quests)
    {
        var status = quest.IsCompleted 
            ? new TextComponent("✓ ").SetColor(TextColor.Green)
            : new TextComponent("○ ").SetColor(TextColor.Gray);
        
        var questLine = status
            .Append(new TextComponent(quest.Name)
                .SetColor(quest.IsCompleted ? TextColor.Gray : TextColor.Yellow)
                .SetStrikethrough(quest.IsCompleted)
                .SetClickEvent(new ClickEvent(
                    ClickAction.RunCommand,
                    $"/quest info {quest.Id}"
                ))
                .SetHoverEvent(new HoverEvent(
                    HoverAction.ShowText,
                    $"§e{quest.Description}\n\n" +
                    $"§7奖励: §6{quest.Reward}\n" +
                    $"§7进度: §a{quest.Progress}§7/§a{quest.Required}\n\n" +
                    $"§8点击查看详情"
                )))
            .Append(new TextComponent("\n"));
        
        questList.Append(questLine);
    }
    
    await _gameDisplay.SendTextComponentAsync(playerName, questList);
}
```

### **示例4：聊天过滤器**

```csharp
public class ChatFormatterPlugin : IPlugin
{
    public void OnEnable(IPluginContext context)
    {
        context.EventBus.Subscribe<PlayerChatEvent>(async e =>
        {
            // 取消原始消息
            e.Cancel = true;
            
            // 创建格式化消息
            var formatted = new TextComponent("[")
                .SetColor(TextColor.Gray)
                .Append(new TextComponent(GetPlayerRank(e.PlayerName))
                    .SetColor(GetRankColor(e.PlayerName))
                    .SetBold(true))
                .Append(new TextComponent("] ")
                    .SetColor(TextColor.Gray))
                .Append(new TextComponent(e.PlayerName)
                    .SetColor(TextColor.White)
                    .SetClickEvent(new ClickEvent(
                        ClickAction.SuggestCommand,
                        $"/msg {e.PlayerName} "
                    ))
                    .SetHoverEvent(new HoverEvent(
                        HoverAction.ShowText,
                        $"§7点击私聊 §f{e.PlayerName}"
                    )))
                .Append(new TextComponent(": ")
                    .SetColor(TextColor.Gray))
                .Append(new TextComponent(e.Message)
                    .SetColor(TextColor.White));
            
            // 广播格式化消息
            await context.GameDisplay.BroadcastTextComponentAsync(formatted);
        });
    }
}
```

### **示例5：公告系统**

```csharp
public class AnnouncementCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var message = string.Join(" ", args);
        
        var announcement = new TextComponent("━━━━━━━━━━━━━━━━━━━━━━━\n")
            .SetColor(TextColor.Gold)
            .SetBold(true)
            .Append(new TextComponent("📢 ")
                .SetColor(TextColor.Yellow))
            .Append(new TextComponent("服务器公告")
                .SetColor(TextColor.Gold)
                .SetBold(true))
            .Append(new TextComponent("\n\n"))
            .Append(new TextComponent(message)
                .SetColor(TextColor.White))
            .Append(new TextComponent("\n\n"))
            .Append(new TextComponent("━━━━━━━━━━━━━━━━━━━━━━━")
                .SetColor(TextColor.Gold)
                .SetBold(true));
        
        await _gameDisplay.BroadcastTextComponentAsync(announcement);
        
        // 播放提示音
        await _musicPlayer.PlayWarningSoundAsync("@a");
        
        return CommandResult.Ok("公告已发布");
    }
}
```

---

## 💡 **最佳实践**

### **1. 保持可读性**

✅ **推荐：** 使用链式调用和缩进
```csharp
var text = new TextComponent("标题")
    .SetColor(TextColor.Gold)
    .SetBold(true)
    .Append(new TextComponent("\n"))
    .Append(new TextComponent("内容")
        .SetColor(TextColor.White));
```

### **2. 复用组件**

✅ **推荐：** 创建可复用的组件
```csharp
private TextComponent CreateButton(string label, string command, string tooltip)
{
    return new TextComponent($"[{label}]")
        .SetColor(TextColor.Green)
        .SetClickEvent(new ClickEvent(ClickAction.RunCommand, command))
        .SetHoverEvent(new HoverEvent(HoverAction.ShowText, tooltip));
}

// 使用
var menu = new TextComponent("菜单: ")
    .Append(CreateButton("传送", "/tp", "打开传送菜单"))
    .Append(" ")
    .Append(CreateButton("商店", "/shop", "打开商店"));
```

### **3. 国际化支持**

✅ **推荐：** 结合 i18n
```csharp
var text = new TextComponent(_i18n.Translate("menu.title"))
    .SetColor(TextColor.Gold)
    .Append(new TextComponent(_i18n.Translate("menu.subtitle"))
        .SetColor(TextColor.Gray));
```

### **4. 颜色一致性**

✅ **推荐：** 定义颜色常量
```csharp
private static class Colors
{
    public static readonly TextColor Title = TextColor.Gold;
    public static readonly TextColor Content = TextColor.White;
    public static readonly TextColor Button = TextColor.Green;
    public static readonly TextColor Warning = TextColor.Red;
}

var text = new TextComponent("标题").SetColor(Colors.Title);
```

---

## 🎮 **高级功能（Minecraft 1.21.9+）**

### **TextComponentBuilder**

从 Minecraft 1.21.9 开始，NetherGate 提供了 `TextComponentBuilder` 类，支持构建包含精灵图和玩家头像的富文本组件。

#### **创建构建器**

```csharp
using NetherGate.API.GameDisplay;

var builder = new TextComponentBuilder();
```

#### **添加文本**

```csharp
builder.Text("欢迎来到服务器！", color: "gold", bold: true);
builder.Text(" 查看帮助：");
```

#### **添加精灵图**

支持两种类型的精灵图：

1. **图集（Atlas）**：显示整个纹理图集
   ```csharp
   builder.Sprite("atlas", "minecraft:blocks");
   ```

2. **单个精灵（Sprite）**：显示图集中的单个纹理
   ```csharp
   // 显示钻石图标
   builder.Sprite("sprite", "item/diamond");
   
   // 显示猪排图标
   builder.Sprite("sprite", "item/porkchop");
   
   // 显示草方块图标
   builder.Sprite("sprite", "block/grass_block");
   ```

#### **添加玩家头像**

显示玩家头部模型：

```csharp
// 通过玩家名称添加头像
builder.PlayerHead("Notch", renderHat: true);

// 通过玩家档案添加头像
var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync("Notch");
if (profile != null)
{
    builder.PlayerHead(profile, renderHat: false);
}
```

**参数说明：**
- `renderHat`: 是否渲染第二层皮肤（帽子层），默认 `true`

#### **构建和发送**

```csharp
// 构建 JSON 字符串
var json = builder.Build();

// 通过 RCON 发送到游戏
await _context.RconClient!.ExecuteCommandAsync($"tellraw @a {json}");
```

---

### **完整示例 1：玩家加入欢迎消息**

```csharp
public class WelcomePlugin : IPlugin
{
    private IPluginContext _context = null!;

    public async Task OnEnableAsync(IPluginContext context)
    {
        _context = context;
        
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
    }

    private async void OnPlayerJoined(PlayerJoinedEvent e)
    {
        var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(e.Player.Name);
        
        if (profile != null)
        {
            var message = new TextComponentBuilder()
                .Text("§6✦ ", color: "gold")
                .PlayerHead(profile)  // 显示玩家头像
                .Text(" ")
                .Text($"{profile.Name}", color: "yellow", bold: true)
                .Text(" 加入了游戏！", color: "white")
                .Build();
            
            await _context.RconClient!.ExecuteCommandAsync($"tellraw @a {message}");
        }
    }
}
```

### **完整示例 2：物品展示菜单**

```csharp
public class ItemMenuCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "itemmenu";
    public string Description => "显示物品菜单";
    public string Usage => "#itemmenu";
    public List<string> Aliases => new() { "im" };
    public string PluginId => "ItemMenu";
    public string? Permission => null;

    public ItemMenuCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var menu = new TextComponentBuilder()
            .Text("§6═══════════════════════════════\n", color: "gold")
            .Text("§e§l物品商店\n\n", color: "yellow", bold: true)
            
            // 钻石
            .Sprite("sprite", "item/diamond")
            .Text(" §f钻石 - §a$100\n", color: "white")
            
            // 铁锭
            .Sprite("sprite", "item/iron_ingot")
            .Text(" §f铁锭 - §a$50\n", color: "white")
            
            // 金锭
            .Sprite("sprite", "item/gold_ingot")
            .Text(" §f金锭 - §a$75\n", color: "white")
            
            // 绿宝石
            .Sprite("sprite", "item/emerald")
            .Text(" §f绿宝石 - §a$200\n", color: "white")
            
            .Text("\n§6═══════════════════════════════", color: "gold")
            .Build();
        
        await _context.RconClient!.ExecuteCommandAsync($"tellraw {sender.Name} {menu}");
        
        return CommandResult.Ok();
    }
}
```

### **完整示例 3：在线玩家列表**

```csharp
public class OnlineListCommand : ICommand
{
    private readonly IPluginContext _context;

    public string Name => "onlinelist";
    public string Description => "显示在线玩家列表（含头像）";
    public string Usage => "#onlinelist";
    public List<string> Aliases => new() { "ol" };
    public string PluginId => "OnlineList";
    public string? Permission => null;

    public OnlineListCommand(IPluginContext context)
    {
        _context = context;
    }

    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        // 获取在线玩家（假设通过某种方式获取）
        var onlinePlayers = new[] { "Steve", "Alex", "Notch" };
        
        var builder = new TextComponentBuilder()
            .Text("§6═══════════════════════════════\n", color: "gold")
            .Text("§e§l在线玩家 ", color: "yellow", bold: true)
            .Text($"§7({onlinePlayers.Length})\n\n", color: "gray");
        
        foreach (var playerName in onlinePlayers)
        {
            var profile = await _context.PlayerProfileApi.FetchProfileByNameAsync(playerName);
            
            if (profile != null)
            {
                builder.PlayerHead(profile)
                       .Text(" ")
                       .Text($"§f{profile.Name}\n", color: "white");
            }
        }
        
        builder.Text("\n§6═══════════════════════════════", color: "gold");
        
        var message = builder.Build();
        await _context.RconClient!.ExecuteCommandAsync($"tellraw {sender.Name} {message}");
        
        return CommandResult.Ok();
    }
}
```

---

### **精灵图路径参考**

#### **常用物品精灵**

| 物品 | 精灵路径 |
|------|---------|
| 钻石 | `item/diamond` |
| 铁锭 | `item/iron_ingot` |
| 金锭 | `item/gold_ingot` |
| 绿宝石 | `item/emerald` |
| 钻石剑 | `item/diamond_sword` |
| 铁镐 | `item/iron_pickaxe` |
| 弓 | `item/bow` |
| 苹果 | `item/apple` |
| 面包 | `item/bread` |
| 猪排 | `item/porkchop` |

#### **常用方块精灵**

| 方块 | 精灵路径 |
|------|---------|
| 草方块 | `block/grass_block` |
| 石头 | `block/stone` |
| 橡木原木 | `block/oak_log` |
| 玻璃 | `block/glass` |
| 钻石块 | `block/diamond_block` |
| TNT | `block/tnt` |

#### **完整路径格式**

```csharp
// 物品精灵
builder.Sprite("sprite", "minecraft:item/<物品ID>");

// 方块精灵
builder.Sprite("sprite", "minecraft:block/<方块ID>");

// 可以省略命名空间（默认 minecraft）
builder.Sprite("sprite", "item/diamond");
```

---

### **系统要求**

- ✅ Minecraft Java 版 **1.21.9+**
- ✅ NetherGate **1.0.0+**
- ✅ 客户端必须支持 1.21.9+ 的文本组件格式

### **已知限制**

1. **客户端版本**：精灵图和玩家头像需要 Minecraft 1.21.9+ 客户端支持，旧版本客户端将无法正确显示
2. **精灵路径**：精灵路径必须在客户端资源包中存在，否则将显示为缺失纹理
3. **性能影响**：大量使用玩家头像可能会增加客户端渲染负担

---

## 📚 **相关文档**

- [游戏显示API](./游戏显示API.md)
- [玩家档案API](../02-核心功能/玩家档案API.md)
- [国际化 (i18n)](./国际化.md)
- [命令系统](../02-核心功能/命令系统.md)

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-10-09  
**许可证：** LGPL-3.0

