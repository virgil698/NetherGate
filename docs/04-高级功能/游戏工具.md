# 游戏工具 API

NetherGate 提供了强大的游戏工具 API，简化常见的游戏操作。该功能受 [MinecraftConnection](https://github.com/takunology/MinecraftConnection) 启发。

---

## 📋 **目录**

- [快速开始](#快速开始)
- [烟花系统](#烟花系统)
- [音乐播放器](#音乐播放器)
- [时间与天气](#时间与天气)
- [区域操作](#区域操作)
- [命令序列](#命令序列)
- [实战示例](#实战示例)

---

## 🚀 **快速开始**

### **获取游戏工具实例**

```csharp
public class MyPlugin : IPlugin
{
    private IGameUtilities _gameUtils;
    
    public void OnEnable(IPluginContext context)
    {
        _gameUtils = context.GameUtilities;
    }
}
```

---

## 🎆 **烟花系统**

### **基本用法**

```csharp
// 在指定位置发射烟花
await _gameUtils.LaunchFireworkAsync(
    position: new Position(100, 70, 200),
    type: FireworkType.Star,
    colors: new[] { FireworkColor.Red, FireworkColor.Gold },
    fadeColors: new[] { FireworkColor.White }
);
```

### **烟花类型**

```csharp
public enum FireworkType
{
    SmallBall,      // 小球
    LargeBall,      // 大球
    Star,           // 星形
    Creeper,        // 苦力怕形状
    Burst           // 爆裂
}
```

### **烟花颜色**

```csharp
public enum FireworkColor
{
    Black,      // 黑色
    Red,        // 红色
    Green,      // 绿色
    Brown,      // 棕色
    Blue,       // 蓝色
    Purple,     // 紫色
    Cyan,       // 青色
    LightGray,  // 浅灰
    Gray,       // 灰色
    Pink,       // 粉色
    Lime,       // 黄绿
    Yellow,     // 黄色
    LightBlue,  // 浅蓝
    Magenta,    // 品红
    Orange,     // 橙色
    White       // 白色
}
```

### **高级烟花**

```csharp
// 创建自定义烟花构建器
var firework = _gameUtils.CreateFirework()
    .SetType(FireworkType.Star)
    .AddColor(FireworkColor.Red)
    .AddColor(FireworkColor.Gold)
    .AddFadeColor(FireworkColor.White)
    .SetFlicker(true)          // 闪烁
    .SetTrail(true)            // 尾迹
    .SetFlightDuration(2)      // 飞行时间
    .BuildAsync();

await _gameUtils.LaunchFireworkAsync(position, firework);
```

### **烟花序列**

```csharp
// 连续发射烟花
public async Task FireworkShowAsync(Position center)
{
    var colors = new[] 
    { 
        FireworkColor.Red, 
        FireworkColor.Green, 
        FireworkColor.Blue 
    };
    
    for (int i = 0; i < 10; i++)
    {
        var offset = new Position(
            center.X + Random.Next(-5, 5),
            center.Y,
            center.Z + Random.Next(-5, 5)
        );
        
        await _gameUtils.LaunchFireworkAsync(
            offset,
            FireworkType.LargeBall,
            new[] { colors[i % colors.Length] }
        );
        
        await Task.Delay(500);  // 间隔 0.5 秒
    }
}
```

---

## 🎵 **音乐播放器**

### **基本音符**

```csharp
// 播放单个音符
await _musicPlayer.PlayNoteAsync(
    player: "@a",           // 目标玩家
    note: Note.C,           // C 调
    duration: 200           // 持续 200ms
);
```

### **音符枚举**

```csharp
public enum Note
{
    C, D, E, F, G, A, B,           // 自然音
    CSharp, DSharp, FSharp,        // 升半音
    GSharp, ASharp
}
```

### **创建旋律**

```csharp
// 使用旋律构建器
await _musicPlayer.CreateMelody()
    .AddNote(Note.C, 200)
    .AddNote(Note.D, 200)
    .AddNote(Note.E, 200)
    .AddNote(Note.C, 400)
    .AddPause(100)           // 暂停 100ms
    .AddNote(Note.E, 200)
    .AddNote(Note.F, 200)
    .AddNote(Note.G, 600)
    .PlayAsync("@a");
```

### **预设旋律**

```csharp
// 播放欢迎音乐
await _musicPlayer.PlayWelcomeMelodyAsync("Steve");

// 播放告别音乐
await _musicPlayer.PlayGoodbyeMelodyAsync("Steve");

// 播放成功音效
await _musicPlayer.PlaySuccessSoundAsync("@a");

// 播放失败音效
await _musicPlayer.PlayFailureSoundAsync("@a");

// 播放警告音效
await _musicPlayer.PlayWarningSoundAsync("@a");
```

### **自定义歌曲**

```csharp
public class SongPlayer
{
    public async Task PlayTwinkleStarAsync(string player)
    {
        var melody = _musicPlayer.CreateMelody()
            // 一闪一闪亮晶晶
            .AddNote(Note.C, 300).AddNote(Note.C, 300)
            .AddNote(Note.G, 300).AddNote(Note.G, 300)
            .AddNote(Note.A, 300).AddNote(Note.A, 300)
            .AddNote(Note.G, 600)
            .AddPause(100)
            .AddNote(Note.F, 300).AddNote(Note.F, 300)
            .AddNote(Note.E, 300).AddNote(Note.E, 300)
            .AddNote(Note.D, 300).AddNote(Note.D, 300)
            .AddNote(Note.C, 600);
        
        await melody.PlayAsync(player);
    }
}
```

---

## ⏰ **时间与天气**

### **时间控制**

```csharp
// 设置为白天
await _gameUtils.SetTimeAsync(TimeOfDay.Day);

// 设置为夜晚
await _gameUtils.SetTimeAsync(TimeOfDay.Night);

// 设置为中午
await _gameUtils.SetTimeAsync(TimeOfDay.Noon);

// 设置为午夜
await _gameUtils.SetTimeAsync(TimeOfDay.Midnight);

// 自定义时间（tick，0-24000）
await _gameUtils.SetTimeAsync(6000);  // 中午
```

### **天气控制**

```csharp
// 晴天
await _gameUtils.SetWeatherAsync(Weather.Clear);

// 下雨
await _gameUtils.SetWeatherAsync(Weather.Rain);

// 雷暴
await _gameUtils.SetWeatherAsync(Weather.Thunder);

// 设置天气持续时间（秒）
await _gameUtils.SetWeatherAsync(Weather.Rain, duration: 300);  // 下雨 5 分钟
```

---

## 🏗️ **区域操作**

### **填充方块**

```csharp
// 填充区域
await _gameUtils.FillBlockAsync(
    from: new Position(0, 64, 0),
    to: new Position(10, 74, 10),
    blockId: "minecraft:stone"
);

// 替换方块
await _gameUtils.ReplaceBlockAsync(
    from: new Position(0, 64, 0),
    to: new Position(10, 74, 10),
    oldBlockId: "minecraft:dirt",
    newBlockId: "minecraft:grass_block"
);

// 清空区域（替换为空气）
await _gameUtils.ClearAreaAsync(
    from: new Position(0, 64, 0),
    to: new Position(10, 74, 10)
);
```

### **克隆区域**

```csharp
// 克隆区域
await _gameUtils.CloneAreaAsync(
    from: new Position(0, 64, 0),
    to: new Position(10, 74, 10),
    destination: new Position(100, 64, 100)
);
```

### **生成结构**

```csharp
// 生成球体
await _gameUtils.GenerateSphereAsync(
    center: new Position(100, 70, 200),
    radius: 5,
    blockId: "minecraft:glass"
);

// 生成立方体
await _gameUtils.GenerateCubeAsync(
    center: new Position(100, 70, 200),
    size: 10,
    blockId: "minecraft:stone"
);

// 生成空心球体
await _gameUtils.GenerateHollowSphereAsync(
    center: new Position(100, 70, 200),
    radius: 8,
    blockId: "minecraft:glass"
);
```

---

## 🔄 **命令序列**

命令序列允许你按顺序执行多个命令，并在命令之间添加延迟。

### **基本用法**

```csharp
// 创建命令序列
await _gameUtils.CreateSequence()
    .Execute(() => _gameDisplay.BroadcastMessage("倒计时开始！"))
    .WaitTicks(20)  // 等待 1 秒
    .Execute(() => _gameDisplay.BroadcastMessage("3..."))
    .WaitTicks(20)
    .Execute(() => _gameDisplay.BroadcastMessage("2..."))
    .WaitTicks(20)
    .Execute(() => _gameDisplay.BroadcastMessage("1..."))
    .WaitTicks(20)
    .Execute(() => _gameDisplay.BroadcastMessage("GO!"))
    .RunAsync();
```

### **支持异步操作**

```csharp
await _gameUtils.CreateSequence()
    .Execute(async () => 
    {
        await _gameDisplay.BroadcastMessageAsync("准备爆炸...");
    })
    .WaitSeconds(3)
    .Execute(async () => 
    {
        await _rconClient.ExecuteCommandAsync("summon minecraft:tnt ~ ~ ~");
    })
    .WaitSeconds(1)
    .Execute(async () => 
    {
        await _gameDisplay.BroadcastMessageAsync("BOOM!");
    })
    .RunAsync();
```

### **条件执行**

```csharp
await _gameUtils.CreateSequence()
    .Execute(() => StartEvent())
    .WaitSeconds(5)
    .ExecuteIf(
        condition: () => IsPlayerOnline("Steve"),
        action: () => NotifyPlayer("Steve")
    )
    .WaitSeconds(5)
    .Execute(() => EndEvent())
    .RunAsync();
```

---

## 💼 **实战示例**

### **示例1：庆祝系统**

```csharp
public class CelebrationManager
{
    public async Task CelebrateVictoryAsync(string playerName, Position pos)
    {
        // 播放音乐
        await _musicPlayer.CreateMelody()
            .AddNote(Note.C, 100)
            .AddNote(Note.E, 100)
            .AddNote(Note.G, 200)
            .AddNote(Note.C, 400)
            .PlayAsync(playerName);
        
        // 发射烟花秀
        for (int i = 0; i < 5; i++)
        {
            var offset = pos.Offset(
                Random.Next(-3, 3), 
                i * 2, 
                Random.Next(-3, 3)
            );
            
            await _gameUtils.LaunchFireworkAsync(
                offset,
                FireworkType.Star,
                new[] { FireworkColor.Gold, FireworkColor.Yellow }
            );
            
            await Task.Delay(500);
        }
        
        // 消息通知
        await _gameDisplay.SendTitleAsync(
            playerName,
            "§6§l胜利！",
            "§e恭喜获胜",
            fadeIn: 10,
            stay: 70,
            fadeOut: 20
        );
    }
}
```

### **示例2：自动建筑**

```csharp
public class BuildingCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var pos = await GetPlayerPositionAsync(sender.Name);
        
        // 建造一个玻璃圆顶
        await _gameUtils.CreateSequence()
            .Execute(async () => 
            {
                await _gameDisplay.SendMessageAsync(sender.Name, "§a开始建造...");
            })
            .WaitSeconds(1)
            .Execute(async () => 
            {
                // 底座
                await _gameUtils.FillBlockAsync(
                    pos.Down(1),
                    pos.Down(1).Offset(10, 0, 10),
                    "minecraft:stone"
                );
            })
            .WaitSeconds(2)
            .Execute(async () => 
            {
                // 玻璃圆顶
                await _gameUtils.GenerateHollowSphereAsync(
                    pos.Offset(5, 5, 5),
                    radius: 8,
                    blockId: "minecraft:glass"
                );
            })
            .WaitSeconds(2)
            .Execute(async () => 
            {
                await _gameDisplay.SendMessageAsync(sender.Name, "§a建造完成！");
                await _musicPlayer.PlaySuccessSoundAsync(sender.Name);
            })
            .RunAsync();
        
        return CommandResult.Ok("建筑任务已启动");
    }
}
```

### **示例3：PvP 竞技场**

```csharp
public class ArenaManager
{
    public async Task StartPvpMatchAsync(List<string> players)
    {
        var arenaCenter = new Position(0, 100, 0);
        
        await _gameUtils.CreateSequence()
            // 倒计时
            .Execute(() => _gameDisplay.BroadcastMessage("§6PvP 竞赛即将开始！"))
            .WaitSeconds(3)
            .Execute(() => _musicPlayer.PlayWarningSoundAsync("@a"))
            .WaitSeconds(1)
            .Execute(() => _gameDisplay.BroadcastMessage("§c3..."))
            .WaitSeconds(1)
            .Execute(() => _gameDisplay.BroadcastMessage("§c2..."))
            .WaitSeconds(1)
            .Execute(() => _gameDisplay.BroadcastMessage("§c1..."))
            .WaitSeconds(1)
            
            // 开始
            .Execute(async () => 
            {
                await _gameDisplay.BroadcastMessageAsync("§a§l开始！");
                await _musicPlayer.PlaySuccessSoundAsync("@a");
                
                // 发射庆祝烟花
                await _gameUtils.LaunchFireworkAsync(
                    arenaCenter.Up(20),
                    FireworkType.Burst,
                    new[] { FireworkColor.Red, FireworkColor.Gold }
                );
            })
            .RunAsync();
    }
}
```

### **示例4：定时重置矿区**

```csharp
public class MiningAreaPlugin : IPlugin
{
    private readonly Position _mineStart = new(1000, 50, 1000);
    private readonly Position _mineEnd = new(1100, 100, 1100);
    
    public void OnEnable(IPluginContext context)
    {
        // 每 6 小时重置矿区
        context.Scheduler.ScheduleRepeating(async () =>
        {
            await ResetMiningAreaAsync();
        }, TimeSpan.FromHours(6));
    }
    
    private async Task ResetMiningAreaAsync()
    {
        await _gameDisplay.BroadcastMessageAsync("§c矿区将在 1 分钟后重置！");
        await _musicPlayer.PlayWarningSoundAsync("@a");
        
        await Task.Delay(TimeSpan.FromSeconds(60));
        
        // 重新生成矿石
        await _gameUtils.CreateSequence()
            .Execute(async () => 
            {
                // 清空区域
                await _gameUtils.ClearAreaAsync(_mineStart, _mineEnd);
            })
            .WaitSeconds(2)
            .Execute(async () => 
            {
                // 填充石头
                await _gameUtils.FillBlockAsync(
                    _mineStart, 
                    _mineEnd, 
                    "minecraft:stone"
                );
            })
            .WaitSeconds(2)
            .Execute(async () => 
            {
                // 随机生成矿石
                await GenerateRandomOresAsync(_mineStart, _mineEnd);
            })
            .WaitSeconds(1)
            .Execute(async () => 
            {
                await _gameDisplay.BroadcastMessageAsync("§a矿区重置完成！");
                await _musicPlayer.PlaySuccessSoundAsync("@a");
            })
            .RunAsync();
    }
}
```

---

## 💡 **最佳实践**

### **1. 异步操作**

✅ **推荐：** 使用 async/await
```csharp
await _gameUtils.LaunchFireworkAsync(...);
await _musicPlayer.PlayNoteAsync(...);
```

### **2. 错误处理**

✅ **推荐：** 捕获异常
```csharp
try
{
    await _gameUtils.FillBlockAsync(from, to, blockId);
}
catch (Exception ex)
{
    _logger.Error("区域填充失败", ex);
}
```

### **3. 性能考虑**

✅ **推荐：** 大规模操作分批执行
```csharp
// 分批填充大区域
var chunks = DivideIntoChunks(largeArea, chunkSize: 16);
foreach (var chunk in chunks)
{
    await _gameUtils.FillBlockAsync(chunk.Start, chunk.End, blockId);
    await Task.Delay(50);  // 避免服务器卡顿
}
```

---

## 📚 **相关文档**

- [调度器系统](./调度器系统.md)
- [扩展方法](./扩展方法.md)
- [游戏显示API](./游戏显示API.md)

---

## 🙏 **致谢**

游戏工具 API 的设计受 [MinecraftConnection](https://github.com/takunology/MinecraftConnection) 启发。

---

**文档维护者：** NetherGate 开发团队  
**最后更新：** 2025-01-08  
**参考项目：** [MinecraftConnection](https://github.com/takunology/MinecraftConnection) (MIT)  
**许可证：** LGPL-3.0

