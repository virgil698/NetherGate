# æ‰©å±•æ–¹æ³•

NetherGate æä¾›äº†ä¸°å¯Œçš„æ‰©å±•æ–¹æ³•åº“ï¼Œç®€åŒ–å¸¸è§çš„æ¸¸æˆæ“ä½œã€‚è¿™äº›æ‰©å±•æ–¹æ³•è®©ä»£ç æ›´ç®€æ´ã€æ›´æ˜“è¯»ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [ItemStack æ‰©å±•](#itemstack-æ‰©å±•)
- [Position æ‰©å±•](#position-æ‰©å±•)
- [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ’ **ItemStack æ‰©å±•**

### **è¿‡æ»¤æ–¹æ³•**

```csharp
using NetherGate.API.Extensions;

var items = await blockReader.GetChestItemsAsync(position);

// è¿‡æ»¤é™„é­”ç‰©å“
var enchantedItems = items.FilterEnchanted();

// æŒ‰ ID è¿‡æ»¤
var diamonds = items.FilterById("minecraft:diamond");

// æŒ‰æ ‡ç­¾è¿‡æ»¤
var tools = items.FilterByTag("tools");

// æŒ‰æ•°é‡è¿‡æ»¤
var stackedItems = items.FilterByCount(count => count > 32);

// è‡ªå®šä¹‰è¿‡æ»¤
var valuable = items.Where(item => 
    item.Id.Contains("diamond") || 
    item.Id.Contains("netherite")
);
```

### **æ’åºæ–¹æ³•**

```csharp
// æŒ‰ ID æ’åº
var sortedById = items.SortById();

// æŒ‰æ•°é‡æ’åº
var sortedByCount = items.SortByCount(descending: true);

// æŒ‰ç¨€æœ‰åº¦æ’åº
var sortedByRarity = items.SortByRarity();
// ä¼˜å…ˆçº§: ä¸‹ç•Œåˆé‡‘ > é’»çŸ³ > é‡‘ > é“ > å…¶ä»–

// è‡ªå®šä¹‰æ’åº
var custom = items.OrderBy(i => i.Slot);
```

### **ç»Ÿè®¡æ–¹æ³•**

```csharp
// è·å–ç»Ÿè®¡ä¿¡æ¯
var stats = items.GetStatistics();

Console.WriteLine($"æ€»ç‰©å“æ•°: {stats.TotalCount}");
Console.WriteLine($"ç§ç±»æ•°: {stats.UniqueItems}");
Console.WriteLine($"é™„é­”ç‰©å“: {stats.EnchantedCount}");
Console.WriteLine($"æŸåç‰©å“: {stats.DamagedCount}");
Console.WriteLine($"æ€»ä»·å€¼: {stats.TotalValue}");
```

### **è½¬æ¢æ–¹æ³•**

```csharp
// è½¬æ¢ä¸ºå­—å…¸ï¼ˆæŒ‰IDåˆ†ç»„ï¼‰
var grouped = items.ToDictionary();
// Key: "minecraft:diamond", Value: List<ItemStack>

// è½¬æ¢ä¸ºæ‘˜è¦åˆ—è¡¨
var summary = items.ToSummary();
// "64x minecraft:stone, 32x minecraft:dirt, ..."

// è·å–å”¯ä¸€ç‰©å“ ID
var uniqueIds = items.GetUniqueIds();
// ["minecraft:diamond", "minecraft:iron_ingot", ...]
```

### **æ£€æŸ¥æ–¹æ³•**

```csharp
// æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰©å“
if (items.ContainsItem("minecraft:diamond"))
{
    // åŒ…å«é’»çŸ³
}

// æ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ§½ä½
if (items.HasEmptySlots())
{
    // æœ‰ç©ºä½
}

// æ£€æŸ¥æ˜¯å¦å·²æ»¡
if (items.IsFull(maxSlots: 27))
{
    // ç®±å­æ»¡äº†
}

// æ£€æŸ¥ç‰¹å®šç‰©å“æ•°é‡
var diamondCount = items.CountItem("minecraft:diamond");
```

---

## ğŸ“ **Position æ‰©å±•**

### **æ–¹å‘åç§»**

```csharp
using NetherGate.API.Extensions;

var pos = new Position(100, 64, 200);

// å…­ä¸ªæ–¹å‘çš„ä¾¿æ·æ–¹æ³•
var up = pos.Up(5);          // Y + 5
var down = pos.Down(3);      // Y - 3
var north = pos.North(10);   // Z - 10
var south = pos.South(10);   // Z + 10
var east = pos.East(5);      // X + 5
var west = pos.West(5);      // X - 5

// è‡ªå®šä¹‰åç§»
var offset = pos.Offset(x: 5, y: 10, z: -3);
```

### **è·ç¦»è®¡ç®—**

```csharp
var pos1 = new Position(0, 0, 0);
var pos2 = new Position(10, 0, 10);

// æ¬§å‡ é‡Œå¾—è·ç¦»
var distance = pos1.DistanceTo(pos2);  // 14.14

// æ›¼å“ˆé¡¿è·ç¦»
var manhattan = pos1.ManhattanDistanceTo(pos2);  // 20

// æ°´å¹³è·ç¦»ï¼ˆå¿½ç•¥Yè½´ï¼‰
var horizontal = pos1.HorizontalDistanceTo(pos2);  // 14.14
```

### **åŒºåŸŸç”Ÿæˆ**

```csharp
// è·å–å‘¨å›´çš„ä½ç½®ï¼ˆ3Dçƒä½“ï¼‰
var surrounding = pos.GetSurroundingPositions(radius: 3);
// è¿”å›åŠå¾„ 3 å†…çš„æ‰€æœ‰ä½ç½®

// è·å–ç«‹æ–¹ä½“åŒºåŸŸ
var cube = pos.GetCube(size: 5);
// è¿”å› 5x5x5 çš„ç«‹æ–¹ä½“åŒºåŸŸ

// è·å–å¹³é¢åŒºåŸŸ
var plane = pos.GetPlane(radius: 10, includeCenter: false);
// è¿”å›æ°´å¹³é¢ä¸ŠåŠå¾„ 10 çš„åœ†å½¢åŒºåŸŸ

// è·å–ä¸€æ¡çº¿ä¸Šçš„æ‰€æœ‰ä½ç½®
var line = pos.GetLineTo(targetPos);
// è¿”å›ä»å½“å‰ä½ç½®åˆ°ç›®æ ‡ä½ç½®çš„ç›´çº¿è·¯å¾„
```

### **ä½ç½®å…³ç³»**

```csharp
// æ£€æŸ¥æ˜¯å¦åœ¨åŒºåŸŸå†…
var isInside = pos.IsInArea(
    corner1: new Position(0, 0, 0),
    corner2: new Position(100, 100, 100)
);

// æ£€æŸ¥æ˜¯å¦ç›¸é‚»
var isAdjacent = pos.IsAdjacentTo(otherPos);

// è·å–æœ€è¿‘çš„ä½ç½®
var nearest = pos.GetNearest(positionList);
```

### **åæ ‡è½¬æ¢**

```csharp
// è½¬æ¢ä¸ºåŒºå—åæ ‡
var chunkPos = pos.ToChunkPosition();  // (ChunkX, ChunkZ)

// è½¬æ¢ä¸ºå­—ç¬¦ä¸²
var str = pos.ToCommandString();  // "100 64 200"
var formatted = pos.ToFormattedString();  // "X:100, Y:64, Z:200"

// è§£æå­—ç¬¦ä¸²
var parsed = Position.Parse("100 64 200");
```

---

## ğŸ’¼ **å®æˆ˜ç¤ºä¾‹**

### **ç¤ºä¾‹1ï¼šç®±å­æ•´ç†ç³»ç»Ÿ**

```csharp
public class ChestOrganizerCommand : ICommand
{
    private readonly IBlockDataReader _blockReader;
    private readonly IBlockDataWriter _blockWriter;
    
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var pos = ParsePosition(args);
        var items = await _blockReader.GetChestItemsAsync(pos);
        
        // æ•´ç†é€»è¾‘ï¼šé™„é­”ç‰©å“ä¼˜å…ˆï¼Œç„¶åæŒ‰ç¨€æœ‰åº¦æ’åº
        var organized = items
            .FilterEnchanted()           // å…ˆæ‹¿å‡ºæ‰€æœ‰é™„é­”ç‰©å“
            .SortByRarity()              // æŒ‰ç¨€æœ‰åº¦æ’åº
            .Concat(                      // æ‹¼æ¥ä¸Šå…¶ä»–ç‰©å“
                items.Where(i => !i.IsEnchanted())
                     .SortById()
            )
            .ToList();
        
        await _blockWriter.SetContainerItemsAsync(pos, organized);
        
        var stats = items.GetStatistics();
        return CommandResult.Ok(
            $"ç®±å­å·²æ•´ç†ï¼š{stats.TotalCount} ä»¶ç‰©å“ï¼Œ{stats.UniqueItems} ä¸ªç§ç±»ï¼Œ{stats.EnchantedCount} ä»¶é™„é­”"
        );
    }
}
```

### **ç¤ºä¾‹2ï¼šåŒºåŸŸæ‰«æ**

```csharp
public class FindDiamondCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var centerPos = await GetPlayerPositionAsync(sender.Name);
        var radius = int.Parse(args[0]);
        
        // æ‰«æå‘¨å›´åŒºåŸŸ
        var positions = centerPos.GetSurroundingPositions(radius);
        var diamondOres = new List<Position>();
        
        foreach (var pos in positions)
        {
            var blockId = await GetBlockIdAsync(pos);
            if (blockId == "minecraft:diamond_ore" || 
                blockId == "minecraft:deepslate_diamond_ore")
            {
                diamondOres.Add(pos);
            }
        }
        
        if (diamondOres.Any())
        {
            var nearest = centerPos.GetNearest(diamondOres);
            var distance = centerPos.DistanceTo(nearest);
            
            return CommandResult.Ok(
                $"æ‰¾åˆ° {diamondOres.Count} å¤„é’»çŸ³çŸ¿ï¼\n" +
                $"æœ€è¿‘çš„åœ¨: {nearest.ToFormattedString()} (è·ç¦» {distance:F1})"
            );
        }
        
        return CommandResult.Ok("é™„è¿‘æ²¡æœ‰é’»çŸ³çŸ¿");
    }
}
```

### **ç¤ºä¾‹3ï¼šç‰©å“ç»Ÿè®¡æŠ¥å‘Š**

```csharp
public class InventoryReportCommand : ICommand
{
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        var positions = FindAllChestsInWorld();
        var allItems = new List<ItemStack>();
        
        foreach (var pos in positions)
        {
            var items = await _blockReader.GetChestItemsAsync(pos);
            allItems.AddRange(items);
        }
        
        // ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
        var stats = allItems.GetStatistics();
        var byId = allItems.ToDictionary();
        
        var report = new StringBuilder();
        report.AppendLine("=== ä»“åº“ç»Ÿè®¡æŠ¥å‘Š ===");
        report.AppendLine($"æ€»ç‰©å“æ•°: {stats.TotalCount}");
        report.AppendLine($"ç§ç±»æ•°: {stats.UniqueItems}");
        report.AppendLine($"é™„é­”ç‰©å“: {stats.EnchantedCount}");
        report.AppendLine();
        report.AppendLine("== ç‰©å“åˆ†å¸ƒ ==");
        
        foreach (var (id, items) in byId.OrderByDescending(x => x.Value.Sum(i => i.Count)))
        {
            var total = items.Sum(i => i.Count);
            report.AppendLine($"{id}: {total}");
        }
        
        return CommandResult.Ok(report.ToString());
    }
}
```

### **ç¤ºä¾‹4ï¼šåŒºåŸŸä¿æŠ¤**

```csharp
public class ProtectionPlugin : IPlugin
{
    private readonly List<(Position, Position)> _protectedAreas = new();
    
    public void OnEnable(IPluginContext context)
    {
        context.EventBus.Subscribe<BlockBreakEvent>(async e =>
        {
            var breakPos = e.Position;
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ä¿æŠ¤åŒº
            foreach (var (corner1, corner2) in _protectedAreas)
            {
                if (breakPos.IsInArea(corner1, corner2))
                {
                    // æ£€æŸ¥æƒé™
                    if (!await HasPermissionAsync(e.PlayerName, "protection.bypass"))
                    {
                        e.Cancel = true;
                        await SendMessageAsync(e.PlayerName, "Â§cæ­¤åŒºåŸŸå—ä¿æŠ¤ï¼");
                        return;
                    }
                }
            }
        });
    }
}
```

### **ç¤ºä¾‹5ï¼šä¼ é€å†·å´ç³»ç»Ÿ**

```csharp
public class TeleportCommand : ICommand
{
    private readonly Dictionary<string, DateTime> _cooldowns = new();
    private readonly TimeSpan _cooldownDuration = TimeSpan.FromMinutes(5);
    
    public async Task<CommandResult> ExecuteAsync(ICommandSender sender, string[] args)
    {
        // æ£€æŸ¥å†·å´
        if (_cooldowns.TryGetValue(sender.Name, out var lastUse))
        {
            var elapsed = DateTime.UtcNow - lastUse;
            if (elapsed < _cooldownDuration)
            {
                var remaining = _cooldownDuration - elapsed;
                return CommandResult.Fail(
                    $"ä¼ é€å†·å´ä¸­ï¼Œè¿˜éœ€ {remaining.TotalSeconds:F0} ç§’"
                );
            }
        }
        
        var targetPos = Position.Parse(args[0]);
        var currentPos = await GetPlayerPositionAsync(sender.Name);
        var distance = currentPos.DistanceTo(targetPos);
        
        // è·ç¦»é™åˆ¶
        if (distance > 1000)
        {
            return CommandResult.Fail("ä¼ é€è·ç¦»ä¸èƒ½è¶…è¿‡ 1000 æ ¼");
        }
        
        await TeleportPlayerAsync(sender.Name, targetPos);
        _cooldowns[sender.Name] = DateTime.UtcNow;
        
        return CommandResult.Ok($"å·²ä¼ é€åˆ° {targetPos.ToFormattedString()}");
    }
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. é“¾å¼æ“ä½œ**

âœ… **æ¨èï¼š** ä½¿ç”¨ LINQ å’Œæ‰©å±•æ–¹æ³•é“¾å¼æ“ä½œ
```csharp
var result = items
    .FilterEnchanted()
    .SortByRarity()
    .Take(10)
    .ToList();
```

### **2. æ€§èƒ½è€ƒè™‘**

âœ… **æ¨èï¼š** å¯¹å¤§é‡æ•°æ®ä½¿ç”¨ç¼“å­˜
```csharp
// ç¼“å­˜ç»Ÿè®¡ç»“æœ
private ItemStatistics? _cachedStats;

public ItemStatistics GetStats(List<ItemStack> items)
{
    if (_cachedStats == null)
    {
        _cachedStats = items.GetStatistics();
    }
    return _cachedStats;
}
```

### **3. ç©ºå€¼æ£€æŸ¥**

âœ… **æ¨èï¼š** å§‹ç»ˆæ£€æŸ¥é›†åˆæ˜¯å¦ä¸ºç©º
```csharp
if (items?.Any() != true)
{
    return CommandResult.Fail("ç®±å­ä¸ºç©º");
}

var sorted = items.SortById();
```

### **4. ç»„åˆä½¿ç”¨**

âœ… **æ¨èï¼š** ç»“åˆå¤šä¸ªæ‰©å±•æ–¹æ³•å®ç°å¤æ‚é€»è¾‘
```csharp
// æ‰¾å‡ºå‘¨å›´ 10 æ ¼å†…æ‰€æœ‰ç®±å­çš„é’»çŸ³
var nearbyChests = playerPos.GetSurroundingPositions(10)
    .Where(p => IsChest(p));

var allDiamonds = new List<ItemStack>();
foreach (var chest in nearbyChests)
{
    var items = await _blockReader.GetChestItemsAsync(chest);
    allDiamonds.AddRange(items.FilterById("minecraft:diamond"));
}

var totalDiamonds = allDiamonds.Sum(i => i.Count);
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ–¹å—æ•°æ®æ“ä½œ](../02-æ ¸å¿ƒåŠŸèƒ½/æ–¹å—æ•°æ®æ“ä½œ.md)
- [ç‰©å“ç»„ä»¶ç³»ç»Ÿ](../02-æ ¸å¿ƒåŠŸèƒ½/ç‰©å“ç»„ä»¶ç³»ç»Ÿ.md)
- [æ¸¸æˆå·¥å…·](./æ¸¸æˆå·¥å…·.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-01-08  
**è®¸å¯è¯ï¼š** LGPL-3.0

