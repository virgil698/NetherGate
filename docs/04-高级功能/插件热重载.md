# æ’ä»¶çƒ­é‡è½½

NetherGate æ”¯æŒæ’ä»¶çƒ­é‡è½½åŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸é‡å¯æœåŠ¡å™¨çš„æƒ…å†µä¸‹é‡æ–°åŠ è½½æ’ä»¶ã€‚æœ¬æ–‡æ¡£ä»‹ç»çƒ­é‡è½½çš„å·¥ä½œåŸç†å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‹ **ç›®å½•**

- [ä»€ä¹ˆæ˜¯çƒ­é‡è½½](#ä»€ä¹ˆæ˜¯çƒ­é‡è½½)
- [ä½¿ç”¨çƒ­é‡è½½](#ä½¿ç”¨çƒ­é‡è½½)
- [çƒ­é‡è½½æµç¨‹](#çƒ­é‡è½½æµç¨‹)
- [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
- [èµ„æºæ¸…ç†](#èµ„æºæ¸…ç†)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ”¥ **ä»€ä¹ˆæ˜¯çƒ­é‡è½½**

çƒ­é‡è½½ï¼ˆHot Reloadï¼‰æ˜¯æŒ‡åœ¨è¿è¡Œæ—¶é‡æ–°åŠ è½½æ’ä»¶çš„èƒ½åŠ›ï¼Œæ— éœ€é‡å¯æ•´ä¸ªæœåŠ¡å™¨ã€‚

### **ä¼˜ç‚¹**

- âœ… **å¿«é€Ÿè¿­ä»£** - ä¿®æ”¹ä»£ç åç«‹å³ç”Ÿæ•ˆ
- âœ… **é›¶åœæœº** - ä¸å½±å“å…¶ä»–æ’ä»¶å’Œç©å®¶
- âœ… **è°ƒè¯•æ–¹ä¾¿** - å¿«é€Ÿæµ‹è¯•ä¿®å¤
- âœ… **å¼€å‘æ•ˆç‡é«˜** - èŠ‚çœé‡å¯æ—¶é—´

### **é™åˆ¶**

- âš ï¸ **é™æ€å˜é‡** - ä¸ä¼šé‡ç½®
- âš ï¸ **ä¾èµ–å…³ç³»** - éœ€è¦æ‰‹åŠ¨ç®¡ç†
- âš ï¸ **çŠ¶æ€ä¿å­˜** - éœ€è¦æ­£ç¡®å®ç°
- âš ï¸ **å†…å­˜æ³„æ¼** - ä¸æ­£ç¡®æ¸…ç†ä¼šå¯¼è‡´æ³„æ¼

---

## ğŸ® **ä½¿ç”¨çƒ­é‡è½½**

### **1. é€šè¿‡æ§åˆ¶å°å‘½ä»¤**

```bash
# é‡è½½å•ä¸ªæ’ä»¶
plugin reload MyPlugin

# é‡è½½æ‰€æœ‰æ’ä»¶
plugin reload all

# ç¦ç”¨æ’ä»¶
plugin disable MyPlugin

# å¯ç”¨æ’ä»¶
plugin enable MyPlugin

# å¸è½½æ’ä»¶
plugin unload MyPlugin

# åŠ è½½æ–°æ’ä»¶
plugin load MyPlugin
```

### **2. é€šè¿‡ API**

```csharp
using NetherGate.API.Plugins;

public class PluginManagerPlugin : PluginBase
{
    public async Task ManagePluginsAsync()
    {
        // ä½¿ç”¨ PluginManager å±æ€§ï¼ˆç”± PluginBase æä¾›ï¼‰
        
        // é‡è½½å•ä¸ªæ’ä»¶
        await PluginManager.ReloadPluginAsync("MyPlugin");
        Logger.Info("æ’ä»¶å·²é‡è½½");
        
        // é‡è½½æ‰€æœ‰æ’ä»¶
        await PluginManager.ReloadAllPluginsAsync();
        Logger.Info("æ‰€æœ‰æ’ä»¶å·²é‡è½½");
        
        // å¯ç”¨/ç¦ç”¨æ’ä»¶
        await PluginManager.EnablePluginAsync("MyPlugin");
        await PluginManager.DisablePluginAsync("MyPlugin");
        
        // åŠ è½½/å¸è½½æ’ä»¶
        await PluginManager.LoadPluginAsync("MyPlugin");
        await PluginManager.UnloadPluginAsync("MyPlugin");
    }
}
```

### **3. è‡ªåŠ¨é‡è½½ï¼ˆæ–‡ä»¶ç›‘è§†ï¼‰**

åœ¨ `nethergate-config.yaml` ä¸­å¯ç”¨ï¼š

```yaml
plugins:
  enable_hot_reload: true  # å¯ç”¨çƒ­é‡è½½
  auto_load: true          # è‡ªåŠ¨åŠ è½½æ–°æ’ä»¶
```

å½“æ£€æµ‹åˆ°æ’ä»¶æ–‡ä»¶å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨é‡è½½ã€‚

---

## ğŸ”„ **çƒ­é‡è½½æµç¨‹**

### **å®Œæ•´æµç¨‹**

```
1. ä¿å­˜çŠ¶æ€
   â””â”€ è°ƒç”¨ SaveState()
   
2. ç¦ç”¨æ’ä»¶
   â”œâ”€ è°ƒç”¨ OnDisable()
   â”œâ”€ å–æ¶ˆäº‹ä»¶è®¢é˜…
   â”œâ”€ æ³¨é”€å‘½ä»¤
   â””â”€ æ¸…ç†èµ„æº
   
3. å¸è½½ç¨‹åºé›†
   â””â”€ é‡Šæ”¾ AssemblyLoadContext
   
4. é‡æ–°åŠ è½½ç¨‹åºé›†
   â”œâ”€ åˆ›å»ºæ–°çš„ AssemblyLoadContext
   â”œâ”€ åŠ è½½ DLL æ–‡ä»¶
   â””â”€ è¯»å– plugin.json
   
5. åˆ›å»ºæ’ä»¶å®ä¾‹
   â””â”€ å®ä¾‹åŒ–ä¸»ç±»
   
6. å¯ç”¨æ’ä»¶
   â”œâ”€ è°ƒç”¨ OnLoad()
   â”œâ”€ åˆ›å»º IPluginContext
   â”œâ”€ è°ƒç”¨ OnEnable()
   â””â”€ æ¢å¤çŠ¶æ€
   
7. æ¢å¤çŠ¶æ€
   â””â”€ è°ƒç”¨ RestoreState()
```

### **æ—¶åºå›¾**

```
[ç”¨æˆ·] â”€â”€â”€â”€â”€â†’ [PluginManager]
                     â”‚
                     â”œâ”€â†’ [æ—§å®ä¾‹].SaveState()
                     â”‚
                     â”œâ”€â†’ [æ—§å®ä¾‹].OnDisable()
                     â”‚      â”œâ”€ å–æ¶ˆäº‹ä»¶è®¢é˜…
                     â”‚      â”œâ”€ æ³¨é”€å‘½ä»¤
                     â”‚      â””â”€ æ¸…ç†èµ„æº
                     â”‚
                     â”œâ”€â†’ å¸è½½ç¨‹åºé›†
                     â”‚
                     â”œâ”€â†’ é‡æ–°åŠ è½½ç¨‹åºé›†
                     â”‚
                     â”œâ”€â†’ [æ–°å®ä¾‹] = new Plugin()
                     â”‚
                     â”œâ”€â†’ [æ–°å®ä¾‹].OnLoad()
                     â”‚
                     â”œâ”€â†’ [æ–°å®ä¾‹].OnEnable(context)
                     â”‚      â”œâ”€ è®¢é˜…äº‹ä»¶
                     â”‚      â”œâ”€ æ³¨å†Œå‘½ä»¤
                     â”‚      â””â”€ åˆå§‹åŒ–
                     â”‚
                     â””â”€â†’ [æ–°å®ä¾‹].RestoreState()
```

---

## ğŸ’¾ **çŠ¶æ€ç®¡ç†**

### **å®ç°çŠ¶æ€ä¿å­˜å’Œæ¢å¤**

```csharp
using NetherGate.API.Plugins;
using System.Text.Json;

public class MyPlugin : PluginBase
{
    private Dictionary<string, PlayerData> _playerData = new();
    private MyConfig _config = null!;

    public override async Task OnLoadAsync()
    {
        Logger.Debug("æ’ä»¶åŠ è½½ä¸­...");
    }

    public override async Task OnEnableAsync()
    {
        // åŠ è½½é…ç½®
        _config = await Config.LoadAsync<MyConfig>("config");
        
        // åŠ è½½æŒä¹…åŒ–æ•°æ®
        await LoadDataAsync();
        
        // å°è¯•æ¢å¤çƒ­é‡è½½å‰çš„çŠ¶æ€
        await RestoreStateAsync();
        
        // æ³¨å†Œäº‹ä»¶å’Œå‘½ä»¤
        RegisterEvents();
        RegisterCommands();
        
        Logger.Info("MyPlugin å·²å¯ç”¨");
    }

    public override async Task OnDisableAsync()
    {
        // ä¿å­˜çŠ¶æ€ï¼ˆç”¨äºçƒ­é‡è½½ï¼‰
        await SaveStateAsync();
        
        // ä¿å­˜æ•°æ®åˆ°ç£ç›˜
        await SaveDataAsync();
        
        Logger.Info("MyPlugin å·²ç¦ç”¨");
    }

    public override async Task OnUnloadAsync()
    {
        // æœ€åçš„æ¸…ç†å·¥ä½œ
        Logger.Debug("æ’ä»¶å¸è½½å®Œæˆ");
    }

    /// <summary>
    /// ä¿å­˜çŠ¶æ€ï¼ˆçƒ­é‡è½½å‰ï¼‰
    /// </summary>
    private async Task SaveStateAsync()
    {
        try
        {
            var state = new PluginState
            {
                PlayerData = _playerData,
                LastSaveTime = DateTime.UtcNow
            };
            
            // ä½¿ç”¨ DataDirectory å±æ€§ï¼ˆç”± PluginBase æä¾›ï¼‰
            var stateFile = Path.Combine(DataDirectory, ".state.json");
            var json = JsonSerializer.Serialize(state, 
                new JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(stateFile, json);
            
            Logger.Debug("çŠ¶æ€å·²ä¿å­˜");
        }
        catch (Exception ex)
        {
            Logger.Error($"ä¿å­˜çŠ¶æ€å¤±è´¥: {ex.Message}");
        }
    }

    /// <summary>
    /// æ¢å¤çŠ¶æ€ï¼ˆçƒ­é‡è½½åï¼‰
    /// </summary>
    private async Task RestoreStateAsync()
    {
        try
        {
            var stateFile = Path.Combine(_context.DataDirectory, ".state.json");
            if (!File.Exists(stateFile))
            {
                _context.Logger.Debug("æ²¡æœ‰æ‰¾åˆ°çŠ¶æ€æ–‡ä»¶ï¼Œè·³è¿‡æ¢å¤");
                return;
            }
            
            var json = File.ReadAllText(stateFile);
            var state = System.Text.Json.JsonSerializer.Deserialize<PluginState>(json);
            
            if (state != null)
            {
                _playerData = state.PlayerData;
                _context.Logger.Info($"çŠ¶æ€å·²æ¢å¤ï¼ˆä¸Šæ¬¡ä¿å­˜: {state.LastSaveTime}ï¼‰");
                
                // åˆ é™¤çŠ¶æ€æ–‡ä»¶
                File.Delete(stateFile);
            }
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"æ¢å¤çŠ¶æ€å¤±è´¥: {ex.Message}");
        }
    }

    private void LoadData()
    {
        // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½æ•°æ®
        var dataFile = Path.Combine(_context.DataDirectory, "data.json");
        if (File.Exists(dataFile))
        {
            var json = File.ReadAllText(dataFile);
            _playerData = System.Text.Json.JsonSerializer
                .Deserialize<Dictionary<string, PlayerData>>(json) ?? new();
        }
    }

    private void SaveData()
    {
        // ä¿å­˜æ•°æ®åˆ°æŒä¹…åŒ–å­˜å‚¨
        var dataFile = Path.Combine(_context.DataDirectory, "data.json");
        var json = System.Text.Json.JsonSerializer.Serialize(_playerData,
            new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        File.WriteAllText(dataFile, json);
    }

    private void RegisterEvents()
    {
        _context.EventBus.Subscribe<PlayerJoinedEvent>(OnPlayerJoined);
        _context.EventBus.Subscribe<PlayerLeftEvent>(OnPlayerLeft);
    }

    private void RegisterCommands()
    {
        _context.CommandManager.RegisterCommand(new MyCommand(_context));
    }

    private void OnPlayerJoined(PlayerJoinedEvent e)
    {
        // å¤„ç†ç©å®¶åŠ å…¥
    }

    private void OnPlayerLeft(PlayerLeftEvent e)
    {
        // å¤„ç†ç©å®¶ç¦»å¼€
    }
}

public class PluginState
{
    public Dictionary<string, PlayerData> PlayerData { get; set; } = new();
    public DateTime LastSaveTime { get; set; }
}

public class PlayerData
{
    public string Name { get; set; } = string.Empty;
    public int Score { get; set; }
    // å…¶ä»–æ•°æ®...
}
```

---

## ğŸ§¹ **èµ„æºæ¸…ç†**

### **1. å–æ¶ˆäº‹ä»¶è®¢é˜…**

```csharp
public class MyPlugin : IPlugin
{
    private Action<PlayerJoinedEvent>? _joinHandler;
    private Action<PlayerLeftEvent>? _leftHandler;

    public void OnEnable(IPluginContext context)
    {
        // ä¿å­˜å¤„ç†å™¨å¼•ç”¨
        _joinHandler = OnPlayerJoined;
        _leftHandler = OnPlayerLeft;
        
        _context.EventBus.Subscribe(_joinHandler);
        _context.EventBus.Subscribe(_leftHandler);
    }

    public void OnDisable()
    {
        // æ‰‹åŠ¨å–æ¶ˆè®¢é˜…ï¼ˆå¯é€‰ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
        if (_joinHandler != null)
            _context.EventBus.Unsubscribe(_joinHandler);
        
        if (_leftHandler != null)
            _context.EventBus.Unsubscribe(_leftHandler);
    }
}
```

### **2. åœæ­¢å®šæ—¶å™¨**

```csharp
public class MyPlugin : IPlugin
{
    private Timer? _heartbeatTimer;
    private Timer? _cleanupTimer;

    public void OnEnable(IPluginContext context)
    {
        _heartbeatTimer = new Timer(_ => DoHeartbeat(), 
            null, TimeSpan.Zero, TimeSpan.FromSeconds(30));
        
        _cleanupTimer = new Timer(_ => DoCleanup(), 
            null, TimeSpan.FromMinutes(5), TimeSpan.FromMinutes(5));
    }

    public void OnDisable()
    {
        // åœæ­¢å¹¶é‡Šæ”¾å®šæ—¶å™¨
        _heartbeatTimer?.Dispose();
        _heartbeatTimer = null;
        
        _cleanupTimer?.Dispose();
        _cleanupTimer = null;
    }

    private void DoHeartbeat() { }
    private void DoCleanup() { }
}
```

### **3. å…³é—­æ–‡ä»¶æµå’Œè¿æ¥**

```csharp
public class MyPlugin : IPlugin
{
    private FileStream? _logStream;
    private HttpClient? _httpClient;
    private DatabaseConnection? _dbConnection;

    public void OnEnable(IPluginContext context)
    {
        _logStream = File.OpenWrite("plugin.log");
        _httpClient = new HttpClient();
        _dbConnection = new DatabaseConnection();
    }

    public void OnDisable()
    {
        // å…³é—­æ‰€æœ‰èµ„æº
        _logStream?.Dispose();
        _logStream = null;
        
        _httpClient?.Dispose();
        _httpClient = null;
        
        _dbConnection?.Close();
        _dbConnection = null;
    }
}
```

### **4. å–æ¶ˆå¼‚æ­¥æ“ä½œ**

```csharp
public class MyPlugin : IPlugin
{
    private CancellationTokenSource? _cts;

    public void OnEnable(IPluginContext context)
    {
        _cts = new CancellationTokenSource();
        
        // å¯åŠ¨åå°ä»»åŠ¡
        _ = BackgroundTaskAsync(_cts.Token);
    }

    public void OnDisable()
    {
        // å–æ¶ˆæ‰€æœ‰åå°ä»»åŠ¡
        _cts?.Cancel();
        _cts?.Dispose();
        _cts = null;
    }

    private async Task BackgroundTaskAsync(CancellationToken cancellationToken)
    {
        while (!cancellationToken.IsCancellationRequested)
        {
            try
            {
                await DoWorkAsync();
                await Task.Delay(1000, cancellationToken);
            }
            catch (OperationCanceledException)
            {
                _context.Logger.Info("åå°ä»»åŠ¡å·²å–æ¶ˆ");
                break;
            }
        }
    }

    private async Task DoWorkAsync()
    {
        // æ‰§è¡Œå·¥ä½œ
    }
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. å§‹ç»ˆå®ç°æ­£ç¡®çš„æ¸…ç†**

```csharp
public void OnDisable()
{
    // âœ… å®Œæ•´çš„æ¸…ç†æµç¨‹
    
    // 1. ä¿å­˜çŠ¶æ€
    SaveState();
    
    // 2. åœæ­¢æ‰€æœ‰å®šæ—¶å™¨
    StopTimers();
    
    // 3. å–æ¶ˆæ‰€æœ‰å¼‚æ­¥æ“ä½œ
    CancelAsyncOperations();
    
    // 4. å…³é—­æ‰€æœ‰è¿æ¥å’Œæµ
    CloseConnections();
    
    // 5. ä¿å­˜æ•°æ®
    SaveData();
    
    // 6. è®°å½•æ—¥å¿—
    _context.Logger.Info("æ’ä»¶å·²å®Œå…¨æ¸…ç†");
}
```

### **2. é¿å…é™æ€å˜é‡**

```csharp
// âŒ ä¸æ¨èï¼šé™æ€å˜é‡åœ¨çƒ­é‡è½½æ—¶ä¸ä¼šé‡ç½®
public static Dictionary<string, PlayerData> PlayerCache = new();

// âœ… æ¨èï¼šä½¿ç”¨å®ä¾‹å˜é‡
private Dictionary<string, PlayerData> _playerCache = new();
```

å¦‚æœå¿…é¡»ä½¿ç”¨é™æ€å˜é‡ï¼Œåœ¨ `OnDisable()` ä¸­æ¸…ç†ï¼š

```csharp
public static Dictionary<string, PlayerData> PlayerCache = new();

public void OnDisable()
{
    // æ¸…ç†é™æ€å˜é‡
    PlayerCache.Clear();
}
```

### **3. å®ç°å¹‚ç­‰æ€§**

ç¡®ä¿å¤šæ¬¡è°ƒç”¨ `OnEnable()` å’Œ `OnDisable()` ä¸ä¼šå‡ºé”™ï¼š

```csharp
private bool _isInitialized = false;

public void OnEnable(IPluginContext context)
{
    if (_isInitialized)
    {
        _context.Logger.Warning("æ’ä»¶å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–");
        return;
    }
    
    // åˆå§‹åŒ–é€»è¾‘
    Initialize();
    
    _isInitialized = true;
}

public void OnDisable()
{
    if (!_isInitialized)
    {
        return;
    }
    
    // æ¸…ç†é€»è¾‘
    Cleanup();
    
    _isInitialized = false;
}
```

### **4. æµ‹è¯•çƒ­é‡è½½**

åœ¨å¼€å‘æ—¶é¢‘ç¹æµ‹è¯•çƒ­é‡è½½ï¼š

```bash
# ä¿®æ”¹ä»£ç 
# æ„å»ºæ’ä»¶
dotnet build

# æµ‹è¯•é‡è½½
plugin reload MyPlugin

# æ£€æŸ¥æ—¥å¿—
# éªŒè¯åŠŸèƒ½
```

### **5. è®°å½•çƒ­é‡è½½æ—¥å¿—**

```csharp
public void OnDisable()
{
    _context.Logger.Info("=== æ’ä»¶æ­£åœ¨å¸è½½ï¼ˆçƒ­é‡è½½ï¼‰ ===");
    _context.Logger.Info($"å½“å‰çŠ¶æ€: {GetCurrentState()}");
    
    SaveState();
    Cleanup();
    
    _context.Logger.Info("æ’ä»¶å¸è½½å®Œæˆ");
}

public void OnEnable(IPluginContext context)
{
    _context.Logger.Info("=== æ’ä»¶æ­£åœ¨åŠ è½½ï¼ˆçƒ­é‡è½½ï¼‰ ===");
    
    Initialize();
    RestoreState();
    
    _context.Logger.Info($"æ¢å¤åçŠ¶æ€: {GetCurrentState()}");
}
```

---

## â“ **å¸¸è§é—®é¢˜**

### **Q: çƒ­é‡è½½åæ•°æ®ä¸¢å¤±ï¼Ÿ**

**A:** ç¡®ä¿æ­£ç¡®å®ç°çŠ¶æ€ä¿å­˜å’Œæ¢å¤ï¼š

```csharp
public void OnDisable()
{
    SaveState();  // ä¿å­˜åˆ°ä¸´æ—¶çŠ¶æ€æ–‡ä»¶
    SaveData();   // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
}

public void OnEnable(IPluginContext context)
{
    LoadData();     // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½
    RestoreState(); // æ¢å¤çƒ­é‡è½½å‰çš„çŠ¶æ€
}
```

---

### **Q: çƒ­é‡è½½åäº‹ä»¶é‡å¤è§¦å‘ï¼Ÿ**

**A:** ç¡®ä¿åœ¨ `OnDisable()` ä¸­å–æ¶ˆæ‰€æœ‰äº‹ä»¶è®¢é˜…ï¼š

```csharp
private Action<PlayerJoinedEvent> _joinHandler = null!;

public void OnEnable(IPluginContext context)
{
    _joinHandler = OnPlayerJoined;
    _context.EventBus.Subscribe(_joinHandler);
}

public void OnDisable()
{
    _context.EventBus.Unsubscribe(_joinHandler);
}
```

---

### **Q: çƒ­é‡è½½å¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ**

**A:** æ£€æŸ¥æ˜¯å¦æ­£ç¡®é‡Šæ”¾äº†æ‰€æœ‰èµ„æºï¼š

```csharp
public void OnDisable()
{
    // æ£€æŸ¥æ¸…å•ï¼š
    // âœ… å®šæ—¶å™¨å·²åœæ­¢ï¼Ÿ
    _timer?.Dispose();
    
    // âœ… æ–‡ä»¶æµå·²å…³é—­ï¼Ÿ
    _fileStream?.Dispose();
    
    // âœ… ç½‘ç»œè¿æ¥å·²å…³é—­ï¼Ÿ
    _httpClient?.Dispose();
    
    // âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­ï¼Ÿ
    _dbConnection?.Close();
    
    // âœ… å¼‚æ­¥æ“ä½œå·²å–æ¶ˆï¼Ÿ
    _cts?.Cancel();
    
    // âœ… äº‹ä»¶è®¢é˜…å·²å–æ¶ˆï¼Ÿ
    _context.EventBus.Unsubscribe(_handler);
}
```

---

### **Q: é™æ€å˜é‡å¦‚ä½•å¤„ç†ï¼Ÿ**

**A:** 

**æ–¹æ³• 1ï¼šé¿å…ä½¿ç”¨é™æ€å˜é‡**ï¼ˆæ¨èï¼‰

```csharp
// ä½¿ç”¨å®ä¾‹å˜é‡
private Dictionary<string, int> _cache = new();
```

**æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ¸…ç†é™æ€å˜é‡**

```csharp
public static Dictionary<string, int> Cache = new();

public void OnDisable()
{
    Cache.Clear();
}
```

**æ–¹æ³• 3ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼**

```csharp
public class PluginData
{
    private static PluginData? _instance;
    
    public static PluginData Instance => _instance ??= new();
    
    public Dictionary<string, int> Cache { get; } = new();
    
    public static void Reset()
    {
        _instance = null;
    }
}

public void OnDisable()
{
    PluginData.Reset();
}
```

---

### **Q: å¦‚ä½•è°ƒè¯•çƒ­é‡è½½é—®é¢˜ï¼Ÿ**

**A:**

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**

```yaml
logging:
  level: "Debug"
```

2. **æ·»åŠ è°ƒè¯•ä¿¡æ¯**

```csharp
public void OnDisable()
{
    _context.Logger.Debug($"OnDisable è°ƒç”¨ï¼Œå½“å‰æ•°æ®é‡: {_playerData.Count}");
    SaveState();
    _context.Logger.Debug("çŠ¶æ€å·²ä¿å­˜");
}

public void OnEnable(IPluginContext context)
{
    _context.Logger.Debug("OnEnable è°ƒç”¨");
    RestoreState();
    _context.Logger.Debug($"çŠ¶æ€å·²æ¢å¤ï¼Œæ•°æ®é‡: {_playerData.Count}");
}
```

3. **æ£€æŸ¥å†…å­˜ä½¿ç”¨**

```csharp
_context.EventBus.Subscribe<ServerHeartbeatEvent>(e =>
{
    var memoryMB = GC.GetTotalMemory(false) / 1024 / 1024;
    _context.Logger.Debug($"å†…å­˜ä½¿ç”¨: {memoryMB} MB");
});
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ’ä»¶å¼€å‘æŒ‡å—](../03-æ’ä»¶å¼€å‘/æ’ä»¶å¼€å‘æŒ‡å—.md)
- [æ€§èƒ½ä¼˜åŒ–](../07-ç¤ºä¾‹å’Œæœ€ä½³å®è·µ/æ€§èƒ½ä¼˜åŒ–.md)
- [è°ƒè¯•æŠ€å·§](../03-æ’ä»¶å¼€å‘/è°ƒè¯•æŠ€å·§.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
