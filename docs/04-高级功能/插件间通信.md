# æ’ä»¶é—´é€šä¿¡

NetherGate æä¾›äº†å¼ºå¤§çš„æ’ä»¶é—´é€šä¿¡ï¼ˆIPCï¼‰ç³»ç»Ÿï¼Œå…è®¸æ’ä»¶ä¹‹é—´å®‰å…¨ã€é«˜æ•ˆåœ°äº¤æ¢æ•°æ®å’Œè°ƒç”¨æœåŠ¡ã€‚

---

## ğŸ“‹ **ç›®å½•**

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é€šä¿¡æ¨¡å¼](#é€šä¿¡æ¨¡å¼)
- [å‘é€æ¶ˆæ¯](#å‘é€æ¶ˆæ¯)
- [æ¥æ”¶æ¶ˆæ¯](#æ¥æ”¶æ¶ˆæ¯)
- [è¯·æ±‚-å“åº”æ¨¡å¼](#è¯·æ±‚-å“åº”æ¨¡å¼)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å®Œæ•´ç¤ºä¾‹](#å®Œæ•´ç¤ºä¾‹)

---

## ğŸš€ **å¿«é€Ÿå¼€å§‹**

### **åŸºæœ¬æ¦‚å¿µ**

- **é¢‘é“ï¼ˆChannelï¼‰ï¼š** æ¶ˆæ¯é€šé“ï¼Œç±»ä¼¼ä¸»é¢˜
- **æ¶ˆæ¯ï¼ˆMessageï¼‰ï¼š** åŒ…å«æ•°æ®çš„é€šä¿¡å•å…ƒ
- **å‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼š** å‘é€æ¶ˆæ¯çš„æ’ä»¶
- **è®¢é˜…è€…ï¼ˆSubscriberï¼‰ï¼š** æ¥æ”¶æ¶ˆæ¯çš„æ’ä»¶

### **ç®€å•ç¤ºä¾‹**

**å‘é€æ¶ˆæ¯ï¼š**
```csharp
// æ’ä»¶ A å‘é€æ¶ˆæ¯
await _context.Messenger.SendMessageAsync(
    targetPlugin: "PluginB",
    channel: "greeting",
    data: new { Message = "Hello!" }
);
```

**æ¥æ”¶æ¶ˆæ¯ï¼š**
```csharp
// æ’ä»¶ B æ¥æ”¶æ¶ˆæ¯
_context.Messenger.Subscribe("greeting", msg =>
{
    _context.Logger.Info($"æ”¶åˆ°æ¥è‡ª {msg.SourcePlugin} çš„æ¶ˆæ¯: {msg.Data}");
});
```

---

## ğŸ“¡ **é€šä¿¡æ¨¡å¼**

### **1. ç‚¹å¯¹ç‚¹é€šä¿¡**

å‘é€æ¶ˆæ¯ç»™ç‰¹å®šæ’ä»¶ã€‚

```csharp
// å‘é€ç»™ EconomyPlugin
await _context.Messenger.SendMessageAsync(
    targetPlugin: "EconomyPlugin",
    channel: "withdraw",
    data: new { PlayerName = "Steve", Amount = 100 }
);
```

### **2. å¹¿æ’­é€šä¿¡**

å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„æ’ä»¶ã€‚

```csharp
// å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜… "player_event" çš„æ’ä»¶
await _context.Messenger.BroadcastMessageAsync(
    channel: "player_event",
    data: new { EventType = "join", PlayerName = "Steve" }
);
```

### **3. è¯·æ±‚-å“åº”æ¨¡å¼**

å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”ã€‚

```csharp
// è¯·æ±‚å¹¶ç­‰å¾…å“åº”
var balance = await _context.Messenger.SendRequestAsync<int>(
    targetPlugin: "EconomyPlugin",
    channel: "get_balance",
    data: new { PlayerName = "Steve" },
    timeoutMs: 5000
);

_context.Logger.Info($"Steve çš„ä½™é¢: {balance}");
```

---

## ğŸ“¤ **å‘é€æ¶ˆæ¯**

### **IPluginMessenger æ¥å£**

```csharp
public interface IPluginMessenger
{
    /// <summary>
    /// å‘é€æ¶ˆæ¯ç»™ç‰¹å®šæ’ä»¶
    /// </summary>
    Task SendMessageAsync(string targetPlugin, string channel, object? data = null);
    
    /// <summary>
    /// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è®¢é˜…è€…
    /// </summary>
    Task BroadcastMessageAsync(string channel, object? data = null);
    
    /// <summary>
    /// å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº”
    /// </summary>
    Task<TResponse?> SendRequestAsync<TResponse>(
        string targetPlugin, 
        string channel, 
        object? data = null, 
        int timeoutMs = 5000);
}
```

### **SendMessageAsync - ç‚¹å¯¹ç‚¹**

```csharp
// åŸºæœ¬ç”¨æ³•
await _context.Messenger.SendMessageAsync("TargetPlugin", "channel");

// å¸¦æ•°æ®
await _context.Messenger.SendMessageAsync(
    "TargetPlugin", 
    "channel", 
    new { Key = "Value" }
);

// å¤æ‚æ•°æ®
await _context.Messenger.SendMessageAsync(
    "EconomyPlugin",
    "transaction",
    new TransactionData
    {
        From = "Steve",
        To = "Alex",
        Amount = 100,
        Reason = "è´­ä¹°ç‰©å“"
    }
);
```

### **BroadcastMessageAsync - å¹¿æ’­**

```csharp
// å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…
await _context.Messenger.BroadcastMessageAsync(
    channel: "server_event",
    data: new 
    {
        Event = "restart",
        Time = DateTime.UtcNow,
        Reason = "å®šæœŸç»´æŠ¤"
    }
);

// æ‰€æœ‰è®¢é˜… "server_event" çš„æ’ä»¶éƒ½ä¼šæ”¶åˆ°
```

### **SendRequestAsync - è¯·æ±‚-å“åº”**

```csharp
// è¯·æ±‚æ•°æ®
var response = await _context.Messenger.SendRequestAsync<PlayerBalance>(
    targetPlugin: "EconomyPlugin",
    channel: "get_balance",
    data: new { PlayerName = "Steve" },
    timeoutMs: 3000  // 3ç§’è¶…æ—¶
);

if (response != null)
{
    _context.Logger.Info($"ä½™é¢: {response.Balance}");
}
else
{
    _context.Logger.Warning("è¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥");
}
```

---

## ğŸ“¥ **æ¥æ”¶æ¶ˆæ¯**

### **Subscribe - è®¢é˜…æ¶ˆæ¯**

```csharp
public interface IPluginMessenger
{
    /// <summary>
    /// è®¢é˜…é¢‘é“æ¶ˆæ¯
    /// </summary>
    void Subscribe(string channel, Action<PluginMessage> handler);
    
    /// <summary>
    /// è®¢é˜…è¯·æ±‚å¹¶æä¾›å“åº”
    /// </summary>
    void SubscribeRequest<TRequest, TResponse>(
        string channel, 
        Func<TRequest, Task<TResponse>> handler);
    
    /// <summary>
    /// å–æ¶ˆè®¢é˜…
    /// </summary>
    void Unsubscribe(string channel, Action<PluginMessage> handler);
}
```

### **PluginMessage ç»“æ„**

```csharp
public class PluginMessage
{
    /// <summary>
    /// æºæ’ä»¶åç§°
    /// </summary>
    public string SourcePlugin { get; set; }
    
    /// <summary>
    /// é¢‘é“åç§°
    /// </summary>
    public string Channel { get; set; }
    
    /// <summary>
    /// æ¶ˆæ¯æ•°æ®
    /// </summary>
    public object? Data { get; set; }
    
    /// <summary>
    /// æ—¶é—´æˆ³
    /// </summary>
    public DateTime Timestamp { get; set; }
}
```

### **åŸºæœ¬è®¢é˜…**

```csharp
public void OnEnable(IPluginContext context)
{
    // è®¢é˜…æ¶ˆæ¯
    _context.Messenger.Subscribe("player_data", OnPlayerDataReceived);
    _context.Messenger.Subscribe("economy_transaction", OnTransaction);
}

private void OnPlayerDataReceived(PluginMessage msg)
{
    _context.Logger.Info($"æ”¶åˆ°æ¥è‡ª {msg.SourcePlugin} çš„æ¶ˆæ¯");
    
    // è§£ææ•°æ®
    if (msg.Data is System.Text.Json.JsonElement json)
    {
        var playerName = json.GetProperty("PlayerName").GetString();
        var level = json.GetProperty("Level").GetInt32();
        
        _context.Logger.Info($"ç©å®¶: {playerName}, ç­‰çº§: {level}");
    }
}

private void OnTransaction(PluginMessage msg)
{
    // å¤„ç†äº¤æ˜“æ¶ˆæ¯
}

public void OnDisable()
{
    // å–æ¶ˆè®¢é˜…
    _context.Messenger.Unsubscribe("player_data", OnPlayerDataReceived);
}
```

### **ç±»å‹åŒ–è®¢é˜…**

```csharp
// å®šä¹‰æ¶ˆæ¯ç±»å‹
public class PlayerDataMessage
{
    public string PlayerName { get; set; } = string.Empty;
    public int Level { get; set; }
    public int Experience { get; set; }
}

// è®¢é˜…å¹¶ååºåˆ—åŒ–
_context.Messenger.Subscribe("player_data", msg =>
{
    var data = DeserializeMessage<PlayerDataMessage>(msg.Data);
    if (data != null)
    {
        _context.Logger.Info($"ç©å®¶ {data.PlayerName} ç­‰çº§ {data.Level}");
    }
});

// è¾…åŠ©æ–¹æ³•
private T? DeserializeMessage<T>(object? data)
{
    if (data is System.Text.Json.JsonElement json)
    {
        return System.Text.Json.JsonSerializer.Deserialize<T>(json.GetRawText());
    }
    return default;
}
```

---

## ğŸ”„ **è¯·æ±‚-å“åº”æ¨¡å¼**

### **å‘é€è¯·æ±‚æ–¹**

```csharp
public async Task<int> GetPlayerBalance(string playerName)
{
    try
    {
        var balance = await _context.Messenger.SendRequestAsync<int>(
            targetPlugin: "EconomyPlugin",
            channel: "get_balance",
            data: new { PlayerName = playerName },
            timeoutMs: 5000
        );
        
        return balance;
    }
    catch (TimeoutException)
    {
        _context.Logger.Warning("è·å–ä½™é¢è¶…æ—¶");
        return 0;
    }
    catch (Exception ex)
    {
        _context.Logger.Error($"è·å–ä½™é¢å¤±è´¥: {ex.Message}");
        return 0;
    }
}
```

### **å“åº”è¯·æ±‚æ–¹**

```csharp
public void OnEnable(IPluginContext context)
{
    // æ³¨å†Œè¯·æ±‚å¤„ç†å™¨
    _context.Messenger.SubscribeRequest<BalanceRequest, int>(
        channel: "get_balance",
        handler: HandleBalanceRequest
    );
    
    _context.Messenger.SubscribeRequest<TransferRequest, TransferResult>(
        channel: "transfer",
        handler: HandleTransferRequest
    );
}

private async Task<int> HandleBalanceRequest(BalanceRequest request)
{
    _context.Logger.Debug($"æ”¶åˆ°ä½™é¢æŸ¥è¯¢è¯·æ±‚: {request.PlayerName}");
    
    // æŸ¥è¯¢ä½™é¢
    var balance = await _economyService.GetBalanceAsync(request.PlayerName);
    
    return balance;
}

private async Task<TransferResult> HandleTransferRequest(TransferRequest request)
{
    _context.Logger.Info($"æ”¶åˆ°è½¬è´¦è¯·æ±‚: {request.From} -> {request.To}, {request.Amount}");
    
    // æ‰§è¡Œè½¬è´¦
    var success = await _economyService.TransferAsync(
        request.From, 
        request.To, 
        request.Amount
    );
    
    return new TransferResult
    {
        Success = success,
        Message = success ? "è½¬è´¦æˆåŠŸ" : "ä½™é¢ä¸è¶³"
    };
}

// è¯·æ±‚å’Œå“åº”ç±»å‹
public class BalanceRequest
{
    public string PlayerName { get; set; } = string.Empty;
}

public class TransferRequest
{
    public string From { get; set; } = string.Empty;
    public string To { get; set; } = string.Empty;
    public int Amount { get; set; }
}

public class TransferResult
{
    public bool Success { get; set; }
    public string Message { get; set; } = string.Empty;
}
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

### **1. å®šä¹‰æ¸…æ™°çš„æ¶ˆæ¯å¥‘çº¦**

```csharp
// åœ¨å…±äº«åº“æˆ–æ–‡æ¡£ä¸­å®šä¹‰æ¶ˆæ¯æ ¼å¼
namespace PluginContracts;

/// <summary>
/// ç»æµç³»ç»Ÿ - ä½™é¢æŸ¥è¯¢è¯·æ±‚
/// é¢‘é“: "economy.get_balance"
/// </summary>
public class GetBalanceRequest
{
    public string PlayerName { get; set; } = string.Empty;
}

/// <summary>
/// ç»æµç³»ç»Ÿ - ä½™é¢æŸ¥è¯¢å“åº”
/// </summary>
public class GetBalanceResponse
{
    public int Balance { get; set; }
    public string Currency { get; set; } = "é‡‘å¸";
}
```

### **2. ä½¿ç”¨å‘½åç©ºé—´é¿å…å†²çª**

```csharp
// âœ… æ¨èï¼šä½¿ç”¨æ’ä»¶åä½œä¸ºå‰ç¼€
await _context.Messenger.SendMessageAsync(
    "EconomyPlugin",
    "economy.transaction",  // å¸¦å‘½åç©ºé—´
    data
);

// âŒ ä¸æ¨èï¼šå¯èƒ½ä¸å…¶ä»–æ’ä»¶å†²çª
await _context.Messenger.SendMessageAsync(
    "EconomyPlugin",
    "transaction",  // å¤ªé€šç”¨
    data
);
```

### **3. é”™è¯¯å¤„ç†**

```csharp
try
{
    var response = await _context.Messenger.SendRequestAsync<int>(
        "EconomyPlugin",
        "economy.get_balance",
        new { PlayerName = "Steve" },
        timeoutMs: 3000
    );
    
    if (response > 0)
    {
        // å¤„ç†å“åº”
    }
}
catch (TimeoutException)
{
    _context.Logger.Warning("è¯·æ±‚è¶…æ—¶ï¼Œç»æµæ’ä»¶å¯èƒ½æœªå¯ç”¨");
}
catch (InvalidOperationException ex)
{
    _context.Logger.Error($"ç›®æ ‡æ’ä»¶æœªæ‰¾åˆ°: {ex.Message}");
}
catch (Exception ex)
{
    _context.Logger.Error($"é€šä¿¡å¤±è´¥: {ex.Message}");
}
```

### **4. ç‰ˆæœ¬å…¼å®¹æ€§**

```csharp
public class GetBalanceRequest
{
    /// <summary>
    /// åè®®ç‰ˆæœ¬
    /// </summary>
    public int Version { get; set; } = 1;
    
    public string PlayerName { get; set; } = string.Empty;
}

// å¤„ç†ä¸åŒç‰ˆæœ¬
private async Task<GetBalanceResponse> HandleGetBalance(GetBalanceRequest request)
{
    if (request.Version != 1)
    {
        throw new NotSupportedException($"ä¸æ”¯æŒçš„åè®®ç‰ˆæœ¬: {request.Version}");
    }
    
    // å¤„ç†è¯·æ±‚...
}
```

### **5. å¼‚æ­¥å¤„ç†**

```csharp
// âœ… æ¨èï¼šä½¿ç”¨å¼‚æ­¥
_context.Messenger.Subscribe("heavy_task", async msg =>
{
    await ProcessHeavyTaskAsync(msg);
});

// âŒ ä¸æ¨èï¼šé˜»å¡å¤„ç†
_context.Messenger.Subscribe("heavy_task", msg =>
{
    Thread.Sleep(5000);  // é˜»å¡ï¼
    ProcessTask(msg);
});
```

---

## ğŸ“š **å®Œæ•´ç¤ºä¾‹**

### **ç»æµæ’ä»¶ï¼ˆæä¾›æœåŠ¡ï¼‰**

```csharp
public class EconomyPlugin : IPlugin
{
    private IPluginContext _context = null!;
    private EconomyService _service = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        _service = new EconomyService();
        
        // æ³¨å†Œè¯·æ±‚å¤„ç†å™¨
        RegisterMessengerHandlers();
        
        _context.Logger.Info("EconomyPlugin API å·²å°±ç»ª");
    }

    private void RegisterMessengerHandlers()
    {
        // æŸ¥è¯¢ä½™é¢
        _context.Messenger.SubscribeRequest<GetBalanceRequest, int>(
            "economy.get_balance",
            async req => await _service.GetBalanceAsync(req.PlayerName)
        );
        
        // è½¬è´¦
        _context.Messenger.SubscribeRequest<TransferRequest, bool>(
            "economy.transfer",
            async req => await _service.TransferAsync(req.From, req.To, req.Amount)
        );
        
        // æ·»åŠ é‡‘å¸
        _context.Messenger.SubscribeRequest<AddMoneyRequest, bool>(
            "economy.add_money",
            async req => await _service.AddMoneyAsync(req.PlayerName, req.Amount)
        );
        
        // æ‰£é™¤é‡‘å¸
        _context.Messenger.SubscribeRequest<RemoveMoneyRequest, bool>(
            "economy.remove_money",
            async req => await _service.RemoveMoneyAsync(req.PlayerName, req.Amount)
        );
        
        // è®¢é˜…äº¤æ˜“å¹¿æ’­ï¼ˆå…¶ä»–æ’ä»¶å¯ä»¥ç›‘å¬ï¼‰
        _context.Messenger.Subscribe("economy.transaction", msg =>
        {
            _context.Logger.Debug($"äº¤æ˜“å¹¿æ’­: {msg.Data}");
        });
    }

    // äº¤æ˜“æ—¶å¹¿æ’­äº‹ä»¶
    private async Task BroadcastTransaction(string from, string to, int amount)
    {
        await _context.Messenger.BroadcastMessageAsync(
            "economy.transaction",
            new
            {
                From = from,
                To = to,
                Amount = amount,
                Timestamp = DateTime.UtcNow
            }
        );
    }
}

public class GetBalanceRequest
{
    public string PlayerName { get; set; } = string.Empty;
}

public class TransferRequest
{
    public string From { get; set; } = string.Empty;
    public string To { get; set; } = string.Empty;
    public int Amount { get; set; }
}

public class AddMoneyRequest
{
    public string PlayerName { get; set; } = string.Empty;
    public int Amount { get; set; }
}

public class RemoveMoneyRequest
{
    public string PlayerName { get; set; } = string.Empty;
    public int Amount { get; set; }
}
```

### **å•†åº—æ’ä»¶ï¼ˆä½¿ç”¨æœåŠ¡ï¼‰**

```csharp
public class ShopPlugin : IPlugin
{
    private IPluginContext _context = null!;

    public void OnEnable(IPluginContext context)
    {
        _context = context;
        
        // æ³¨å†Œè´­ä¹°å‘½ä»¤
        _context.CommandManager.RegisterCommand(new BuyCommand(_context, this));
        
        // ç›‘å¬ç»æµäº¤æ˜“äº‹ä»¶
        _context.Messenger.Subscribe("economy.transaction", OnTransaction);
        
        _context.Logger.Info("ShopPlugin å·²å¯ç”¨");
    }

    public async Task<bool> PurchaseItemAsync(string playerName, string itemName, int price)
    {
        // æ£€æŸ¥ä½™é¢
        var balance = await GetPlayerBalanceAsync(playerName);
        
        if (balance < price)
        {
            await _context.GameDisplayApi.SendChatMessage(
                playerName, 
                $"Â§cä½™é¢ä¸è¶³ï¼éœ€è¦ {price} é‡‘å¸ï¼Œå½“å‰ä½™é¢ {balance}"
            );
            return false;
        }
        
        // æ‰£é™¤é‡‘å¸
        var success = await RemoveMoneyAsync(playerName, price);
        
        if (success)
        {
            // ç»™äºˆç‰©å“
            await _context.GameDisplayApi.GiveItem(playerName, itemName, 1);
            
            await _context.GameDisplayApi.SendChatMessage(
                playerName,
                $"Â§aè´­ä¹°æˆåŠŸï¼èŠ±è´¹ {price} é‡‘å¸"
            );
            
            return true;
        }
        
        return false;
    }

    private async Task<int> GetPlayerBalanceAsync(string playerName)
    {
        try
        {
            return await _context.Messenger.SendRequestAsync<int>(
                "EconomyPlugin",
                "economy.get_balance",
                new { PlayerName = playerName },
                timeoutMs: 3000
            );
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"æŸ¥è¯¢ä½™é¢å¤±è´¥: {ex.Message}");
            return 0;
        }
    }

    private async Task<bool> RemoveMoneyAsync(string playerName, int amount)
    {
        try
        {
            return await _context.Messenger.SendRequestAsync<bool>(
                "EconomyPlugin",
                "economy.remove_money",
                new { PlayerName = playerName, Amount = amount },
                timeoutMs: 3000
            );
        }
        catch (Exception ex)
        {
            _context.Logger.Error($"æ‰£é™¤é‡‘å¸å¤±è´¥: {ex.Message}");
            return false;
        }
    }

    private void OnTransaction(PluginMessage msg)
    {
        // è®°å½•äº¤æ˜“
        _context.Logger.Debug($"ç›‘å¬åˆ°äº¤æ˜“: {msg.Data}");
    }
}

public class BuyCommand : ICommand
{
    private readonly IPluginContext _context;
    private readonly ShopPlugin _plugin;

    public string Name => "buy";
    public string Description => "è´­ä¹°ç‰©å“";

    public BuyCommand(IPluginContext context, ShopPlugin plugin)
    {
        _context = context;
        _plugin = plugin;
    }

    public async Task<CommandResult> ExecuteAsync(string[] args, ICommandSender? sender = null)
    {
        if (sender == null)
            return CommandResult.Fail("æ­¤å‘½ä»¤åªèƒ½åœ¨æ¸¸æˆå†…ä½¿ç”¨");
        
        if (args.Length == 0)
            return CommandResult.Fail("ç”¨æ³•: #buy <ç‰©å“å>");
        
        var itemName = args[0];
        var price = 100; // å‡è®¾ä»·æ ¼
        
        var success = await _plugin.PurchaseItemAsync(sender.Name, itemName, price);
        
        return success ? CommandResult.Success() : CommandResult.Fail();
    }
}
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [æ’ä»¶å¼€å‘æŒ‡å—](../03-æ’ä»¶å¼€å‘/æ’ä»¶å¼€å‘æŒ‡å—.md)
- [æ’ä»¶çƒ­é‡è½½](./æ’ä»¶çƒ­é‡è½½.md)
- [API å‚è€ƒ](../08-å‚è€ƒ/APIå‚è€ƒ.md)

---

**æ–‡æ¡£ç»´æŠ¤è€…ï¼š** NetherGate å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°ï¼š** 2025-10-05
