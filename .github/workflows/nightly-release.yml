name: Nightly Release

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯æ™š 20:00 (UTC 12:00)
    - cron: '0 12 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  check-commits:
    name: Check Daily Commits
    runs-on: ubuntu-latest
    outputs:
      has_commits: ${{ steps.check.outputs.has_commits }}
      commit_count: ${{ steps.check.outputs.commit_count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for commits today
        id: check
        run: |
          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„æ—¥æœŸ
          TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "æ£€æŸ¥æ—¥æœŸ: $TODAY"
          
          # è·å–ä»Šå¤©çš„æäº¤æ•°é‡ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          COMMIT_COUNT=$(git log --since="$TODAY 00:00:00 +0800" --until="$TODAY 23:59:59 +0800" --oneline | wc -l)
          echo "ä»Šæ—¥æäº¤æ•°: $COMMIT_COUNT"
          
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç° $COMMIT_COUNT ä¸ªæäº¤ï¼Œå°†è¿›è¡Œæ„å»º"
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "commit_count=0" >> $GITHUB_OUTPUT
            echo "â­ï¸ ä»Šæ—¥æ— æäº¤ï¼Œè·³è¿‡æ„å»º"
          fi

  build:
    name: Build ${{ matrix.platform }}
    needs: check-commits
    if: needs.check-commits.outputs.has_commits == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows å¹³å°
          - os: windows-latest
            platform: win-x64
            artifact_name: nethergate-nightly-win-x64
            archive_ext: zip
          - os: windows-latest
            platform: win-x86
            artifact_name: nethergate-nightly-win-x86
            archive_ext: zip
          - os: windows-latest
            platform: win-arm64
            artifact_name: nethergate-nightly-win-arm64
            archive_ext: zip
          
          # Linux å¹³å°
          - os: ubuntu-latest
            platform: linux-x64
            artifact_name: nethergate-nightly-linux-x64
            archive_ext: tar.gz
          - os: ubuntu-latest
            platform: linux-arm
            artifact_name: nethergate-nightly-linux-arm
            archive_ext: tar.gz
          - os: ubuntu-latest
            platform: linux-arm64
            artifact_name: nethergate-nightly-linux-arm64
            archive_ext: tar.gz
          
          # macOS å¹³å°
          - os: macos-latest
            platform: osx-x64
            artifact_name: nethergate-nightly-osx-x64
            archive_ext: tar.gz
          - os: macos-latest
            platform: osx-arm64
            artifact_name: nethergate-nightly-osx-arm64
            archive_ext: tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        shell: bash
        run: |
          dotnet publish src/NetherGate.Host/NetherGate.Host.csproj \
            -c Release \
            -r ${{ matrix.platform }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:IncludeNativeLibrariesForSelfExtract=true \
            -o ./publish/${{ matrix.platform }}

      - name: Create archive (Linux/macOS)
        if: matrix.archive_ext == 'tar.gz'
        run: |
          cd ./publish/${{ matrix.platform }}
          chmod +x NetherGate.Host
          tar -czf ../../${{ matrix.artifact_name }}.tar.gz *
          cd ../..
          
      - name: Create archive (Windows)
        if: matrix.archive_ext == 'zip'
        shell: pwsh
        run: |
          cd ./publish/${{ matrix.platform }}
          Compress-Archive -Path * -DestinationPath ../../${{ matrix.artifact_name }}.zip
          cd ../..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}.tar.gz
            ${{ matrix.artifact_name }}.zip
          retention-days: 7

  create-release:
    name: Create Nightly Release
    needs: [check-commits, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Generate release notes
        id: release_notes
        run: |
          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„æ—¥æœŸ
          TODAY=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          DATETIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          > âš ï¸ **This is a nightly release.**
          > âš ï¸ **This is not the latest stable version.**
          
          ## ğŸ“… æ„å»ºä¿¡æ¯
          
          - **æ„å»ºæ—¥æœŸ**: $DATETIME (åŒ—äº¬æ—¶é—´)
          - **æäº¤æ•°é‡**: ${{ needs.check-commits.outputs.commit_count }}
          - **åˆ†æ”¯**: \`${GITHUB_REF#refs/heads/}\`
          - **æäº¤**: \`${GITHUB_SHA:0:7}\`
          
          ---
          
          ## ğŸ“ ä»Šæ—¥æäº¤è®°å½•
          
          EOF
          
          # æ·»åŠ ä»Šæ—¥æ‰€æœ‰æäº¤
          git log --since="$TODAY 00:00:00 +0800" \
                  --until="$TODAY 23:59:59 +0800" \
                  --pretty=format:"- \`%h\` %s - *%an*" >> release_notes.md
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ğŸ“¦ ä¸‹è½½è¯´æ˜" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„é€‰æ‹©ç›¸åº”çš„å‹ç¼©åŒ…ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Windows" >> release_notes.md
          echo "- **x64 (64ä½)**: \`nethergate-nightly-win-x64.zip\` - æ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨" >> release_notes.md
          echo "- **x86 (32ä½)**: \`nethergate-nightly-win-x86.zip\` - é€‚ç”¨äº 32 ä½ç³»ç»Ÿ" >> release_notes.md
          echo "- **ARM64**: \`nethergate-nightly-win-arm64.zip\` - é€‚ç”¨äº ARM æ¶æ„ï¼ˆå¦‚éªé¾™ PCï¼‰" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Linux" >> release_notes.md
          echo "- **x64 (amd64)**: \`nethergate-nightly-linux-x64.tar.gz\` - æ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨" >> release_notes.md
          echo "- **ARM**: \`nethergate-nightly-linux-arm.tar.gz\` - é€‚ç”¨äº 32 ä½ ARMï¼ˆå¦‚æ ‘è“æ´¾ 2/3ï¼‰" >> release_notes.md
          echo "- **ARM64 (aarch64)**: \`nethergate-nightly-linux-arm64.tar.gz\` - é€‚ç”¨äº 64 ä½ ARMï¼ˆå¦‚æ ‘è“æ´¾ 4/5ï¼‰" >> release_notes.md
          echo "" >> release_notes.md
          echo "### macOS" >> release_notes.md
          echo "- **Intel (x64)**: \`nethergate-nightly-osx-x64.tar.gz\` - é€‚ç”¨äº Intel Mac" >> release_notes.md
          echo "- **Apple Silicon (ARM64)**: \`nethergate-nightly-osx-arm64.tar.gz\` - é€‚ç”¨äº M1/M2/M3/M4 Mac" >> release_notes.md
          echo "" >> release_notes.md
          echo "è§£å‹åè¿è¡Œ \`NetherGate.Host\` (æˆ– \`NetherGate.Host.exe\` on Windows) å³å¯ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## âš™ï¸ ç³»ç»Ÿè¦æ±‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **.NET Runtime**: å·²åŒ…å«åœ¨æ„å»ºä¸­ï¼ˆself-containedï¼‰" >> release_notes.md
          echo "- **Minecraft**: Java Edition 1.21.9+" >> release_notes.md
          echo "- **æ“ä½œç³»ç»Ÿ**:" >> release_notes.md
          echo "  - Windows 10+ (x64, x86, ARM64)" >> release_notes.md
          echo "  - Linux (Ubuntu 20.04+, Debian 10+, å…¶ä»–ä¸»æµå‘è¡Œç‰ˆ)" >> release_notes.md
          echo "  - macOS 11+ (Intel & Apple Silicon)" >> release_notes.md
          
          # è®¾ç½® release tag
          RELEASE_TAG="nightly-$(TZ='Asia/Shanghai' date '+%Y%m%d')"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=Nightly Release $(TZ='Asia/Shanghai' date '+%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Delete old nightly releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ä¿ç•™æœ€è¿‘ 7 å¤©çš„ nightly ç‰ˆæœ¬ï¼Œåˆ é™¤æ›´æ—©çš„
          CUTOFF_DATE=$(date -d '7 days ago' '+%Y%m%d' 2>/dev/null || date -v-7d '+%Y%m%d')
          
          # è·å–æ‰€æœ‰ nightly æ ‡ç­¾
          gh release list --limit 100 | grep "nightly-" | while read -r line; do
            TAG=$(echo "$line" | awk '{print $1}')
            TAG_DATE=$(echo "$TAG" | sed 's/nightly-//')
            
            if [ "$TAG_DATE" -lt "$CUTOFF_DATE" ]; then
              echo "åˆ é™¤æ—§ç‰ˆæœ¬: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag || true
            fi
          done

      - name: Organize artifacts
        run: |
          mkdir -p release_files
          find ./artifacts -type f \( -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} ./release_files/ \;
          ls -lh ./release_files/

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # åˆ é™¤åŒå releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          gh release delete "${{ steps.release_notes.outputs.release_tag }}" --yes --cleanup-tag || true
          
          # åˆ›å»ºæ–°çš„ release
          gh release create "${{ steps.release_notes.outputs.release_tag }}" \
            --title "${{ steps.release_notes.outputs.release_name }}" \
            --notes-file release_notes.md \
            --prerelease \
            --target "${GITHUB_SHA}" \
            ./release_files/*

  notify:
    name: Notify Build Status
    needs: [check-commits, build, create-release]
    if: always() && needs.check-commits.outputs.has_commits == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "âœ… Nightly æ„å»ºæˆåŠŸï¼"
            echo "ğŸ“¦ å·²å‘å¸ƒ 8 ä¸ªå¹³å°æ„å»ºåˆ° GitHub Releases"
          else
            echo "âŒ Nightly æ„å»ºå¤±è´¥"
            exit 1
          fi
